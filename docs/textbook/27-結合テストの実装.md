# ç¬¬27ç« ï¼šçµåˆãƒ†ã‚¹ãƒˆã®å®Ÿè£…

ã“ã®ç« ã§ã¯ã€**çµåˆãƒ†ã‚¹ãƒˆï¼ˆIntegration Testï¼‰**ã®å®Ÿè£…ã‚’å­¦ã³ã¾ã™ã€‚API Routes ã®ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆãªã©ã€è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒé€£æºã™ã‚‹éƒ¨åˆ†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

## 27.1 çµåˆãƒ†ã‚¹ãƒˆã¨ã¯

### çµåˆãƒ†ã‚¹ãƒˆã®ä½ç½®ã¥ã‘

```
ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰:
       /\
      /  \     E2Eãƒ†ã‚¹ãƒˆï¼ˆå°‘æ•°ï¼‰â† ç¬¬28ç« 
     /____\    â† é…ã„ã€é«˜ã‚³ã‚¹ãƒˆ
    /      \
   / çµåˆ   \  çµåˆãƒ†ã‚¹ãƒˆï¼ˆä¸­ç¨‹åº¦ï¼‰â† ã“ã®ç« 
  / ãƒ†ã‚¹ãƒˆ  \  â† è¤‡æ•°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é€£æº
 /__________\
/            \
/  å˜ä½“ãƒ†ã‚¹ãƒˆ  \ å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆå¤šæ•°ï¼‰â† ç¬¬26ç« 
/______________\ â† é€Ÿã„ã€ä½ã‚³ã‚¹ãƒˆ
```

### çµåˆãƒ†ã‚¹ãƒˆã®å¯¾è±¡

```
çµåˆãƒ†ã‚¹ãƒˆã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚‚ã®:
âœ… API Routesï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œï¼ˆPrismaï¼‰
âœ… èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆNextAuth.jsï¼‰
âœ… Server Actions
âœ… è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€£æº
```

---

## 27.2 ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™

çµåˆãƒ†ã‚¹ãƒˆã§ã¯ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ±šã•ãªã„ã‚ˆã†ã€**ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ã‚’ç”¨æ„ã—ã¾ã™ã€‚

**SQLite ã‚’ãƒ†ã‚¹ãƒˆç”¨ã«ä½¿ç”¨:**

```bash
# ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š
DATABASE_URL="file:./test.db"
```

**ãªãœ SQLite ã‚’ä½¿ã†ã®ã‹ï¼Ÿ**

```
æœ¬ç•ªç’°å¢ƒ: PostgreSQLï¼ˆSupabaseï¼‰
â”œâ”€ é«˜æ©Ÿèƒ½
â”œâ”€ è¤‡æ•°äººã§å…±æœ‰
â””â”€ ã‚¯ãƒ©ã‚¦ãƒ‰ã§é‹ç”¨

ãƒ†ã‚¹ãƒˆç’°å¢ƒ: SQLiteï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”œâ”€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸è¦
â”œâ”€ é«˜é€Ÿ
â”œâ”€ å„é–‹ç™ºè€…ã®ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµ
â””â”€ test.db ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«1ã¤ã§ç®¡ç†
```

**package.json ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ :**

```json
{
  "scripts": {
    "test:integration": "DATABASE_URL=file:./test.db jest --testMatch='**/*.integration.test.ts'",
    "test:integration:watch": "DATABASE_URL=file:./test.db jest --watch --testMatch='**/*.integration.test.ts'"
  }
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã®è©³ã—ã„èª¬æ˜:**

#### 1. ç’°å¢ƒå¤‰æ•°ã®ä¸Šæ›¸ã

```bash
DATABASE_URL=file:./test.db jest
```

- **`DATABASE_URL=file:./test.db`**: ã“ã®å®Ÿè¡Œã®é–“ã ã‘ç’°å¢ƒå¤‰æ•°ã‚’ä¸Šæ›¸ã
- **`jest`**: Jest ã‚’å®Ÿè¡Œ
- **çµæœ**: `.env` ã®è¨­å®šã‚’ç„¡è¦–ã—ã¦ã€ãƒ†ã‚¹ãƒˆç”¨DBã‚’ä½¿ã†

**å›³è§£:**

```
é€šå¸¸ã®å®Ÿè¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .env        â”‚
â”‚ DATABASE_URLâ”‚â”€â”€â†’ PostgreSQLï¼ˆæœ¬ç•ªï¼‰
â”‚ =postgres://â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³â”‚â”€â”€â†’ SQLiteï¼ˆãƒ†ã‚¹ãƒˆå°‚ç”¨ï¼‰
â”‚ DATABASE_URL â”‚
â”‚ =file:test.dbâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
  âœ“ æœ¬ç•ªDBã‚’æ±šã•ãªã„
  âœ“ é«˜é€Ÿã«ãƒ†ã‚¹ãƒˆã§ãã‚‹
```

#### 2. `--testMatch` ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
jest --testMatch='**/*.integration.test.ts'
```

- **å½¹å‰²**: çµåˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’å®Ÿè¡Œ
- **ãƒ‘ã‚¿ãƒ¼ãƒ³**: `*.integration.test.ts` ã«ãƒãƒƒãƒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®ä¾‹:**

```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ __tests__/
â”‚   â”‚   â”œâ”€â”€ utils.test.ts              â† å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè¡Œã•ã‚Œãªã„ï¼‰
â”‚   â”‚   â””â”€â”€ utils.integration.test.ts  â† çµåˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè¡Œã•ã‚Œã‚‹ï¼‰ âœ“
â”‚   â””â”€â”€ utils.ts
â””â”€â”€ app/
    â””â”€â”€ api/
        â””â”€â”€ posts/
            â””â”€â”€ route.integration.test.ts  â† çµåˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè¡Œã•ã‚Œã‚‹ï¼‰ âœ“
```

**ãªãœåˆ†ã‘ã‚‹ã®ã‹ï¼Ÿ**

```
å˜ä½“ãƒ†ã‚¹ãƒˆ: é«˜é€Ÿï¼ˆDBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
â”œâ”€ é–‹ç™ºä¸­ã«é »ç¹ã«å®Ÿè¡Œ
â””â”€ npm run test:watch

çµåˆãƒ†ã‚¹ãƒˆ: ä½é€Ÿï¼ˆDBã‚¢ã‚¯ã‚»ã‚¹ã‚ã‚Šï¼‰
â”œâ”€ å¿…è¦ãªæ™‚ã ã‘å®Ÿè¡Œ
â””â”€ npm run test:integration
```

#### 3. `--watch` ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
jest --watch --testMatch='**/*.integration.test.ts'
```

- ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆå†å®Ÿè¡Œ
- é–‹ç™ºä¸­ã«ä¾¿åˆ©

> ğŸ’¡ **åˆå¿ƒè€…ã¸ã®è£œè¶³:**
> - **çµåˆãƒ†ã‚¹ãƒˆ**: è¤‡æ•°ã®éƒ¨å“ï¼ˆAPI + DB + èªè¨¼ï¼‰ãŒé€£æºã—ã¦å‹•ãã‹ã‚’ãƒ†ã‚¹ãƒˆ
> - **ãƒ†ã‚¹ãƒˆDB**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã‚’å£Šã•ãªã„ãŸã‚ã®å°‚ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
> - **SQLite**: ãƒ•ã‚¡ã‚¤ãƒ«1ã¤ã§å‹•ãè»½é‡ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
> 
> **å®Ÿè¡Œæ–¹æ³•:**
> ```bash
> # çµåˆãƒ†ã‚¹ãƒˆã‚’1å›å®Ÿè¡Œ
> npm run test:integration
> 
> # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ï¼ˆé–‹ç™ºä¸­ï¼‰
> npm run test:integration:watch
> ```

### Prisma ã®ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼

çµåˆãƒ†ã‚¹ãƒˆã§ã¯ã€å„ãƒ†ã‚¹ãƒˆã®å‰ã«**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹**ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**tests/helpers/database.ts ã‚’ä½œæˆ:**

```typescript
// tests/helpers/database.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: 'file:./test.db',
    },
  },
});

export async function resetDatabase() {
  // ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
  await prisma.$transaction([
    prisma.comment.deleteMany(),
    prisma.like.deleteMany(),
    prisma.activityParticipant.deleteMany(),
    prisma.activitySchedule.deleteMany(),
    prisma.eventParticipant.deleteMany(),
    prisma.eventPart.deleteMany(),
    prisma.event.deleteMany(),
    prisma.postParticipant.deleteMany(),
    prisma.post.deleteMany(),
    prisma.verificationToken.deleteMany(),
    prisma.passwordResetToken.deleteMany(),
    prisma.account.deleteMany(),
    prisma.session.deleteMany(),
    prisma.user.deleteMany(),
  ]);
}

export async function seedDatabase() {
  // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
  const admin = await prisma.user.create({
    data: {
      email: 'admin@test.com',
      name: 'Admin User',
      role: 'admin',
      emailVerified: new Date(),
    },
  });

  const member = await prisma.user.create({
    data: {
      email: 'member@test.com',
      name: 'Member User',
      role: 'member',
      emailVerified: new Date(),
    },
  });

  const post = await prisma.post.create({
    data: {
      title: 'Test Post',
      content: 'This is a test post',
      userId: admin.id,
    },
  });

  return { admin, member, post };
}

export { prisma };
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã®è©³ã—ã„èª¬æ˜:**

#### 1. ãƒ†ã‚¹ãƒˆå°‚ç”¨ã® Prisma Client

```typescript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: 'file:./test.db',  // ãƒ†ã‚¹ãƒˆå°‚ç”¨DB
    },
  },
});
```

- **å½¹å‰²**: ãƒ†ã‚¹ãƒˆç”¨DBã«æ¥ç¶šã™ã‚‹ Prisma Client
- **ãªãœå¿…è¦ï¼Ÿ**: æœ¬ç•ªç”¨ã¨ãƒ†ã‚¹ãƒˆç”¨ã§æ¥ç¶šå…ˆã‚’åˆ†ã‘ã‚‹

**é€šå¸¸ã® Prisma Client ã¨ã®é•ã„:**

```typescript
// é€šå¸¸ï¼ˆsrc/lib/db.tsï¼‰
const prisma = new PrismaClient();
// â†’ ç’°å¢ƒå¤‰æ•° DATABASE_URL ã‚’ä½¿ã†ï¼ˆPostgreSQLï¼‰

// ãƒ†ã‚¹ãƒˆç”¨ï¼ˆtests/helpers/database.tsï¼‰
const prisma = new PrismaClient({
  datasources: { db: { url: 'file:./test.db' } }
});
// â†’ SQLite ã‚’ä½¿ã†
```

#### 2. `resetDatabase()` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒªã‚¢

```typescript
export async function resetDatabase() {
  await prisma.$transaction([
    prisma.comment.deleteMany(),
    prisma.like.deleteMany(),
    // ...
    prisma.user.deleteMany(),
  ]);
}
```

- **å½¹å‰²**: ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
- **`$transaction()`**: è¤‡æ•°ã®æ“ä½œã‚’1ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ
- **å‰Šé™¤ã®é †åº**: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è€ƒæ…®ï¼ˆå­ãƒ†ãƒ¼ãƒ–ãƒ« â†’ è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**ãªãœå¿…è¦ï¼Ÿ**

```
ãƒ†ã‚¹ãƒˆ1: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‚’ä½œæˆ
ãƒ†ã‚¹ãƒˆ2: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‚’ä½œæˆ  â† ã‚¨ãƒ©ãƒ¼ï¼ï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹ï¼‰

â†“ resetDatabase() ã‚’å„ãƒ†ã‚¹ãƒˆã®å‰ã«å®Ÿè¡Œ

ãƒ†ã‚¹ãƒˆ1: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‚’ä½œæˆ
  â†“ DBã‚¯ãƒªã‚¢
ãƒ†ã‚¹ãƒˆ2: ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‚’ä½œæˆ  â† OKï¼ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ï¼‰
```

**å‰Šé™¤é †åºã®ç†ç”±:**

```
Userï¼ˆè¦ªï¼‰
 â””â”€â”€ Postï¼ˆå­ï¼‰
      â””â”€â”€ Commentï¼ˆå­«ï¼‰
      â””â”€â”€ Likeï¼ˆå­«ï¼‰

å‰Šé™¤ã¯é€†é †:
1. Comment, Likeï¼ˆå­«ï¼‰ã‚’å‰Šé™¤
2. Postï¼ˆå­ï¼‰ã‚’å‰Šé™¤
3. Userï¼ˆè¦ªï¼‰ã‚’å‰Šé™¤

ç†ç”±: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã§ã€è¦ªã‚’å…ˆã«å‰Šé™¤ã§ããªã„
```

**å›³è§£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ resetDatabase()                     â”‚
â”‚                                     â”‚
â”‚ 1. comments ãƒ†ãƒ¼ãƒ–ãƒ« â†’ å…¨å‰Šé™¤      â”‚
â”‚ 2. likes ãƒ†ãƒ¼ãƒ–ãƒ« â†’ å…¨å‰Šé™¤         â”‚
â”‚ 3. posts ãƒ†ãƒ¼ãƒ–ãƒ« â†’ å…¨å‰Šé™¤         â”‚
â”‚ 4. users ãƒ†ãƒ¼ãƒ–ãƒ« â†’ å…¨å‰Šé™¤         â”‚
â”‚                                     â”‚
â”‚ çµæœ: ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. `seedDatabase()` - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

```typescript
export async function seedDatabase() {
  const admin = await prisma.user.create({
    data: {
      email: 'admin@test.com',
      name: 'Admin User',
      role: 'admin',
      emailVerified: new Date(),
    },
  });

  const member = await prisma.user.create({
    data: {
      email: 'member@test.com',
      name: 'Member User',
      role: 'member',
      emailVerified: new Date(),
    },
  });

  const post = await prisma.post.create({
    data: {
      title: 'Test Post',
      content: 'This is a test post',
      userId: admin.id,
    },
  });

  return { admin, member, post };
}
```

- **å½¹å‰²**: ãƒ†ã‚¹ãƒˆã§ä½¿ã†åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
- **è¿”ã‚Šå€¤**: ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ï¼ˆãƒ†ã‚¹ãƒˆã§åˆ©ç”¨ï¼‰

**ä½¿ç”¨ä¾‹:**

```typescript
describe('API Routes', () => {
  beforeEach(async () => {
    await resetDatabase();  // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
  });

  it('æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ã§ãã‚‹', async () => {
    // 2. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const { admin, post } = await seedDatabase();
    
    // 3. APIã‚’ãƒ†ã‚¹ãƒˆ
    const response = await fetch('/api/posts');
    const posts = await response.json();
    
    expect(posts).toHaveLength(1);
    expect(posts[0].title).toBe('Test Post');
  });
});
```

**ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ:**

```
ãƒ†ã‚¹ãƒˆé–‹å§‹
  â†“
resetDatabase()  â† ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç©ºã«ã™ã‚‹
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç©ºã®DB          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
seedDatabase()   â† åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ admin ãƒ¦ãƒ¼ã‚¶ãƒ¼  â”‚
â”‚ member ãƒ¦ãƒ¼ã‚¶ãƒ¼ â”‚
â”‚ 1ä»¶ã®æŠ•ç¨¿       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ       â† ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆ
```

> ğŸ’¡ **åˆå¿ƒè€…ã¸ã®è£œè¶³:**
> - **resetDatabase**: ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã€ã‚¤ãƒ¡ãƒ¼ã‚¸
> - **seedDatabase**: ã€Œãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ã€ã‚¤ãƒ¡ãƒ¼ã‚¸
> - **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**: è¤‡æ•°ã®æ“ä½œã‚’ã€Œã¾ã¨ã‚ã¦å®Ÿè¡Œã€ã™ã‚‹ä»•çµ„ã¿
> 
> **å…¸å‹çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³:**
> ```typescript
> beforeEach(async () => {
>   await resetDatabase();   // æ¯å›ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹ã‹ã‚‰
>   await seedDatabase();    // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
> });
> 
> it('ãƒ†ã‚¹ãƒˆ', async () => {
>   // ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹ + åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹çŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã§ãã‚‹
> });
> ```

### Next.js API Routes ã®ãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼

API Routesã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**tests/helpers/api.ts ã‚’ä½œæˆ:**

```typescript
// tests/helpers/api.ts
import { NextRequest } from 'next/server';
import { Session } from 'next-auth';

export function createMockRequest(
  url: string,
  options: {
    method?: string;
    body?: any;
    headers?: Record<string, string>;
  } = {}
): NextRequest {
  const { method = 'GET', body, headers = {} } = options;

  const request = new NextRequest(new URL(url, 'http://localhost:3000'), {
    method,
    headers: new Headers({
      'Content-Type': 'application/json',
      ...headers,
    }),
    body: body ? JSON.stringify(body) : undefined,
  });

  return request;
}

export function createMockSession(overrides?: Partial<Session>): Session {
  return {
    user: {
      id: '1',
      email: 'user@test.com',
      name: 'Test User',
      role: 'member',
      ...overrides?.user,
    },
    expires: new Date(Date.now() + 86400000).toISOString(),
    ...overrides,
  };
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã®è©³ã—ã„èª¬æ˜:**

#### 1. `createMockRequest()` - ãƒ¢ãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ

```typescript
export function createMockRequest(
  url: string,
  options: {
    method?: string;
    body?: any;
    headers?: Record<string, string>;
  } = {}
): NextRequest
```

- **å½¹å‰²**: ãƒ†ã‚¹ãƒˆç”¨ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
- **å¼•æ•°**:
  - `url`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆã®URLï¼ˆä¾‹: `/api/posts`ï¼‰
  - `options`: ãƒ¡ã‚½ãƒƒãƒ‰ã€ãƒœãƒ‡ã‚£ã€ãƒ˜ãƒƒãƒ€ãƒ¼

**è©³ç´°ãªä»•çµ„ã¿:**

```typescript
const request = new NextRequest(new URL(url, 'http://localhost:3000'), {
  method,
  headers: new Headers({
    'Content-Type': 'application/json',
    ...headers,
  }),
  body: body ? JSON.stringify(body) : undefined,
});
```

**1. URL ã®æ§‹ç¯‰**

```typescript
new URL(url, 'http://localhost:3000')
```

- **`url`**: ç›¸å¯¾ãƒ‘ã‚¹ï¼ˆä¾‹: `/api/posts`ï¼‰
- **`'http://localhost:3000'`**: ãƒ™ãƒ¼ã‚¹URL
- **çµæœ**: `http://localhost:3000/api/posts`

**ãªãœãƒ™ãƒ¼ã‚¹URLãŒå¿…è¦ï¼Ÿ**

```
URL ã‚¯ãƒ©ã‚¹ã¯çµ¶å¯¾URLã‚’è¦æ±‚ã™ã‚‹:
âœ— /api/posts            ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã®ã¿ï¼‰
âœ“ http://localhost:3000/api/posts  ï¼ˆçµ¶å¯¾URLï¼‰

ãƒ†ã‚¹ãƒˆã§ã¯å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ã¯å‹•ã„ã¦ã„ãªã„ã®ã§ã€
ãƒ€ãƒŸãƒ¼ã®ãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š
```

**2. ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®š**

```typescript
headers: new Headers({
  'Content-Type': 'application/json',  // JSONã‚’é€å—ä¿¡
  ...headers,  // è¿½åŠ ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å±•é–‹
}),
```

- **`Content-Type`**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å½¢å¼ã‚’æŒ‡å®š
- **`...headers`**: è¿½åŠ ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ï¼‰

**Headers ã‚¯ãƒ©ã‚¹ã¨ã¯ï¼Ÿ**

```typescript
// Fetch API ã® Headers ã‚¯ãƒ©ã‚¹
const headers = new Headers();
headers.append('Content-Type', 'application/json');
headers.append('Authorization', 'Bearer token');
```

**3. ãƒœãƒ‡ã‚£ã®è¨­å®š**

```typescript
body: body ? JSON.stringify(body) : undefined,
```

- **`body` ãŒã‚ã‚‹å ´åˆ**: JSONæ–‡å­—åˆ—ã«å¤‰æ›
- **`body` ãŒãªã„å ´åˆ**: `undefined`ï¼ˆGET ãƒªã‚¯ã‚¨ã‚¹ãƒˆãªã©ï¼‰

**ä½¿ç”¨ä¾‹:**

```typescript
// GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
const getRequest = createMockRequest('/api/posts');

// POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒœãƒ‡ã‚£ã‚ã‚Šï¼‰
const postRequest = createMockRequest('/api/posts', {
  method: 'POST',
  body: {
    title: 'New Post',
    content: 'Content',
  },
});

// PATCH ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
const patchRequest = createMockRequest('/api/posts/1', {
  method: 'PATCH',
  body: { title: 'Updated' },
  headers: {
    'Authorization': 'Bearer test-token',
  },
});
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ§‹é€ :**

```
GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URL: /api/posts                  â”‚
â”‚ Method: GET                      â”‚
â”‚ Headers:                         â”‚
â”‚   Content-Type: application/json â”‚
â”‚ Body: (ãªã—)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URL: /api/posts                  â”‚
â”‚ Method: POST                     â”‚
â”‚ Headers:                         â”‚
â”‚   Content-Type: application/json â”‚
â”‚ Body:                            â”‚
â”‚   {                              â”‚
â”‚     "title": "New Post",         â”‚
â”‚     "content": "Content"         â”‚
â”‚   }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. `createMockSession()` - ãƒ¢ãƒƒã‚¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ

```typescript
export function createMockSession(overrides?: Partial<Session>): Session {
  return {
    user: {
      id: '1',
      email: 'user@test.com',
      name: 'Test User',
      role: 'member',
      ...overrides?.user,
    },
    expires: new Date(Date.now() + 86400000).toISOString(),
    ...overrides,
  };
}
```

- **å½¹å‰²**: ãƒ†ã‚¹ãƒˆç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ä½œæˆ
- **å¼•æ•°**: `overrides` - ä¸€éƒ¨ã®å€¤ã‚’ä¸Šæ›¸ãï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**è©³ç´°ãªä»•çµ„ã¿:**

**1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±**

```typescript
user: {
  id: '1',
  email: 'user@test.com',
  name: 'Test User',
  role: 'member',
  ...overrides?.user,  // ä¸Šæ›¸ãå¯èƒ½
},
```

- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆrole: 'member'ï¼‰
- **ä¸Šæ›¸ã**: `overrides.user` ã§ä»»æ„ã®å€¤ã«å¤‰æ›´å¯èƒ½

**2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™**

```typescript
expires: new Date(Date.now() + 86400000).toISOString(),
```

- **`Date.now()`**: ç¾åœ¨æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
- **`+ 86400000`**: 1æ—¥å¾Œï¼ˆ86400ç§’ Ã— 1000ãƒŸãƒªç§’ï¼‰
- **`.toISOString()`**: ISOå½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›

**è¨ˆç®—ã®å†…è¨³:**

```
1æ—¥ = 24æ™‚é–“ Ã— 60åˆ† Ã— 60ç§’ = 86,400ç§’
86,400ç§’ Ã— 1,000ãƒŸãƒªç§’ = 86,400,000ãƒŸãƒªç§’
```

**ä½¿ç”¨ä¾‹:**

```typescript
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ï¼‰
const memberSession = createMockSession();

// ç®¡ç†è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
const adminSession = createMockSession({
  user: { role: 'admin' },
});

// ã‚µã‚¤ãƒˆç®¡ç†è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
const siteAdminSession = createMockSession({
  user: {
    id: 'admin-123',
    email: 'admin@example.com',
    name: 'Admin User',
    role: 'site_admin',
  },
});

// ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³
const customSession = createMockSession({
  user: { id: 'custom-id', role: 'member' },
  expires: '2026-12-31T23:59:59.000Z',
});
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ§‹é€ :**

```typescript
{
  user: {
    id: '1',
    email: 'user@test.com',
    name: 'Test User',
    role: 'member'
  },
  expires: '2025-12-29T10:00:00.000Z'
}
```

**å›³è§£:**

```
createMockSession()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤                    â”‚
â”‚ - id: '1'                       â”‚
â”‚ - role: 'member'                â”‚
â”‚ - expires: 1æ—¥å¾Œ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ overrides ã§ä¸Šæ›¸ã
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³    â”‚
â”‚ - role: 'admin' ï¼ˆä¸Šæ›¸ãï¼‰      â”‚
â”‚ - ãã®ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Partial<Session> ã¨ã¯ï¼Ÿ**

```typescript
// é€šå¸¸ã® Session å‹
type Session = {
  user: {
    id: string;
    email: string;
    name: string;
    role: string;
  };
  expires: string;
};

// Partial<Session> - ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ªãƒ—ã‚·ãƒ§ãƒ³
type PartialSession = {
  user?: {
    id?: string;
    email?: string;
    name?: string;
    role?: string;
  };
  expires?: string;
};
```

**ä½¿ã„æ–¹:**

```typescript
// ä¸€éƒ¨ã ã‘æŒ‡å®šã™ã‚Œã°OK
createMockSession({ user: { role: 'admin' } });
//                  ^^^^^^ role ã ã‘ä¸Šæ›¸ã

// ã™ã¹ã¦æŒ‡å®šã—ã¦ã‚‚OK
createMockSession({
  user: {
    id: 'abc',
    email: 'test@example.com',
    name: 'Test',
    role: 'member',
  },
  expires: '2026-01-01T00:00:00.000Z',
});
```

> ğŸ’¡ **åˆå¿ƒè€…ã¸ã®è£œè¶³:**
> - **NextRequest**: Next.js ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
> - **Session**: ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
> - **ãƒ¢ãƒƒã‚¯**: ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
> 
> **ã“ã‚Œã‚‰ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ã†ã¨:**
> ```typescript
> // Before: è¤‡é›‘ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
> const request = new NextRequest(
>   new URL('/api/posts', 'http://localhost:3000'),
>   { method: 'POST', body: JSON.stringify({ title: 'Test' }) }
> );
> 
> // After: ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ã‚‹
> const request = createMockRequest('/api/posts', {
>   method: 'POST',
>   body: { title: 'Test' },
> });
> ```
> 
> **ãƒ†ã‚¹ãƒˆãŒã‚¹ãƒƒã‚­ãƒªæ›¸ã‘ã‚‹ = èª­ã¿ã‚„ã™ã„ = ãƒ¡ãƒ³ãƒ†ã—ã‚„ã™ã„ âœ“**

---

## 27.3 API Routes ã®ãƒ†ã‚¹ãƒˆ

### GET ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

**src/app/api/posts/route.ts ã‚’æƒ³å®š:**

```typescript
// src/app/api/posts/route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET() {
  try {
    const posts = await prisma.post.findMany({
      include: {
        user: {
          select: { name: true, avatar: true },
        },
        likes: true,
        comments: true,
      },
      orderBy: { createdAt: 'desc' },
    });

    return NextResponse.json(posts);
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to fetch posts' },
      { status: 500 }
    );
  }
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/api/posts/__tests__/route.integration.test.ts
import { GET } from '../route';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';

describe('GET /api/posts', () => {
  beforeAll(async () => {
    await resetDatabase();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  beforeEach(async () => {
    await resetDatabase();
  });

  it('æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ã§ãã‚‹', async () => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    const { admin, member } = await seedDatabase();

    // API ã‚’å‘¼ã³å‡ºã—
    const response = await GET();
    const data = await response.json();

    // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
    expect(response.status).toBe(200);
    expect(Array.isArray(data)).toBe(true);
    expect(data.length).toBeGreaterThan(0);
    expect(data[0]).toHaveProperty('title');
    expect(data[0]).toHaveProperty('user');
    expect(data[0]).toHaveProperty('likes');
    expect(data[0]).toHaveProperty('comments');
  });

  it('æŠ•ç¨¿ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™', async () => {
    const response = await GET();
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data).toEqual([]);
  });

  it('æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹', async () => {
    const { admin } = await seedDatabase();

    // è¤‡æ•°ã®æŠ•ç¨¿ã‚’ä½œæˆ
    await prisma.post.create({
      data: {
        title: 'Post 1',
        content: 'Content 1',
        userId: admin.id,
        createdAt: new Date('2025-12-01'),
      },
    });

    await prisma.post.create({
      data: {
        title: 'Post 2',
        content: 'Content 2',
        userId: admin.id,
        createdAt: new Date('2025-12-02'),
      },
    });

    const response = await GET();
    const data = await response.json();

    expect(data[0].title).toBe('Post 2');
    expect(data[1].title).toBe('Post 1');
  });
});
```

### POST ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

**src/app/api/posts/route.tsï¼ˆPOSTè¿½åŠ ï¼‰:**

```typescript
export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    if (session.user.role !== 'admin') {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const body = await request.json();
    const { title, content, youtubeUrls, imageUrls } = body;

    if (!title || !content) {
      return NextResponse.json(
        { error: 'Title and content are required' },
        { status: 400 }
      );
    }

    const post = await prisma.post.create({
      data: {
        title,
        content,
        youtubeUrls: youtubeUrls || [],
        imageUrls: imageUrls || [],
        userId: session.user.id,
      },
    });

    return NextResponse.json(post, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to create post' },
      { status: 500 }
    );
  }
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/api/posts/__tests__/route.integration.test.tsï¼ˆç¶šãï¼‰
import { POST } from '../route';
import { createMockRequest } from '@/tests/helpers/api';

// auth() ã‚’ãƒ¢ãƒƒã‚¯
jest.mock('@/lib/auth', () => ({
  auth: jest.fn(),
}));

import { auth } from '@/lib/auth';

describe('POST /api/posts', () => {
  beforeEach(async () => {
    await resetDatabase();
    (auth as jest.Mock).mockClear();
  });

  it('ç®¡ç†è€…ã¯æŠ•ç¨¿ã‚’ä½œæˆã§ãã‚‹', async () => {
    const { admin } = await seedDatabase();

    // ç®¡ç†è€…ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ¢ãƒƒã‚¯
    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const request = createMockRequest('http://localhost:3000/api/posts', {
      method: 'POST',
      body: {
        title: 'New Post',
        content: 'New Content',
        youtubeUrls: ['https://youtube.com/watch?v=abc'],
        imageUrls: [],
      },
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(201);
    expect(data).toHaveProperty('id');
    expect(data.title).toBe('New Post');
    expect(data.content).toBe('New Content');
    expect(data.userId).toBe(admin.id);

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const savedPost = await prisma.post.findUnique({
      where: { id: data.id },
    });
    expect(savedPost).not.toBeNull();
  });

  it('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æŠ•ç¨¿ã‚’ä½œæˆã§ããªã„', async () => {
    const { member } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    const request = createMockRequest('http://localhost:3000/api/posts', {
      method: 'POST',
      body: {
        title: 'New Post',
        content: 'New Content',
      },
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(403);
    expect(data.error).toBe('Forbidden');
  });

  it('æœªãƒ­ã‚°ã‚¤ãƒ³ã¯æŠ•ç¨¿ã‚’ä½œæˆã§ããªã„', async () => {
    (auth as jest.Mock).mockResolvedValue(null);

    const request = createMockRequest('http://localhost:3000/api/posts', {
      method: 'POST',
      body: {
        title: 'New Post',
        content: 'New Content',
      },
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(401);
    expect(data.error).toBe('Unauthorized');
  });

  it('ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼', async () => {
    const { admin } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const request = createMockRequest('http://localhost:3000/api/posts', {
      method: 'POST',
      body: {
        title: '',
        content: 'Content',
      },
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(400);
    expect(data.error).toBe('Title and content are required');
  });
});
```

### PATCH ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

**src/app/api/posts/[id]/route.ts:**

```typescript
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const post = await prisma.post.findUnique({
      where: { id: params.id },
    });

    if (!post) {
      return NextResponse.json({ error: 'Post not found' }, { status: 404 });
    }

    // æŠ•ç¨¿è€…ã‹ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
    if (post.userId !== session.user.id && session.user.role !== 'admin') {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
    }

    const body = await request.json();
    const { title, content, youtubeUrls, imageUrls } = body;

    const updatedPost = await prisma.post.update({
      where: { id: params.id },
      data: {
        title,
        content,
        youtubeUrls,
        imageUrls,
      },
    });

    return NextResponse.json(updatedPost);
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to update post' },
      { status: 500 }
    );
  }
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/api/posts/[id]/__tests__/route.integration.test.ts
import { PATCH } from '../route';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';
import { createMockRequest } from '@/tests/helpers/api';

jest.mock('@/lib/auth');
import { auth } from '@/lib/auth';

describe('PATCH /api/posts/[id]', () => {
  beforeEach(async () => {
    await resetDatabase();
    (auth as jest.Mock).mockClear();
  });

  it('æŠ•ç¨¿è€…ã¯æŠ•ç¨¿ã‚’ç·¨é›†ã§ãã‚‹', async () => {
    const { admin, post } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const request = createMockRequest(
      `http://localhost:3000/api/posts/${post.id}`,
      {
        method: 'PATCH',
        body: {
          title: 'Updated Title',
          content: 'Updated Content',
        },
      }
    );

    const response = await PATCH(request, { params: { id: post.id } });
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.title).toBe('Updated Title');
    expect(data.content).toBe('Updated Content');

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const updatedPost = await prisma.post.findUnique({
      where: { id: post.id },
    });
    expect(updatedPost?.title).toBe('Updated Title');
  });

  it('ä»–äººã®æŠ•ç¨¿ã¯ç·¨é›†ã§ããªã„', async () => {
    const { admin, member, post } = await seedDatabase();

    // member ãŒ admin ã®æŠ•ç¨¿ã‚’ç·¨é›†ã—ã‚ˆã†ã¨ã™ã‚‹
    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    const request = createMockRequest(
      `http://localhost:3000/api/posts/${post.id}`,
      {
        method: 'PATCH',
        body: {
          title: 'Updated Title',
        },
      }
    );

    const response = await PATCH(request, { params: { id: post.id } });
    const data = await response.json();

    expect(response.status).toBe(403);
    expect(data.error).toBe('Forbidden');
  });

  it('å­˜åœ¨ã—ãªã„æŠ•ç¨¿ã¯404', async () => {
    const { admin } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const request = createMockRequest(
      'http://localhost:3000/api/posts/nonexistent',
      {
        method: 'PATCH',
        body: { title: 'Title' },
      }
    );

    const response = await PATCH(request, { params: { id: 'nonexistent' } });
    const data = await response.json();

    expect(response.status).toBe(404);
    expect(data.error).toBe('Post not found');
  });
});
```

---

## 27.4 ã„ã„ã­æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ

**src/app/api/posts/[id]/like/route.ts:**

```typescript
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await auth();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const existingLike = await prisma.like.findFirst({
      where: {
        postId: params.id,
        userId: session.user.id,
      },
    });

    if (existingLike) {
      // ã„ã„ã­è§£é™¤
      await prisma.like.delete({
        where: { id: existingLike.id },
      });
      return NextResponse.json({ liked: false });
    } else {
      // ã„ã„ã­è¿½åŠ 
      await prisma.like.create({
        data: {
          postId: params.id,
          userId: session.user.id,
        },
      });
      return NextResponse.json({ liked: true });
    }
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to toggle like' },
      { status: 500 }
    );
  }
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/api/posts/[id]/like/__tests__/route.integration.test.ts
import { POST } from '../route';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';
import { createMockRequest } from '@/tests/helpers/api';

jest.mock('@/lib/auth');
import { auth } from '@/lib/auth';

describe('POST /api/posts/[id]/like', () => {
  beforeEach(async () => {
    await resetDatabase();
    (auth as jest.Mock).mockClear();
  });

  it('ã„ã„ã­ã‚’è¿½åŠ ã§ãã‚‹', async () => {
    const { member, post } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    const request = createMockRequest(
      `http://localhost:3000/api/posts/${post.id}/like`,
      { method: 'POST' }
    );

    const response = await POST(request, { params: { id: post.id } });
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.liked).toBe(true);

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const like = await prisma.like.findFirst({
      where: { postId: post.id, userId: member.id },
    });
    expect(like).not.toBeNull();
  });

  it('ã„ã„ã­ã‚’è§£é™¤ã§ãã‚‹', async () => {
    const { member, post } = await seedDatabase();

    // å…ˆã«ã„ã„ã­ã‚’è¿½åŠ 
    await prisma.like.create({
      data: { postId: post.id, userId: member.id },
    });

    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    const request = createMockRequest(
      `http://localhost:3000/api/posts/${post.id}/like`,
      { method: 'POST' }
    );

    const response = await POST(request, { params: { id: post.id } });
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.liked).toBe(false);

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const like = await prisma.like.findFirst({
      where: { postId: post.id, userId: member.id },
    });
    expect(like).toBeNull();
  });

  it('æœªãƒ­ã‚°ã‚¤ãƒ³ã¯401ã‚¨ãƒ©ãƒ¼', async () => {
    const { post } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue(null);

    const request = createMockRequest(
      `http://localhost:3000/api/posts/${post.id}/like`,
      { method: 'POST' }
    );

    const response = await POST(request, { params: { id: post.id } });

    expect(response.status).toBe(401);
  });
});
```

---

## 27.5 Server Actions ã®ãƒ†ã‚¹ãƒˆ

### Server Actions ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•

**src/app/posts/actions.ts:**

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/prisma';

export async function createPost(formData: FormData) {
  const session = await auth();
  if (!session?.user?.id) {
    throw new Error('Unauthorized');
  }

  if (session.user.role !== 'admin') {
    throw new Error('Forbidden');
  }

  const title = formData.get('title') as string;
  const content = formData.get('content') as string;

  if (!title || !content) {
    throw new Error('Title and content are required');
  }

  const post = await prisma.post.create({
    data: {
      title,
      content,
      userId: session.user.id,
    },
  });

  revalidatePath('/posts');

  return post;
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/posts/__tests__/actions.integration.test.ts
import { createPost } from '../actions';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';

jest.mock('@/lib/auth');
jest.mock('next/cache', () => ({
  revalidatePath: jest.fn(),
}));

import { auth } from '@/lib/auth';
import { revalidatePath } from 'next/cache';

describe('createPost', () => {
  beforeEach(async () => {
    await resetDatabase();
    (auth as jest.Mock).mockClear();
    (revalidatePath as jest.Mock).mockClear();
  });

  it('æŠ•ç¨¿ã‚’ä½œæˆã§ãã‚‹', async () => {
    const { admin } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const formData = new FormData();
    formData.append('title', 'New Post');
    formData.append('content', 'New Content');

    const post = await createPost(formData);

    expect(post).toHaveProperty('id');
    expect(post.title).toBe('New Post');
    expect(post.content).toBe('New Content');
    expect(post.userId).toBe(admin.id);

    // revalidatePath ãŒå‘¼ã°ã‚ŒãŸã‹ç¢ºèª
    expect(revalidatePath).toHaveBeenCalledWith('/posts');

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const savedPost = await prisma.post.findUnique({
      where: { id: post.id },
    });
    expect(savedPost).not.toBeNull();
  });

  it('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯403ã‚¨ãƒ©ãƒ¼', async () => {
    const { member } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    const formData = new FormData();
    formData.append('title', 'New Post');
    formData.append('content', 'New Content');

    await expect(createPost(formData)).rejects.toThrow('Forbidden');
  });

  it('æœªãƒ­ã‚°ã‚¤ãƒ³ã¯401ã‚¨ãƒ©ãƒ¼', async () => {
    (auth as jest.Mock).mockResolvedValue(null);

    const formData = new FormData();
    formData.append('title', 'New Post');
    formData.append('content', 'New Content');

    await expect(createPost(formData)).rejects.toThrow('Unauthorized');
  });

  it('ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼', async () => {
    const { admin } = await seedDatabase();

    (auth as jest.Mock).mockResolvedValue({
      user: { id: admin.id, role: 'admin' },
    });

    const formData = new FormData();
    formData.append('title', '');
    formData.append('content', 'Content');

    await expect(createPost(formData)).rejects.toThrow(
      'Title and content are required'
    );
  });
});
```

---

## 27.6 èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ

### èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒ†ã‚¹ãƒˆ

**src/middleware.ts:**

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { auth } from '@/lib/auth';

export async function middleware(request: NextRequest) {
  const session = await auth();

  // èªè¨¼ãŒå¿…è¦ãªãƒ‘ã‚¹
  const protectedPaths = ['/posts/new', '/events', '/schedules'];
  const isProtectedPath = protectedPaths.some((path) =>
    request.nextUrl.pathname.startsWith(path)
  );

  if (isProtectedPath && !session) {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  // ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ‘ã‚¹
  const adminPaths = ['/posts/new', '/events/new', '/schedules/new'];
  const isAdminPath = adminPaths.some((path) =>
    request.nextUrl.pathname.startsWith(path)
  );

  if (isAdminPath && session?.user?.role !== 'admin') {
    return NextResponse.redirect(new URL('/', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/__tests__/middleware.integration.test.ts
import { middleware } from '../middleware';
import { NextRequest } from 'next/server';

jest.mock('@/lib/auth');
import { auth } from '@/lib/auth';

describe('middleware', () => {
  beforeEach(() => {
    (auth as jest.Mock).mockClear();
  });

  it('æœªãƒ­ã‚°ã‚¤ãƒ³ã§ä¿è­·ã•ã‚ŒãŸãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', async () => {
    (auth as jest.Mock).mockResolvedValue(null);

    const request = new NextRequest(new URL('http://localhost:3000/posts/new'));
    const response = await middleware(request);

    expect(response.status).toBe(307); // Redirect
    expect(response.headers.get('location')).toBe('http://localhost:3000/login');
  });

  it('ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ›ãƒ¼ãƒ ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ', async () => {
    (auth as jest.Mock).mockResolvedValue({
      user: { id: '1', role: 'member' },
    });

    const request = new NextRequest(new URL('http://localhost:3000/posts/new'));
    const response = await middleware(request);

    expect(response.status).toBe(307);
    expect(response.headers.get('location')).toBe('http://localhost:3000/');
  });

  it('ç®¡ç†è€…ã¯ç®¡ç†è€…ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹', async () => {
    (auth as jest.Mock).mockResolvedValue({
      user: { id: '1', role: 'admin' },
    });

    const request = new NextRequest(new URL('http://localhost:3000/posts/new'));
    const response = await middleware(request);

    expect(response.status).toBe(200); // Next
  });

  it('å…¬é–‹ãƒ‘ã‚¹ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹', async () => {
    (auth as jest.Mock).mockResolvedValue(null);

    const request = new NextRequest(new URL('http://localhost:3000/'));
    const response = await middleware(request);

    expect(response.status).toBe(200);
  });
});
```

---

## 27.7 è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€£æºãƒ†ã‚¹ãƒˆ

### æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ

**src/app/posts/page.tsx:**

```typescript
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/prisma';
import PostList from '@/components/PostList';

export default async function PostsPage() {
  const session = await auth();
  const posts = await prisma.post.findMany({
    include: {
      user: true,
      likes: true,
      comments: true,
    },
    orderBy: { createdAt: 'desc' },
  });

  return <PostList posts={posts} currentUser={session?.user} />;
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/app/posts/__tests__/page.integration.test.tsx
import { render, screen } from '@testing-library/react';
import PostsPage from '../page';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';

jest.mock('@/lib/auth');
import { auth } from '@/lib/auth';

// Prismaã‚’ãƒ¢ãƒƒã‚¯ã›ãšã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨

describe('PostsPage', () => {
  beforeEach(async () => {
    await resetDatabase();
    (auth as jest.Mock).mockClear();
  });

  it('æŠ•ç¨¿ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
    const { admin, member } = await seedDatabase();

    // è¤‡æ•°ã®æŠ•ç¨¿ã‚’ä½œæˆ
    await prisma.post.create({
      data: {
        title: 'Post 1',
        content: 'Content 1',
        userId: admin.id,
      },
    });

    await prisma.post.create({
      data: {
        title: 'Post 2',
        content: 'Content 2',
        userId: member.id,
      },
    });

    (auth as jest.Mock).mockResolvedValue({
      user: { id: member.id, role: 'member' },
    });

    // Server Component ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const jsx = await PostsPage();
    const { container } = render(jsx);

    expect(screen.getByText('Post 1')).toBeInTheDocument();
    expect(screen.getByText('Post 2')).toBeInTheDocument();
  });

  it('æŠ•ç¨¿ãŒãªã„å ´åˆã¯ã€ŒæŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨è¡¨ç¤º', async () => {
    (auth as jest.Mock).mockResolvedValue(null);

    const jsx = await PostsPage();
    const { container } = render(jsx);

    expect(screen.getByText('æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“')).toBeInTheDocument();
  });
});
```

---

## 27.8 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ

### è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’å«ã‚€ãƒ†ã‚¹ãƒˆ

```typescript
// src/lib/post-service.ts
export async function createPostWithParticipants(
  postData: PostCreateInput,
  participantIds: string[]
) {
  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§æŠ•ç¨¿ã¨å‚åŠ è€…ã‚’åŒæ™‚ã«ä½œæˆ
  return await prisma.$transaction(async (tx) => {
    const post = await tx.post.create({
      data: postData,
    });

    await tx.postParticipant.createMany({
      data: participantIds.map((userId) => ({
        postId: post.id,
        userId,
      })),
    });

    return post;
  });
}
```

**ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ:**

```typescript
// src/lib/__tests__/post-service.integration.test.ts
import { createPostWithParticipants } from '../post-service';
import { resetDatabase, seedDatabase, prisma } from '@/tests/helpers/database';

describe('createPostWithParticipants', () => {
  beforeEach(async () => {
    await resetDatabase();
  });

  it('æŠ•ç¨¿ã¨å‚åŠ è€…ã‚’åŒæ™‚ã«ä½œæˆ', async () => {
    const { admin, member } = await seedDatabase();

    const postData = {
      title: 'Event Post',
      content: 'Event Content',
      userId: admin.id,
    };

    const post = await createPostWithParticipants(postData, [member.id]);

    expect(post).toHaveProperty('id');
    expect(post.title).toBe('Event Post');

    // å‚åŠ è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const participants = await prisma.postParticipant.findMany({
      where: { postId: post.id },
    });

    expect(participants).toHaveLength(1);
    expect(participants[0].userId).toBe(member.id);
  });

  it('ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯', async () => {
    const { admin } = await seedDatabase();

    const postData = {
      title: 'Event Post',
      content: 'Event Content',
      userId: admin.id,
    };

    // å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æŒ‡å®šã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
    await expect(
      createPostWithParticipants(postData, ['nonexistent-user-id'])
    ).rejects.toThrow();

    // æŠ•ç¨¿ã‚‚ä½œæˆã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const posts = await prisma.post.findMany({
      where: { title: 'Event Post' },
    });

    expect(posts).toHaveLength(0);
  });
});
```

---

## 27.9 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š

### ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª

```bash
npm run test:integration -- --coverage
```

**å‡ºåŠ›ä¾‹:**

```
File                              | % Stmts | % Branch | % Funcs | % Lines
----------------------------------|---------|----------|---------|----------
All files                         |   82.45 |    75.32 |   85.71 |   82.18
 src/app/api/posts                |   95.24 |    90.00 |     100 |   95.00
  route.ts                        |   95.24 |    90.00 |     100 |   95.00
 src/app/api/posts/[id]           |   88.89 |    80.00 |   91.67 |   88.46
  route.ts                        |   88.89 |    80.00 |   91.67 |   88.46
 src/app/api/posts/[id]/like      |   91.30 |    85.00 |     100 |   91.30
  route.ts                        |   91.30 |    85.00 |     100 |   91.30
 src/app/posts                    |   85.71 |    75.00 |   88.89 |   85.00
  actions.ts                      |   85.71 |    75.00 |   88.89 |   85.00
 src/lib                          |   78.26 |    68.75 |   82.35 |   77.78
  post-service.ts                 |   78.26 |    68.75 |   82.35 |   77.78
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨ï¼š

âœ… **çµåˆãƒ†ã‚¹ãƒˆã®åŸºæœ¬** - è¤‡æ•°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é€£æºãƒ†ã‚¹ãƒˆ
âœ… **API Routes ã®ãƒ†ã‚¹ãƒˆ** - GET, POST, PATCH, DELETE
âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ** - Prismaã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
âœ… **Server Actions ã®ãƒ†ã‚¹ãƒˆ** - FormDataã€revalidatePath
âœ… **èªè¨¼ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ** - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€æ¨©é™ãƒã‚§ãƒƒã‚¯
âœ… **è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€£æºãƒ†ã‚¹ãƒˆ** - Server Components
âœ… **ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä½œæˆ** - resetDatabase, seedDatabase
âœ… **ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèª** - çµåˆãƒ†ã‚¹ãƒˆã®ã‚«ãƒãƒ¬ãƒƒã‚¸

**æ¬¡ã®ç« ã§ã¯ã€E2Eãƒ†ã‚¹ãƒˆï¼ˆEnd-to-End Testï¼‰ã‚’å­¦ã³ã¾ã™ã€‚**

---

[â† å‰ã®ç« ï¼šç¬¬26ç«  å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿè£…](26-å˜ä½“ãƒ†ã‚¹ãƒˆã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬28ç«  E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£… â†’](28-E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£….md)
