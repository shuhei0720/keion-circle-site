# ç¬¬34ç« ï¼šä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã“ã®ç« ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨ä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ–¹æ³•ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

## 34.1 ãƒ­ã‚°ç®¡ç†

### æ§‹é€ åŒ–ãƒ­ã‚°

```typescript
// lib/logger.ts
type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogEntry {
  level: LogLevel;
  message: string;
  timestamp: string;
  context?: Record<string, any>;
  userId?: string;
  requestId?: string;
}

class Logger {
  private isDevelopment = process.env.NODE_ENV === 'development';
  
  private log(level: LogLevel, message: string, context?: Record<string, any>) {
    const entry: LogEntry = {
      level,
      message,
      timestamp: new Date().toISOString(),
      context,
    };
    
    if (this.isDevelopment) {
      // é–‹ç™ºç’°å¢ƒã§ã¯èª­ã¿ã‚„ã™ãå‡ºåŠ›
      console[level === 'debug' ? 'log' : level](
        `[${entry.timestamp}] ${level.toUpperCase()}: ${message}`,
        context || ''
      );
    } else {
      // æœ¬ç•ªç’°å¢ƒã§ã¯JSONå½¢å¼ã§å‡ºåŠ›
      console.log(JSON.stringify(entry));
    }
  }
  
  debug(message: string, context?: Record<string, any>) {
    if (this.isDevelopment) {
      this.log('debug', message, context);
    }
  }
  
  info(message: string, context?: Record<string, any>) {
    this.log('info', message, context);
  }
  
  warn(message: string, context?: Record<string, any>) {
    this.log('warn', message, context);
  }
  
  error(message: string, error?: Error, context?: Record<string, any>) {
    this.log('error', message, {
      ...context,
      error: error ? {
        message: error.message,
        stack: error.stack,
        name: error.name,
      } : undefined,
    });
  }
}

export const logger = new Logger();

// ä½¿ç”¨ä¾‹
logger.info('User logged in', { userId: '123', email: 'user@example.com' });
logger.error('Failed to create post', new Error('Database error'), { userId: '123' });
```

### API ãƒ«ãƒ¼ãƒˆã§ã®ãƒ­ã‚°è¨˜éŒ²

```typescript
// app/api/posts/route.ts
import { logger } from '@/lib/logger';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const requestId = crypto.randomUUID();
  
  try {
    logger.info('Creating new post', { requestId });
    
    const data = await request.json();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.title || !data.content) {
      logger.warn('Invalid post data', { requestId, data });
      return NextResponse.json(
        { error: 'Title and content are required' },
        { status: 400 }
      );
    }
    
    // æŠ•ç¨¿ä½œæˆ
    const post = await prisma.post.create({ data });
    
    logger.info('Post created successfully', {
      requestId,
      postId: post.id,
      userId: post.authorId,
    });
    
    return NextResponse.json(post);
  } catch (error) {
    logger.error('Failed to create post', error as Error, { requestId });
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

---

## 34.2 ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ï¼ˆSentryï¼‰

### Sentryã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
npm install @sentry/nextjs
```

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  
  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
  tracesSampleRate: 1.0,
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªãƒ—ãƒ¬ã‚¤
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
  
  // ç’°å¢ƒ
  environment: process.env.NODE_ENV,
  
  // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  beforeSend(event, hint) {
    // ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã‚’é™¤å¤–
    if (event.exception) {
      const error = hint.originalException;
      if (error && typeof error === 'object' && 'message' in error) {
        const message = (error as Error).message;
        if (message.includes('ResizeObserver')) {
          return null; // ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ã—ãªã„
        }
      }
    }
    return event;
  },
});

// sentry.server.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
});
```

### ã‚¨ãƒ©ãƒ¼ã®æ‰‹å‹•å ±å‘Š

```typescript
// lib/error-reporter.ts
import * as Sentry from '@sentry/nextjs';

export function reportError(error: Error, context?: Record<string, any>) {
  if (process.env.NODE_ENV === 'production') {
    Sentry.captureException(error, {
      extra: context,
    });
  } else {
    console.error('Error:', error, context);
  }
}

export function setUserContext(user: { id: string; email: string; name: string }) {
  Sentry.setUser({
    id: user.id,
    email: user.email,
    username: user.name,
  });
}

// ä½¿ç”¨ä¾‹
try {
  await createPost(data);
} catch (error) {
  reportError(error as Error, {
    action: 'create_post',
    userId: session.user.id,
    data,
  });
  throw error;
}
```

---

## 34.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹

```typescript
// lib/metrics.ts
interface Metric {
  name: string;
  value: number;
  unit: string;
  timestamp: number;
  tags?: Record<string, string>;
}

class MetricsCollector {
  private metrics: Metric[] = [];
  
  record(name: string, value: number, unit = 'ms', tags?: Record<string, string>) {
    this.metrics.push({
      name,
      value,
      unit,
      timestamp: Date.now(),
      tags,
    });
    
    // å®šæœŸçš„ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡
    if (this.metrics.length >= 100) {
      this.flush();
    }
  }
  
  async flush() {
    if (this.metrics.length === 0) return;
    
    const metricsToSend = [...this.metrics];
    this.metrics = [];
    
    try {
      await fetch('/api/metrics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ metrics: metricsToSend }),
      });
    } catch (error) {
      console.error('Failed to send metrics:', error);
    }
  }
  
  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨ˆæ¸¬
  time<T>(name: string, fn: () => T | Promise<T>): Promise<T> {
    const start = performance.now();
    
    const finish = (result: T) => {
      const duration = performance.now() - start;
      this.record(name, duration, 'ms');
      return result;
    };
    
    try {
      const result = fn();
      if (result instanceof Promise) {
        return result.then(finish);
      }
      return Promise.resolve(finish(result));
    } catch (error) {
      const duration = performance.now() - start;
      this.record(name, duration, 'ms', { error: 'true' });
      throw error;
    }
  }
}

export const metrics = new MetricsCollector();

// ä½¿ç”¨ä¾‹
const posts = await metrics.time('fetch_posts', async () => {
  return prisma.post.findMany();
});
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®ç›£è¦–

```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client';
import { logger } from './logger';

const prismaClientSingleton = () => {
  const client = new PrismaClient({
    log: [
      { level: 'query', emit: 'event' },
      { level: 'error', emit: 'event' },
      { level: 'warn', emit: 'event' },
    ],
  });
  
  // ã‚¯ã‚¨ãƒªãƒ­ã‚°
  client.$on('query', (e) => {
    if (e.duration > 1000) {
      // 1ç§’ä»¥ä¸Šã‹ã‹ã‚‹ã‚¯ã‚¨ãƒªã‚’è­¦å‘Š
      logger.warn('Slow query detected', {
        query: e.query,
        duration: e.duration,
        params: e.params,
      });
    } else {
      logger.debug('Query executed', {
        query: e.query,
        duration: e.duration,
      });
    }
  });
  
  // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
  client.$on('error', (e) => {
    logger.error('Database error', new Error(e.message), {
      target: e.target,
    });
  });
  
  return client;
};

declare global {
  var prisma: undefined | ReturnType<typeof prismaClientSingleton>;
}

export const prisma = globalThis.prisma ?? prismaClientSingleton();

if (process.env.NODE_ENV !== 'production') {
  globalThis.prisma = prisma;
}
```

---

## 34.4 ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã¨æ‰‹æ³•

### React Developer Tools

```typescript
// é–‹ç™ºç’°å¢ƒå°‚ç”¨ã®ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
'use client';

import { useEffect } from 'react';

export function DebugPanel() {
  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒãƒƒã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      (window as any).__DEBUG__ = {
        clearCache: async () => {
          await fetch('/api/cache/clear', { method: 'POST' });
          console.log('Cache cleared');
        },
        logState: () => {
          console.log('Current state:', (window as any).__STATE__);
        },
      };
      
      console.log('Debug tools available at window.__DEBUG__');
    }
  }, []);
  
  if (process.env.NODE_ENV !== 'development') {
    return null;
  }
  
  return (
    <div className="fixed bottom-4 right-4 bg-black text-white p-4 rounded-lg text-xs">
      <div className="font-bold mb-2">Debug Panel</div>
      <div>Environment: {process.env.NODE_ENV}</div>
      <div>Next.js: {process.env.NEXT_PUBLIC_VERSION}</div>
    </div>
  );
}
```

### ãƒ‡ãƒãƒƒã‚°ç”¨ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const start = Date.now();
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
  const response = NextResponse.next();
  
  if (process.env.NODE_ENV === 'development') {
    const duration = Date.now() - start;
    response.headers.set('X-Response-Time', `${duration}ms`);
    response.headers.set('X-Request-ID', crypto.randomUUID());
  }
  
  return response;
}
```

---

## 34.5 ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•

### èªè¨¼ã‚¨ãƒ©ãƒ¼

```typescript
// ã‚ˆãã‚ã‚‹NextAuth.jsã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦

// ã‚¨ãƒ©ãƒ¼1: "Callback URL not allowed"
// è§£æ±ºç­–: NEXTAUTH_URLç’°å¢ƒå¤‰æ•°ã‚’æ­£ã—ãè¨­å®š
// .env.local
AUTH_URL=http://localhost:3000
# æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¤‰æ›´

// ã‚¨ãƒ©ãƒ¼2: "Session token expired"
// è§£æ±ºç­–: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’å»¶é•·
// auth.config.ts
export const authConfig = {
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30æ—¥
  },
};

// ã‚¨ãƒ©ãƒ¼3: "Database connection failed"
// è§£æ±ºç­–: DATABASE_URLã‚’ç¢ºèªã—ã€Prisma Clientã‚’å†ç”Ÿæˆ
// Terminal:
// export DATABASE_URL="file:./dev.db"
// npx prisma generate
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

```typescript
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
import { Prisma } from '@prisma/client';

async function handleDatabaseOperation<T>(
  operation: () => Promise<T>
): Promise<{ data?: T; error?: string }> {
  try {
    const data = await operation();
    return { data };
  } catch (error) {
    if (error instanceof Prisma.PrismaClientKnownRequestError) {
      // P2002: Unique constraint violation
      if (error.code === 'P2002') {
        return { error: 'ã“ã®å€¤ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™' };
      }
      
      // P2025: Record not found
      if (error.code === 'P2025') {
        return { error: 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
      }
      
      // P2003: Foreign key constraint violation
      if (error.code === 'P2003') {
        return { error: 'é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™' };
      }
    }
    
    if (error instanceof Prisma.PrismaClientValidationError) {
      return { error: 'ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
    }
    
    return { error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' };
  }
}

// ä½¿ç”¨ä¾‹
const result = await handleDatabaseOperation(() =>
  prisma.user.create({
    data: { email: 'user@example.com', name: 'User' },
  })
);

if (result.error) {
  return NextResponse.json({ error: result.error }, { status: 400 });
}

return NextResponse.json(result.data);
```

### ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼

```typescript
// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
export async function uploadImage(file: File) {
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
  const MAX_SIZE = 5 * 1024 * 1024; // 5MB
  if (file.size > MAX_SIZE) {
    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
  }
  
  // MIME typeãƒã‚§ãƒƒã‚¯
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    throw new Error('JPEGã€PNGã€GIFã€WebPå½¢å¼ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™');
  }
  
  // ç”»åƒã®æ¤œè¨¼ï¼ˆç ´æãƒã‚§ãƒƒã‚¯ï¼‰
  try {
    await validateImageFile(file);
  } catch (error) {
    throw new Error('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã¾ã™');
  }
  
  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
    return response.json();
  } catch (error) {
    if (error instanceof TypeError && error.message.includes('fetch')) {
      throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
    throw error;
  }
}

async function validateImageFile(file: File): Promise<void> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve();
    img.onerror = () => reject(new Error('Invalid image'));
    img.src = URL.createObjectURL(file);
  });
}
```

---

## 34.6 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# scripts/backup-db.sh

BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
DB_FILE="./prisma/dev.db"
BACKUP_FILE="$BACKUP_DIR/db_backup_$TIMESTAMP.db"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p $BACKUP_DIR

# SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
if [ -f "$DB_FILE" ]; then
  cp "$DB_FILE" "$BACKUP_FILE"
  echo "Backup created: $BACKUP_FILE"
  
  # åœ§ç¸®
  gzip "$BACKUP_FILE"
  echo "Backup compressed: ${BACKUP_FILE}.gz"
  
  # å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰
  find $BACKUP_DIR -name "*.gz" -mtime +30 -delete
  echo "Old backups cleaned up"
else
  echo "Database file not found: $DB_FILE"
  exit 1
fi
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```typescript
// scripts/cleanup-db.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function cleanup() {
  console.log('Starting database cleanup...');
  
  // 1. å¤ã„é€šçŸ¥ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå‰ï¼‰
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const deletedNotifications = await prisma.notification.deleteMany({
    where: {
      createdAt: { lt: thirtyDaysAgo },
      read: true,
    },
  });
  console.log(`Deleted ${deletedNotifications.count} old notifications`);
  
  // 2. å­¤ç«‹ã—ãŸç”»åƒãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
  const orphanedImages = await prisma.image.findMany({
    where: {
      postId: null,
    },
  });
  
  for (const image of orphanedImages) {
    // Supabaseã‹ã‚‰ç”»åƒã‚’å‰Šé™¤
    await deleteImageFromStorage(image.url);
    await prisma.image.delete({ where: { id: image.id } });
  }
  console.log(`Deleted ${orphanedImages.length} orphaned images`);
  
  // 3. å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  const deletedUsers = await prisma.user.findMany({
    where: { deletedAt: { not: null } },
  });
  
  for (const user of deletedUsers) {
    const thirtyDaysAfterDeletion = new Date(user.deletedAt!);
    thirtyDaysAfterDeletion.setDate(thirtyDaysAfterDeletion.getDate() + 30);
    
    if (new Date() > thirtyDaysAfterDeletion) {
      // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      await prisma.post.deleteMany({ where: { authorId: user.id } });
      await prisma.comment.deleteMany({ where: { authorId: user.id } });
      await prisma.user.delete({ where: { id: user.id } });
      console.log(`Permanently deleted user: ${user.email}`);
    }
  }
  
  console.log('Database cleanup completed');
}

cleanup()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

```typescript
// scripts/optimize-db.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function optimize() {
  console.log('Optimizing database...');
  
  // SQLiteã®å ´åˆ
  if (process.env.DATABASE_URL?.includes('file:')) {
    // VACUUM: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å†æ§‹ç¯‰ã—ã¦æ–­ç‰‡åŒ–ã‚’è§£æ¶ˆ
    await prisma.$executeRawUnsafe('VACUUM');
    console.log('VACUUM completed');
    
    // ANALYZE: ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    await prisma.$executeRawUnsafe('ANALYZE');
    console.log('ANALYZE completed');
  }
  
  // PostgreSQLã®å ´åˆ
  if (process.env.DATABASE_URL?.includes('postgresql')) {
    await prisma.$executeRawUnsafe('VACUUM ANALYZE');
    console.log('VACUUM ANALYZE completed');
  }
  
  console.log('Database optimization completed');
}

optimize()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

---

## 34.7 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

### ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯

```bash
# npm audit
npm audit

# è‡ªå‹•ä¿®æ­£
npm audit fix

# å¼·åˆ¶ä¿®æ­£ï¼ˆç ´å£Šçš„å¤‰æ›´ã‚’å«ã‚€ï¼‰
npm audit fix --force

# è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
npm audit --json > audit-report.json
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯

```typescript
// scripts/check-security-headers.ts
async function checkSecurityHeaders(url: string) {
  const response = await fetch(url);
  
  const requiredHeaders = {
    'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
    'X-Content-Type-Options': 'nosniff',
    'X-Frame-Options': 'DENY',
    'Content-Security-Policy': true, // å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    'Permissions-Policy': true,
  };
  
  console.log('Security Headers Check:');
  console.log('='.repeat(50));
  
  for (const [header, expectedValue] of Object.entries(requiredHeaders)) {
    const actualValue = response.headers.get(header);
    
    if (!actualValue) {
      console.log(`âŒ ${header}: Missing`);
    } else if (expectedValue === true) {
      console.log(`âœ… ${header}: ${actualValue}`);
    } else if (actualValue === expectedValue) {
      console.log(`âœ… ${header}: ${actualValue}`);
    } else {
      console.log(`âš ï¸  ${header}: ${actualValue} (Expected: ${expectedValue})`);
    }
  }
}

// ä½¿ç”¨ä¾‹
checkSecurityHeaders('https://your-app.vercel.app');
```

### ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼

```typescript
// lib/validate-env.ts
import { z } from 'zod';

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']),
  DATABASE_URL: z.string().url(),
  AUTH_SECRET: z.string().min(32),
  AUTH_URL: z.string().url(),
  GOOGLE_CLIENT_ID: z.string().optional(),
  GOOGLE_CLIENT_SECRET: z.string().optional(),
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string(),
});

export function validateEnv() {
  try {
    envSchema.parse(process.env);
    console.log('âœ… Environment variables are valid');
  } catch (error) {
    console.error('âŒ Invalid environment variables:');
    if (error instanceof z.ZodError) {
      error.errors.forEach((err) => {
        console.error(`  - ${err.path.join('.')}: ${err.message}`);
      });
    }
    process.exit(1);
  }
}

// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å®Ÿè¡Œ
if (process.env.NODE_ENV === 'production') {
  validateEnv();
}
```

---

## 34.8 ä¾å­˜é–¢ä¿‚ã®æ›´æ–°

### å®‰å…¨ãªæ›´æ–°æ‰‹é †

```bash
# 1. ç¾åœ¨ã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª
npm list --depth=0

# 2. å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç¢ºèª
npm outdated

# 3. ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿æ›´æ–°ï¼ˆå®‰å…¨ï¼‰
npm update

# 4. ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§æ›´æ–°
npx npm-check-updates -u --target minor
npm install

# 5. ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ï¼ˆæ³¨æ„ãŒå¿…è¦ï¼‰
npx npm-check-updates -u
npm install

# 6. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test
npm run build

# 7. å‹•ä½œç¢ºèª
npm run dev
```

### æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```typescript
// scripts/update-check.ts
import { execSync } from 'child_process';
import * as fs from 'fs';

interface PackageUpdate {
  name: string;
  current: string;
  wanted: string;
  latest: string;
  type: 'patch' | 'minor' | 'major';
}

function checkUpdates(): PackageUpdate[] {
  const output = execSync('npm outdated --json', {
    encoding: 'utf-8',
    stdio: ['pipe', 'pipe', 'ignore'],
  });
  
  if (!output) return [];
  
  const outdated = JSON.parse(output);
  const updates: PackageUpdate[] = [];
  
  for (const [name, info] of Object.entries(outdated)) {
    const current = (info as any).current;
    const wanted = (info as any).wanted;
    const latest = (info as any).latest;
    
    let type: 'patch' | 'minor' | 'major' = 'patch';
    
    if (current && latest) {
      const [currMajor] = current.split('.');
      const [latestMajor] = latest.split('.');
      
      if (currMajor !== latestMajor) {
        type = 'major';
      } else if (current !== wanted) {
        type = 'minor';
      }
    }
    
    updates.push({ name, current, wanted, latest, type });
  }
  
  return updates;
}

function generateUpdateReport() {
  const updates = checkUpdates();
  
  console.log('ğŸ“¦ Dependency Update Report');
  console.log('='.repeat(60));
  
  const byType = {
    major: updates.filter((u) => u.type === 'major'),
    minor: updates.filter((u) => u.type === 'minor'),
    patch: updates.filter((u) => u.type === 'patch'),
  };
  
  if (byType.major.length > 0) {
    console.log('\nğŸ”´ Major Updates (Breaking Changes Possible):');
    byType.major.forEach((u) => {
      console.log(`  ${u.name}: ${u.current} â†’ ${u.latest}`);
    });
  }
  
  if (byType.minor.length > 0) {
    console.log('\nğŸŸ¡ Minor Updates (New Features):');
    byType.minor.forEach((u) => {
      console.log(`  ${u.name}: ${u.current} â†’ ${u.latest}`);
    });
  }
  
  if (byType.patch.length > 0) {
    console.log('\nğŸŸ¢ Patch Updates (Bug Fixes):');
    byType.patch.forEach((u) => {
      console.log(`  ${u.name}: ${u.current} â†’ ${u.latest}`);
    });
  }
  
  if (updates.length === 0) {
    console.log('\nâœ… All dependencies are up to date!');
  }
}

generateUpdateReport();
```

---

## 34.9 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ãªã„

```bash
# 1. Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node --version  # 18.xä»¥ä¸ŠãŒå¿…è¦

# 2. ä¾å­˜é–¢ä¿‚ã®å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
rm -rf node_modules package-lock.json
npm install

# 3. ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
rm -rf .next

# 4. ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
cat .env.local

# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ç¢ºèª
npx prisma db push

# 6. ãƒãƒ¼ãƒˆã®ç«¶åˆã‚’ç¢ºèª
lsof -i :3000
# ä½¿ç”¨ä¸­ã®å ´åˆã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
kill -9 <PID>
```

### ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼

```bash
# 1. TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
npx tsc --noEmit

# 2. ESLintã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
npm run lint

# 3. å‹å®šç¾©ã‚’å†ç”Ÿæˆ
npx prisma generate

# 4. Next.jsã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
rm -rf .next

# 5. ä¾å­˜é–¢ä¿‚ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
npm ci
```

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

```bash
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ç¢ºèª
export DATABASE_URL="file:./dev.db"
npx prisma studio

# 2. ã‚¹ã‚­ãƒ¼ãƒã‚’ç¢ºèª
npx prisma validate

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
npx prisma migrate reset

# 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åŒæœŸ
npx prisma db push

# 5. ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
npx prisma studio
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ

```typescript
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«
export function PerformanceDiagnostics() {
  useEffect(() => {
    if (process.env.NODE_ENV === 'development') {
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const renderCount = useRef(0);
      renderCount.current++;
      console.log(`Render count: ${renderCount.current}`);
      
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚é–“ã‚’è¨ˆæ¸¬
      const startTime = performance.now();
      return () => {
        const endTime = performance.now();
        console.log(`Render time: ${endTime - startTime}ms`);
      };
    }
  });
  
  return null;
}
```

---

## 34.10 ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```typescript
// app/api/health/route.ts
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET() {
  const checks = {
    database: false,
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
  };
  
  try {
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒã‚§ãƒƒã‚¯
    await prisma.$queryRaw`SELECT 1`;
    checks.database = true;
  } catch (error) {
    console.error('Database health check failed:', error);
  }
  
  const isHealthy = checks.database;
  
  return NextResponse.json(
    {
      status: isHealthy ? 'healthy' : 'unhealthy',
      checks,
    },
    { status: isHealthy ? 200 : 503 }
  );
}
```

### ç›£è¦–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```typescript
// scripts/monitor.ts
async function monitor() {
  const HEALTH_CHECK_URL = process.env.HEALTH_CHECK_URL || 'http://localhost:3000/api/health';
  const CHECK_INTERVAL = 60000; // 1åˆ†
  
  while (true) {
    try {
      const response = await fetch(HEALTH_CHECK_URL);
      const data = await response.json();
      
      if (data.status !== 'healthy') {
        console.error('âŒ Health check failed:', data);
        // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼ˆä¾‹: Slackã€ãƒ¡ãƒ¼ãƒ«ï¼‰
        await sendAlert('Application is unhealthy', data);
      } else {
        console.log('âœ… Health check passed');
      }
    } catch (error) {
      console.error('âŒ Health check error:', error);
      await sendAlert('Health check failed', { error: String(error) });
    }
    
    await new Promise((resolve) => setTimeout(resolve, CHECK_INTERVAL));
  }
}

async function sendAlert(message: string, details: any) {
  // Slacké€šçŸ¥ã®ä¾‹
  if (process.env.SLACK_WEBHOOK_URL) {
    await fetch(process.env.SLACK_WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: `ğŸš¨ ${message}`,
        attachments: [
          {
            color: 'danger',
            text: JSON.stringify(details, null, 2),
          },
        ],
      }),
    });
  }
}

monitor();
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨ä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ãƒ­ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- âœ… **æ§‹é€ åŒ–ãƒ­ã‚°**: JSONå½¢å¼ã§ã®ä¸€è²«ã—ãŸãƒ­ã‚°è¨˜éŒ²
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°**: Sentryã§ã®ã‚¨ãƒ©ãƒ¼ç›£è¦–
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ç›£è¦–

### ãƒ‡ãƒãƒƒã‚°
- âœ… **é–‹ç™ºãƒ„ãƒ¼ãƒ«**: React DevToolsã€ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«
- âœ… **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¿½è·¡
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### ã‚ˆãã‚ã‚‹å•é¡Œ
- âœ… **èªè¨¼ã‚¨ãƒ©ãƒ¼**: NextAuth.jsã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Prismaã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦
- âœ… **ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã¨ã‚¨ãƒ©ãƒ¼å‡¦ç†

### ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- âœ… **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- âœ… **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
- âœ… **æœ€é©åŒ–**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æœ€é©åŒ–
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»**: è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯

### ä¾å­˜é–¢ä¿‚ç®¡ç†
- âœ… **æ›´æ–°æ‰‹é †**: å®‰å…¨ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°
- âœ… **è„†å¼±æ€§**: npm auditã§ã®ãƒã‚§ãƒƒã‚¯
- âœ… **è‡ªå‹•åŒ–**: æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ

### ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
- âœ… **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: ã‚·ã‚¹ãƒ†ãƒ ã®å¥å…¨æ€§ç›£è¦–
- âœ… **ã‚¢ãƒ©ãƒ¼ãƒˆ**: å•é¡Œç™ºç”Ÿæ™‚ã®é€šçŸ¥
- âœ… **ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

### å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ
- âœ… **ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–**: å•é¡ŒãŒèµ·ãã‚‹å‰ã«æ¤œçŸ¥
- âœ… **è‡ªå‹•åŒ–**: å®šæœŸçš„ãªãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¿ã‚¹ã‚¯
- âœ… **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ‰‹é †ã®æ–‡æ›¸åŒ–
- âœ… **ç›£è¦–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

æ¬¡ã®ç« ã§ã¯ã€**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬33ç«  é«˜åº¦ãªæ©Ÿèƒ½å®Ÿè£…](33-é«˜åº¦ãªæ©Ÿèƒ½å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬35ç«  ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ â†’](35-ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹.md)
