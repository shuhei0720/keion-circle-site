# ç¬¬30ç« ï¼šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

ã“ã®ç« ã§ã¯ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚

## 30.1 ç”»åƒæœ€é©åŒ–

### next/imageã®æ´»ç”¨

```typescript
// components/OptimizedImage.tsx
import Image from 'next/image';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  priority?: boolean;
  className?: string;
}

export function OptimizedImage({
  src,
  alt,
  width = 800,
  height = 600,
  priority = false,
  className,
}: OptimizedImageProps) {
  return (
    <Image
      src={src}
      alt={alt}
      width={width}
      height={height}
      priority={priority}
      className={className}
      sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      quality={85}
      placeholder="blur"
      blurDataURL="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
    />
  );
}

// ã‚¢ãƒã‚¿ãƒ¼ç”»åƒå°‚ç”¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export function Avatar({ src, alt, size = 40 }: {
  src?: string | null;
  alt: string;
  size?: number;
}) {
  return (
    <div
      className="relative rounded-full overflow-hidden bg-gray-200"
      style={{ width: size, height: size }}
    >
      {src ? (
        <Image
          src={src}
          alt={alt}
          width={size}
          height={size}
          className="object-cover"
        />
      ) : (
        <div className="flex items-center justify-center h-full text-gray-500">
          {alt.charAt(0).toUpperCase()}
        </div>
      )}
    </div>
  );
}
```

### next.config.jsã®ç”»åƒè¨­å®š

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    // ãƒªãƒ¢ãƒ¼ãƒˆç”»åƒã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨±å¯
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        pathname: '/storage/v1/object/**',
      },
      {
        protocol: 'https',
        hostname: 'lh3.googleusercontent.com',
      },
    ],
    // ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆWebPå„ªå…ˆï¼‰
    formats: ['image/webp', 'image/avif'],
    // ãƒ‡ãƒã‚¤ã‚¹ã‚µã‚¤ã‚º
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    // ç”»åƒã‚µã‚¤ã‚º
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    // æœ€å°ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLï¼ˆç§’ï¼‰
    minimumCacheTTL: 60 * 60 * 24 * 30, // 30æ—¥
  },
};

module.exports = nextConfig;
```

### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒ

```typescript
// components/ResponsiveImage.tsx
import Image from 'next/image';

interface ResponsiveImageProps {
  src: string;
  alt: string;
  aspectRatio?: '16/9' | '4/3' | '1/1';
  priority?: boolean;
}

export function ResponsiveImage({
  src,
  alt,
  aspectRatio = '16/9',
  priority = false,
}: ResponsiveImageProps) {
  const ratios = {
    '16/9': 'aspect-[16/9]',
    '4/3': 'aspect-[4/3]',
    '1/1': 'aspect-square',
  };
  
  return (
    <div className={`relative w-full ${ratios[aspectRatio]}`}>
      <Image
        src={src}
        alt={alt}
        fill
        priority={priority}
        className="object-cover"
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      />
    </div>
  );
}
```

---

## 30.2 ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã¨ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

### ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```typescript
// app/posts/[id]/page.tsx
import dynamic from 'next/dynamic';
import { Suspense } from 'react';

// YouTubeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆSSRç„¡åŠ¹ï¼‰
const YouTubeEmbed = dynamic(
  () => import('@/components/YouTubeEmbed'),
  {
    ssr: false,
    loading: () => (
      <div className="flex items-center justify-center h-64 bg-gray-100">
        <p>å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    ),
  }
);

// ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const CommentSection = dynamic(
  () => import('@/components/CommentSection'),
  {
    loading: () => <div className="animate-pulse h-64 bg-gray-100" />,
  }
);

export default async function PostDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const post = await getPost(params.id);
  
  return (
    <div>
      <h1>{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: post.content }} />
      
      {/* YouTubeå‹•ç”»ã¯é…å»¶èª­ã¿è¾¼ã¿ */}
      <Suspense fallback={<div>å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>}>
        {post.youtubeUrls?.map((url) => (
          <YouTubeEmbed key={url} url={url} />
        ))}
      </Suspense>
      
      {/* ã‚³ãƒ¡ãƒ³ãƒˆã‚‚é…å»¶èª­ã¿è¾¼ã¿ */}
      <Suspense fallback={<div>ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>}>
        <CommentSection postId={post.id} />
      </Suspense>
    </div>
  );
}
```

### æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```typescript
// components/AdminPanel.tsx
'use client';

import { useState } from 'react';
import dynamic from 'next/dynamic';

// ç®¡ç†è€…ãƒ‘ãƒãƒ«ã¯å¿…è¦ãªæ™‚ã ã‘ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const AdminDashboard = dynamic(() => import('./AdminDashboard'), {
  loading: () => <div>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>,
});

export function AdminPanel({ isAdmin }: { isAdmin: boolean }) {
  const [showDashboard, setShowDashboard] = useState(false);
  
  if (!isAdmin) {
    return null;
  }
  
  return (
    <div>
      <button onClick={() => setShowDashboard(!showDashboard)}>
        {showDashboard ? 'é–‰ã˜ã‚‹' : 'ç®¡ç†ç”»é¢ã‚’é–‹ã'}
      </button>
      
      {showDashboard && <AdminDashboard />}
    </div>
  );
}
```

---

## 30.3 ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

### ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
// app/posts/page.tsx
import { cache } from 'react';
import { prisma } from '@/lib/prisma';

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸé–¢æ•°
const getPosts = cache(async () => {
  return prisma.post.findMany({
    where: { published: true },
    include: {
      author: {
        select: {
          id: true,
          name: true,
          image: true,
        },
      },
    },
    orderBy: { createdAt: 'desc' },
  });
});

export default async function PostsPage() {
  const posts = await getPosts();
  
  return (
    <div>
      {posts.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}
    </div>
  );
}
```

### Fetchã‚­ãƒ£ãƒƒã‚·ãƒ¥

```typescript
// è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
async function getData() {
  const res = await fetch('https://api.example.com/data', {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: { cache: 'force-cache' }
  });
  return res.json();
}

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
async function getRealtimeData() {
  const res = await fetch('https://api.example.com/realtime', {
    cache: 'no-store',
  });
  return res.json();
}

// æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®å†æ¤œè¨¼
async function getDataWithRevalidation() {
  const res = await fetch('https://api.example.com/data', {
    next: { revalidate: 3600 }, // 1æ™‚é–“ã”ã¨ã«å†æ¤œè¨¼
  });
  return res.json();
}
```

### ãƒ«ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š

```typescript
// app/posts/[id]/page.tsx
export const revalidate = 3600; // 1æ™‚é–“ã”ã¨ã«å†ç”Ÿæˆ
export const dynamic = 'force-static'; // é™çš„ç”Ÿæˆã‚’å¼·åˆ¶

// ã¾ãŸã¯å‹•çš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// export const dynamic = 'force-dynamic';

export default async function PostPage({
  params,
}: {
  params: { id: string };
}) {
  const post = await getPost(params.id);
  
  return <div>{/* ... */}</div>;
}
```

---

## 30.4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–

### N+1å•é¡Œã®è§£æ±º

```typescript
// âŒ éåŠ¹ç‡: N+1ã‚¯ã‚¨ãƒª
async function getPostsWithAuthorsBad() {
  const posts = await prisma.post.findMany();
  
  // å„æŠ•ç¨¿ã”ã¨ã«ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹
  const postsWithAuthors = await Promise.all(
    posts.map(async (post) => ({
      ...post,
      author: await prisma.user.findUnique({
        where: { id: post.authorId },
      }),
    }))
  );
  
  return postsWithAuthors;
}

// âœ… åŠ¹ç‡çš„: includeã§ä¸€åº¦ã«å–å¾—
async function getPostsWithAuthorsGood() {
  return prisma.post.findMany({
    include: {
      author: {
        select: {
          id: true,
          name: true,
          image: true,
        },
      },
    },
  });
}
```

### ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–

```typescript
// âŒ éåŠ¹ç‡: skipã¨takeã‚’ä½¿ç”¨
async function getPaginatedPostsBad(page: number, perPage: number) {
  return prisma.post.findMany({
    skip: (page - 1) * perPage,
    take: perPage,
    orderBy: { createdAt: 'desc' },
  });
}

// âœ… åŠ¹ç‡çš„: ã‚«ãƒ¼ã‚½ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
async function getPaginatedPostsGood(cursor?: string, take: number = 20) {
  return prisma.post.findMany({
    take,
    ...(cursor && {
      skip: 1,
      cursor: {
        id: cursor,
      },
    }),
    orderBy: { createdAt: 'desc' },
  });
}
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ´»ç”¨

```prisma
// prisma/schema.prisma
model Post {
  id          String   @id @default(cuid())
  title       String
  content     String
  authorId    String
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  author      User     @relation(fields: [authorId], references: [id])
  
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©
  @@index([authorId])
  @@index([published, createdAt])
  @@index([createdAt(sort: Desc)])
}

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String?
  role     String  @default("member")
  
  // è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  @@index([email, role])
}
```

### éƒ¨åˆ†çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—

```typescript
// âœ… å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
async function getPostSummaries() {
  return prisma.post.findMany({
    select: {
      id: true,
      title: true,
      createdAt: true,
      author: {
        select: {
          name: true,
          image: true,
        },
      },
    },
  });
}
```

---

## 30.5 ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®å‰Šæ¸›

### Tree Shakingã®æ´»ç”¨

```typescript
// âŒ æ‚ªã„ä¾‹: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¨ä½“ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import _ from 'lodash';
import * as dateFns from 'date-fns';

// âœ… è‰¯ã„ä¾‹: å¿…è¦ãªé–¢æ•°ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import debounce from 'lodash/debounce';
import { format, parseISO } from 'date-fns';
```

### ãƒãƒ³ãƒ‰ãƒ«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼

```bash
# ãƒãƒ³ãƒ‰ãƒ«ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install -D @next/bundle-analyzer

# next.config.jsã«è¿½åŠ 
```

```javascript
// next.config.js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

module.exports = withBundleAnalyzer({
  // æ—¢å­˜ã®è¨­å®š
});
```

```bash
# ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æ
ANALYZE=true npm run build
```

### å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€é©åŒ–

```typescript
// app/layout.tsx
import Script from 'next/script';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <body>
        {children}
        
        {/* å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é…å»¶èª­ã¿è¾¼ã¿ */}
        <Script
          src="https://www.googletagmanager.com/gtag/js?id=GA_ID"
          strategy="afterInteractive"
        />
        
        <Script id="google-analytics" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'GA_ID');
          `}
        </Script>
      </body>
    </html>
  );
}
```

---

## 30.6 ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥

### é™çš„ç”Ÿæˆï¼ˆSSGï¼‰

```typescript
// app/posts/[id]/page.tsx

// é™çš„ãƒ‘ã‚¹ã®ç”Ÿæˆ
export async function generateStaticParams() {
  const posts = await prisma.post.findMany({
    where: { published: true },
    select: { id: true },
  });
  
  return posts.map((post) => ({
    id: post.id,
  }));
}

// ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export default async function PostPage({
  params,
}: {
  params: { id: string };
}) {
  const post = await prisma.post.findUnique({
    where: { id: params.id },
  });
  
  if (!post) {
    notFound();
  }
  
  return <div>{/* ... */}</div>;
}
```

### ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«é™çš„å†ç”Ÿæˆï¼ˆISRï¼‰

```typescript
// app/posts/page.tsx
export const revalidate = 60; // 60ç§’ã”ã¨ã«å†ç”Ÿæˆ

export default async function PostsPage() {
  const posts = await prisma.post.findMany({
    where: { published: true },
  });
  
  return <div>{/* ... */}</div>;
}
```

### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆSSRï¼‰

```typescript
// app/dashboard/page.tsx
export const dynamic = 'force-dynamic'; // SSRã‚’å¼·åˆ¶

export default async function DashboardPage() {
  const session = await auth();
  
  if (!session) {
    redirect('/login');
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const userData = await getUserData(session.user.id);
  
  return <div>{/* ... */}</div>;
}
```

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°SSR

```typescript
// app/posts/page.tsx
import { Suspense } from 'react';

// æŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’éåŒæœŸã§å–å¾—
async function PostsList() {
  const posts = await getPosts();
  
  return (
    <div>
      {posts.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}
    </div>
  );
}

// ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export default function PostsPage() {
  return (
    <div>
      <h1>æŠ•ç¨¿ä¸€è¦§</h1>
      
      {/* Suspenseã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚° */}
      <Suspense fallback={<PostsListSkeleton />}>
        <PostsList />
      </Suspense>
    </div>
  );
}

// ã‚¹ã‚±ãƒ«ãƒˆãƒ³UI
function PostsListSkeleton() {
  return (
    <div className="space-y-4">
      {[...Array(5)].map((_, i) => (
        <div key={i} className="animate-pulse">
          <div className="h-6 bg-gray-200 rounded w-3/4 mb-2" />
          <div className="h-4 bg-gray-200 rounded w-full" />
        </div>
      ))}
    </div>
  );
}
```

---

## 30.7 Core Web Vitalsæœ€é©åŒ–

### Largest Contentful Paint (LCP)

```typescript
// components/Hero.tsx
import Image from 'next/image';

export function Hero() {
  return (
    <div className="relative h-[600px]">
      {/* priorityã§LCPè¦ç´ ã‚’å„ªå…ˆèª­ã¿è¾¼ã¿ */}
      <Image
        src="/hero-image.jpg"
        alt="Hero"
        fill
        priority
        className="object-cover"
        sizes="100vw"
      />
      <div className="absolute inset-0 flex items-center justify-center">
        <h1 className="text-5xl font-bold text-white">
          Welcome to Our Site
        </h1>
      </div>
    </div>
  );
}
```

### First Input Delay (FID) / Interaction to Next Paint (INP)

```typescript
// hooks/useDebouncedCallback.ts
import { useCallback, useRef } from 'react';

export function useDebouncedCallback<T extends (...args: any[]) => any>(
  callback: T,
  delay: number
): (...args: Parameters<T>) => void {
  const timeoutRef = useRef<NodeJS.Timeout>();
  
  return useCallback(
    (...args: Parameters<T>) => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
      
      timeoutRef.current = setTimeout(() => {
        callback(...args);
      }, delay);
    },
    [callback, delay]
  );
}

// ä½¿ç”¨ä¾‹
function SearchBox() {
  const [query, setQuery] = useState('');
  
  const debouncedSearch = useDebouncedCallback(
    (value: string) => {
      // æ¤œç´¢å‡¦ç†ï¼ˆé‡ã„å‡¦ç†ï¼‰
      performSearch(value);
    },
    300
  );
  
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setQuery(value);
    debouncedSearch(value);
  };
  
  return <input value={query} onChange={handleChange} />;
}
```

### Cumulative Layout Shift (CLS)

```typescript
// components/ImageWithAspectRatio.tsx
import Image from 'next/image';

export function ImageWithAspectRatio({
  src,
  alt,
  width,
  height,
}: {
  src: string;
  alt: string;
  width: number;
  height: number;
}) {
  return (
    <div
      style={{
        position: 'relative',
        width: '100%',
        paddingBottom: `${(height / width) * 100}%`,
      }}
    >
      <Image
        src={src}
        alt={alt}
        fill
        className="object-cover"
        sizes="(max-width: 768px) 100vw, 50vw"
      />
    </div>
  );
}
```

### ãƒ•ã‚©ãƒ³ãƒˆæœ€é©åŒ–

```typescript
// app/layout.tsx
import { Inter, Noto_Sans_JP } from 'next/font/google';

const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
  variable: '--font-inter',
});

const notoSansJP = Noto_Sans_JP({
  subsets: ['latin'],
  weight: ['400', '500', '700'],
  display: 'swap',
  variable: '--font-noto-sans-jp',
});

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja" className={`${inter.variable} ${notoSansJP.variable}`}>
      <body className="font-sans">{children}</body>
    </html>
  );
}
```

---

## 30.8 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

### Web Vitalsã®è¨ˆæ¸¬

```typescript
// app/layout.tsx
'use client';

import { useReportWebVitals } from 'next/web-vitals';

export function WebVitalsReporter() {
  useReportWebVitals((metric) => {
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
    console.log(metric);
    
    // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«é€ä¿¡
    if (process.env.NODE_ENV === 'production') {
      // Google Analytics
      window.gtag?.('event', metric.name, {
        value: Math.round(
          metric.name === 'CLS' ? metric.value * 1000 : metric.value
        ),
        event_label: metric.id,
        non_interaction: true,
      });
    }
  });
  
  return null;
}
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

```typescript
// lib/performance.ts
export class PerformanceMonitor {
  private marks = new Map<string, number>();
  
  start(label: string) {
    this.marks.set(label, performance.now());
  }
  
  end(label: string) {
    const startTime = this.marks.get(label);
    if (startTime === undefined) {
      console.warn(`No start mark found for "${label}"`);
      return;
    }
    
    const duration = performance.now() - startTime;
    console.log(`â±ï¸ ${label}: ${duration.toFixed(2)}ms`);
    
    this.marks.delete(label);
    return duration;
  }
  
  async measure<T>(label: string, fn: () => Promise<T>): Promise<T> {
    this.start(label);
    try {
      return await fn();
    } finally {
      this.end(label);
    }
  }
}

// ä½¿ç”¨ä¾‹
const monitor = new PerformanceMonitor();

export async function fetchPosts() {
  return monitor.measure('fetch-posts', async () => {
    const posts = await prisma.post.findMany();
    return posts;
  });
}
```

---

## 30.9 ãƒ¡ãƒ¢åŒ–ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

### React.memoã®æ´»ç”¨

```typescript
// components/PostCard.tsx
import { memo } from 'react';

interface PostCardProps {
  post: {
    id: string;
    title: string;
    content: string;
    author: {
      name: string;
      image: string;
    };
  };
}

// ãƒ¡ãƒ¢åŒ–ã—ã¦ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ã
export const PostCard = memo(function PostCard({ post }: PostCardProps) {
  return (
    <div className="card">
      <h3>{post.title}</h3>
      <p>{post.content}</p>
      <div className="flex items-center gap-2">
        <img src={post.author.image} alt={post.author.name} />
        <span>{post.author.name}</span>
      </div>
    </div>
  );
});
```

### useMemoã®æ´»ç”¨

```typescript
// components/PostsList.tsx
'use client';

import { useMemo } from 'react';

export function PostsList({ posts }: { posts: Post[] }) {
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’ãƒ¡ãƒ¢åŒ–
  const publishedPosts = useMemo(() => {
    return posts.filter((post) => post.published);
  }, [posts]);
  
  // ã‚½ãƒ¼ãƒˆçµæœã‚’ãƒ¡ãƒ¢åŒ–
  const sortedPosts = useMemo(() => {
    return [...publishedPosts].sort((a, b) => 
      b.createdAt.getTime() - a.createdAt.getTime()
    );
  }, [publishedPosts]);
  
  return (
    <div>
      {sortedPosts.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}
    </div>
  );
}
```

### useCallbackã®æ´»ç”¨

```typescript
// components/SearchableList.tsx
'use client';

import { useState, useCallback } from 'react';

export function SearchableList({ items }: { items: string[] }) {
  const [query, setQuery] = useState('');
  
  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒ¡ãƒ¢åŒ–
  const handleSearch = useCallback((value: string) => {
    setQuery(value);
  }, []);
  
  const filteredItems = items.filter((item) =>
    item.toLowerCase().includes(query.toLowerCase())
  );
  
  return (
    <div>
      <SearchBox onSearch={handleSearch} />
      <ul>
        {filteredItems.map((item, index) => (
          <li key={index}>{item}</li>
        ))}
      </ul>
    </div>
  );
}
```

---

## 30.10 ãƒªã‚½ãƒ¼ã‚¹ãƒ’ãƒ³ãƒˆ

### Preloadã€Prefetchã€Preconnect

```typescript
// app/layout.tsx
import { Metadata } from 'next';

export const metadata: Metadata = {
  // ãã®ä»–ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿...
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <head>
        {/* é‡è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’preload */}
        <link
          rel="preload"
          href="/fonts/inter-var.woff2"
          as="font"
          type="font/woff2"
          crossOrigin="anonymous"
        />
        
        {/* å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®æ¥ç¶šã‚’äº‹å‰ç¢ºç«‹ */}
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link
          rel="preconnect"
          href="https://fonts.gstatic.com"
          crossOrigin="anonymous"
        />
        
        {/* æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’prefetch */}
        <link rel="prefetch" href="/posts" />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

### Next.js Linkã®prefetch

```typescript
// components/Navigation.tsx
import Link from 'next/link';

export function Navigation() {
  return (
    <nav>
      {/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§prefetchãŒæœ‰åŠ¹ */}
      <Link href="/posts">æŠ•ç¨¿ä¸€è¦§</Link>
      
      {/* prefetchã‚’ç„¡åŠ¹åŒ– */}
      <Link href="/admin" prefetch={false}>
        ç®¡ç†ç”»é¢
      </Link>
    </nav>
  );
}
```

---

## 30.11 ãƒ“ãƒ«ãƒ‰æ™‚æœ€é©åŒ–

### next.config.jsã®æœ€é©åŒ–è¨­å®š

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // æœ¬ç•ªãƒ“ãƒ«ãƒ‰ã®æœ€é©åŒ–
  compiler: {
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®å‰Šé™¤ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
    removeConsole: process.env.NODE_ENV === 'production' ? {
      exclude: ['error', 'warn'],
    } : false,
  },
  
  // SWC Minifyï¼ˆé«˜é€Ÿï¼‰
  swcMinify: true,
  
  // Gzipåœ§ç¸®
  compress: true,
  
  // å³å¯†ãƒ¢ãƒ¼ãƒ‰
  reactStrictMode: true,
  
  // æœªä½¿ç”¨ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’æ¤œå‡º
  experimental: {
    optimizePackageImports: ['lucide-react', 'date-fns'],
  },
  
  // ãƒšãƒ¼ã‚¸æ‹¡å¼µå­
  pageExtensions: ['tsx', 'ts', 'jsx', 'js'],
  
  // å‡ºåŠ›è¨­å®š
  output: 'standalone', // Dockerãƒ‡ãƒ—ãƒ­ã‚¤ç”¨
};

module.exports = nextConfig;
```

### Tree Shakingè¨­å®š

```javascript
// package.json
{
  "sideEffects": [
    "*.css",
    "*.scss"
  ]
}
```

---

## 30.12 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯

```markdown
## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç”»åƒ
- [ ] ã™ã¹ã¦ã®ç”»åƒã§next/imageã‚’ä½¿ç”¨
- [ ] é‡è¦ãªç”»åƒã«priorityã‚’è¨­å®š
- [ ] é©åˆ‡ãªsizesãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®š
- [ ] WebP/AVIFå½¢å¼ã‚’æœ‰åŠ¹åŒ–

### ã‚³ãƒ¼ãƒ‰
- [ ] ä¸è¦ãªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’å‰Šé™¤
- [ ] æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤
- [ ] ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§é…å»¶èª­ã¿è¾¼ã¿
- [ ] Tree Shakingã‚’æœ‰åŠ¹åŒ–

### ãƒ‡ãƒ¼ã‚¿
- [ ] N+1ã‚¯ã‚¨ãƒªã‚’è§£æ±º
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
- [ ] å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’å®Ÿè£…

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- [ ] é©åˆ‡ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥ã‚’é¸æŠ
- [ ] ISRã§å®šæœŸçš„ã«æ›´æ–°
- [ ] Suspenseã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- [ ] ã‚¹ã‚±ãƒ«ãƒˆãƒ³UIã‚’å®Ÿè£…

### Core Web Vitals
- [ ] LCP < 2.5s
- [ ] FID < 100ms / INP < 200ms
- [ ] CLS < 0.1
- [ ] ãƒ•ã‚©ãƒ³ãƒˆã®æœ€é©åŒ–

### ãã®ä»–
- [ ] ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’åˆ†æ
- [ ] å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æœ€é©åŒ–
- [ ] ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰/ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã‚’è¨­å®š
- [ ] Lighthouseã‚¹ã‚³ã‚¢90+
```

---

## 30.13 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### æœ¬ç•ªç’°å¢ƒã§ã®ç›£è¦–

```typescript
// lib/monitoring.ts
export class PerformanceLogger {
  static logMetric(
    name: string,
    value: number,
    unit: string = 'ms'
  ) {
    if (process.env.NODE_ENV === 'production') {
      // ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«é€ä¿¡
      console.log(`ğŸ“Š ${name}: ${value}${unit}`);
      
      // ä¾‹: Datadogã€Sentryã€New Relicãªã©ã«é€ä¿¡
      // datadog.gauge(name, value);
    }
  }
  
  static logError(error: Error, context?: Record<string, any>) {
    console.error('âŒ Error:', error);
    
    if (process.env.NODE_ENV === 'production') {
      // ã‚¨ãƒ©ãƒ¼è¿½è·¡ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡
      // Sentry.captureException(error, { extra: context });
    }
  }
}
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ç”»åƒæœ€é©åŒ–
- âœ… **next/image**: è‡ªå‹•æœ€é©åŒ–ã€é…å»¶èª­ã¿è¾¼ã¿
- âœ… **WebP/AVIF**: æ¬¡ä¸–ä»£ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- âœ… **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–**: ãƒ‡ãƒã‚¤ã‚¹ã‚µã‚¤ã‚ºã«å¿œã˜ãŸæœ€é©åŒ–
- âœ… **Priority**: é‡è¦ç”»åƒã®å„ªå…ˆèª­ã¿è¾¼ã¿

### ã‚³ãƒ¼ãƒ‰åˆ†å‰²
- âœ… **ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**: å¿…è¦ãªæ™‚ã ã‘èª­ã¿è¾¼ã¿
- âœ… **Suspense**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°SSR
- âœ… **Tree Shaking**: æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤
- âœ… **ãƒãƒ³ãƒ‰ãƒ«åˆ†æ**: ã‚µã‚¤ã‚ºæœ€é©åŒ–

### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- âœ… **ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: React cacheé–¢æ•°
- âœ… **Fetchã‚­ãƒ£ãƒƒã‚·ãƒ¥**: è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- âœ… **ISR**: ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«é™çš„å†ç”Ÿæˆ
- âœ… **ãƒ«ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥**: ãƒšãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«è¨­å®š

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
- âœ… **N+1è§£æ±º**: includeã§ä¸€æ‹¬å–å¾—
- âœ… **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
- âœ… **éƒ¨åˆ†å–å¾—**: å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿
- âœ… **ã‚«ãƒ¼ã‚½ãƒ«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒ³ã‚°

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥
- âœ… **SSG**: é™çš„ç”Ÿæˆ
- âœ… **ISR**: å®šæœŸçš„å†ç”Ÿæˆ
- âœ… **SSR**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- âœ… **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: æ®µéšçš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

### Core Web Vitals
- âœ… **LCP**: æœ€å¤§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æç”»æ™‚é–“
- âœ… **FID/INP**: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¿œç­”æ€§
- âœ… **CLS**: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆé˜²æ­¢
- âœ… **ãƒ•ã‚©ãƒ³ãƒˆæœ€é©åŒ–**: display: swap

### æ¸¬å®šã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- âœ… **Web Vitals**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆæ¸¬
- âœ… **ã‚«ã‚¹ã‚¿ãƒ æ¸¬å®š**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼
- âœ… **Lighthouse**: ã‚¹ã‚³ã‚¢ç¢ºèª
- âœ… **æœ¬ç•ªç›£è¦–**: ç¶™ç¶šçš„ãªè¿½è·¡

æ¬¡ã®ç« ã§ã¯ã€**ãƒ†ã‚¹ãƒˆå®Ÿè£…**ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬29ç«  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](29-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬31ç«  ãƒ†ã‚¹ãƒˆå®Ÿè£… â†’](31-ãƒ†ã‚¹ãƒˆå®Ÿè£….md)
