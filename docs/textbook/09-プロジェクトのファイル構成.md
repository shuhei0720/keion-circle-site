# ç¬¬9ç« ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã“ã®ç« ã§ã¯ã€BOLDè»½éŸ³ãƒ¡ãƒ³ãƒãƒ¼ã‚µã‚¤ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨ã€å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã«ã¤ã„ã¦è©³ã—ãå­¦ã³ã¾ã™ã€‚

## 9.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“åƒ

```
keion-circle-site/
â”œâ”€â”€ prisma/              # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
â”œâ”€â”€ public/              # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ scripts/             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â””â”€â”€ src/                 # ãƒ¡ã‚¤ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
    â”œâ”€â”€ app/             # Next.js App Router
    â”œâ”€â”€ components/      # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â””â”€â”€ lib/             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
```

---

## 9.2 `prisma/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’ç®¡ç†ã—ã¾ã™ã€‚

### prisma/schema.prisma

```prisma
// ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è¨­å®š
datasource db {
  provider = "postgresql"  // PostgreSQLã‚’ä½¿ç”¨
  url      = env("DATABASE_URL")  // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—
}

// Prisma Clientã®è¨­å®š
generator client {
  provider = "prisma-client-js"
}

// Userãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‰
model User {
  id            String    @id @default(cuid())  // ä¸€æ„ID
  name          String?                         // åå‰
  email         String?   @unique               // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¸€æ„ï¼‰
  emailVerified DateTime?                       // ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ—¥æ™‚
  image         String?                         // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL
  password      String?                         // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
  role          String    @default("member")    // å½¹å‰²ï¼ˆadmin/memberï¼‰
  bio           String?                         // è‡ªå·±ç´¹ä»‹
  instrument    String?                         // æ‹…å½“æ¥½å™¨
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  accounts      Account[]     // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆOAuthç­‰ï¼‰
  sessions      Session[]     // ã‚»ãƒƒã‚·ãƒ§ãƒ³
  posts         Post[]        // æŠ•ç¨¿
  likes         Like[]        // ã„ã„ã­
  comments      Comment[]     // ã‚³ãƒ¡ãƒ³ãƒˆ
  participation Participation[]  // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ 
  scheduleVotes ScheduleVote[]   // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æŠ•ç¥¨
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Postãƒ¢ãƒ‡ãƒ«ï¼ˆæ´»å‹•å ±å‘Šï¼‰
model Post {
  id          String   @id @default(cuid())
  title       String                           // ã‚¿ã‚¤ãƒˆãƒ«
  content     String   @db.Text                // æœ¬æ–‡
  youtubeUrls String[] @default([])            // YouTube URLï¼ˆé…åˆ—ï¼‰
  images      String[] @default([])            // ç”»åƒURLï¼ˆé…åˆ—ï¼‰
  authorId    String                           // æŠ•ç¨¿è€…ID
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  author      User     @relation(fields: [authorId], references: [id])
  likes       Like[]
  comments    Comment[]
  participation Participation[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Likeãƒ¢ãƒ‡ãƒ«ï¼ˆã„ã„ã­ï¼‰
model Like {
  id        String   @id @default(cuid())
  userId    String
  postId    String
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æŠ•ç¨¿ã®çµ„ã¿åˆã‚ã›ã‚’ä¸€æ„ã«
  @@unique([userId, postId])
}

// Commentãƒ¢ãƒ‡ãƒ«ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  postId    String
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Eventãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰
model Event {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  date        DateTime
  location    String?
  
  participation Participation[]
  schedules     Schedule[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Participationãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ï¼‰
model Participation {
  id        String   @id @default(cuid())
  userId    String
  eventId   String?
  postId    String?
  status    String   @default("å‚åŠ äºˆå®š")  // å‚åŠ äºˆå®š/å‚åŠ ã—ãŸ/ä¸å‚åŠ 
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, eventId])
  @@unique([userId, postId])
}

// Scheduleãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ï¼‰
model Schedule {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  eventId     String?
  
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  candidates  ScheduleCandidate[]  // å€™è£œæ—¥
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ScheduleCandidateãƒ¢ãƒ‡ãƒ«ï¼ˆå€™è£œæ—¥ï¼‰
model ScheduleCandidate {
  id          String   @id @default(cuid())
  scheduleId  String
  datetime    DateTime
  location    String?
  
  schedule    Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  votes       ScheduleVote[]
  comments    ScheduleCandidateComment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ScheduleVoteãƒ¢ãƒ‡ãƒ«ï¼ˆæŠ•ç¥¨ï¼‰
model ScheduleVote {
  id          String   @id @default(cuid())
  candidateId String
  userId      String
  response    String   // "å‚åŠ å¯èƒ½" | "æœªå®š" | "å‚åŠ ä¸å¯"
  
  candidate   ScheduleCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([candidateId, userId])
}

// ScheduleCandidateCommentãƒ¢ãƒ‡ãƒ«ï¼ˆå€™è£œæ—¥ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
model ScheduleCandidateComment {
  id          String   @id @default(cuid())
  candidateId String
  userId      String
  content     String   @db.Text
  
  candidate   ScheduleCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NextAuth.jsç”¨ã®ãƒ¢ãƒ‡ãƒ«
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

**ãƒã‚¤ãƒ³ãƒˆï¼š**

- `@id`: ä¸»ã‚­ãƒ¼
- `@unique`: ä¸€æ„åˆ¶ç´„
- `@default`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
- `@relation`: ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
- `onDelete: Cascade`: è¦ªãŒå‰Šé™¤ã•ã‚ŒãŸã‚‰å­ã‚‚å‰Šé™¤

---

## 9.3 `src/lib/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

å…±é€šã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’æ ¼ç´ã—ã¾ã™ã€‚

### src/lib/db.tsï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šï¼‰

```typescript
import { PrismaClient } from '@prisma/client';

// PrismaClientã®ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ['query'], // SQLã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
  });

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}
```

**ãªãœã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã«ã™ã‚‹ã®ã‹ï¼Ÿ**

é–‹ç™ºç’°å¢ƒã§ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã®ãŸã³ã«æ–°ã—ã„æ¥ç¶šã‚’ä½œã‚‹ã¨ã€æ¥ç¶šæ•°ã®ä¸Šé™ã«é”ã—ã¦ã—ã¾ã†ãŸã‚ã€‚

**ä½¿ã„æ–¹ï¼š**

```typescript
import { prisma } from '@/lib/db';

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
const users = await prisma.user.findMany();

// æŠ•ç¨¿ã‚’ä½œæˆ
const post = await prisma.post.create({
  data: {
    title: "æ–°ã—ã„æŠ•ç¨¿",
    content: "å†…å®¹",
    authorId: "user-id",
  },
});
```

### src/lib/auth.tsï¼ˆèªè¨¼è¨­å®šï¼‰

```typescript
import NextAuth from 'next-auth';
import { PrismaAdapter } from '@auth/prisma-adapter';
import Google from 'next-auth/providers/google';
import Credentials from 'next-auth/providers/credentials';
import { prisma } from '@/lib/db';
import bcrypt from 'bcryptjs';

export const { handlers, signIn, signOut, auth } = NextAuth({
  // Prismaã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  adapter: PrismaAdapter(prisma),
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼
  session: {
    strategy: 'jwt', // JWTã‚’ä½¿ç”¨
  },
  
  // èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
  providers: [
    // Google OAuth
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    Credentials({
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const user = await prisma.user.findUnique({
          where: { email: credentials.email as string },
        });
        
        if (!user || !user.password) {
          return null;
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œè¨¼
        const isValid = await bcrypt.compare(
          credentials.password as string,
          user.password
        );
        
        if (!isValid) {
          return null;
        }
        
        return {
          id: user.id,
          email: user.email,
          name: user.name,
          image: user.image,
          role: user.role,
        };
      },
    }),
  ],
  
  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  callbacks: {
    // JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.role = user.role;
      }
      return token;
    },
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;
        session.user.role = token.role as string;
      }
      return session;
    },
  },
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒšãƒ¼ã‚¸
  pages: {
    signIn: '/login',  // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
  },
});
```

**ä½¿ã„æ–¹ï¼š**

```typescript
import { auth } from '@/lib/auth';

// ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
export default async function Page() {
  const session = await auth();
  
  if (!session) {
    return <div>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>;
  }
  
  return <div>ã“ã‚“ã«ã¡ã¯ã€{session.user.name}ã•ã‚“</div>;
}

// API Route
export async function GET() {
  const session = await auth();
  
  if (!session) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // å‡¦ç†...
}
```

### src/lib/supabase.tsï¼ˆSupabaseè¨­å®šï¼‰

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseKey);
```

**ä½¿ã„æ–¹ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰ï¼š**

```typescript
import { supabase } from '@/lib/supabase';

// ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
const file = event.target.files[0];
const fileName = `${Date.now()}-${file.name}`;

const { data, error } = await supabase.storage
  .from('avatars')
  .upload(fileName, file);

if (error) {
  console.error(error);
  return;
}

// å…¬é–‹URLã‚’å–å¾—
const { data: urlData } = supabase.storage
  .from('avatars')
  .getPublicUrl(fileName);

const imageUrl = urlData.publicUrl;
```

---

## 9.4 `src/app/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆApp Routerï¼‰

Next.js 16ã®App Routerã‚’ä½¿ã£ãŸãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ§‹é€ ã§ã™ã€‚

```
src/app/
â”œâ”€â”€ api/                    # APIãƒ«ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ auth/               # èªè¨¼é–¢é€£API
â”‚   â”‚   â””â”€â”€ [...nextauth]/route.ts
â”‚   â”œâ”€â”€ posts/              # æŠ•ç¨¿é–¢é€£API
â”‚   â”‚   â”œâ”€â”€ route.ts
â”‚   â”‚   â”œâ”€â”€ [id]/route.ts
â”‚   â”‚   â””â”€â”€ [id]/like/route.ts
â”‚   â”œâ”€â”€ schedules/          # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢é€£API
â”‚   â””â”€â”€ users/              # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£API
â”œâ”€â”€ posts/                  # æŠ•ç¨¿ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ page.tsx            # /posts
â”‚   â”œâ”€â”€ new/page.tsx        # /posts/new
â”‚   â””â”€â”€ [id]/page.tsx       # /posts/123
â”œâ”€â”€ schedules/              # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ page.tsx            # /schedules
â”‚   â”œâ”€â”€ new/page.tsx        # /schedules/new
â”‚   â””â”€â”€ [id]/page.tsx       # /schedules/123
â”œâ”€â”€ users/                  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ page.tsx            # /users
â”‚   â””â”€â”€ [id]/page.tsx       # /users/123
â”œâ”€â”€ login/                  # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ register/               # ç™»éŒ²ãƒšãƒ¼ã‚¸
â”‚   â””â”€â”€ page.tsx
â”œâ”€â”€ layout.tsx              # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”œâ”€â”€ page.tsx                # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆ/ï¼‰
â””â”€â”€ globals.css             # ã‚°ãƒ­ãƒ¼ãƒãƒ«CSS
```

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä»•çµ„ã¿

```
ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                    URL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app/page.tsx                â†’ /
app/posts/page.tsx          â†’ /posts
app/posts/new/page.tsx      â†’ /posts/new
app/posts/[id]/page.tsx     â†’ /posts/123
app/schedules/[id]/page.tsx â†’ /schedules/abc
```

**å‹•çš„ãƒ«ãƒ¼ãƒˆ `[id]`:**

```typescript
// app/posts/[id]/page.tsx
export default async function PostPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  
  // idã‚’ä½¿ã£ã¦æŠ•ç¨¿ã‚’å–å¾—
  const post = await prisma.post.findUnique({
    where: { id },
  });
  
  return <div>{post.title}</div>;
}
```

---

## 9.5 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ 

### app/layout.tsxï¼ˆãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰

ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã«å…±é€šã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã™ã€‚

```typescript
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import Navigation from '@/components/Navigation';
import AuthButton from '@/components/AuthButton';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'BOLDè»½éŸ³ ãƒ¡ãƒ³ãƒãƒ¼ã‚µã‚¤ãƒˆ',
  description: 'ãƒ¡ãƒ³ãƒãƒ¼å°‚ç”¨ã®æ´»å‹•å ±å‘Šãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ã‚µã‚¤ãƒˆ',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <header className="border-b">
          <div className="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 className="text-2xl font-bold">BOLDè»½éŸ³</h1>
            <div className="flex items-center gap-4">
              <Navigation />
              <AuthButton />
            </div>
          </div>
        </header>
        
        <main className="container mx-auto px-4 py-8">
          {children}
        </main>
        
        <footer className="border-t mt-16">
          <div className="container mx-auto px-4 py-8 text-center text-gray-600">
            Â© 2024 BOLDè»½éŸ³ã‚µãƒ¼ã‚¯ãƒ«
          </div>
        </footer>
      </body>
    </html>
  );
}
```

**ãƒã‚¤ãƒ³ãƒˆï¼š**

- `{children}`: å„ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæŒ¿å…¥ã•ã‚Œã‚‹
- `<header>` ã¨ `<footer>` ã¯ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã§å…±é€š
- `metadata`: SEOç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

### ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```typescript
// app/posts/layout.tsx
export default function PostsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div>
      <div className="mb-8">
        <h2 className="text-3xl font-bold">æ´»å‹•å ±å‘Š</h2>
        <p className="text-gray-600">BOLDè»½éŸ³ã®æ´»å‹•ã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†</p>
      </div>
      {children}
    </div>
  );
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€`/posts` é…ä¸‹ã®ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã§å…±é€šã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

---

## 9.6 `src/components/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

å†åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ ¼ç´ã—ã¾ã™ã€‚

```
src/components/
â”œâ”€â”€ AuthButton.tsx          # èªè¨¼ãƒœã‚¿ãƒ³
â”œâ”€â”€ Navigation.tsx          # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ PostCard.tsx            # æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰
â”œâ”€â”€ CommentList.tsx         # ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§
â”œâ”€â”€ YouTubeEmbed.tsx        # YouTubeåŸ‹ã‚è¾¼ã¿
â”œâ”€â”€ ImageUpload.tsx         # ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â”œâ”€â”€ ScheduleVoteButton.tsx  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æŠ•ç¥¨ãƒœã‚¿ãƒ³
â””â”€â”€ UserAvatar.tsx          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆã®åŸå‰‡

**1. å°ã•ãã€å†åˆ©ç”¨å¯èƒ½ã«**

```typescript
// âŒ æ‚ªã„ä¾‹ï¼šå¤§ãã™ãã‚‹
function PostPage() {
  return (
    <div>
      {/* æŠ•ç¨¿è¡¨ç¤º */}
      {/* ã„ã„ã­ãƒœã‚¿ãƒ³ */}
      {/* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ */}
      {/* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  */}
    </div>
  );
}

// âœ… è‰¯ã„ä¾‹ï¼šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†å‰²
function PostPage() {
  return (
    <div>
      <PostHeader />
      <PostContent />
      <LikeButton />
      <CommentList />
      <CommentForm />
    </div>
  );
}
```

**2. Propsã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã«Avatarã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼š**

```typescript
// components/UserAvatar.tsx
interface UserAvatarProps {
  src?: string | null;
  name: string;
  size?: 'sm' | 'md' | 'lg';
}

export default function UserAvatar({ src, name, size = 'md' }: UserAvatarProps) {
  const sizeClasses = {
    sm: 'w-8 h-8 text-sm',
    md: 'w-12 h-12 text-base',
    lg: 'w-16 h-16 text-lg',
  };
  
  if (src) {
    return (
      <img
        src={src}
        alt={name}
        className={`${sizeClasses[size]} rounded-full object-cover`}
      />
    );
  }
  
  // ç”»åƒãŒãªã„å ´åˆã¯åå‰ã®é ­æ–‡å­—
  const initial = name.charAt(0).toUpperCase();
  
  return (
    <div
      className={`${sizeClasses[size]} rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold`}
    >
      {initial}
    </div>
  );
}

// ä½¿ã„æ–¹
<UserAvatar src={user.image} name={user.name} size="sm" />
<UserAvatar src={user.image} name={user.name} size="md" />
<UserAvatar src={user.image} name={user.name} size="lg" />
```

**3. Client Componentã¨Server Componentã‚’ä½¿ã„åˆ†ã‘ã‚‹**

```typescript
// Server Componentï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
export default async function PostList() {
  const posts = await prisma.post.findMany();
  
  return (
    <div>
      {posts.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}
    </div>
  );
}

// Client Componentï¼ˆã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ï¼‰
'use client';

export default function LikeButton({ postId }: { postId: string }) {
  const [liked, setLiked] = useState(false);
  
  const handleLike = async () => {
    await fetch(`/api/posts/${postId}/like`, { method: 'POST' });
    setLiked(true);
  };
  
  return (
    <button onClick={handleLike}>
      {liked ? 'â¤ï¸' : 'ğŸ¤'} ã„ã„ã­
    </button>
  );
}
```

---

## 9.7 APIãƒ«ãƒ¼ãƒˆã®æ§‹é€ 

### app/api/posts/route.tsï¼ˆæŠ•ç¨¿ä¸€è¦§ãƒ»ä½œæˆï¼‰

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

// GET /api/posts - æŠ•ç¨¿ä¸€è¦§
export async function GET() {
  const posts = await prisma.post.findMany({
    include: {
      author: true,
      _count: { select: { likes: true, comments: true } },
    },
    orderBy: { createdAt: 'desc' },
  });
  
  return NextResponse.json(posts);
}

// POST /api/posts - æŠ•ç¨¿ä½œæˆ
export async function POST(request: NextRequest) {
  const session = await auth();
  
  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
  if (session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  const body = await request.json();
  
  const post = await prisma.post.create({
    data: {
      title: body.title,
      content: body.content,
      youtubeUrls: body.youtubeUrls || [],
      images: body.images || [],
      authorId: session.user.id,
    },
  });
  
  return NextResponse.json(post);
}
```

### app/api/posts/[id]/route.tsï¼ˆæŠ•ç¨¿è©³ç´°ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼‰

```typescript
// GET /api/posts/123 - æŠ•ç¨¿è©³ç´°
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  
  const post = await prisma.post.findUnique({
    where: { id },
    include: {
      author: true,
      likes: true,
      comments: {
        include: { user: true },
        orderBy: { createdAt: 'desc' },
      },
    },
  });
  
  if (!post) {
    return NextResponse.json({ error: 'Not found' }, { status: 404 });
  }
  
  return NextResponse.json(post);
}

// PUT /api/posts/123 - æŠ•ç¨¿æ›´æ–°
export async function PUT(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const session = await auth();
  const { id } = await params;
  
  if (!session?.user || session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  const body = await request.json();
  
  const post = await prisma.post.update({
    where: { id },
    data: {
      title: body.title,
      content: body.content,
      youtubeUrls: body.youtubeUrls,
      images: body.images,
    },
  });
  
  return NextResponse.json(post);
}

// DELETE /api/posts/123 - æŠ•ç¨¿å‰Šé™¤
export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const session = await auth();
  const { id } = await params;
  
  if (!session?.user || session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  await prisma.post.delete({
    where: { id },
  });
  
  return NextResponse.json({ success: true });
}
```

---

## 9.8 ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

### ç‰¹æ®Šãªãƒ•ã‚¡ã‚¤ãƒ«å

Next.js App Routerã§ã¯ã€ç‰¹å®šã®åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç‰¹åˆ¥ãªæ„å‘³ãŒã‚ã‚Šã¾ã™ï¼š

```
page.tsx          - ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
layout.tsx        - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
loading.tsx       - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
error.tsx         - ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
not-found.tsx     - 404ãƒšãƒ¼ã‚¸
route.ts          - APIãƒ«ãƒ¼ãƒˆ
```

### ä¾‹ï¼šloading.tsx

```typescript
// app/posts/loading.tsx
export default function Loading() {
  return (
    <div className="flex justify-center items-center min-h-screen">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600" />
    </div>
  );
}
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ã€`/posts` ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ä¸­ã«è‡ªå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

### ä¾‹ï¼šerror.tsx

```typescript
// app/posts/error.tsx
'use client';

export default function Error({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  return (
    <div className="text-center py-16">
      <h2 className="text-2xl font-bold text-red-600 mb-4">
        ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
      </h2>
      <p className="text-gray-600 mb-4">{error.message}</p>
      <button
        onClick={reset}
        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
      >
        å†è©¦è¡Œ
      </button>
    </div>
  );
}
```

---

## 9.9 ã‚³ãƒ¼ãƒ‰åˆ†å‰²ã¨æœ€é©åŒ–

### å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

é‡ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚’é«˜é€ŸåŒ–ã§ãã¾ã™ã€‚

```typescript
import dynamic from 'next/dynamic';

// å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆä½¿ç”¨æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ï¼‰
const ReactPlayer = dynamic(() => import('react-player'), {
  ssr: false,  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ–
  loading: () => <div>Loading player...</div>,
});

export default function VideoPage() {
  return (
    <div>
      <ReactPlayer url="https://youtube.com/watch?v=..." />
    </div>
  );
}
```

### ç”»åƒæœ€é©åŒ–

```typescript
import Image from 'next/image';

export default function PostImage({ src, alt }: { src: string; alt: string }) {
  return (
    <Image
      src={src}
      alt={alt}
      width={800}
      height={600}
      className="rounded-lg"
      // è‡ªå‹•çš„ã«æœ€é©ãªã‚µã‚¤ã‚ºã«å¤‰æ›ã•ã‚Œã‚‹
    />
  );
}
```

---

## 9.10 ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†

### .env.localï¼ˆé–‹ç™ºç’°å¢ƒï¼‰

```env
# å…¬é–‹ã•ã‚Œãªã„ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ï¼‰
DATABASE_URL="file:./dev.db"
AUTH_SECRET="secret-key"
GOOGLE_CLIENT_SECRET="secret"

# å…¬é–‹ã•ã‚Œã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ä½¿ãˆã‚‹ï¼‰
NEXT_PUBLIC_SUPABASE_URL="https://xxx.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="xxx"
```

**ä½¿ã„æ–¹ï¼š**

```typescript
// ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿
const dbUrl = process.env.DATABASE_URL;

// ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ä½¿ãˆã‚‹
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
```

**é‡è¦ï¼š** `NEXT_PUBLIC_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã¤ã‘ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚‚å…¬é–‹ã•ã‚Œã‚‹ã®ã§ã€ç§˜å¯†æƒ…å ±ã¯å…¥ã‚Œãªã„ï¼

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- âœ… **prisma/**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
- âœ… **src/lib/**: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆdbã€authã€supabaseï¼‰
- âœ… **src/app/**: App Routerã®ãƒšãƒ¼ã‚¸ã¨ã‚¢ãƒ”
- âœ… **src/components/**: å†åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### App Router
- âœ… **page.tsx**: ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- âœ… **layout.tsx**: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- âœ… **route.ts**: APIãƒ«ãƒ¼ãƒˆ
- âœ… **[id]**: å‹•çš„ãƒ«ãƒ¼ãƒˆ

### è¨­è¨ˆåŸå‰‡
- âœ… **å°ã•ãåˆ†å‰²**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å°ã•ãã€å†åˆ©ç”¨å¯èƒ½ã«
- âœ… **Server/Clientåˆ†é›¢**: é©åˆ‡ã«ä½¿ã„åˆ†ã‘ã‚‹
- âœ… **å‹å®‰å…¨**: TypeScriptã§å‹ã‚’å®šç¾©
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ç”»åƒæœ€é©åŒ–

æ¬¡ã®ç« ã§ã¯ã€**NextAuth.jsã«ã‚ˆã‚‹èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **ã®å®Ÿè£…ã‚’è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬8ç«  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](08-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬10ç«  NextAuth.jsã«ã‚ˆã‚‹èªè¨¼ â†’](10-NextAuth.jsã«ã‚ˆã‚‹èªè¨¼.md)
