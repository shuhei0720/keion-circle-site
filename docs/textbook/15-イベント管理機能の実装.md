# ç¬¬15ç« ï¼šã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…

> **ã“ã®ç« ã§ã¯ã€ãƒ©ã‚¤ãƒ–ã‚„ãƒªãƒãƒ¼ã‚µãƒ«ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™**

## ğŸ“š ã“ã®ç« ã§å­¦ã¶ã“ã¨

- âœ… ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- âœ… å‚åŠ ç™»éŒ²æ©Ÿèƒ½
- âœ… å‚åŠ è€…ä¸€è¦§ã®è¡¨ç¤º
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›
- âœ… æ—¥æ™‚ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„æ–¹

## ğŸ’¡ ã“ã®ç« ã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  ã€ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã€‘                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ğŸ¸ 12æœˆå®šæœŸãƒ©ã‚¤ãƒ–             â”‚         â”‚
â”‚  â”‚ ğŸ“… 2024/12/25 18:00          â”‚         â”‚
â”‚  â”‚ ğŸ“ å¸‚æ°‘ä¼šé¤¨                  â”‚         â”‚
â”‚  â”‚ ğŸ‘¥ å‚åŠ è€…: 8å               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                            â”‚
â”‚  ã€ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã€‘                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ã‚¿ã‚¤ãƒˆãƒ«: 12æœˆå®šæœŸãƒ©ã‚¤ãƒ–      â”‚         â”‚
â”‚  â”‚ æ—¥æ™‚: 2024/12/25 18:00       â”‚         â”‚
â”‚  â”‚ å ´æ‰€: å¸‚æ°‘ä¼šé¤¨               â”‚         â”‚
â”‚  â”‚ èª¬æ˜: å¹´æœ«ã®å®šæœŸãƒ©ã‚¤ãƒ–ã§ã™   â”‚         â”‚
â”‚  â”‚                              â”‚         â”‚
â”‚  â”‚ [å‚åŠ ã™ã‚‹] [å‚åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«]  â”‚         â”‚
â”‚  â”‚                              â”‚         â”‚
â”‚  â”‚ å‚åŠ è€… (8å):                â”‚         â”‚
â”‚  â”‚ ğŸ‘¤ å¤ªéƒã•ã‚“                  â”‚         â”‚
â”‚  â”‚ ğŸ‘¤ èŠ±å­ã•ã‚“                  â”‚         â”‚
â”‚  â”‚ ...                          â”‚         â”‚
â”‚  â”‚                              â”‚         â”‚
â”‚  â”‚ [æ´»å‹•å ±å‘Šã‚’ä½œæˆ]ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå¾Œï¼‰â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 15.1 ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª

### Eventãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ 

`prisma/schema.prisma` ã‚’é–‹ã„ã¦ã€Eventãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```prisma
model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  location    String?
  
  // ä½œæˆè€…
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String
  
  // é–¢é€£ãƒ‡ãƒ¼ã‚¿
  participations Participation[]
  posts       Post[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ç™»éŒ²
model Participation {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  createdAt DateTime @default(now())

  // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã«è¤‡æ•°å›å‚åŠ ç™»éŒ²ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
  @@unique([userId, eventId])
}
```

**Eventãƒ¢ãƒ‡ãƒ«ã®ãƒã‚¤ãƒ³ãƒˆ:**

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|----------|-----|------|
| `title` | String | ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ« |
| `description` | String? | èª¬æ˜ï¼ˆä»»æ„ï¼‰ |
| `date` | DateTime | é–‹å‚¬æ—¥æ™‚ |
| `location` | String? | é–‹å‚¬å ´æ‰€ï¼ˆä»»æ„ï¼‰ |
| `authorId` | String | ä½œæˆè€… |
| `participations` | Participation[] | å‚åŠ ç™»éŒ²ä¸€è¦§ |
| `posts` | Post[] | ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»å‹•å ±å‘Š |

**Participationãƒ¢ãƒ‡ãƒ«ã®ãƒã‚¤ãƒ³ãƒˆ:**

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|----------|-----|------|
| `userId` | String | å‚åŠ è€… |
| `eventId` | String | ã‚¤ãƒ™ãƒ³ãƒˆ |
| `@@unique([userId, eventId])` | - | é‡è¤‡å‚åŠ ç™»éŒ²ã‚’é˜²æ­¢ |
| `onDelete: Cascade` | - | ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤æ™‚ã«å‚åŠ ç™»éŒ²ã‚‚å‰Šé™¤ |

---

## 15.2 ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/events/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import Link from 'next/link';
import { Calendar, MapPin, Users, Plus } from 'lucide-react';

export default async function EventsPage() {
  const session = await auth();

  // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆæ–°ã—ã„é †ï¼‰
  const events = await prisma.event.findMany({
    include: {
      author: {
        select: {
          id: true,
          name: true,
          image: true,
        },
      },
      participations: {
        include: {
          user: {
            select: {
              id: true,
              name: true,
              image: true,
            },
          },
        },
      },
    },
    orderBy: {
      date: 'asc', // æ—¥ä»˜ã®æ—©ã„é †
    },
  });

  // éå»ã¨æœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã«åˆ†ã‘ã‚‹
  const now = new Date();
  const upcomingEvents = events.filter((event) => new Date(event.date) >= now);
  const pastEvents = events.filter((event) => new Date(event.date) < now);

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">ã‚¤ãƒ™ãƒ³ãƒˆ</h1>
            <p className="text-gray-600 mt-2">
              ãƒ©ã‚¤ãƒ–ã‚„ãƒªãƒãƒ¼ã‚µãƒ«ã®äºˆå®šã‚’ç®¡ç†
            </p>
          </div>

          {/* æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
          {session?.user?.role === 'admin' && (
            <Link
              href="/events/new"
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
            >
              <Plus size={20} />
              æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆ
            </Link>
          )}
        </div>

        {/* ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆ */}
        <section className="mb-12">
          <h2 className="text-2xl font-bold text-gray-900 mb-6">
            ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆ ({upcomingEvents.length})
          </h2>

          {upcomingEvents.length === 0 ? (
            <div className="bg-white rounded-lg shadow p-12 text-center">
              <p className="text-gray-500 text-lg">
                äºˆå®šã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“
              </p>
              {session?.user?.role === 'admin' && (
                <Link
                  href="/events/new"
                  className="inline-block mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ
                </Link>
              )}
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {upcomingEvents.map((event) => (
                <EventCard key={event.id} event={event} session={session} />
              ))}
            </div>
          )}
        </section>

        {/* éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆ */}
        {pastEvents.length > 0 && (
          <section>
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆ ({pastEvents.length})
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {pastEvents.map((event) => (
                <EventCard
                  key={event.id}
                  event={event}
                  session={session}
                  isPast
                />
              ))}
            </div>
          </section>
        )}
      </div>
    </div>
  );
}

// ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function EventCard({
  event,
  session,
  isPast = false,
}: {
  event: any;
  session: any;
  isPast?: boolean;
}) {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ç™»éŒ²ã—ã¦ã„ã‚‹ã‹
  const isParticipating = session?.user
    ? event.participations.some(
        (p: any) => p.userId === session.user.id
      )
    : false;

  return (
    <Link
      href={`/events/${event.id}`}
      className={`
        bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden
        ${isPast ? 'opacity-75' : ''}
      `}
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè‰²ä»˜ãï¼‰ */}
      <div
        className={`
          p-4
          ${isPast ? 'bg-gray-500' : 'bg-gradient-to-r from-purple-600 to-blue-600'}
          text-white
        `}
      >
        <h3 className="text-xl font-semibold mb-2">{event.title}</h3>
        <div className="flex items-center gap-2 text-sm">
          <Calendar size={16} />
          <span>
            {new Date(event.date).toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })}
          </span>
        </div>
      </div>

      {/* æœ¬æ–‡ */}
      <div className="p-4">
        {/* å ´æ‰€ */}
        {event.location && (
          <div className="flex items-center gap-2 text-gray-600 mb-3">
            <MapPin size={16} />
            <span>{event.location}</span>
          </div>
        )}

        {/* èª¬æ˜ */}
        {event.description && (
          <p className="text-gray-700 text-sm mb-4 line-clamp-3">
            {event.description}
          </p>
        )}

        {/* å‚åŠ è€…æ•° */}
        <div className="flex items-center justify-between pt-4 border-t border-gray-200">
          <div className="flex items-center gap-2 text-gray-600">
            <Users size={18} />
            <span className="font-medium">
              {event.participations.length}åå‚åŠ 
            </span>
          </div>

          {/* å‚åŠ çŠ¶æ…‹ãƒãƒƒã‚¸ */}
          {isParticipating && (
            <span className="px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full">
              å‚åŠ äºˆå®š
            </span>
          )}
        </div>
      </div>
    </Link>
  );
}
```

**ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®ç‰¹å¾´:**

1. âœ… **éå»ã¨æœªæ¥ã®åˆ†é¡**: ä»Šå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆã¨éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ†ã‘ã¦è¡¨ç¤º
2. âœ… **ã‚«ãƒ¼ãƒ‰å½¢å¼**: ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã§è¦–è¦šçš„ã«é­…åŠ›çš„
3. âœ… **å‚åŠ çŠ¶æ…‹è¡¨ç¤º**: è‡ªåˆ†ãŒå‚åŠ äºˆå®šã®ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒãƒƒã‚¸è¡¨ç¤º
4. âœ… **ç®¡ç†è€…ã®ã¿ä½œæˆ**: æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆãƒœã‚¿ãƒ³ã¯ç®¡ç†è€…ã®ã¿è¡¨ç¤º

### Step 2: å‹•ä½œç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000/events ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚

â†’ âœ… ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ï¼ˆã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ç©ºã®çŠ¶æ…‹ï¼‰

---

## 15.3 ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆæ©Ÿèƒ½ã®å®Ÿè£…

### Step 1: ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆAPIã‚’å®Ÿè£…

`src/app/api/events/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§å–å¾—ï¼ˆGETï¼‰
 */
export async function GET() {
  try {
    const events = await prisma.event.findMany({
      include: {
        author: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
        participations: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                image: true,
              },
            },
          },
        },
      },
      orderBy: {
        date: 'asc',
      },
    });

    return NextResponse.json({ events });
  } catch (error) {
    console.error('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆï¼ˆPOSTï¼‰
 */
export async function POST(request: Request) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' },
        { status: 403 }
      );
    }

    const body = await request.json();
    const { title, description, date, location } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!title || !date) {
      return NextResponse.json(
        { error: 'ã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥æ™‚ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // æ—¥æ™‚ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const eventDate = new Date(date);
    if (isNaN(eventDate.getTime())) {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªæ—¥æ™‚ã§ã™' },
        { status: 400 }
      );
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ
    const event = await prisma.event.create({
      data: {
        title,
        description: description || null,
        date: eventDate,
        location: location || null,
        authorId: session.user.id,
      },
      include: {
        author: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
        participations: true,
      },
    });

    return NextResponse.json({ event }, { status: 201 });
  } catch (error) {
    console.error('ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/events/new/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { EventForm } from '@/components/EventForm';

export default async function NewEventPage() {
  const session = await auth();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session) {
    redirect('/auth/signin');
  }

  // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
  if (session.user?.role !== 'admin') {
    redirect('/events');
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">
          æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        </h1>
        
        <EventForm />
      </div>
    </div>
  );
}
```

### Step 3: ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/EventForm.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/Button';

interface EventFormProps {
  initialData?: {
    id: string;
    title: string;
    description: string | null;
    date: Date;
    location: string | null;
  };
}

export function EventForm({ initialData }: EventFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [title, setTitle] = useState(initialData?.title || '');
  const [description, setDescription] = useState(
    initialData?.description || ''
  );
  const [date, setDate] = useState(
    initialData?.date
      ? new Date(initialData.date).toISOString().slice(0, 16)
      : ''
  );
  const [location, setLocation] = useState(initialData?.location || '');

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!title.trim()) {
        setError('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        setLoading(false);
        return;
      }

      if (!date) {
        setError('æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„');
        setLoading(false);
        return;
      }

      const url = initialData
        ? `/api/events/${initialData.id}`
        : '/api/events';
      
      const method = initialData ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title.trim(),
          description: description.trim() || null,
          date: new Date(date).toISOString(),
          location: location.trim() || null,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || 'ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push(`/events/${data.event.id}`);
      router.refresh();
    } catch (err) {
      setError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6">
      {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
          {error}
        </div>
      )}

      {/* ã‚¿ã‚¤ãƒˆãƒ« */}
      <div className="mb-6">
        <label
          htmlFor="title"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          ã‚¿ã‚¤ãƒˆãƒ« <span className="text-red-500">*</span>
        </label>
        <input
          id="title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ä¾‹: 12æœˆå®šæœŸãƒ©ã‚¤ãƒ–"
          required
        />
      </div>

      {/* æ—¥æ™‚ */}
      <div className="mb-6">
        <label
          htmlFor="date"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          æ—¥æ™‚ <span className="text-red-500">*</span>
        </label>
        <input
          id="date"
          type="datetime-local"
          value={date}
          onChange={(e) => setDate(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
        <p className="mt-2 text-sm text-gray-500">
          ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„
        </p>
      </div>

      {/* å ´æ‰€ */}
      <div className="mb-6">
        <label
          htmlFor="location"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          å ´æ‰€
        </label>
        <input
          id="location"
          type="text"
          value={location}
          onChange={(e) => setLocation(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ä¾‹: å¸‚æ°‘ä¼šé¤¨ å¤§ãƒ›ãƒ¼ãƒ«"
        />
      </div>

      {/* èª¬æ˜ */}
      <div className="mb-6">
        <label
          htmlFor="description"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          èª¬æ˜
        </label>
        <textarea
          id="description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          rows={5}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ã‚„æ³¨æ„äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
        />
      </div>

      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <Button
          type="submit"
          variant="primary"
          loading={loading}
          className="flex-1"
        >
          {initialData ? 'æ›´æ–°' : 'ä½œæˆ'}
        </Button>
        
        <Button
          type="button"
          variant="outline"
          onClick={() => router.back()}
          disabled={loading}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
      </div>
    </form>
  );
}
```

**EventFormã®ç‰¹å¾´:**

1. âœ… **datetime-local**: HTML5ã®datetime-local inputã‚’ä½¿ç”¨
2. âœ… **ISOå½¢å¼**: ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹éš›ã¯ISOå½¢å¼ã«å¤‰æ›
3. âœ… **ä»»æ„é …ç›®**: èª¬æ˜ã¨å ´æ‰€ã¯ä»»æ„
4. âœ… **ç·¨é›†å¯¾å¿œ**: initialDataãŒã‚ã‚Œã°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰

### Step 4: å‹•ä½œç¢ºèª

**4-1.** ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³

**4-2.** http://localhost:3000/events/new ã‚’é–‹ã

**4-3.** ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›

```
ã‚¿ã‚¤ãƒˆãƒ«: 12æœˆå®šæœŸãƒ©ã‚¤ãƒ–
æ—¥æ™‚: 2024-12-25 18:00
å ´æ‰€: å¸‚æ°‘ä¼šé¤¨
èª¬æ˜: å¹´æœ«ã®å®šæœŸãƒ©ã‚¤ãƒ–ã§ã™
```

**4-4.** ã€Œä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… ã‚¤ãƒ™ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã€è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ï¼

---

## 15.4 ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/events/[id]/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { Calendar, MapPin, Users, Edit, Trash2, FileText } from 'lucide-react';
import { ParticipationButton } from '@/components/ParticipationButton';
import { DeleteEventButton } from '@/components/DeleteEventButton';
import { CreatePostFromEventButton } from '@/components/CreatePostFromEventButton';

export default async function EventDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const session = await auth();

  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
  const event = await prisma.event.findUnique({
    where: { id: params.id },
    include: {
      author: true,
      participations: {
        include: {
          user: true,
        },
        orderBy: {
          createdAt: 'asc',
        },
      },
      posts: {
        select: {
          id: true,
          title: true,
          createdAt: true,
        },
      },
    },
  });

  if (!event) {
    notFound();
  }

  // ç·¨é›†ãƒ»å‰Šé™¤æ¨©é™ï¼ˆä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ï¼‰
  const canEdit =
    session?.user?.id === event.authorId ||
    session?.user?.role === 'admin';

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ç™»éŒ²ã—ã¦ã„ã‚‹ã‹
  const isParticipating = session?.user
    ? event.participations.some((p) => p.userId === session.user.id)
    : false;

  // ã‚¤ãƒ™ãƒ³ãƒˆãŒéå»ã‹ã©ã†ã‹
  const isPast = new Date(event.date) < new Date();

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <Link
          href="/events"
          className="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6"
        >
          â† ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹
        </Link>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */}
        <article className="bg-white rounded-lg shadow-lg overflow-hidden">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ï¼‰ */}
          <div
            className={`
              p-6
              ${isPast ? 'bg-gray-500' : 'bg-gradient-to-r from-purple-600 to-blue-600'}
              text-white
            `}
          >
            <div className="flex justify-between items-start">
              <div className="flex-1">
                <h1 className="text-3xl font-bold mb-4">{event.title}</h1>

                {/* ãƒ¡ã‚¿æƒ…å ± */}
                <div className="space-y-2">
                  {/* æ—¥æ™‚ */}
                  <div className="flex items-center gap-2">
                    <Calendar size={20} />
                    <span className="text-lg">
                      {new Date(event.date).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                      })}
                    </span>
                  </div>

                  {/* å ´æ‰€ */}
                  {event.location && (
                    <div className="flex items-center gap-2">
                      <MapPin size={20} />
                      <span className="text-lg">{event.location}</span>
                    </div>
                  )}

                  {/* å‚åŠ è€…æ•° */}
                  <div className="flex items-center gap-2">
                    <Users size={20} />
                    <span className="text-lg">
                      {event.participations.length}åå‚åŠ 
                    </span>
                  </div>
                </div>
              </div>

              {/* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */}
              {canEdit && (
                <div className="flex gap-2">
                  <Link
                    href={`/events/${event.id}/edit`}
                    className="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors flex items-center gap-1"
                  >
                    <Edit size={18} />
                    <span>ç·¨é›†</span>
                  </Link>
                  <DeleteEventButton eventId={event.id} />
                </div>
              )}
            </div>
          </div>

          {/* æœ¬æ–‡ */}
          <div className="p-6">
            {/* èª¬æ˜ */}
            {event.description && (
              <div className="mb-6">
                <h2 className="text-xl font-semibold text-gray-900 mb-3">
                  è©³ç´°
                </h2>
                <p className="text-gray-700 whitespace-pre-wrap">
                  {event.description}
                </p>
              </div>
            )}

            {/* å‚åŠ ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰ */}
            {session?.user && !isPast && (
              <div className="mb-6 pb-6 border-b border-gray-200">
                <ParticipationButton
                  eventId={event.id}
                  isParticipating={isParticipating}
                />
              </div>
            )}

            {/* æ´»å‹•å ±å‘Šä½œæˆãƒœã‚¿ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå¾Œã€ç®¡ç†è€…ã®ã¿ï¼‰ */}
            {isPast && canEdit && (
              <div className="mb-6 pb-6 border-b border-gray-200">
                <CreatePostFromEventButton event={event} />
              </div>
            )}

            {/* ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»å‹•å ±å‘Š */}
            {event.posts.length > 0 && (
              <div className="mb-6 pb-6 border-b border-gray-200">
                <h2 className="text-xl font-semibold text-gray-900 mb-4">
                  ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»å‹•å ±å‘Š
                </h2>
                <div className="space-y-3">
                  {event.posts.map((post) => (
                    <Link
                      key={post.id}
                      href={`/posts/${post.id}`}
                      className="flex items-center gap-3 p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors"
                    >
                      <FileText size={20} className="text-blue-600" />
                      <div>
                        <p className="font-medium text-gray-900">
                          {post.title}
                        </p>
                        <p className="text-sm text-gray-500">
                          {new Date(post.createdAt).toLocaleDateString('ja-JP')}
                        </p>
                      </div>
                    </Link>
                  ))}
                </div>
              </div>
            )}

            {/* å‚åŠ è€…ä¸€è¦§ */}
            <div>
              <h2 className="text-xl font-semibold text-gray-900 mb-4">
                å‚åŠ è€… ({event.participations.length}å)
              </h2>

              {event.participations.length === 0 ? (
                <p className="text-gray-500 text-center py-8">
                  ã¾ã å‚åŠ è€…ãŒã„ã¾ã›ã‚“
                </p>
              ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                  {event.participations.map((participation) => (
                    <div
                      key={participation.id}
                      className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg"
                    >
                      {/* ã‚¢ãƒã‚¿ãƒ¼ */}
                      {participation.user.image ? (
                        <Image
                          src={participation.user.image}
                          alt={participation.user.name || ''}
                          width={40}
                          height={40}
                          className="rounded-full"
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold">
                          {participation.user.name?.charAt(0) || 'U'}
                        </div>
                      )}

                      {/* åå‰ */}
                      <span className="font-medium text-gray-900">
                        {participation.user.name}
                      </span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </article>
      </div>
    </div>
  );
}
```

### Step 2: å‚åŠ ç™»éŒ²ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/ParticipationButton.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { UserCheck, UserX } from 'lucide-react';
import { Button } from '@/components/ui/Button';

interface ParticipationButtonProps {
  eventId: string;
  isParticipating: boolean;
}

export function ParticipationButton({
  eventId,
  isParticipating: initialIsParticipating,
}: ParticipationButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [isParticipating, setIsParticipating] = useState(
    initialIsParticipating
  );
  const [isLoading, setIsLoading] = useState(false);

  const handleToggle = async () => {
    setIsLoading(true);

    try {
      const response = await fetch(`/api/events/${eventId}/participate`, {
        method: 'POST',
      });

      if (!response.ok) {
        throw new Error('å‚åŠ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      setIsParticipating(data.isParticipating);

      // ãƒšãƒ¼ã‚¸ã‚’å†æ¤œè¨¼
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      alert('å‚åŠ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Button
      onClick={handleToggle}
      variant={isParticipating ? 'outline' : 'primary'}
      loading={isLoading || isPending}
      className="w-full sm:w-auto"
    >
      {isParticipating ? (
        <>
          <UserX size={20} className="mr-2" />
          å‚åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </>
      ) : (
        <>
          <UserCheck size={20} className="mr-2" />
          å‚åŠ ã™ã‚‹
        </>
      )}
    </Button>
  );
}
```

### Step 3: å‚åŠ ç™»éŒ²APIã‚’å®Ÿè£…

`src/app/api/events/[id]/participate/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * å‚åŠ ç™»éŒ²ã®ãƒˆã‚°ãƒ«å‡¦ç†ï¼ˆPOSTï¼‰
 */
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const eventId = params.id;
    const userId = session.user.id;

    // ã‚¤ãƒ™ãƒ³ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const event = await prisma.event.findUnique({
      where: { id: eventId },
    });

    if (!event) {
      return NextResponse.json(
        { error: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ã™ã§ã«å‚åŠ ç™»éŒ²ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const existingParticipation = await prisma.participation.findUnique({
      where: {
        userId_eventId: {
          userId,
          eventId,
        },
      },
    });

    if (existingParticipation) {
      // å‚åŠ ç™»éŒ²æ¸ˆã¿ â†’ å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
      await prisma.participation.delete({
        where: {
          id: existingParticipation.id,
        },
      });

      return NextResponse.json({
        isParticipating: false,
      });
    } else {
      // å‚åŠ ç™»éŒ²ã—ã¦ã„ãªã„ â†’ è¿½åŠ 
      await prisma.participation.create({
        data: {
          userId,
          eventId,
        },
      });

      return NextResponse.json({
        isParticipating: true,
      });
    }
  } catch (error) {
    console.error('å‚åŠ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'å‚åŠ ç™»éŒ²ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 4: å‰Šé™¤ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/DeleteEventButton.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'use';
import { useRouter } from 'next/navigation';
import { Trash2 } from 'lucide-react';

export function DeleteEventButton({ eventId }: { eventId: string }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const handleDelete = async () => {
    if (!confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
      return;
    }

    setLoading(true);

    try {
      const response = await fetch(`/api/events/${eventId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
        return;
      }

      // ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push('/events');
      router.refresh();
    } catch (error) {
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleDelete}
      disabled={loading}
      className="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors flex items-center gap-1 disabled:opacity-50"
    >
      <Trash2 size={18} />
      <span>{loading ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤'}</span>
    </button>
  );
}
```

### Step 5: ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ãƒ»å‰Šé™¤APIã‚’å®Ÿè£…

`src/app/api/events/[id]/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ï¼ˆPUTï¼‰
 */
export async function PUT(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const event = await prisma.event.findUnique({
      where: { id: params.id },
    });

    if (!event) {
      return NextResponse.json(
        { error: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (
      event.authorId !== session.user.id &&
      session.user.role !== 'admin'
    ) {
      return NextResponse.json(
        { error: 'ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    const body = await request.json();
    const { title, description, date, location } = body;

    if (!title || !date) {
      return NextResponse.json(
        { error: 'ã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥æ™‚ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    const eventDate = new Date(date);
    if (isNaN(eventDate.getTime())) {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªæ—¥æ™‚ã§ã™' },
        { status: 400 }
      );
    }

    const updatedEvent = await prisma.event.update({
      where: { id: params.id },
      data: {
        title,
        description: description || null,
        date: eventDate,
        location: location || null,
      },
      include: {
        author: true,
        participations: {
          include: {
            user: true,
          },
        },
      },
    });

    return NextResponse.json({ event: updatedEvent });
  } catch (error) {
    console.error('ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚¤ãƒ™ãƒ³ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}

/**
 * ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ï¼ˆDELETEï¼‰
 */
export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const event = await prisma.event.findUnique({
      where: { id: params.id },
    });

    if (!event) {
      return NextResponse.json(
        { error: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (
      event.authorId !== session.user.id &&
      session.user.role !== 'admin'
    ) {
      return NextResponse.json(
        { error: 'å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' },
        { status: 403 }
      );
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
    await prisma.event.delete({
      where: { id: params.id },
    });

    return NextResponse.json({ message: 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ' });
  } catch (error) {
    console.error('ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 6: å‹•ä½œç¢ºèª

**å‚åŠ ç™»éŒ²:**
1. ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œå‚åŠ ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
â†’ âœ… ãƒœã‚¿ãƒ³ãŒã€Œå‚åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã«å¤‰ã‚ã‚Šã€å‚åŠ è€…ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼

**å‚åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«:**
2. ã€Œå‚åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
â†’ âœ… ãƒœã‚¿ãƒ³ãŒã€Œå‚åŠ ã™ã‚‹ã€ã«æˆ»ã‚Šã€å‚åŠ è€…ä¸€è¦§ã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹ï¼

---

## 15.5 ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›

ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†å¾Œã€ãã®ã‚¤ãƒ™ãƒ³ãƒˆã®æƒ…å ±ã‚’ä½¿ã£ã¦æ´»å‹•å ±å‘Šã‚’ç°¡å˜ã«ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### Step 1: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

`src/components/CreatePostFromEventButton.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { FileText } from 'lucide-react';
import { Button } from '@/components/ui/Button';

interface CreatePostFromEventButtonProps {
  event: {
    id: string;
    title: string;
    description: string | null;
    date: Date;
    location: string | null;
    participations: any[];
  };
}

export function CreatePostFromEventButton({
  event,
}: CreatePostFromEventButtonProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const handleCreate = () => {
    // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æŠ•ç¨¿ä½œæˆãƒšãƒ¼ã‚¸ã«æ¸¡ã™
    const params = new URLSearchParams({
      eventId: event.id,
      title: `ã€æ´»å‹•å ±å‘Šã€‘${event.title}`,
      content: createTemplateContent(event),
    });

    router.push(`/posts/new?${params.toString()}`);
  };

  return (
    <Button
      onClick={handleCreate}
      variant="primary"
      loading={loading}
      className="w-full sm:w-auto"
    >
      <FileText size={20} className="mr-2" />
      ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»å‹•å ±å‘Šã‚’ä½œæˆ
    </Button>
  );
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœ¬æ–‡ã‚’ç”Ÿæˆ
function createTemplateContent(event: any): string {
  const date = new Date(event.date).toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  let content = `${date}ã«é–‹å‚¬ã•ã‚ŒãŸã€Œ${event.title}ã€ã®æ´»å‹•å ±å‘Šã§ã™ã€‚\n\n`;

  if (event.location) {
    content += `ã€é–‹å‚¬å ´æ‰€ã€‘\n${event.location}\n\n`;
  }

  content += `ã€å‚åŠ è€…ã€‘\n${event.participations.length}å\n\n`;

  if (event.description) {
    content += `ã€ã‚¤ãƒ™ãƒ³ãƒˆæ¦‚è¦ã€‘\n${event.description}\n\n`;
  }

  content += `ã€æ´»å‹•å†…å®¹ã€‘\nï¼ˆã“ã“ã«æ´»å‹•ã®æ§˜å­ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼‰\n\n`;
  content += `ã€æ„Ÿæƒ³ã€‘\nï¼ˆã“ã“ã«æ„Ÿæƒ³ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼‰`;

  return content;
}
```

### Step 2: æŠ•ç¨¿ä½œæˆãƒšãƒ¼ã‚¸ã§ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹

`src/app/posts/new/page.tsx` ã‚’é–‹ã„ã¦ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ã‚‡ã†ã€‚

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { PostForm } from '@/components/PostForm';

export default async function NewPostPage({
  searchParams,
}: {
  searchParams: { [key: string]: string | string[] | undefined };
}) {
  const session = await auth();

  if (!session) {
    redirect('/auth/signin');
  }

  if (session.user?.role !== 'admin') {
    redirect('/posts');
  }

  // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
  const eventId = searchParams.eventId as string | undefined;
  const templateTitle = searchParams.title as string | undefined;
  const templateContent = searchParams.content as string | undefined;

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">
          æ–°è¦æŠ•ç¨¿
        </h1>
        
        <PostForm
          eventId={eventId}
          templateTitle={templateTitle}
          templateContent={templateContent}
        />
      </div>
    </div>
  );
}
```

### Step 3: PostFormã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ›´æ–°

`src/components/PostForm.tsx` ã‚’é–‹ã„ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚

propsã«ä»¥ä¸‹ã‚’è¿½åŠ :

```typescript
interface PostFormProps {
  eventId?: string;
  templateTitle?: string;
  templateContent?: string;
  initialData?: {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
  };
}

export function PostForm({
  eventId,
  templateTitle,
  templateContent,
  initialData,
}: PostFormProps) {
  // ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®š
  const [title, setTitle] = useState(
    initialData?.title || templateTitle || ''
  );
  const [content, setContent] = useState(
    initialData?.content || templateContent || ''
  );
  
  // ... æ®‹ã‚Šã®æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
```

ãã—ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«eventIdã‚‚é€ä¿¡:

```typescript
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title.trim(),
          content: content.trim(),
          youtubeUrls: validYoutubeUrls,
          images: imageUrls,
          eventId: eventId || null, // è¿½åŠ 
        }),
      });
```

### Step 4: å‹•ä½œç¢ºèª

**4-1.** éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã

**4-2.** ã€Œã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»å‹•å ±å‘Šã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… æŠ•ç¨¿ä½œæˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§åŸ‹ã¾ã£ã¦ã„ã‚‹ï¼

**4-3.** å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦æŠ•ç¨¿

â†’ âœ… ã‚¤ãƒ™ãƒ³ãƒˆã¨ç´ã¥ã„ãŸæŠ•ç¨¿ãŒä½œæˆã•ã‚Œã‚‹ï¼

---

## 15.6 ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Chapter 15ã®å†…å®¹ã‚’ç†è§£ã§ããŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

- [ ] Eventãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚’ç†è§£ã—ãŸ
- [ ] Participationãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚’ç†è§£ã—ãŸ
- [ ] @@uniqueåˆ¶ç´„ã‚’ç†è§£ã—ãŸ
- [ ] ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’ç†è§£ã—ãŸ

### ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] éå»ã¨æœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ†ã‘ã¦è¡¨ç¤ºã§ãã‚‹
- [ ] ã‚«ãƒ¼ãƒ‰å½¢å¼ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] å‚åŠ çŠ¶æ…‹ã®ãƒãƒƒã‚¸ã‚’è¡¨ç¤ºã§ãã‚‹

### ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆAPIã‚’å®Ÿè£…ã§ãã‚‹
- [ ] datetime-local inputã‚’ä½¿ç”¨ã§ãã‚‹
- [ ] ISOå½¢å¼ã§ã®æ—¥æ™‚ã®æ‰±ã„ã‚’ç†è§£ã—ãŸ
- [ ] EventFormã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã§ãã‚‹

### ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] å‚åŠ ç™»éŒ²ãƒˆã‚°ãƒ«æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] å‚åŠ è€…ä¸€è¦§ã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã‚‹

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‹ã‚‰æŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã§ãã‚‹
- [ ] ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã›ã‚‹
- [ ] æŠ•ç¨¿ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç´ã¥ã‘ã‚‰ã‚Œã‚‹

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆCRUDï¼ˆä½œæˆãƒ»èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼‰
- âœ… datetime-local inputã®ä½¿ç”¨
- âœ… æ—¥æ™‚ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ï¼ˆDate, ISOå½¢å¼ï¼‰
- âœ… éå»ã¨æœªæ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆåˆ†é¡

#### å‚åŠ ç™»éŒ²
- âœ… å‚åŠ ç™»éŒ²ã®ãƒˆã‚°ãƒ«å‡¦ç†
- âœ… @@uniqueåˆ¶ç´„ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢
- âœ… å‚åŠ è€…ä¸€è¦§ã®è¡¨ç¤º
- âœ… å‚åŠ çŠ¶æ…‹ã®ç¢ºèª

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‹ã‚‰æŠ•ç¨¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
- âœ… ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆã¨æŠ•ç¨¿ã®ç´ã¥ã‘

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### æ—¥æ™‚ã®æ‰±ã„æ–¹

```typescript
// HTML5ã®datetime-local input
<input type="datetime-local" value="2024-12-25T18:00" />

// ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹éš›ã¯ISOå½¢å¼ã«å¤‰æ›
const eventDate = new Date(date).toISOString();
// â†’ "2024-12-25T09:00:00.000Z" (UTC)

// è¡¨ç¤ºã™ã‚‹éš›ã¯æ—¥æœ¬èªå½¢å¼ã«
new Date(event.date).toLocaleDateString('ja-JP', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
});
// â†’ "2024å¹´12æœˆ25æ—¥ 18:00"
```

#### ãƒˆã‚°ãƒ«å‡¦ç†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// ã„ã„ã­ã€å‚åŠ ç™»éŒ²ãªã©ã®ãƒˆã‚°ãƒ«å‡¦ç†ã®å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³
const existing = await prisma.xxx.findUnique({
  where: { userId_postId: { userId, postId } },
});

if (existing) {
  // ã‚ã‚Œã°å‰Šé™¤
  await prisma.xxx.delete({ where: { id: existing.id } });
  return { status: false };
} else {
  // ãªã‘ã‚Œã°è¿½åŠ 
  await prisma.xxx.create({ data: { userId, postId } });
  return { status: true };
}
```

### ğŸš€ æ¬¡ã®ç« ã¸ã®æº–å‚™

æ¬¡ã®ç« ï¼ˆChapter 16: æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ï¼‰ã§ã¯ã€ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š

1. **æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç®¡ç†**
   - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
   - æ—¥æ™‚ãƒ»å ´æ‰€ã®è¨­å®š
   - åœ°å›³ãƒªãƒ³ã‚¯ã®è¨­å®š

2. **å‚åŠ ç™»éŒ²æ©Ÿèƒ½**
   - å‚åŠ /ä¸å‚åŠ ã®ç™»éŒ²
   - å‚åŠ è€…ä¸€è¦§ã®è¡¨ç¤º

3. **æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›**
   - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ã®æ´»ç”¨
   - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã®å¼•ãç¶™ã

**æº–å‚™ã™ã‚‹ã“ã¨:**
- âœ… ã‚¤ãƒ™ãƒ³ãƒˆæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… å‚åŠ ç™»éŒ²æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ç†è§£

---

[â† å‰ã®ç« ï¼šç¬¬14ç«  ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…](14-ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬16ç«  æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£… â†’](16-æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£….md)
