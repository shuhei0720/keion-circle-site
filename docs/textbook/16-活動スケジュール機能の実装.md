# ç¬¬16ç« ï¼šæ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…

> **ã“ã®ç« ã§ã¯ã€æ´»å‹•ã®æ—¥ç¨‹ã‚’ç®¡ç†ã™ã‚‹æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™**

## ğŸ“š ã“ã®ç« ã§å­¦ã¶ã“ã¨

- âœ… æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
- âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ãƒ»è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½
- âœ… å‚åŠ ç™»éŒ²æ©Ÿèƒ½
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- âœ… æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ï¼‰
- âœ… åœ°å›³ãƒªãƒ³ã‚¯ã®æ´»ç”¨

## ğŸ’¡ ã“ã®ç« ã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å…¨ä½“åƒ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç®¡ç†è€…ãŒä½œæˆã€‘
æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆ
  - ã‚¿ã‚¤ãƒˆãƒ«
  - æ—¥æ™‚
  - å ´æ‰€ï¼ˆåœ°å›³ãƒªãƒ³ã‚¯ä»˜ãï¼‰
  - å†…å®¹ï¼ˆMarkdownå¯¾å¿œï¼‰
   â†“
ã€ãƒ¡ãƒ³ãƒãƒ¼ãŒå‚åŠ ç™»éŒ²ã€‘
å‚åŠ ã™ã‚‹/ã—ãªã„ã‚’è¡¨æ˜
   â†“
ã€ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã€‘
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ
   â†“
ã€æ´»å‹•å ±å‘Šã¸å¤‰æ›ã€‘
ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦
æ´»å‹•å ±å‘Šã‚’ä½œæˆ


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¸ 12æœˆãƒ©ã‚¤ãƒ–ç·´ç¿’                 â”‚
â”‚  ğŸ“… 2025/12/25(æ°´) 18:00          â”‚
â”‚  ğŸ“ ã‚¹ã‚¿ã‚¸ã‚ªABC                    â”‚
â”‚      ğŸ—ºï¸ åœ°å›³ã‚’è¦‹ã‚‹                â”‚
â”‚                                    â”‚
â”‚  å†…å®¹:                             â”‚
â”‚  æ¬¡å›ãƒ©ã‚¤ãƒ–ã«å‘ã‘ãŸç·´ç¿’ã§ã™...     â”‚
â”‚                                    â”‚
â”‚  ğŸ‘¥ å‚åŠ è€… (8å)                   â”‚
â”‚  [ã‚ãªãŸã®å‚åŠ çŠ¶æ…‹: å‚åŠ ä¸­]        â”‚
â”‚  [å‚åŠ ç™»éŒ²] [å‚åŠ å–æ¶ˆ]             â”‚
â”‚                                    â”‚
â”‚  ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ (3ä»¶)                 â”‚
â”‚  â”” ç”°ä¸­: æ¥½ã—ã¿ã§ã™ï¼              â”‚
â”‚                                    â”‚
â”‚  ğŸ“ ã“ã®å†…å®¹ã§æ´»å‹•å ±å‘Šã‚’ä½œæˆ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 16.1 æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª

### Prismaã‚¹ã‚­ãƒ¼ãƒ

ã™ã§ã« `prisma/schema.prisma` ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```prisma
// æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½
model ActivitySchedule {
  id          String   @id @default(cuid())
  title       String
  content     String?  // å†…å®¹ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
  date        DateTime?
  location    String?  // é–‹å‚¬å ´æ‰€å
  locationUrl String?  // é–‹å‚¬å ´æ‰€URLï¼ˆGoogle Mapsãªã©ï¼‰
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  participants ActivityParticipant[]
  comments    Comment[]  // ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ï¼ˆæŠ•ç¨¿ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå…±é€šï¼‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ActivityParticipant {
  id                  String            @id @default(cuid())
  activityScheduleId  String
  userId              String
  activitySchedule    ActivitySchedule  @relation(fields: [activityScheduleId], references: [id], onDelete: Cascade)
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt           DateTime          @default(now())

  @@unique([activityScheduleId, userId])
}

// ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯ãªã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ‡ãƒ«
// æŠ•ç¨¿ã€æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚¤ãƒ™ãƒ³ãƒˆã§å…±é€šåˆ©ç”¨
model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ä»¥ä¸‹ã®ã„ãšã‚Œã‹1ã¤ã ã‘ã«å€¤ãŒå…¥ã‚‹
  postId              String?
  activityScheduleId  String?
  eventId             String?
  
  post              Post?              @relation(fields: [postId], references: [id], onDelete: Cascade)
  activitySchedule  ActivitySchedule?  @relation(fields: [activityScheduleId], references: [id], onDelete: Cascade)
  event             Event?             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**é‡è¦ï¼šãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ã«ã¤ã„ã¦**

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€1ã¤ã®`Comment`ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆæŠ•ç¨¿ã€æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã§ãã¾ã™ã€‚ã“ã‚Œã‚’ã€Œãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ã€ã¨å‘¼ã³ã¾ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆï¼š**
- ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã‚’1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§çµ±ä¸€ç®¡ç†
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¢—ãˆãªã„
- ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå…±é€šåŒ–ã§ãã‚‹

**ä»•çµ„ã¿ï¼š**
```
1ã¤ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯å¿…ãš1ã¤ã ã‘IDãŒå…¥ã‚‹ï¼š

æŠ•ç¨¿ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ      â†’ postId ã«å€¤, ä»–ã¯null
æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ â†’ activityScheduleId ã«å€¤, ä»–ã¯null
ã‚¤ãƒ™ãƒ³ãƒˆã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ    â†’ eventId ã«å€¤, ä»–ã¯null
```

**ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜:**

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `title` | String | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ« |
| `content` | String? | å†…å®¹ï¼ˆMarkdownå½¢å¼ï¼‰ |
| `date` | DateTime? | é–‹å‚¬æ—¥æ™‚ |
| `location` | String? | é–‹å‚¬å ´æ‰€å |
| `locationUrl` | String? | åœ°å›³URLï¼ˆGoogle Mapsãªã©ï¼‰ |
| `userId` | String? | ä½œæˆè€…IDï¼ˆç®¡ç†è€…ï¼‰ |
| `participants` | ActivityParticipant[] | å‚åŠ è€…ãƒªã‚¹ãƒˆ |
| `comments` | Comment[] | ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ï¼‰ |

---

## 16.2 æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/activity-schedules/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { Suspense } from 'react';
import Link from 'next/link';
import { Calendar, MapPin, Users, Plus } from 'lucide-react';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';
import { redirect } from 'next/navigation';

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—
async function getActivitySchedules() {
  return await db.activitySchedule.findMany({
    include: {
      user: {
        select: {
          id: true,
          name: true,
          avatarUrl: true,
        },
      },
      participants: {
        include: {
          user: {
            select: {
              id: true,
              name: true,
              avatarUrl: true,
            },
          },
        },
      },
      _count: {
        select: {
          comments: true,
        },
      },
    },
    orderBy: {
      date: 'desc',
    },
  });
}

export default async function ActivitySchedulesPage() {
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    redirect('/auth/signin');
  }

  const schedules = await getActivitySchedules();
  const isAdmin = session.user.role === 'admin';

  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 mb-2">æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
          <p className="text-gray-600">ä»Šå¾Œã®æ´»å‹•äºˆå®šã‚’ç¢ºèªãƒ»å‚åŠ ç™»éŒ²ã§ãã¾ã™</p>
        </div>
        
        {/* ä½œæˆãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
        {isAdmin && (
          <Link
            href="/activity-schedules/new"
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
          >
            <Plus size={20} />
            æ–°è¦ä½œæˆ
          </Link>
        )}
      </div>

      {/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ */}
      {schedules.length === 0 ? (
        <div className="text-center py-12">
          <Calendar className="mx-auto h-12 w-12 text-gray-400 mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">
            ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“
          </h3>
          <p className="text-gray-600">
            {isAdmin
              ? 'æœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†'
              : 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™'}
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          {schedules.map((schedule) => (
            <Link
              key={schedule.id}
              href={`/activity-schedules/${schedule.id}`}
              className="block bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-6"
            >
              {/* ã‚¿ã‚¤ãƒˆãƒ« */}
              <h2 className="text-xl font-bold text-gray-900 mb-3">
                {schedule.title}
              </h2>

              {/* æ—¥æ™‚ãƒ»å ´æ‰€ */}
              <div className="space-y-2 mb-4">
                {schedule.date && (
                  <div className="flex items-center gap-2 text-gray-600">
                    <Calendar size={18} />
                    <span>
                      {new Date(schedule.date).toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        weekday: 'short',
                      })}
                    </span>
                  </div>
                )}

                {schedule.location && (
                  <div className="flex items-center gap-2 text-gray-600">
                    <MapPin size={18} />
                    <span>{schedule.location}</span>
                    {schedule.locationUrl && (
                      <a
                        href={schedule.locationUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="text-blue-600 hover:text-blue-700 text-sm"
                        onClick={(e) => e.stopPropagation()}
                      >
                        ğŸ—ºï¸ åœ°å›³
                      </a>
                    )}
                  </div>
                )}
              </div>

              {/* å‚åŠ è€…æ•° */}
              <div className="flex items-center justify-between text-sm text-gray-600">
                <div className="flex items-center gap-2">
                  <Users size={18} />
                  <span>{schedule.participants.length}åå‚åŠ </span>
                </div>

                {schedule._count.comments > 0 && (
                  <span>ğŸ’¬ {schedule._count.comments}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆ</span>
                )}
              </div>
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
```

### Step 2: å‹•ä½œç¢ºèª

**2-1.** ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000/activity-schedules ã‚’é–‹ã

**2-2.** ã€Œæ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

â†’ âœ… ã¾ã ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãªã„ã®ã§ç©ºã®çŠ¶æ…‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼

---

## 16.3 æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆæ©Ÿèƒ½ã®å®Ÿè£…

### Step 1: ä½œæˆAPIã‚’å®Ÿè£…

`src/app/api/activity-schedules/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆAPI
export async function POST(req: Request) {
  try {
    const session = await getServerSession(authOptions);

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!session?.user) {
      return NextResponse.json(
        { error: 'èªè¨¼ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' },
        { status: 403 }
      );
    }

    const body = await req.json();
    const { title, content, date, location, locationUrl } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!title || title.trim().length === 0) {
      return NextResponse.json(
        { error: 'ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
    const schedule = await db.activitySchedule.create({
      data: {
        title: title.trim(),
        content: content?.trim() || null,
        date: date ? new Date(date) : null,
        location: location?.trim() || null,
        locationUrl: locationUrl?.trim() || null,
        userId: session.user.id,
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            avatarUrl: true,
          },
        },
      },
    });

    return NextResponse.json(schedule, { status: 201 });
  } catch (error) {
    console.error('Activity schedule creation error:', error);
    return NextResponse.json(
      { error: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…

`src/app/activity-schedules/new/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useSession } from 'next-auth/react';
import { Calendar, MapPin, FileText, Loader2 } from 'lucide-react';
import { MarkdownEditor } from '@/components/MarkdownEditor';

export default function NewActivitySchedulePage() {
  const router = useRouter();
  const { data: session } = useSession();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [date, setDate] = useState('');
  const [location, setLocation] = useState('');
  const [locationUrl, setLocationUrl] = useState('');

  // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
  if (session && session.user.role !== 'admin') {
    router.push('/activity-schedules');
    return null;
  }

  // ä½œæˆå‡¦ç†
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const response = await fetch('/api/activity-schedules', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title,
          content,
          date: date || null,
          location,
          locationUrl,
        }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const schedule = await response.json();
      router.push(`/activity-schedules/${schedule.id}`);
      router.refresh();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      setLoading(false);
    }
  };

  return (
    <div className="max-w-3xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">
          æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
        </h1>
        <p className="text-gray-600">
          æ–°ã—ã„æ´»å‹•äºˆå®šã‚’ä½œæˆã—ã¦ãƒ¡ãƒ³ãƒãƒ¼ã«å…±æœ‰ã—ã¾ã—ã‚‡ã†
        </p>
      </div>

      {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600">
          {error}
        </div>
      )}

      {/* ãƒ•ã‚©ãƒ¼ãƒ  */}
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* ã‚¿ã‚¤ãƒˆãƒ« */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ã‚¿ã‚¤ãƒˆãƒ« <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="ä¾‹: 12æœˆãƒ©ã‚¤ãƒ–ç·´ç¿’"
            required
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        {/* æ—¥æ™‚ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <Calendar className="inline mr-1" size={16} />
            æ—¥æ™‚
          </label>
          <input
            type="datetime-local"
            value={date}
            onChange={(e) => setDate(e.target.value)}
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        {/* å ´æ‰€ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <MapPin className="inline mr-1" size={16} />
            å ´æ‰€
          </label>
          <input
            type="text"
            value={location}
            onChange={(e) => setLocation(e.target.value)}
            placeholder="ä¾‹: ã‚¹ã‚¿ã‚¸ã‚ªABC"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        {/* åœ°å›³URL */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ğŸ—ºï¸ åœ°å›³URLï¼ˆGoogle Mapsãªã©ï¼‰
          </label>
          <input
            type="url"
            value={locationUrl}
            onChange={(e) => setLocationUrl(e.target.value)}
            placeholder="https://maps.google.com/..."
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <p className="mt-1 text-sm text-gray-500">
            Google Mapsã§å ´æ‰€ã‚’æ¤œç´¢ã—ã€ã€Œå…±æœ‰ã€ã‹ã‚‰å–å¾—ã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
          </p>
        </div>

        {/* å†…å®¹ */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <FileText className="inline mr-1" size={16} />
            å†…å®¹
          </label>
          <MarkdownEditor
            value={content}
            onChange={setContent}
            placeholder="æ´»å‹•ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..."
            minHeight="300px"
          />
        </div>

        {/* ãƒœã‚¿ãƒ³ */}
        <div className="flex gap-3">
          <button
            type="button"
            onClick={() => router.back()}
            disabled={loading}
            className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50"
          >
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button
            type="submit"
            disabled={loading || !title.trim()}
            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {loading && <Loader2 className="animate-spin" size={18} />}
            ä½œæˆ
          </button>
        </div>
      </form>
    </div>
  );
}
```

### Step 3: å‹•ä½œç¢ºèª

**3-1.** ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³

**3-2.** http://localhost:3000/activity-schedules/new ã«ã‚¢ã‚¯ã‚»ã‚¹

**3-3.** ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦ä½œæˆ

â†’ âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½œæˆã•ã‚Œã€ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼

---

## 16.4 æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: è©³ç´°å–å¾—APIã‚’å®Ÿè£…

`src/app/api/activity-schedules/[id]/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { db } from '@/lib/db';

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°å–å¾—
export async function GET(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const schedule = await db.activitySchedule.findUnique({
      where: {
        id: params.id,
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            avatarUrl: true,
          },
        },
        participants: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                avatarUrl: true,
              },
            },
          },
          orderBy: {
            createdAt: 'asc',
          },
        },
        comments: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                avatarUrl: true,
              },
            },
          },
          orderBy: {
            createdAt: 'desc',
          },
        },
      },
    });

    if (!schedule) {
      return NextResponse.json(
        { error: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    return NextResponse.json(schedule);
  } catch (error) {
    console.error('Activity schedule fetch error:', error);
    return NextResponse.json(
      { error: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: è©³ç´°ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…

`src/app/activity-schedules/[id]/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { Suspense } from 'react';
import { notFound, redirect } from 'next/navigation';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { Calendar, MapPin, Users, MessageSquare, Edit, FileText } from 'lucide-react';
import Link from 'next/link';
import { ParticipateButton } from './ParticipateButton';
import { CommentSection } from './CommentSection';
import { Avatar } from '@/components/Avatar';

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ã‚’å–å¾—
async function getActivitySchedule(id: string) {
  return await db.activitySchedule.findUnique({
    where: { id },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          avatarUrl: true,
        },
      },
      participants: {
        include: {
          user: {
            select: {
              id: true,
              name: true,
              avatarUrl: true,
            },
          },
        },
        orderBy: {
          createdAt: 'asc',
        },
      },
      comments: {
        include: {
          user: {
            select: {
              id: true,
              name: true,
              avatarUrl: true,
            },
          },
        },
        orderBy: {
          createdAt: 'desc',
        },
      },
    },
  });
}

export default async function ActivityScheduleDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    redirect('/auth/signin');
  }

  const schedule = await getActivitySchedule(params.id);

  if (!schedule) {
    notFound();
  }

  const isAdmin = session.user.role === 'admin';
  const isParticipating = schedule.participants.some(
    (p) => p.userId === session.user.id
  );

  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <div className="flex items-start justify-between mb-4">
          <h1 className="text-3xl font-bold text-gray-900">{schedule.title}</h1>
          
          {/* ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
          {isAdmin && (
            <Link
              href={`/activity-schedules/${schedule.id}/edit`}
              className="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-1"
            >
              <Edit size={16} />
              ç·¨é›†
            </Link>
          )}
        </div>

        {/* æ—¥æ™‚ãƒ»å ´æ‰€ */}
        <div className="space-y-3">
          {schedule.date && (
            <div className="flex items-center gap-2 text-gray-600">
              <Calendar size={20} />
              <span className="text-lg">
                {new Date(schedule.date).toLocaleString('ja-JP', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  weekday: 'short',
                })}
              </span>
            </div>
          )}

          {schedule.location && (
            <div className="flex items-center gap-2 text-gray-600">
              <MapPin size={20} />
              <span className="text-lg">{schedule.location}</span>
              {schedule.locationUrl && (
                <a
                  href={schedule.locationUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="ml-2 px-3 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition-colors text-sm flex items-center gap-1"
                >
                  ğŸ—ºï¸ åœ°å›³ã‚’è¦‹ã‚‹
                </a>
              )}
            </div>
          )}
        </div>
      </div>

      {/* å†…å®¹ */}
      {schedule.content && (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <FileText size={20} />
            å†…å®¹
          </h2>
          <div className="prose max-w-none">
            <ReactMarkdown remarkPlugins={[remarkGfm]}>
              {schedule.content}
            </ReactMarkdown>
          </div>
        </div>
      )}

      {/* å‚åŠ è€… */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <Users size={20} />
          å‚åŠ è€… ({schedule.participants.length}å)
        </h2>

        {/* å‚åŠ ç™»éŒ²ãƒœã‚¿ãƒ³ */}
        <div className="mb-6">
          <ParticipateButton
            scheduleId={schedule.id}
            isParticipating={isParticipating}
          />
        </div>

        {/* å‚åŠ è€…ä¸€è¦§ */}
        {schedule.participants.length > 0 ? (
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            {schedule.participants.map((participant) => (
              <Link
                key={participant.id}
                href={`/users/${participant.userId}`}
                className="flex flex-col items-center gap-2 p-3 rounded-lg hover:bg-gray-50 transition-colors"
              >
                <Avatar
                  src={participant.user.avatarUrl}
                  alt={participant.user.name || 'User'}
                  size="lg"
                />
                <span className="text-sm font-medium text-gray-700 text-center">
                  {participant.user.name || 'åç„¡ã—'}
                </span>
              </Link>
            ))}
          </div>
        ) : (
          <p className="text-gray-500 text-center py-8">
            ã¾ã å‚åŠ è€…ãŒã„ã¾ã›ã‚“
          </p>
        )}
      </div>

      {/* æ´»å‹•å ±å‘Šã¸å¤‰æ›ãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
      {isAdmin && (
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-3">æ´»å‹•å ±å‘Šã‚’ä½œæˆ</h2>
          <p className="text-gray-600 mb-4">
            ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æƒ…å ±ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ´»å‹•å ±å‘Šã‚’ä½œæˆã§ãã¾ã™
          </p>
          <Link
            href={`/activity-schedules/${schedule.id}/report`}
            className="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            <FileText size={18} />
            æ´»å‹•å ±å‘Šã‚’ä½œæˆ
          </Link>
        </div>
      )}

      {/* ã‚³ãƒ¡ãƒ³ãƒˆ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <MessageSquare size={20} />
          ã‚³ãƒ¡ãƒ³ãƒˆ ({schedule.comments.length}ä»¶)
        </h2>
        <CommentSection
          scheduleId={schedule.id}
          comments={schedule.comments}
          currentUserId={session.user.id}
        />
      </div>
    </div>
  );
}
```

---

## 16.5 å‚åŠ ç™»éŒ²æ©Ÿèƒ½ã®å®Ÿè£…

### Step 1: å‚åŠ ç™»éŒ²APIã‚’å®Ÿè£…

`src/app/api/activity-schedules/[id]/participate/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';

// å‚åŠ ç™»éŒ²/å–æ¶ˆ
export async function POST(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession(authOptions);

    if (!session?.user) {
      return NextResponse.json(
        { error: 'èªè¨¼ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const scheduleId = params.id;
    const userId = session.user.id;

    // æ—¢ã«å‚åŠ ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const existing = await db.activityParticipant.findUnique({
      where: {
        activityScheduleId_userId: {
          activityScheduleId: scheduleId,
          userId,
        },
      },
    });

    if (existing) {
      // å‚åŠ å–æ¶ˆ
      await db.activityParticipant.delete({
        where: {
          id: existing.id,
        },
      });

      return NextResponse.json({ participating: false });
    } else {
      // å‚åŠ ç™»éŒ²
      await db.activityParticipant.create({
        data: {
          activityScheduleId: scheduleId,
          userId,
        },
      });

      return NextResponse.json({ participating: true });
    }
  } catch (error) {
    console.error('Participation toggle error:', error);
    return NextResponse.json(
      { error: 'å‚åŠ ç™»éŒ²ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: å‚åŠ ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…

`src/app/activity-schedules/[id]/ParticipateButton.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Check, X, Loader2 } from 'lucide-react';

interface ParticipateButtonProps {
  scheduleId: string;
  isParticipating: boolean;
}

export function ParticipateButton({
  scheduleId,
  isParticipating: initialIsParticipating,
}: ParticipateButtonProps) {
  const router = useRouter();
  const [isParticipating, setIsParticipating] = useState(initialIsParticipating);
  const [loading, setLoading] = useState(false);

  const handleToggle = async () => {
    setLoading(true);

    try {
      const response = await fetch(`/api/activity-schedules/${scheduleId}/participate`, {
        method: 'POST',
      });

      if (!response.ok) {
        throw new Error('å‚åŠ ç™»éŒ²ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const data = await response.json();
      setIsParticipating(data.participating);
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleToggle}
      disabled={loading}
      className={`
        w-full sm:w-auto px-6 py-2 rounded-lg font-semibold transition-colors
        flex items-center justify-center gap-2
        disabled:opacity-50 disabled:cursor-not-allowed
        ${
          isParticipating
            ? 'bg-red-100 text-red-600 hover:bg-red-200'
            : 'bg-green-600 text-white hover:bg-green-700'
        }
      `}
    >
      {loading ? (
        <Loader2 className="animate-spin" size={20} />
      ) : isParticipating ? (
        <>
          <X size={20} />
          å‚åŠ ã‚’å–ã‚Šæ¶ˆã™
        </>
      ) : (
        <>
          <Check size={20} />
          å‚åŠ ã™ã‚‹
        </>
      )}
    </button>
  );
}
```

---

## 16.6 ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…

### Step 1: ã‚³ãƒ¡ãƒ³ãƒˆAPIã‚’å®Ÿè£…

`src/app/api/activity-schedules/[id]/comments/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';

// ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
export async function POST(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession(authOptions);

    if (!session?.user) {
      return NextResponse.json(
        { error: 'èªè¨¼ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const body = await req.json();
    const { content } = body;

    if (!content || content.trim().length === 0) {
      return NextResponse.json(
        { error: 'ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã¯å¿…é ˆã§ã™' },
        { status: 400 }
      );
    }

    const comment = await db.comment.create({
      data: {
        content: content.trim(),
        userId: session.user.id,
        activityScheduleId: params.id,
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            avatarUrl: true,
          },
        },
      },
    });

    return NextResponse.json(comment, { status: 201 });
  } catch (error) {
    console.error('Comment creation error:', error);
    return NextResponse.json(
      { error: 'ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…

`src/app/activity-schedules/[id]/CommentSection.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Send, Loader2, Trash2 } from 'lucide-react';
import { Avatar } from '@/components/Avatar';
import Link from 'next/link';

interface Comment {
  id: string;
  content: string;
  createdAt: Date;
  user: {
    id: string;
    name: string | null;
    avatarUrl: string | null;
  };
}

interface CommentSectionProps {
  scheduleId: string;
  comments: Comment[];
  currentUserId: string;
}

export function CommentSection({
  scheduleId,
  comments: initialComments,
  currentUserId,
}: CommentSectionProps) {
  const router = useRouter();
  const [comments, setComments] = useState(initialComments);
  const [newComment, setNewComment] = useState('');
  const [submitting, setSubmitting] = useState(false);

  // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!newComment.trim()) return;

    setSubmitting(true);

    try {
      const response = await fetch(`/api/activity-schedules/${scheduleId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: newComment }),
      });

      if (!response.ok) {
        throw new Error('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const comment = await response.json();
      setComments([comment, ...comments]);
      setNewComment('');
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
      <form onSubmit={handleSubmit} className="flex gap-3">
        <input
          type="text"
          value={newComment}
          onChange={(e) => setNewComment(e.target.value)}
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
          className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <button
          type="submit"
          disabled={submitting || !newComment.trim()}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          {submitting ? (
            <Loader2 className="animate-spin" size={18} />
          ) : (
            <Send size={18} />
          )}
          æŠ•ç¨¿
        </button>
      </form>

      {/* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ */}
      {comments.length === 0 ? (
        <p className="text-gray-500 text-center py-8">
          ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“
        </p>
      ) : (
        <div className="space-y-4">
          {comments.map((comment) => (
            <div key={comment.id} className="flex gap-3">
              <Link href={`/users/${comment.user.id}`}>
                <Avatar
                  src={comment.user.avatarUrl}
                  alt={comment.user.name || 'User'}
                  size="md"
                />
              </Link>
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-1">
                  <Link
                    href={`/users/${comment.user.id}`}
                    className="font-semibold text-gray-900 hover:text-blue-600"
                  >
                    {comment.user.name || 'åç„¡ã—'}
                  </Link>
                  <span className="text-sm text-gray-500">
                    {new Date(comment.createdAt).toLocaleString('ja-JP', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </span>
                </div>
                <p className="text-gray-700 whitespace-pre-wrap">{comment.content}</p>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

---

## 16.7 æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›

### Step 1: å¤‰æ›APIã‚’å®Ÿè£…

`src/app/api/activity-schedules/[id]/report/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æ´»å‹•å ±å‘Šã‚’ä½œæˆ
export async function POST(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const session = await getServerSession(authOptions);

    if (!session?.user) {
      return NextResponse.json(
        { error: 'èªè¨¼ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' },
        { status: 403 }
      );
    }

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
    const schedule = await db.activitySchedule.findUnique({
      where: { id: params.id },
      include: {
        participants: {
          include: {
            user: {
              select: {
                name: true,
              },
            },
          },
        },
      },
    });

    if (!schedule) {
      return NextResponse.json(
        { error: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æŠ•ç¨¿ã‚’ä½œæˆ
    const participantNames = schedule.participants
      .map((p) => p.user.name || 'åç„¡ã—')
      .join('ã€');

    const templateContent = `# ${schedule.title}

**æ—¥æ™‚**: ${schedule.date ? new Date(schedule.date).toLocaleString('ja-JP') : 'æœªå®š'}
**å ´æ‰€**: ${schedule.location || 'æœªå®š'}

## æ´»å‹•å†…å®¹

${schedule.content || ''}

## å‚åŠ è€… (${schedule.participants.length}å)

${participantNames || 'ãªã—'}

## æ´»å‹•ã®æ§˜å­

ï¼ˆå†™çœŸã‚„å‹•ç”»ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰

## æ„Ÿæƒ³ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ

ï¼ˆæ´»å‹•ã®æ„Ÿæƒ³ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼‰
`;

    const post = await db.post.create({
      data: {
        title: `ã€æ´»å‹•å ±å‘Šã€‘${schedule.title}`,
        content: templateContent,
        userId: session.user.id,
        activityScheduleId: schedule.id,
        youtubeUrls: [],
        images: [],
      },
    });

    return NextResponse.json({ postId: post.id }, { status: 201 });
  } catch (error) {
    console.error('Report creation error:', error);
    return NextResponse.json(
      { error: 'æ´»å‹•å ±å‘Šã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: å¤‰æ›ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…

`src/app/activity-schedules/[id]/report/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useEffect, useState, useRef } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { Loader2, FileText } from 'lucide-react';

export default function CreateReportPage() {
  const router = useRouter();
  const params = useParams();
  const [creating, setCreating] = useState(true);
  const hasCreated = useRef(false); // é‡è¤‡å®Ÿè¡Œã‚’é˜²ããƒ•ãƒ©ã‚°

  useEffect(() => {
    // æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆReact StrictModeå¯¾ç­–ï¼‰
    if (hasCreated.current) return;
    hasCreated.current = true;

    const createReport = async () => {
      try {
        const response = await fetch(
          `/api/activity-schedules/${params.id}/report`,
          {
            method: 'POST',
          }
        );

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'æ´»å‹•å ±å‘Šã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const { postId } = await response.json();
        router.push(`/posts/${postId}/edit`);
      } catch (error) {
        alert(error instanceof Error ? error.message : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        router.push(`/activity-schedules/${params.id}`);
      }
    };

    createReport();
  }, [params.id, router]);

  return (
    <div className="max-w-2xl mx-auto px-4 py-16">
      <div className="text-center">
        <Loader2 className="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" />
        <h2 className="text-2xl font-bold text-gray-900 mb-2">
          æ´»å‹•å ±å‘Šã‚’ä½œæˆä¸­...
        </h2>
        <p className="text-gray-600">
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™
        </p>
      </div>
    </div>
  );
}
```

**é‡è¦ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ:**

1. **useRefã«ã‚ˆã‚‹é‡è¤‡å®Ÿè¡Œé˜²æ­¢**
   - React 18ã®StrictModeã§ã¯ã€é–‹ç™ºç’°å¢ƒã§useEffectãŒ2å›å®Ÿè¡Œã•ã‚Œã¾ã™
   - `hasCreated.current`ãƒ•ãƒ©ã‚°ã§æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
   - ã“ã‚Œã«ã‚ˆã‚Šã€æ´»å‹•å ±å‘ŠãŒé‡è¤‡ã—ã¦ä½œæˆã•ã‚Œã‚‹ã®ã‚’é˜²ãã¾ã™

2. **è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**
   - æ´»å‹•å ±å‘Šä½œæˆå¾Œã€ç·¨é›†ãƒšãƒ¼ã‚¸ã«è‡ªå‹•é·ç§»
   - ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹

**React StrictModeã«ã¤ã„ã¦:**
é–‹ç™ºç’°å¢ƒã§ã¯ã€ReactãŒæ„å›³çš„ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’2å›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã€å‰¯ä½œç”¨ã®ãƒã‚°ã‚’è¦‹ã¤ã‘ã‚„ã™ãã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€useEffectã‚‚2å›å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€useRefãƒ•ãƒ©ã‚°ã‚’ä½¿ã†ã“ã¨ã§é–‹ç™ºãƒ»æœ¬ç•ªã®ä¸¡æ–¹ã§æ­£ã—ãå‹•ä½œã—ã¾ã™ã€‚

---

## 16.8 ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Chapter 16ã®å†…å®¹ã‚’ç†è§£ã§ããŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½

- [ ] ActivityScheduleãƒ¢ãƒ‡ãƒ«ã‚’ç†è§£ã§ãã‚‹
- [ ] ActivityParticipantãƒ¢ãƒ‡ãƒ«ã‚’ç†è§£ã§ãã‚‹
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹

### å‚åŠ ç™»éŒ²æ©Ÿèƒ½

- [ ] å‚åŠ ç™»éŒ²APIã‚’å®Ÿè£…ã§ãã‚‹
- [ ] å‚åŠ /å–æ¶ˆã®ãƒˆã‚°ãƒ«å‡¦ç†ã‚’ç†è§£ã§ãã‚‹
- [ ] @@uniqueåˆ¶ç´„ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢ã‚’ç†è§£ã§ãã‚‹

### ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½

- [ ] ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿APIã‚’å®Ÿè£…ã§ãã‚‹
- [ ] CommentSectionã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ã‚’ç†è§£ã§ãã‚‹

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½

- [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰æŠ•ç¨¿ã¸ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ç†è§£ã§ãã‚‹

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
- âœ… ActivityScheduleãƒ¢ãƒ‡ãƒ«ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€æ—¥æ™‚ã€å ´æ‰€ã€åœ°å›³URLï¼‰
- âœ… ActivityParticipantãƒ¢ãƒ‡ãƒ«ï¼ˆå‚åŠ è€…ç®¡ç†ï¼‰
- âœ… Commentãƒ¢ãƒ‡ãƒ«ã®ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£

#### ä¸»è¦æ©Ÿèƒ½
- âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ãƒ»è©³ç´°è¡¨ç¤º
- âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- âœ… å‚åŠ ç™»éŒ²/å–æ¶ˆæ©Ÿèƒ½
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½
- âœ… æ´»å‹•å ±å‘Šã¸ã®å¤‰æ›ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ï¼‰
- âœ… åœ°å›³ãƒªãƒ³ã‚¯ã®æ´»ç”¨

#### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
- âœ… ãƒˆã‚°ãƒ«å‡¦ç†ï¼ˆå‚åŠ /å–æ¶ˆï¼‰
- âœ… @@uniqueåˆ¶ç´„ã«ã‚ˆã‚‹é‡è¤‡é˜²æ­¢
- âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
- âœ… ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£ã®æ´»ç”¨

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### @@uniqueåˆ¶ç´„

```prisma
model ActivityParticipant {
  activityScheduleId  String
  userId              String
  
  @@unique([activityScheduleId, userId])
}
```

â†’ åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¤‡æ•°å›å‚åŠ ç™»éŒ²ã§ããªã„ã‚ˆã†ã«ã™ã‚‹

#### ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯é–¢é€£

```prisma
model Comment {
  postId              String?
  activityScheduleId  String?
  eventId             String?
  
  post              Post?              @relation(...)
  activitySchedule  ActivitySchedule?  @relation(...)
  event             Event?             @relation(...)
}
```

â†’ 1ã¤ã®Commentãƒ¢ãƒ‡ãƒ«ã§è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ã‚³ãƒ¡ãƒ³ãƒˆã§ãã‚‹

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½

```typescript
const templateContent = `# ${schedule.title}

**æ—¥æ™‚**: ${schedule.date}
**å ´æ‰€**: ${schedule.location}

## å‚åŠ è€…
${participantNames}
`;
```

â†’ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±ã‚’æ´»å‹•å ±å‘Šã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ´»ç”¨

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¬¡ã®ç« ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ï¼š

- **Chapter 17**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸
  - å½¹å‰²å¤‰æ›´æ©Ÿèƒ½
  - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
  - ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

---

[â† å‰ã®ç« ï¼šç¬¬15ç«  ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…](15-ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬17ç«  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« â†’](17-ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«.md)
