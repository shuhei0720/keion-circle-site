# ç¬¬21ç« ï¼šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

ã“ã®ç« ã§ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚è¤‡æ•°å€™è£œæ—¥ã®è¡¨ç¤ºã€æŠ•ç¥¨æ©Ÿèƒ½ã€ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ãªã©ã‚’å«ã¿ã¾ã™ã€‚

## 21.1 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§ãƒšãƒ¼ã‚¸

### app/schedules/page.tsx

```typescript
import Link from 'next/link';
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import ScheduleCard from '@/components/ScheduleCard';
import { Plus, Calendar } from 'lucide-react';

async function getSchedules() {
  const now = new Date();
  
  const [active, completed] = await Promise.all([
    // é€²è¡Œä¸­ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    prisma.schedule.findMany({
      where: {
        candidates: {
          some: {
            datetime: {
              gte: now,
            },
          },
        },
      },
      include: {
        candidates: {
          include: {
            _count: {
              select: {
                votes: true,
              },
            },
          },
          orderBy: {
            datetime: 'asc',
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
    }),
    
    // çµ‚äº†ã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    prisma.schedule.findMany({
      where: {
        candidates: {
          every: {
            datetime: {
              lt: now,
            },
          },
        },
      },
      include: {
        candidates: {
          include: {
            _count: {
              select: {
                votes: true,
              },
            },
          },
          orderBy: {
            datetime: 'asc',
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
      take: 10,
    }),
  ]);
  
  return { active, completed };
}

export default async function SchedulesPage() {
  const session = await auth();
  const { active, completed } = await getSchedules();
  
  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold flex items-center gap-2">
          <Calendar className="w-8 h-8" />
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´
        </h1>
        
        {session?.user?.role === 'admin' && (
          <Link
            href="/schedules/new"
            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            <Plus className="w-5 h-5" />
            æ–°è¦ä½œæˆ
          </Link>
        )}
      </div>
      
      {/* é€²è¡Œä¸­ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */}
      <section className="mb-12">
        <h2 className="text-2xl font-bold mb-6">ğŸ“… èª¿æ•´ä¸­</h2>
        
        {active.length === 0 ? (
          <div className="text-center py-12 bg-gray-50 rounded-lg">
            <p className="text-gray-600 mb-4">èª¿æ•´ä¸­ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>
            
            {session?.user?.role === 'admin' && (
              <Link
                href="/schedules/new"
                className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Plus className="w-5 h-5" />
                ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆ
              </Link>
            )}
          </div>
        ) : (
          <div className="grid md:grid-cols-2 gap-6">
            {active.map(schedule => (
              <ScheduleCard
                key={schedule.id}
                schedule={schedule}
                userId={session?.user?.id}
              />
            ))}
          </div>
        )}
      </section>
      
      {/* çµ‚äº†ã—ãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */}
      {completed.length > 0 && (
        <section>
          <h2 className="text-2xl font-bold mb-6">âœ… çµ‚äº†</h2>
          
          <div className="grid md:grid-cols-2 gap-6">
            {completed.map(schedule => (
              <ScheduleCard
                key={schedule.id}
                schedule={schedule}
                userId={session?.user?.id}
                isCompleted
              />
            ))}
          </div>
        </section>
      )}
    </div>
  );
}
```

---

## 21.2 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/ScheduleCard.tsx

```typescript
import Link from 'next/link';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import { Calendar, Users, CheckCircle } from 'lucide-react';

interface ScheduleCardProps {
  schedule: {
    id: string;
    title: string;
    description: string | null;
    candidates: {
      id: string;
      datetime: Date;
      location: string | null;
      _count: {
        votes: number;
      };
    }[];
  };
  userId?: string;
  isCompleted?: boolean;
}

export default function ScheduleCard({ schedule, userId, isCompleted }: ScheduleCardProps) {
  // æœ€ã‚‚äººæ°—ã®ã‚ã‚‹å€™è£œæ—¥ã‚’è¦‹ã¤ã‘ã‚‹
  const bestCandidate = schedule.candidates.reduce((best, current) => {
    return current._count.votes > best._count.votes ? current : best;
  }, schedule.candidates[0]);
  
  // ç·æŠ•ç¥¨æ•°
  const totalVotes = schedule.candidates.reduce(
    (sum, c) => sum + c._count.votes,
    0
  );
  
  return (
    <Link
      href={`/schedules/${schedule.id}`}
      className="block border rounded-lg p-6 hover:shadow-lg transition-shadow bg-white"
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex justify-between items-start mb-4">
        <h3 className="text-xl font-bold flex-1 mr-2">{schedule.title}</h3>
        
        {isCompleted && (
          <span className="px-2 py-1 bg-gray-200 text-gray-600 text-xs rounded flex items-center gap-1">
            <CheckCircle className="w-3 h-3" />
            çµ‚äº†
          </span>
        )}
      </div>
      
      {/* èª¬æ˜ */}
      {schedule.description && (
        <p className="text-gray-600 text-sm mb-4 line-clamp-2">
          {schedule.description}
        </p>
      )}
      
      {/* å€™è£œæ—¥æ•° */}
      <div className="flex items-center gap-2 text-sm text-gray-600 mb-3">
        <Calendar className="w-4 h-4" />
        <span>{schedule.candidates.length}å€‹ã®å€™è£œæ—¥</span>
      </div>
      
      {/* æœ€æœ‰åŠ›å€™è£œ */}
      {bestCandidate && (
        <div className="bg-blue-50 rounded-lg p-3 mb-3">
          <p className="text-xs text-blue-600 font-medium mb-1">
            ğŸ† æœ€æœ‰åŠ›å€™è£œ
          </p>
          <p className="font-medium">
            {format(new Date(bestCandidate.datetime), 'Mæœˆdæ—¥(E) HH:mm', { locale: ja })}
          </p>
          {bestCandidate.location && (
            <p className="text-sm text-gray-600 mt-1">
              ğŸ“ {bestCandidate.location}
            </p>
          )}
          <p className="text-sm text-blue-600 mt-1">
            {bestCandidate._count.votes}äººãŒå‚åŠ å¯èƒ½
          </p>
        </div>
      )}
      
      {/* çµ±è¨ˆ */}
      <div className="flex items-center gap-2 text-sm text-gray-600">
        <Users className="w-4 h-4" />
        <span>åˆè¨ˆ {totalVotes} ç¥¨</span>
      </div>
    </Link>
  );
}
```

---

## 21.3 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆãƒšãƒ¼ã‚¸

### app/schedules/new/page.tsx

```typescript
import { redirect } from 'next/navigation';
import { auth } from '@/lib/auth';
import ScheduleForm from '@/components/ScheduleForm';

export default async function NewSchedulePage() {
  const session = await auth();
  
  if (!session) {
    redirect('/login');
  }
  
  if (session.user.role !== 'admin') {
    redirect('/schedules');
  }
  
  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ã‚’ä½œæˆ</h1>
      
      <ScheduleForm />
    </div>
  );
}
```

---

## 21.4 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/ScheduleForm.tsx

```typescript
'use client';

import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import { Plus, X, Calendar, MapPin } from 'lucide-react';

interface Candidate {
  datetime: string;
  location: string;
}

export default function ScheduleForm() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    candidates: [
      { datetime: '', location: '' },
    ] as Candidate[],
  });
  
  // å€™è£œæ—¥ã‚’è¿½åŠ 
  const addCandidate = () => {
    setFormData({
      ...formData,
      candidates: [...formData.candidates, { datetime: '', location: '' }],
    });
  };
  
  // å€™è£œæ—¥ã‚’å‰Šé™¤
  const removeCandidate = (index: number) => {
    setFormData({
      ...formData,
      candidates: formData.candidates.filter((_, i) => i !== index),
    });
  };
  
  // å€™è£œæ—¥ã‚’æ›´æ–°
  const updateCandidate = (index: number, field: keyof Candidate, value: string) => {
    const newCandidates = [...formData.candidates];
    newCandidates[index] = { ...newCandidates[index], [field]: value };
    setFormData({ ...formData, candidates: newCandidates });
  };
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    
    if (!formData.title) {
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    // æœ‰åŠ¹ãªå€™è£œæ—¥ã‚’ãƒ•ã‚£ãƒ«ã‚¿
    const validCandidates = formData.candidates.filter(c => c.datetime);
    
    if (validCandidates.length === 0) {
      alert('å°‘ãªãã¨ã‚‚1ã¤ã®å€™è£œæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    setLoading(true);
    
    try {
      const response = await fetch('/api/schedules', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: formData.title,
          description: formData.description || null,
          candidates: validCandidates,
        }),
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error);
      }
      
      const schedule = await response.json();
      router.push(`/schedules/${schedule.id}`);
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* ã‚¿ã‚¤ãƒˆãƒ« */}
      <div>
        <label className="block text-sm font-medium mb-2">
          ã‚¿ã‚¤ãƒˆãƒ« <span className="text-red-600">*</span>
        </label>
        <input
          type="text"
          value={formData.title}
          onChange={(e) => setFormData({ ...formData, title: e.target.value })}
          placeholder="ä¾‹: 12æœˆã®ç·´ç¿’æ—¥ç¨‹èª¿æ•´"
          className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
      </div>
      
      {/* èª¬æ˜ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          èª¬æ˜
        </label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          placeholder="ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ã®è©³ç´°ã‚’å…¥åŠ›..."
          rows={4}
          className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      
      {/* å€™è£œæ—¥ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          å€™è£œæ—¥ <span className="text-red-600">*</span>
        </label>
        
        <div className="space-y-3">
          {formData.candidates.map((candidate, index) => (
            <div key={index} className="border rounded-lg p-4">
              <div className="flex justify-between items-center mb-3">
                <span className="font-medium">å€™è£œ {index + 1}</span>
                
                {formData.candidates.length > 1 && (
                  <button
                    type="button"
                    onClick={() => removeCandidate(index)}
                    className="text-red-600 hover:text-red-700"
                  >
                    <X className="w-5 h-5" />
                  </button>
                )}
              </div>
              
              <div className="space-y-3">
                {/* æ—¥æ™‚ */}
                <div>
                  <label className="block text-xs text-gray-600 mb-1">
                    <Calendar className="w-3 h-3 inline mr-1" />
                    æ—¥æ™‚
                  </label>
                  <input
                    type="datetime-local"
                    value={candidate.datetime}
                    onChange={(e) => updateCandidate(index, 'datetime', e.target.value)}
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                
                {/* å ´æ‰€ */}
                <div>
                  <label className="block text-xs text-gray-600 mb-1">
                    <MapPin className="w-3 h-3 inline mr-1" />
                    å ´æ‰€
                  </label>
                  <input
                    type="text"
                    value={candidate.location}
                    onChange={(e) => updateCandidate(index, 'location', e.target.value)}
                    placeholder="ä¾‹: éŸ³æ¥½å®¤A"
                    className="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
        
        <button
          type="button"
          onClick={addCandidate}
          className="mt-3 flex items-center gap-2 text-blue-600 hover:text-blue-700 text-sm font-medium"
        >
          <Plus className="w-4 h-4" />
          å€™è£œæ—¥ã‚’è¿½åŠ 
        </button>
      </div>
      
      {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <button
          type="submit"
          disabled={loading}
          className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {loading ? 'ä½œæˆä¸­...' : 'ä½œæˆã™ã‚‹'}
        </button>
        
        <button
          type="button"
          onClick={() => router.back()}
          className="px-6 py-3 border rounded-lg hover:bg-gray-100 transition-colors"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </form>
  );
}
```

---

## 21.5 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°ãƒšãƒ¼ã‚¸

### app/schedules/[id]/page.tsx

```typescript
import { notFound } from 'next/navigation';
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import CandidateVoting from '@/components/CandidateVoting';
import { Calendar, Users } from 'lucide-react';

interface PageProps {
  params: Promise<{
    id: string;
  }>;
}

async function getSchedule(id: string) {
  return prisma.schedule.findUnique({
    where: { id },
    include: {
      candidates: {
        include: {
          votes: {
            include: {
              user: {
                select: {
                  id: true,
                  name: true,
                  image: true,
                },
              },
            },
          },
          comments: {
            include: {
              user: {
                select: {
                  id: true,
                  name: true,
                  image: true,
                },
              },
            },
            orderBy: {
              createdAt: 'desc',
            },
          },
        },
        orderBy: {
          datetime: 'asc',
        },
      },
    },
  });
}

export default async function ScheduleDetailPage({ params }: PageProps) {
  const { id } = await params;
  const session = await auth();
  
  const schedule = await getSchedule(id);
  
  if (!schedule) {
    notFound();
  }
  
  // å„å€™è£œæ—¥ã®çµ±è¨ˆã‚’è¨ˆç®—
  const candidatesWithStats = schedule.candidates.map(candidate => {
    const votes = candidate.votes;
    const available = votes.filter(v => v.status === 'å‚åŠ å¯èƒ½').length;
    const maybe = votes.filter(v => v.status === 'æœªå®š').length;
    const unavailable = votes.filter(v => v.status === 'å‚åŠ ä¸å¯').length;
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¥¨
    const userVote = session?.user
      ? votes.find(v => v.userId === session.user.id)
      : null;
    
    return {
      ...candidate,
      stats: { available, maybe, unavailable, total: votes.length },
      userVote: userVote?.status || null,
    };
  });
  
  // æœ€æœ‰åŠ›å€™è£œã‚’è¦‹ã¤ã‘ã‚‹
  const bestCandidate = candidatesWithStats.reduce((best, current) => {
    return current.stats.available > best.stats.available ? current : best;
  }, candidatesWithStats[0]);
  
  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="mb-8">
        <h1 className="text-4xl font-bold mb-4">{schedule.title}</h1>
        
        {schedule.description && (
          <p className="text-gray-600 text-lg">{schedule.description}</p>
        )}
      </div>
      
      {/* æœ€æœ‰åŠ›å€™è£œ */}
      {bestCandidate && (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-6 mb-8">
          <div className="flex items-center gap-2 text-blue-600 font-medium mb-3">
            <Calendar className="w-5 h-5" />
            ğŸ† æœ€æœ‰åŠ›å€™è£œ
          </div>
          
          <p className="text-2xl font-bold mb-2">
            {new Date(bestCandidate.datetime).toLocaleDateString('ja-JP', {
              month: 'long',
              day: 'numeric',
              weekday: 'short',
              hour: '2-digit',
              minute: '2-digit',
            })}
          </p>
          
          {bestCandidate.location && (
            <p className="text-gray-600 mb-3">ğŸ“ {bestCandidate.location}</p>
          )}
          
          <div className="flex items-center gap-4 text-sm">
            <span className="flex items-center gap-1 text-green-600">
              <Users className="w-4 h-4" />
              {bestCandidate.stats.available}äººãŒå‚åŠ å¯èƒ½
            </span>
            
            {bestCandidate.stats.maybe > 0 && (
              <span className="text-gray-600">
                {bestCandidate.stats.maybe}äººãŒæœªå®š
              </span>
            )}
          </div>
        </div>
      )}
      
      {/* å€™è£œæ—¥ä¸€è¦§ */}
      <div className="space-y-6">
        <h2 className="text-2xl font-bold">å€™è£œæ—¥</h2>
        
        {candidatesWithStats.map((candidate) => (
          <CandidateVoting
            key={candidate.id}
            candidate={candidate}
            scheduleId={schedule.id}
            userVote={candidate.userVote}
            isLoggedIn={!!session}
          />
        ))}
      </div>
    </div>
  );
}
```

---

## 21.6 å€™è£œæ—¥æŠ•ç¥¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/CandidateVoting.tsx

```typescript
'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import { Check, X, HelpCircle, Calendar, MapPin, MessageCircle } from 'lucide-react';
import CandidateComments from './CandidateComments';

interface CandidateVotingProps {
  candidate: {
    id: string;
    datetime: Date;
    location: string | null;
    stats: {
      available: number;
      maybe: number;
      unavailable: number;
      total: number;
    };
    votes: {
      id: string;
      status: string;
      user: {
        id: string;
        name: string | null;
        image: string | null;
      };
    }[];
    comments: any[];
  };
  scheduleId: string;
  userVote: string | null;
  isLoggedIn: boolean;
}

export default function CandidateVoting({
  candidate,
  scheduleId,
  userVote: initialUserVote,
  isLoggedIn,
}: CandidateVotingProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [userVote, setUserVote] = useState(initialUserVote);
  const [showComments, setShowComments] = useState(false);
  
  const handleVote = async (status: 'å‚åŠ å¯èƒ½' | 'æœªå®š' | 'å‚åŠ ä¸å¯') => {
    if (!isLoggedIn) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
      return;
    }
    
    // æ¥½è¦³çš„UIæ›´æ–°
    const previousVote = userVote;
    setUserVote(status);
    
    try {
      const response = await fetch(`/api/schedules/${scheduleId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          candidateId: candidate.id,
          status,
        }),
      });
      
      if (!response.ok) {
        setUserVote(previousVote);
        const data = await response.json();
        throw new Error(data.error);
      }
      
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      console.error('Vote error:', error);
    }
  };
  
  return (
    <div className="border rounded-lg overflow-hidden">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-gray-50 p-4">
        <div className="flex items-start gap-3">
          <Calendar className="w-5 h-5 text-gray-600 mt-1 flex-shrink-0" />
          
          <div className="flex-1">
            <p className="text-xl font-bold">
              {format(new Date(candidate.datetime), 'Mæœˆdæ—¥(E) HH:mm', { locale: ja })}
            </p>
            
            {candidate.location && (
              <p className="text-gray-600 flex items-center gap-1 mt-1">
                <MapPin className="w-4 h-4" />
                {candidate.location}
              </p>
            )}
          </div>
        </div>
      </div>
      
      {/* æŠ•ç¥¨ãƒœã‚¿ãƒ³ */}
      <div className="p-4">
        {isLoggedIn ? (
          <div className="flex gap-2 mb-4">
            <button
              onClick={() => handleVote('å‚åŠ å¯èƒ½')}
              disabled={isPending}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 ${
                userVote === 'å‚åŠ å¯èƒ½'
                  ? 'bg-green-600 text-white'
                  : 'border-2 border-green-600 text-green-600 hover:bg-green-50'
              }`}
            >
              <Check className="w-5 h-5" />
              å‚åŠ å¯èƒ½
            </button>
            
            <button
              onClick={() => handleVote('æœªå®š')}
              disabled={isPending}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 ${
                userVote === 'æœªå®š'
                  ? 'bg-gray-600 text-white'
                  : 'border-2 border-gray-600 text-gray-600 hover:bg-gray-50'
              }`}
            >
              <HelpCircle className="w-5 h-5" />
              æœªå®š
            </button>
            
            <button
              onClick={() => handleVote('å‚åŠ ä¸å¯')}
              disabled={isPending}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-medium transition-colors disabled:opacity-50 ${
                userVote === 'å‚åŠ ä¸å¯'
                  ? 'bg-red-600 text-white'
                  : 'border-2 border-red-600 text-red-600 hover:bg-red-50'
              }`}
            >
              <X className="w-5 h-5" />
              å‚åŠ ä¸å¯
            </button>
          </div>
        ) : (
          <p className="text-gray-600 text-center mb-4">
            æŠ•ç¥¨ã™ã‚‹ã«ã¯<a href="/login" className="text-blue-600 hover:underline">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„
          </p>
        )}
        
        {/* çµ±è¨ˆ */}
        <div className="space-y-2">
          {/* å‚åŠ å¯èƒ½ */}
          <div className="flex items-center gap-3">
            <span className="text-sm font-medium text-green-600 w-20">
              å‚åŠ å¯èƒ½
            </span>
            <div className="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
              <div
                className="bg-green-600 h-full flex items-center justify-end px-2 text-xs text-white font-medium transition-all"
                style={{
                  width: candidate.stats.total > 0
                    ? `${(candidate.stats.available / candidate.stats.total) * 100}%`
                    : '0%',
                }}
              >
                {candidate.stats.available > 0 && candidate.stats.available}
              </div>
            </div>
          </div>
          
          {/* æœªå®š */}
          {candidate.stats.maybe > 0 && (
            <div className="flex items-center gap-3">
              <span className="text-sm font-medium text-gray-600 w-20">
                æœªå®š
              </span>
              <div className="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                <div
                  className="bg-gray-600 h-full flex items-center justify-end px-2 text-xs text-white font-medium transition-all"
                  style={{
                    width: `${(candidate.stats.maybe / candidate.stats.total) * 100}%`,
                  }}
                >
                  {candidate.stats.maybe}
                </div>
              </div>
            </div>
          )}
          
          {/* å‚åŠ ä¸å¯ */}
          {candidate.stats.unavailable > 0 && (
            <div className="flex items-center gap-3">
              <span className="text-sm font-medium text-red-600 w-20">
                å‚åŠ ä¸å¯
              </span>
              <div className="flex-1 bg-gray-200 rounded-full h-6 overflow-hidden">
                <div
                  className="bg-red-600 h-full flex items-center justify-end px-2 text-xs text-white font-medium transition-all"
                  style={{
                    width: `${(candidate.stats.unavailable / candidate.stats.total) * 100}%`,
                  }}
                >
                  {candidate.stats.unavailable}
                </div>
              </div>
            </div>
          )}
        </div>
        
        {/* ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ */}
        <button
          onClick={() => setShowComments(!showComments)}
          className="mt-4 flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900"
        >
          <MessageCircle className="w-4 h-4" />
          ã‚³ãƒ¡ãƒ³ãƒˆ ({candidate.comments.length})
        </button>
      </div>
      
      {/* ã‚³ãƒ¡ãƒ³ãƒˆ */}
      {showComments && (
        <div className="border-t p-4 bg-gray-50">
          <CandidateComments
            candidateId={candidate.id}
            scheduleId={scheduleId}
            comments={candidate.comments}
            isLoggedIn={isLoggedIn}
          />
        </div>
      )}
    </div>
  );
}
```

---

## 21.7 å€™è£œæ—¥ã‚³ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/CandidateComments.tsx

```typescript
'use client';

import { useState, FormEvent, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';
import { ja } from 'date-fns/locale';
import { Send } from 'lucide-react';

interface CandidateCommentsProps {
  candidateId: string;
  scheduleId: string;
  comments: {
    id: string;
    content: string;
    createdAt: Date;
    user: {
      id: string;
      name: string | null;
      image: string | null;
    };
  }[];
  isLoggedIn: boolean;
}

export default function CandidateComments({
  candidateId,
  scheduleId,
  comments,
  isLoggedIn,
}: CandidateCommentsProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [content, setContent] = useState('');
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    
    if (!content.trim()) return;
    
    setLoading(true);
    
    try {
      const response = await fetch(`/api/schedules/${scheduleId}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          candidateId,
          content,
        }),
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error);
      }
      
      setContent('');
      
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="space-y-4">
      {/* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ */}
      {comments.length > 0 && (
        <div className="space-y-3">
          {comments.map(comment => (
            <div key={comment.id} className="flex gap-2">
              <div className="relative w-8 h-8 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                {comment.user.image ? (
                  <Image
                    src={comment.user.image}
                    alt={comment.user.name || ''}
                    fill
                    className="object-cover"
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs">
                    {comment.user.name?.[0] || '?'}
                  </div>
                )}
              </div>
              
              <div className="flex-1 bg-white rounded-lg p-3">
                <div className="flex items-center gap-2 mb-1">
                  <span className="font-medium text-sm">{comment.user.name}</span>
                  <span className="text-xs text-gray-500">
                    {formatDistanceToNow(new Date(comment.createdAt), {
                      addSuffix: true,
                      locale: ja,
                    })}
                  </span>
                </div>
                <p className="text-sm text-gray-700">{comment.content}</p>
              </div>
            </div>
          ))}
        </div>
      )}
      
      {/* ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ  */}
      {isLoggedIn ? (
        <form onSubmit={handleSubmit} className="flex gap-2">
          <input
            type="text"
            value={content}
            onChange={(e) => setContent(e.target.value)}
            placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
            className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
            disabled={loading}
          />
          
          <button
            type="submit"
            disabled={loading || !content.trim()}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <Send className="w-4 h-4" />
          </button>
        </form>
      ) : (
        <p className="text-sm text-gray-600 text-center">
          ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯<a href="/login" className="text-blue-600 hover:underline">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„
        </p>
      )}
    </div>
  );
}
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§
- âœ… **é€²è¡Œä¸­/çµ‚äº†**: æ—¥ä»˜ã§ãƒ•ã‚£ãƒ«ã‚¿
- âœ… **ScheduleCard**: å€™è£œæ—¥æ•°ã€æœ€æœ‰åŠ›å€™è£œã€æŠ•ç¥¨æ•°
- âœ… **ç®¡ç†è€…å°‚ç”¨**: æ–°è¦ä½œæˆãƒœã‚¿ãƒ³

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
- âœ… **ScheduleForm**: ã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€è¤‡æ•°å€™è£œæ—¥
- âœ… **æ—¥æ™‚å…¥åŠ›**: datetime-local
- âœ… **å ´æ‰€å…¥åŠ›**: å„å€™è£œæ—¥ã«è¨­å®šå¯èƒ½

### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°
- âœ… **æœ€æœ‰åŠ›å€™è£œ**: å‚åŠ å¯èƒ½æ•°ãŒæœ€å¤šã®å€™è£œæ—¥
- âœ… **æŠ•ç¥¨æ©Ÿèƒ½**: å‚åŠ å¯èƒ½/æœªå®š/å‚åŠ ä¸å¯
- âœ… **çµ±è¨ˆè¡¨ç¤º**: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã§å¯è¦–åŒ–
- âœ… **ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½**: å„å€™è£œæ—¥ã«ã‚³ãƒ¡ãƒ³ãƒˆå¯èƒ½

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
- âœ… **æ¥½è¦³çš„UI**: å³åº§ã«åæ˜ 
- âœ… **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: router.refresh()
- âœ… **è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: è‰²åˆ†ã‘ã¨ã‚¢ã‚¤ã‚³ãƒ³

æ¬¡ã®ç« ã§ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£…**ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬20ç«  æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…](20-æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬22ç«  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£… â†’](22-ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£….md)
