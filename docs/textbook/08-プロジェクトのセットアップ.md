# 第8章：プロジェクトのセットアップ

この章では、BOLD軽音メンバーサイトプロジェクトのセットアップ方法と、プロジェクト構成について詳しく学びます。

## 8.1 プロジェクトの概要

### 使用技術スタック

本プロジェクトは、以下の技術で構築されています：

```
フロントエンド:
- Next.js 16.1（App Router）
- React 19
- TypeScript 5
- Tailwind CSS v4

バックエンド:
- Next.js API Routes
- Prisma 5.22（ORM）
- NextAuth.js v5（認証）

データベース:
- PostgreSQL（本番：Supabase）
- SQLite（開発環境）

ストレージ:
- Supabase Storage（画像）

その他:
- bcryptjs（パスワードハッシュ化）
- Lucide React（アイコン）
- react-youtube（YouTube埋め込み）
```

---

## 8.2 ローカル環境のセットアップ

### 1. 必要なツール

プロジェクトを動かすには、以下のツールが必要です：

```bash
# Node.jsのバージョン確認
node --version
# v20以上が必要

# npmのバージョン確認
npm --version
```

**インストール方法：**
- [Node.js公式サイト](https://nodejs.org/)からインストーラーをダウンロード
- LTS版（Long Term Support）を推奨

### 2. プロジェクトのクローン

```bash
# GitHubからクローン
git clone https://github.com/your-repo/keion-circle-site.git
cd keion-circle-site
```

### 3. 依存関係のインストール

```bash
# パッケージのインストール
npm install
```

このコマンドで、`package.json`に記載されているすべての依存パッケージがインストールされます。

### 4. 環境変数の設定

`.env.example`ファイルをコピーして`.env.local`を作成：

```bash
cp .env.example .env.local
```

**.env.local の内容:**

```env
# 認証
AUTH_URL=http://localhost:3000
AUTH_SECRET=your-random-secret-key-here
AUTH_TRUST_HOST=true

# データベース（開発環境はSQLite）
DATABASE_URL="file:./dev.db"

# Google OAuth（Google Cloud Consoleで取得）
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Supabase（Supabaseダッシュボードで取得）
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

**環境変数の取得方法：**

1. **AUTH_SECRET**: ランダムな文字列を生成
   ```bash
   openssl rand -base64 32
   ```

2. **Google OAuth**:
   - [Google Cloud Console](https://console.cloud.google.com/)にアクセス
   - 新しいプロジェクトを作成
   - OAuth 2.0 クライアント IDを作成
   - 承認済みのリダイレクト URIに追加：
     - `http://localhost:3000/api/auth/callback/google`

3. **Supabase**:
   - [Supabase](https://supabase.com/)でプロジェクトを作成
   - Settings → API から URL と Anon Key を取得
   - Storage → Create bucket で `avatars` バケットを作成（Public）

### 5. データベースの初期化

```bash
# 環境変数を設定
export DATABASE_URL="file:./dev.db"

# Prisma Clientの生成
npx prisma generate

# データベースのマイグレーション
npx prisma db push
```

### 6. 管理者ユーザーの作成

```bash
# 管理者アカウントを作成
export DATABASE_URL="file:./dev.db"
node scripts/create-admin.js admin@example.com admin123 "管理者名"
```

### 7. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで `http://localhost:3000` を開いて確認します。

---

## 8.3 package.json の解説

### scripts（よく使うコマンド）

```json
{
  "scripts": {
    "dev": "next dev",                    // 開発サーバー起動
    "build": "prisma generate && prisma db push --skip-generate --accept-data-loss && next build",  // 本番ビルド
    "start": "next start",                // 本番サーバー起動
    "lint": "eslint",                     // コードチェック
    "postinstall": "prisma generate",     // npm install後に自動実行
    "db:generate": "prisma generate",     // Prisma Client生成
    "db:push": "prisma db push",          // データベース更新
    "db:studio": "prisma studio"          // データベースGUI起動
  }
}
```

**使い方：**

```bash
# 開発
npm run dev

# データベースを確認
npm run db:studio

# 本番ビルド
npm run build

# 本番サーバー起動
npm run start
```

### dependencies（本番環境でも必要）

```json
{
  "dependencies": {
    "@auth/core": "^0.41.0",              // NextAuth.jsのコア
    "@auth/prisma-adapter": "^2.11.1",    // NextAuth.js + Prisma連携
    "@prisma/client": "^5.22.0",          // Prismaクライアント
    "@supabase/supabase-js": "^2.89.0",   // Supabaseクライアント
    "bcryptjs": "^3.0.3",                 // パスワードハッシュ化
    "lucide-react": "^0.562.0",           // アイコン
    "next": "16.1.0",                     // Next.js
    "next-auth": "^5.0.0-beta.30",        // NextAuth.js
    "react": "19.2.3",                    // React
    "react-dom": "19.2.3",                // React DOM
    "react-youtube": "^10.1.0"            // YouTube埋め込み
  }
}
```

### devDependencies（開発環境のみ）

```json
{
  "devDependencies": {
    "@tailwindcss/postcss": "^4",         // Tailwind CSS PostCSS
    "@types/node": "^20",                 // Node.jsの型定義
    "@types/react": "^19",                // Reactの型定義
    "@types/react-dom": "^19",            // React DOMの型定義
    "eslint": "^9",                       // コードチェックツール
    "eslint-config-next": "16.1.0",       // Next.js用ESLint設定
    "tailwindcss": "^4",                  // Tailwind CSS
    "typescript": "^5"                    // TypeScript
  }
}
```

---

## 8.4 設定ファイル

### next.config.ts

Next.jsの設定ファイルです。

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // 画像最適化の設定
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        pathname: '/storage/v1/object/public/**',
      },
    ],
  },
};

export default nextConfig;
```

**重要なポイント：**

- **remotePatterns**: 外部画像を使う場合、ドメインを許可する必要がある
- Supabase Storageの画像を使うため、`*.supabase.co`を許可

### tsconfig.json

TypeScriptの設定ファイルです。

```json
{
  "compilerOptions": {
    "target": "ES2022",                   // 出力するJavaScriptのバージョン
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,                      // JavaScriptファイルも許可
    "skipLibCheck": true,                 // 型定義ファイルのチェックをスキップ
    "strict": true,                       // 厳格な型チェック
    "noEmit": true,                       // JavaScriptを出力しない
    "esModuleInterop": true,
    "module": "esnext",                   // モジュールシステム
    "moduleResolution": "bundler",        // モジュール解決方法
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",                    // JSXを保持（Next.jsが処理）
    "incremental": true,                  // 差分コンパイル
    "plugins": [
      { "name": "next" }                  // Next.jsプラグイン
    ],
    "paths": {
      "@/*": ["./src/*"]                  // パスエイリアス
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}
```

**パスエイリアス：**

```typescript
// パスエイリアスなし
import { Button } from '../../../components/Button';

// パスエイリアスあり
import { Button } from '@/components/Button';
```

### tailwind.config.ts

Tailwind CSSの設定ファイルです。

```typescript
import type { Config } from 'tailwindcss';

const config: Config = {
  // Tailwind CSSを適用するファイル
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  
  // テーマのカスタマイズ
  theme: {
    extend: {
      // カスタムカラー、フォント等を追加できる
    },
  },
  
  plugins: [],
};

export default config;
```

### .eslintrc.json

ESLint（コードチェックツール）の設定です。

```json
{
  "extends": "next/core-web-vitals"
}
```

### .gitignore

Gitで管理しないファイルを指定します。

```
# 依存関係
/node_modules

# Next.js
/.next
/out

# 環境変数（機密情報）
.env.local
.env*.local

# データベース
*.db
*.db-journal

# その他
.DS_Store
```

---

## 8.5 プロジェクト構造の詳細

```
keion-circle-site/
├── .next/                    # Next.jsのビルド結果（自動生成）
├── node_modules/             # 依存パッケージ（自動生成）
├── prisma/                   # Prisma関連
│   └── schema.prisma         # データベーススキーマ
├── public/                   # 静的ファイル
│   ├── uploads/              # アップロードされた画像
│   └── favicon.ico           # ファビコン
├── scripts/                  # ユーティリティスクリプト
│   └── create-admin.js       # 管理者作成スクリプト
├── src/                      # ソースコード
│   ├── app/                  # Next.js App Router
│   │   ├── api/              # APIルート
│   │   ├── posts/            # 投稿ページ
│   │   ├── events/           # イベントページ
│   │   ├── schedules/        # スケジュールページ
│   │   ├── users/            # ユーザーページ
│   │   ├── layout.tsx        # ルートレイアウト
│   │   ├── page.tsx          # トップページ
│   │   └── globals.css       # グローバルCSS
│   ├── components/           # 共通コンポーネント
│   │   ├── AuthButton.tsx
│   │   ├── Navigation.tsx
│   │   └── ...
│   └── lib/                  # ユーティリティ関数
│       ├── auth.ts           # 認証関連
│       ├── db.ts             # データベース接続
│       └── supabase.ts       # Supabase設定
├── .env.example              # 環境変数のサンプル
├── .env.local                # 環境変数（実際の値）
├── .eslintrc.json            # ESLint設定
├── .gitignore                # Git除外設定
├── next.config.ts            # Next.js設定
├── package.json              # パッケージ情報
├── README.md                 # プロジェクト説明
├── tailwind.config.ts        # Tailwind CSS設定
└── tsconfig.json             # TypeScript設定
```

---

## 8.6 開発フロー

### 1. 新機能の開発

```bash
# 1. ブランチを作成
git checkout -b feature/new-feature

# 2. 開発サーバーを起動
npm run dev

# 3. コードを書く
# src/app/... や src/components/... を編集

# 4. データベースを変更する場合
# prisma/schema.prisma を編集
npx prisma db push

# 5. 動作確認
# http://localhost:3000 で確認

# 6. コミット
git add .
git commit -m "feat: 新機能を追加"

# 7. プッシュ
git push origin feature/new-feature
```

### 2. データベースの確認

```bash
# Prisma Studioを起動（GUI）
npm run db:studio
```

ブラウザで `http://localhost:5555` が開き、データベースの中身を確認・編集できます。

### 3. トラブルシューティング

**問題: 開発サーバーが起動しない**

```bash
# ポートが使用中の場合
lsof -i :3000
kill -9 <PID>

# または別のポートで起動
PORT=3001 npm run dev
```

**問題: データベースエラー**

```bash
# データベースをリセット
rm dev.db
npx prisma db push

# 管理者を再作成
node scripts/create-admin.js admin@example.com admin123 "管理者"
```

**問題: 型エラー**

```bash
# Prisma Clientを再生成
npx prisma generate

# node_modulesを再インストール
rm -rf node_modules package-lock.json
npm install
```

---

## 8.7 本番環境へのデプロイ（Vercel）

### 1. Vercelへのデプロイ

```bash
# Vercel CLIをインストール
npm install -g vercel

# ログイン
vercel login

# デプロイ
vercel
```

### 2. 環境変数の設定

Vercelのダッシュボードで以下を設定：

```env
AUTH_URL=https://your-domain.vercel.app
AUTH_SECRET=<ランダムな文字列>
AUTH_TRUST_HOST=true
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=<AUTH_SECRETと同じ>
DATABASE_URL=<Supabase PostgreSQL URL>
GOOGLE_CLIENT_ID=<Google OAuth ID>
GOOGLE_CLIENT_SECRET=<Google OAuth Secret>
NEXT_PUBLIC_SUPABASE_URL=<Supabase URL>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<Supabase Anon Key>
```

### 3. データベースの設定（Supabase）

1. [Supabase](https://supabase.com/)でプロジェクトを作成
2. Settings → Database で接続文字列を取得
3. Vercelの環境変数に設定

**接続文字列の例：**
```
postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres
```

### 4. Google OAuth の設定

Google Cloud Consoleで、承認済みのリダイレクト URIに追加：

```
https://your-domain.vercel.app/api/auth/callback/google
```

---

## 8.8 便利なVS Code拡張機能

開発を効率化する推奨の拡張機能：

1. **ES7+ React/Redux/React-Native snippets**
   - Reactのスニペット

2. **Tailwind CSS IntelliSense**
   - Tailwind CSSの自動補完

3. **Prisma**
   - Prismaのシンタックスハイライト

4. **ESLint**
   - コードの問題を検出

5. **Prettier - Code formatter**
   - コード整形

6. **Auto Rename Tag**
   - タグの自動リネーム

**.vscode/settings.json** (推奨設定)：

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "tailwindCSS.experimental.classRegex": [
    ["clsx\\(([^)]*)\\)", "(?:'|\"|`)([^']*)(?:'|\"|`)"]
  ]
}
```

---

## 8.9 開発のベストプラクティス

### 1. コミットメッセージ

```bash
# 機能追加
git commit -m "feat: ユーザープロフィール編集機能を追加"

# バグ修正
git commit -m "fix: 投稿削除時のエラーを修正"

# ドキュメント
git commit -m "docs: READMEを更新"

# リファクタリング
git commit -m "refactor: API呼び出し処理を共通化"

# スタイル
git commit -m "style: コードフォーマットを修正"
```

### 2. ブランチ戦略

```bash
# 機能開発
git checkout -b feature/post-like-button

# バグ修正
git checkout -b fix/login-error

# ホットフィックス
git checkout -b hotfix/security-issue
```

### 3. コードレビューのポイント

- ✅ TypeScriptの型は正しく定義されているか
- ✅ エラーハンドリングは適切か
- ✅ セキュリティ上の問題はないか
- ✅ パフォーマンスは問題ないか
- ✅ テストは書かれているか

---

## まとめ

この章では、プロジェクトのセットアップについて学びました：

### 環境構築
- ✅ **必要なツール**: Node.js、npm、Git
- ✅ **依存関係のインストール**: `npm install`
- ✅ **環境変数の設定**: `.env.local`
- ✅ **データベースの初期化**: Prisma

### 設定ファイル
- ✅ **next.config.ts**: Next.jsの設定
- ✅ **tsconfig.json**: TypeScriptの設定
- ✅ **tailwind.config.ts**: Tailwind CSSの設定
- ✅ **package.json**: パッケージ情報とスクリプト

### 開発フロー
- ✅ **開発サーバー**: `npm run dev`
- ✅ **データベース確認**: `npm run db:studio`
- ✅ **本番ビルド**: `npm run build`

### デプロイ
- ✅ **Vercel**: 簡単にデプロイ可能
- ✅ **Supabase**: PostgreSQLとストレージ
- ✅ **環境変数**: 本番環境の設定

次の章では、**プロジェクトのファイル構成**について、各ディレクトリの役割を詳しく見ていきます。

---

[← 前の章：第7章 Tailwind CSS入門](07-Tailwind-CSS入門.md) | [目次に戻る](00-目次.md) | [次の章へ：第9章 プロジェクトのファイル構成 →](09-プロジェクトのファイル構成.md)
