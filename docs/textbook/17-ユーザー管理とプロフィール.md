# ç¬¬17ç« ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€ãƒãƒ³ã‚ºã‚ªãƒ³ã€‘

> **ã“ã®ç« ã§ã¯ã€ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™**

## ğŸ› ï¸ **ãƒãƒ³ã‚ºã‚ªãƒ³ä½œæ¥­**

**âš ï¸ é‡è¦**: ã“ã®ç« ã§ã¯å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã€ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ»å½¹å‰²ç®¡ç†æ©Ÿèƒ½ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ğŸ“š ã“ã®ç« ã§å­¦ã¶ã“ã¨

- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… ç®¡ç†è€…ã«ã‚ˆã‚‹å½¹å‰²å¤‰æ›´æ©Ÿèƒ½
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½
- âœ… ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSupabase Storageï¼‰
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… æ´»å‹•å±¥æ­´ã®è¡¨ç¤º

## ğŸ’¡ ã“ã®ç« ã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã®å…¨ä½“åƒ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã€‘
å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®è¡¨ç¤ºã€å½¹å‰²ã®ç¢ºèª
   â†“
ã€ç®¡ç†è€…æ©Ÿèƒ½ã€‘
å½¹å‰²å¤‰æ›´ï¼ˆmember â‡„ adminï¼‰
   â†“
ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã€‘
åå‰ã€è‡ªå·±ç´¹ä»‹ã€æ‹…å½“æ¥½å™¨ã€ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
   â†“
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ã€‘
ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã€æ´»å‹•å±¥æ­´


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§                      â”‚
â”‚                                    â”‚
â”‚   [ğŸ¸ å±±ç”°å¤ªéƒ]  ç®¡ç†è€…            â”‚
â”‚   [ğŸ¤ ä½è—¤èŠ±å­]  ãƒ¡ãƒ³ãƒãƒ¼          â”‚
â”‚   [ğŸ¥ éˆ´æœ¨ä¸€éƒ]  ãƒ¡ãƒ³ãƒãƒ¼          â”‚
â”‚                                    â”‚
â”‚   â†’ ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒšãƒ¼ã‚¸ã¸        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†                  â”‚
â”‚                                    â”‚
â”‚   [ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ]                   â”‚
â”‚   ğŸ“· ç”»åƒã‚’å¤‰æ›´                    â”‚
â”‚                                    â”‚
â”‚   åå‰: [å±±ç”°å¤ªéƒ]                 â”‚
â”‚   è‡ªå·±ç´¹ä»‹: [ã‚®ã‚¿ãƒ¼æ‹…å½“ã§ã™]       â”‚
â”‚   æ‹…å½“æ¥½å™¨: [ã‚®ã‚¿ãƒ¼]               â”‚
â”‚                                    â”‚
â”‚   [ä¿å­˜]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 17.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### ãƒ‡ãƒ¼ã‚¿å–å¾—ã®è¨­è¨ˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã§ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã§è¡¨ç¤ºã™ã‚‹æƒ…å ±        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ                       â”‚
â”‚ âœ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼å                         â”‚
â”‚ âœ“ å½¹å‰²ï¼ˆadmin / memberï¼‰             â”‚
â”‚ âœ“ è‡ªå·±ç´¹ä»‹                           â”‚
â”‚ âœ“ æ‹…å½“æ¥½å™¨                           â”‚
â”‚ âœ“ ç™»éŒ²æ—¥                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/users/page.tsx` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import Link from 'next/link';
import Image from 'next/image';
import { Users, Shield, User } from 'lucide-react';

export default async function UsersPage() {
  const session = await auth();

  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
  const users = await prisma.user.findMany({
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      role: true,
      bio: true,
      instrument: true,
      createdAt: true,
      // çµ±è¨ˆæƒ…å ±
      _count: {
        select: {
          posts: true,
          participations: true,
          comments: true,
        },
      },
    },
    orderBy: [
      { role: 'desc' }, // adminã‚’å…ˆã«
      { createdAt: 'asc' }, // å¤ã„é †
    ],
  });

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="mb-8">
          <div className="flex items-center gap-3 mb-3">
            <Users size={32} className="text-blue-600" />
            <h1 className="text-3xl font-bold text-gray-900">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h1>
          </div>
          <p className="text-gray-600">
            BOLDè»½éŸ³ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç¢ºèªã§ãã¾ã™
          </p>
        </div>

        {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã®è¡¨ç¤º */}
        <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <p className="text-blue-900 font-medium">
            ç·ãƒ¡ãƒ³ãƒãƒ¼æ•°: {users.length}å
            {users.filter((u) => u.role === 'admin').length > 0 && (
              <span className="ml-4 text-blue-700">
                ï¼ˆç®¡ç†è€…: {users.filter((u) => u.role === 'admin').length}åï¼‰
              </span>
            )}
          </p>
        </div>

        {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {users.map((user) => (
            <UserCard key={user.id} user={user} isAdmin={session?.user?.role === 'admin'} />
          ))}
        </div>
      </div>
    </div>
  );
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function UserCard({ user, isAdmin }: { user: any; isAdmin: boolean }) {
  return (
    <Link
      href={`/users/${user.id}`}
      className="block bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden"
    >
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå½¹å‰²ã«å¿œã˜ã¦è‰²åˆ†ã‘ï¼‰ */}
      <div
        className={`h-20 ${
          user.role === 'admin'
            ? 'bg-gradient-to-r from-purple-600 to-indigo-600'
            : 'bg-gradient-to-r from-blue-500 to-cyan-500'
        }`}
      />

      {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="p-6 -mt-12">
        {/* ã‚¢ãƒã‚¿ãƒ¼ */}
        <div className="flex items-start justify-between mb-4">
          <div className="relative">
            {user.image ? (
              <Image
                src={user.image}
                alt={user.name || 'User'}
                width={80}
                height={80}
                className="rounded-full border-4 border-white shadow-lg"
              />
            ) : (
              <div className="w-20 h-20 rounded-full bg-gray-300 border-4 border-white shadow-lg flex items-center justify-center">
                <User size={40} className="text-gray-600" />
              </div>
            )}

            {/* å½¹å‰²ãƒãƒƒã‚¸ */}
            {user.role === 'admin' && (
              <div className="absolute -bottom-1 -right-1 bg-yellow-400 rounded-full p-1.5 border-2 border-white">
                <Shield size={16} className="text-yellow-900" />
              </div>
            )}
          </div>

          {/* ç®¡ç†è€…ãƒãƒ¼ã‚¯ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ */}
          {user.role === 'admin' && (
            <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded">
              ç®¡ç†è€…
            </span>
          )}
        </div>

        {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼å */}
        <h3 className="text-xl font-bold text-gray-900 mb-2">
          {user.name || 'Unknown User'}
        </h3>

        {/* è‡ªå·±ç´¹ä»‹ */}
        {user.bio && (
          <p className="text-gray-600 text-sm mb-3 line-clamp-2">{user.bio}</p>
        )}

        {/* æ‹…å½“æ¥½å™¨ */}
        {user.instrument && (
          <div className="mb-3">
            <span className="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
              {user.instrument}
            </span>
          </div>
        )}

        {/* çµ±è¨ˆæƒ…å ± */}
        <div className="flex items-center gap-4 text-sm text-gray-600 pt-3 border-t border-gray-200">
          <div>
            <span className="font-semibold">{user._count.posts}</span>
            <span className="ml-1">æŠ•ç¨¿</span>
          </div>
          <div>
            <span className="font-semibold">{user._count.participations}</span>
            <span className="ml-1">å‚åŠ </span>
          </div>
          <div>
            <span className="font-semibold">{user._count.comments}</span>
            <span className="ml-1">ã‚³ãƒ¡ãƒ³ãƒˆ</span>
          </div>
        </div>
      </div>
    </Link>
  );
}
```

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®ç‰¹å¾´:**

1. âœ… **å½¹å‰²ã«ã‚ˆã‚‹è‰²åˆ†ã‘**: ç®¡ç†è€…ã¯ç´«ã€ãƒ¡ãƒ³ãƒãƒ¼ã¯é’
2. âœ… **ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’è¡¨ç¤º
3. âœ… **çµ±è¨ˆæƒ…å ±**: æŠ•ç¨¿æ•°ã€å‚åŠ æ•°ã€ã‚³ãƒ¡ãƒ³ãƒˆæ•°
4. âœ… **ã‚«ãƒ¼ãƒ‰å½¢å¼**: ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
5. âœ… **ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã¸

### Step 2: å‹•ä½œç¢ºèª

**ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª:**

http://localhost:3000/users ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚

â†’ âœ… ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼

---

## 17.2 ç®¡ç†è€…æ©Ÿèƒ½ã®å®Ÿè£…

### å½¹å‰²å¤‰æ›´ã®ä»•çµ„ã¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å½¹å‰²å¤‰æ›´æ©Ÿèƒ½                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€æ¨©é™ã€‘
ç®¡ç†è€…ã®ã¿ãŒä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å¤‰æ›´å¯èƒ½

ã€å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘
member â†’ admin  æ˜‡æ ¼
admin  â†’ member é™æ ¼

ã€åˆ¶ç´„ã€‘
è‡ªåˆ†è‡ªèº«ã®å½¹å‰²ã¯å¤‰æ›´ä¸å¯
ï¼ˆæœ€å¾Œã®ç®¡ç†è€…ã‚’å¤±ã‚ãªã„ãŸã‚ï¼‰
```

### Step 1: å½¹å‰²å¤‰æ›´APIã‚’å®Ÿè£…

`src/app/api/users/[id]/role/route.ts` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å½¹å‰²ã®å¤‰æ›´ï¼ˆPATCHï¼‰
 */
export async function PATCH(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (session.user.role !== 'admin') {
      return NextResponse.json(
        { error: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' },
        { status: 403 }
      );
    }

    const userId = params.id;
    const body = await request.json();
    const { role } = body; // 'admin' or 'member'

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (role !== 'admin' && role !== 'member') {
      return NextResponse.json(
        { error: 'ç„¡åŠ¹ãªå½¹å‰²ã§ã™' },
        { status: 400 }
      );
    }

    // è‡ªåˆ†è‡ªèº«ã®å½¹å‰²ã¯å¤‰æ›´ä¸å¯
    if (userId === session.user.id) {
      return NextResponse.json(
        { error: 'è‡ªåˆ†è‡ªèº«ã®å½¹å‰²ã¯å¤‰æ›´ã§ãã¾ã›ã‚“' },
        { status: 400 }
      );
    }

    // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const targetUser = await prisma.user.findUnique({
      where: { id: userId },
    });

    if (!targetUser) {
      return NextResponse.json(
        { error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' },
        { status: 404 }
      );
    }

    // å½¹å‰²ã‚’æ›´æ–°
    const updatedUser = await prisma.user.update({
      where: { id: userId },
      data: { role },
      select: {
        id: true,
        name: true,
        email: true,
        role: true,
      },
    });

    return NextResponse.json({
      user: updatedUser,
      message: `å½¹å‰²ã‚’${role === 'admin' ? 'ç®¡ç†è€…' : 'ãƒ¡ãƒ³ãƒãƒ¼'}ã«å¤‰æ›´ã—ã¾ã—ãŸ`,
    });
  } catch (error) {
    console.error('å½¹å‰²å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'å½¹å‰²ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/users/[id]/page.tsx` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import {
  User,
  Mail,
  Calendar,
  Music,
  FileText,
  Users as UsersIcon,
  MessageCircle,
  Shield,
  Edit,
} from 'lucide-react';
import { RoleChangeButton } from '@/components/RoleChangeButton';

export default async function UserDetailPage({
  params,
}: {
  params: { id: string };
}) {
  const session = await auth();

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const user = await prisma.user.findUnique({
    where: { id: params.id },
    include: {
      // æŠ•ç¨¿
      posts: {
        take: 5,
        orderBy: { createdAt: 'desc' },
        include: {
          _count: {
            select: {
              likes: true,
              comments: true,
            },
          },
        },
      },
      // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ 
      participations: {
        take: 5,
        orderBy: { createdAt: 'desc' },
        include: {
          event: true,
        },
      },
      // ã‚³ãƒ¡ãƒ³ãƒˆ
      comments: {
        take: 5,
        orderBy: { createdAt: 'desc' },
        include: {
          post: {
            select: {
              id: true,
              title: true,
            },
          },
        },
      },
      // çµ±è¨ˆ
      _count: {
        select: {
          posts: true,
          participations: true,
          comments: true,
          likes: true,
        },
      },
    },
  });

  if (!user) {
    notFound();
  }

  // ç·¨é›†æ¨©é™ï¼ˆæœ¬äººã¾ãŸã¯ç®¡ç†è€…ï¼‰
  const canEdit =
    session?.user?.id === user.id || session?.user?.role === 'admin';

  // å½¹å‰²å¤‰æ›´æ¨©é™ï¼ˆç®¡ç†è€…ã®ã¿ã€è‡ªåˆ†ä»¥å¤–ï¼‰
  const canChangeRole =
    session?.user?.role === 'admin' && session?.user?.id !== user.id;

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <Link
          href="/users"
          className="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6"
        >
          â† ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã«æˆ»ã‚‹
        </Link>

        {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */}
        <div className="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå½¹å‰²ã«å¿œã˜ã¦è‰²åˆ†ã‘ï¼‰ */}
          <div
            className={`h-32 ${
              user.role === 'admin'
                ? 'bg-gradient-to-r from-purple-600 to-indigo-600'
                : 'bg-gradient-to-r from-blue-500 to-cyan-500'
            }`}
          />

          {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± */}
          <div className="px-8 pb-8">
            <div className="flex flex-col md:flex-row items-start md:items-end gap-6 -mt-16 mb-6">
              {/* ã‚¢ãƒã‚¿ãƒ¼ */}
              <div className="relative">
                {user.image ? (
                  <Image
                    src={user.image}
                    alt={user.name || 'User'}
                    width={120}
                    height={120}
                    className="rounded-full border-4 border-white shadow-lg"
                  />
                ) : (
                  <div className="w-30 h-30 rounded-full bg-gray-300 border-4 border-white shadow-lg flex items-center justify-center">
                    <User size={60} className="text-gray-600" />
                  </div>
                )}

                {/* å½¹å‰²ãƒãƒƒã‚¸ */}
                {user.role === 'admin' && (
                  <div className="absolute -bottom-2 -right-2 bg-yellow-400 rounded-full p-2 border-2 border-white">
                    <Shield size={20} className="text-yellow-900" />
                  </div>
                )}
              </div>

              {/* åå‰ã¨å½¹å‰² */}
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <h1 className="text-3xl font-bold text-gray-900">
                    {user.name || 'Unknown User'}
                  </h1>
                  {user.role === 'admin' && (
                    <span className="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-bold rounded">
                      ç®¡ç†è€…
                    </span>
                  )}
                </div>

                {/* æ‹…å½“æ¥½å™¨ */}
                {user.instrument && (
                  <div className="flex items-center gap-2 text-gray-600 mb-2">
                    <Music size={18} />
                    <span className="font-medium">{user.instrument}</span>
                  </div>
                )}

                {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */}
                <div className="flex items-center gap-2 text-gray-600">
                  <Mail size={18} />
                  <span>{user.email}</span>
                </div>
              </div>

              {/* ãƒœã‚¿ãƒ³ */}
              <div className="flex gap-2">
                {/* ç·¨é›†ãƒœã‚¿ãƒ³ */}
                {canEdit && (
                  <Link
                    href="/profile"
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                  >
                    <Edit size={18} />
                    ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                  </Link>
                )}

                {/* å½¹å‰²å¤‰æ›´ãƒœã‚¿ãƒ³ */}
                {canChangeRole && (
                  <RoleChangeButton userId={user.id} currentRole={user.role} />
                )}
              </div>
            </div>

            {/* è‡ªå·±ç´¹ä»‹ */}
            {user.bio && (
              <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 className="font-semibold text-gray-900 mb-2">è‡ªå·±ç´¹ä»‹</h3>
                <p className="text-gray-700 whitespace-pre-wrap">{user.bio}</p>
              </div>
            )}

            {/* çµ±è¨ˆæƒ…å ± */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div className="p-4 bg-blue-50 rounded-lg text-center">
                <FileText className="mx-auto mb-2 text-blue-600" size={24} />
                <div className="text-2xl font-bold text-blue-900">
                  {user._count.posts}
                </div>
                <div className="text-sm text-blue-700">æŠ•ç¨¿</div>
              </div>

              <div className="p-4 bg-green-50 rounded-lg text-center">
                <UsersIcon className="mx-auto mb-2 text-green-600" size={24} />
                <div className="text-2xl font-bold text-green-900">
                  {user._count.participations}
                </div>
                <div className="text-sm text-green-700">ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ </div>
              </div>

              <div className="p-4 bg-purple-50 rounded-lg text-center">
                <MessageCircle
                  className="mx-auto mb-2 text-purple-600"
                  size={24}
                />
                <div className="text-2xl font-bold text-purple-900">
                  {user._count.comments}
                </div>
                <div className="text-sm text-purple-700">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
              </div>

              <div className="p-4 bg-red-50 rounded-lg text-center">
                <Calendar className="mx-auto mb-2 text-red-600" size={24} />
                <div className="text-sm text-red-700">
                  {new Date(user.createdAt).toLocaleDateString('ja-JP')}
                </div>
                <div className="text-sm text-red-700">ç™»éŒ²æ—¥</div>
              </div>
            </div>
          </div>
        </div>

        {/* æ´»å‹•å±¥æ­´ */}
        <div className="grid md:grid-cols-2 gap-8">
          {/* æœ€è¿‘ã®æŠ•ç¨¿ */}
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
              <FileText size={24} className="text-blue-600" />
              æœ€è¿‘ã®æŠ•ç¨¿
            </h2>

            {user.posts.length > 0 ? (
              <div className="space-y-3">
                {user.posts.map((post) => (
                  <Link
                    key={post.id}
                    href={`/posts/${post.id}`}
                    className="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                  >
                    <h3 className="font-semibold text-gray-900 mb-1">
                      {post.title}
                    </h3>
                    <div className="flex items-center gap-4 text-sm text-gray-600">
                      <span>ğŸ‘ {post._count.likes}</span>
                      <span>ğŸ’¬ {post._count.comments}</span>
                      <span>
                        {new Date(post.createdAt).toLocaleDateString('ja-JP')}
                      </span>
                    </div>
                  </Link>
                ))}
              </div>
            ) : (
              <p className="text-gray-500 text-center py-8">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            )}
          </div>

          {/* æœ€è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ  */}
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
              <UsersIcon size={24} className="text-green-600" />
              æœ€è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ 
            </h2>

            {user.participations.length > 0 ? (
              <div className="space-y-3">
                {user.participations.map((participation) => (
                  <Link
                    key={participation.id}
                    href={`/events/${participation.event.id}`}
                    className="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors"
                  >
                    <h3 className="font-semibold text-gray-900 mb-1">
                      {participation.event.title}
                    </h3>
                    <div className="text-sm text-gray-600">
                      {new Date(participation.event.date).toLocaleDateString(
                        'ja-JP',
                        {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric',
                          weekday: 'short',
                        }
                      )}
                    </div>
                  </Link>
                ))}
              </div>
            ) : (
              <p className="text-gray-500 text-center py-8">
                å‚åŠ ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“
              </p>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
```

### Step 3: å½¹å‰²å¤‰æ›´ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/RoleChangeButton.tsx` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { Shield, ShieldOff } from 'lucide-react';

interface RoleChangeButtonProps {
  userId: string;
  currentRole: string;
}

export function RoleChangeButton({ userId, currentRole }: RoleChangeButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [isChanging, setIsChanging] = useState(false);

  const handleRoleChange = async () => {
    const newRole = currentRole === 'admin' ? 'member' : 'admin';
    const confirmMessage =
      newRole === 'admin'
        ? 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†è€…ã«æ˜‡æ ¼ã—ã¾ã™ã‹ï¼Ÿ'
        : 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã«é™æ ¼ã—ã¾ã™ã‹ï¼Ÿ';

    if (!confirm(confirmMessage)) {
      return;
    }

    setIsChanging(true);

    try {
      const response = await fetch(`/api/users/${userId}/role`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole }),
      });

      const data = await response.json();

      if (!response.ok) {
        alert(data.error || 'å½¹å‰²ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setIsChanging(false);
        return;
      }

      alert(data.message);

      // ãƒšãƒ¼ã‚¸ã‚’å†æ¤œè¨¼
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      alert('å½¹å‰²ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      setIsChanging(false);
    }
  };

  return (
    <button
      onClick={handleRoleChange}
      disabled={isChanging || isPending}
      className={`
        px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2
        ${
          currentRole === 'admin'
            ? 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            : 'bg-purple-600 text-white hover:bg-purple-700'
        }
        disabled:opacity-50 disabled:cursor-not-allowed
      `}
    >
      {currentRole === 'admin' ? (
        <>
          <ShieldOff size={18} />
          é™æ ¼
        </>
      ) : (
        <>
          <Shield size={18} />
          æ˜‡æ ¼
        </>
      )}
    </button>
  );
}
```

### Step 4: å‹•ä½œç¢ºèª

**4-1.** ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³

**4-2.** http://localhost:3000/users ã‚’é–‹ã„ã¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯

**4-3.** ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œæ˜‡æ ¼ã€ã¾ãŸã¯ã€Œé™æ ¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… å½¹å‰²ãŒå¤‰æ›´ã•ã‚Œã¾ã™ï¼

---

## 17.3 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã®ä»•çµ„ã¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç·¨é›†å¯èƒ½ãªé …ç›®ã€‘
âœ“ ã‚¢ãƒã‚¿ãƒ¼ç”»åƒï¼ˆSupabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
âœ“ åå‰
âœ“ è‡ªå·±ç´¹ä»‹
âœ“ æ‹…å½“æ¥½å™¨

ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æµã‚Œã€‘
1ï¸âƒ£ ç”»åƒã‚’é¸æŠ
2ï¸âƒ£ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
3ï¸âƒ£ Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
4ï¸âƒ£ URLã‚’å–å¾—
5ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
```

### Step 1: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°APIã‚’å®Ÿè£…

`src/app/api/profile/route.ts` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ï¼ˆPATCHï¼‰
 */
export async function PATCH(request: Request) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { name, bio, instrument, image } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (name && name.trim().length === 0) {
      return NextResponse.json(
        { error: 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' },
        { status: 400 }
      );
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
    const updatedUser = await prisma.user.update({
      where: { id: session.user.id },
      data: {
        ...(name && { name: name.trim() }),
        ...(bio !== undefined && { bio: bio.trim() || null }),
        ...(instrument !== undefined && { instrument: instrument.trim() || null }),
        ...(image !== undefined && { image: image.trim() || null }),
      },
      select: {
        id: true,
        name: true,
        email: true,
        image: true,
        bio: true,
        instrument: true,
      },
    });

    return NextResponse.json({
      user: updatedUser,
      message: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ',
    });
  } catch (error) {
    console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### Step 2: Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ

`src/lib/supabase.ts` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { createClient } from '@supabase/supabase-js';

// Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

/**
 * ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 */
export async function uploadAvatar(file: File, userId: string): Promise<string> {
  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ï¼‰
  const fileExt = file.name.split('.').pop();
  const fileName = `${userId}-${Date.now()}.${fileExt}`;
  const filePath = `avatars/${fileName}`;

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
    });

  if (error) {
    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  // å…¬é–‹URLã‚’å–å¾—
  const { data: publicUrlData } = supabase.storage
    .from('avatars')
    .getPublicUrl(filePath);

  return publicUrlData.publicUrl;
}

/**
 * å¤ã„ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å‰Šé™¤
 */
export async function deleteAvatar(imageUrl: string): Promise<void> {
  try {
    // URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡º
    const url = new URL(imageUrl);
    const filePath = url.pathname.split('/storage/v1/object/public/avatars/')[1];

    if (!filePath) {
      return;
    }

    // ç”»åƒã‚’å‰Šé™¤
    const { error } = await supabase.storage.from('avatars').remove([`avatars/${filePath}`]);

    if (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    }
  } catch (error) {
    console.error('å‰Šé™¤å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}
```

### Step 3: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/profile/page.tsx` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';
import { prisma } from '@/lib/db';
import { ProfileForm } from '@/components/ProfileForm';

export default async function ProfilePage() {
  const session = await auth();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session) {
    redirect('/auth/signin');
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      bio: true,
      instrument: true,
    },
  });

  if (!user) {
    redirect('/auth/signin');
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
        </h1>

        <ProfileForm user={user} />
      </div>
    </div>
  );
}
```

### Step 4: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/ProfileForm.tsx` ã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’**ã™ã¹ã¦**å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š

```typescript
'use client';

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { Camera, User, Loader2 } from 'lucide-react';
import { uploadAvatar } from '@/lib/supabase';

interface ProfileFormProps {
  user: {
    id: string;
    name: string | null;
    email: string;
    image: string | null;
    bio: string | null;
    instrument: string | null;
  };
}

export function ProfileForm({ user }: ProfileFormProps) {
  const router = useRouter();
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [loading, setLoading] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState('');

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [name, setName] = useState(user.name || '');
  const [bio, setBio] = useState(user.bio || '');
  const [instrument, setInstrument] = useState(user.instrument || '');
  const [imageUrl, setImageUrl] = useState(user.image || '');
  const [imageFile, setImageFile] = useState<File | null>(null);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);

  // ç”»åƒé¸æŠ
  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
    if (file.size > 5 * 1024 * 1024) {
      alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
      return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
    if (!file.type.startsWith('image/')) {
      alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    setImageFile(file);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®URLã‚’ä½œæˆ
    const url = URL.createObjectURL(file);
    setPreviewUrl(url);
  };

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      let finalImageUrl = imageUrl;

      // æ–°ã—ã„ç”»åƒãŒã‚ã‚‹å ´åˆã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if (imageFile) {
        setUploading(true);
        finalImageUrl = await uploadAvatar(imageFile, user.id);
        setUploading(false);
      }

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
      const response = await fetch('/api/profile', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: name.trim(),
          bio: bio.trim(),
          instrument: instrument.trim(),
          image: finalImageUrl,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
        return;
      }

      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      router.push(`/users/${user.id}`);
      router.refresh();
    } catch (err) {
      setError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      setLoading(false);
    }
  };

  // ç¾åœ¨è¡¨ç¤ºã™ã‚‹ç”»åƒURL
  const displayImageUrl = previewUrl || imageUrl;

  return (
    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6">
      {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
          {error}
        </div>
      )}

      {/* ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ */}
      <div className="mb-8">
        <label className="block text-sm font-medium text-gray-700 mb-4">
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
        </label>

        <div className="flex items-center gap-6">
          {/* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
          <div className="relative">
            {displayImageUrl ? (
              <Image
                src={displayImageUrl}
                alt="Profile"
                width={120}
                height={120}
                className="rounded-full object-cover"
              />
            ) : (
              <div className="w-30 h-30 rounded-full bg-gray-200 flex items-center justify-center">
                <User size={60} className="text-gray-400" />
              </div>
            )}

            {/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */}
            {uploading && (
              <div className="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center">
                <Loader2 className="animate-spin text-white" size={32} />
              </div>
            )}
          </div>

          {/* ç”»åƒé¸æŠãƒœã‚¿ãƒ³ */}
          <div>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleImageSelect}
              className="hidden"
            />
            <button
              type="button"
              onClick={() => fileInputRef.current?.click()}
              disabled={uploading || loading}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Camera size={20} />
              ç”»åƒã‚’é¸æŠ
            </button>
            <p className="text-xs text-gray-500 mt-2">
              JPG, PNG, GIFï¼ˆæœ€å¤§5MBï¼‰
            </p>
          </div>
        </div>
      </div>

      {/* åå‰ */}
      <div className="mb-6">
        <label
          htmlFor="name"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          åå‰ <span className="text-red-500">*</span>
        </label>
        <input
          id="name"
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="å±±ç”° å¤ªéƒ"
          required
        />
      </div>

      {/* è‡ªå·±ç´¹ä»‹ */}
      <div className="mb-6">
        <label
          htmlFor="bio"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          è‡ªå·±ç´¹ä»‹
        </label>
        <textarea
          id="bio"
          value={bio}
          onChange={(e) => setBio(e.target.value)}
          rows={4}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
        />
        <p className="text-xs text-gray-500 mt-1">
          {bio.length}/500æ–‡å­—
        </p>
      </div>

      {/* æ‹…å½“æ¥½å™¨ */}
      <div className="mb-8">
        <label
          htmlFor="instrument"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          æ‹…å½“æ¥½å™¨
        </label>
        <input
          id="instrument"
          type="text"
          value={instrument}
          onChange={(e) => setInstrument(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ä¾‹: ã‚®ã‚¿ãƒ¼ã€ãƒœãƒ¼ã‚«ãƒ«ã€ãƒ‰ãƒ©ãƒ "
        />
      </div>

      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <button
          type="submit"
          disabled={loading || uploading}
          className="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          {loading ? (
            <>
              <Loader2 className="animate-spin" size={20} />
              æ›´æ–°ä¸­...
            </>
          ) : (
            'ä¿å­˜'
          )}
        </button>

        <button
          type="button"
          onClick={() => router.back()}
          disabled={loading || uploading}
          className="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </form>
  );
}
```

### Step 5: Supabaseã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

**5-1.** Supabase Dashboard ã§ã€ŒStorageã€â†’ã€ŒCreate bucketã€

**5-2.** ãƒã‚±ãƒƒãƒˆå: `avatars`ã€Public: âœ“ï¼ˆæœ‰åŠ¹ï¼‰

**5-3.** `.env.local` ã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼ˆæ—¢ã«è¨­å®šæ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰

```env
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

**5-4.** Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @supabase/supabase-js
```

### Step 6: å‹•ä½œç¢ºèª

**6-1.** http://localhost:3000/profile ã‚’é–‹ã

**6-2.** ç”»åƒã‚’é¸æŠã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª

**6-3.** åå‰ã€è‡ªå·±ç´¹ä»‹ã€æ‹…å½“æ¥½å™¨ã‚’å…¥åŠ›

**6-4.** ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ï¼

---

## 17.4 ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Chapter 17ã®å†…å®¹ã‚’ç†è§£ã§ããŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] å½¹å‰²ã«ã‚ˆã‚‹è‰²åˆ†ã‘ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®Ÿè£…ã§ãã‚‹

### ç®¡ç†è€…æ©Ÿèƒ½

- [ ] å½¹å‰²å¤‰æ›´APIã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ç®¡ç†è€…æ¨©é™ã®ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹
- [ ] è‡ªåˆ†è‡ªèº«ã®å½¹å‰²å¤‰æ›´ã‚’é˜²æ­¢ã§ãã‚‹
- [ ] å½¹å‰²å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’å®Ÿè£…ã§ãã‚‹

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†

- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°APIã‚’å®Ÿè£…ã§ãã‚‹
- [ ] Supabase Storageã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒã§ãã‚‹
- [ ] ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãŒã§ãã‚‹
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã§ãã‚‹

### ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] æ´»å‹•å±¥æ­´ã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤ºã§ãã‚‹

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®è¡¨ç¤º
- âœ… å½¹å‰²ã«ã‚ˆã‚‹è‰²åˆ†ã‘
- âœ… çµ±è¨ˆæƒ…å ±ã®é›†è¨ˆ
- âœ… ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®è¡¨ç¤º

#### ç®¡ç†è€…æ©Ÿèƒ½
- âœ… å½¹å‰²å¤‰æ›´API
- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯
- âœ… æ¥½è¦³çš„UIã«ã‚ˆã‚‹æ›´æ–°

#### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
- âœ… Supabase Storageã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
- âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®æ›´æ–°

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®è¡¨ç¤º
- âœ… æ´»å‹•å±¥æ­´ã®è¡¨ç¤º
- âœ… çµ±è¨ˆæƒ…å ±ã®å¯è¦–åŒ–

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### Supabase Storage ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```typescript
// ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
const { data, error } = await supabase.storage
  .from('avatars')
  .upload(filePath, file, {
    cacheControl: '3600',
    upsert: false,
  });

// å…¬é–‹URLã‚’å–å¾—
const { data: publicUrlData } = supabase.storage
  .from('avatars')
  .getPublicUrl(filePath);
```

#### å½¹å‰²å¤‰æ›´ã®æ¨©é™ãƒã‚§ãƒƒã‚¯

```typescript
// ç®¡ç†è€…ã®ã¿
if (session.user.role !== 'admin') {
  return { error: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' };
}

// è‡ªåˆ†è‡ªèº«ã¯å¤‰æ›´ä¸å¯
if (userId === session.user.id) {
  return { error: 'è‡ªåˆ†è‡ªèº«ã®å½¹å‰²ã¯å¤‰æ›´ã§ãã¾ã›ã‚“' };
}
```

### ğŸš€ æ¬¡ã®ç« ã¸ã®æº–å‚™

æ¬¡ã®ç« ï¼ˆChapter 18: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼‰ã§ã¯ã€ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š

1. **æŠ•ç¨¿ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   - è¤‡æ•°ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

2. **ç”»åƒã®æœ€é©åŒ–**
   - next/imageã®æ´»ç”¨
   - ãƒªã‚µã‚¤ã‚ºå‡¦ç†

**æº–å‚™ã™ã‚‹ã“ã¨:**
- âœ… Supabase StorageãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

[â† å‰ã®ç« ï¼šç¬¬16ç«  æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…](16-æ´»å‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬18ç«  ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ â†’](18-ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½.md)
