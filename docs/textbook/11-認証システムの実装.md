# 第11章：認証システムの実装【ハンズオン】

> **この章では、NextAuth.jsを使ってログイン・サインアップ機能を実際に作成します**

## 🛠️ **ハンズオン作業**

**⚠️ 重要**: この章では実際に手を動かして認証システムを実装します。各セクションの指示に従って、ファイルを作成・編集してください。コードは必ず自分で入力しながら進めましょう。

## 📚 この章で学ぶこと

- ✅ 認証の基本概念（認証 vs 認可）
- ✅ NextAuth.js v5 のセットアップ
- ✅ Google OAuth ログインの実装
- ✅ メールアドレス+パスワード認証の実装
- ✅ サインアップページの作成
- ✅ ログインページの作成
- ✅ ログアウト機能の実装
- ✅ 認証状態の確認と保護されたページ

---

## 11.1 認証の基本概念

### 認証（Authentication）と認可（Authorization）の違い

```
┌─────────────────────────────────────────────────┐
│ 認証（Authentication）                           │
│ 「あなたは誰ですか？」                            │
│                                                 │
│ 例：ログイン                                     │
│   - メールアドレスとパスワードで本人確認           │
│   - Googleアカウントで本人確認                    │
└─────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────┐
│ 認可（Authorization）                            │
│ 「あなたは何ができますか？」                       │
│                                                 │
│ 例：権限チェック                                  │
│   - 管理者だけが投稿を削除できる                   │
│   - 本人だけが自分の投稿を編集できる               │
└─────────────────────────────────────────────────┘
```

**このプロジェクトの認証・認可：**

| ユーザー種別 | 認証方法 | できること（認可） |
|------------|---------|------------------|
| **一般メンバー** | Google or パスワード | 投稿閲覧、いいね、コメント、スケジュール投票 |
| **管理者** | Google or パスワード | 上記 + 投稿作成/編集/削除、スケジュール作成 |

### セッション管理の仕組み

```
1️⃣ ユーザーがログイン（メール + パスワード）
   ↓
2️⃣ サーバーがユーザー情報を確認
   ↓
3️⃣ サーバーがセッショントークンを発行
   ↓
4️⃣ ブラウザがCookieにトークンを保存
   ↓
5️⃣ 以降のリクエストでCookieを自動送信
   ↓
6️⃣ サーバーがトークンを検証してユーザーを特定
   ↓
7️⃣ ログアウト時にトークンを削除
```

**JWT（JSON Web Token）:**
- トークンの中にユーザー情報を含める
- サーバー側でデータベースを確認しなくても検証可能
- 有効期限を設定できる

---

## 11.2 NextAuth.js とは

NextAuth.js は、Next.js アプリケーションで認証を簡単に実装できるライブラリです。

### NextAuth.js の特徴

| 特徴 | 説明 | メリット |
|-----|------|---------|
| 🔐 **多様な認証方法** | Google, GitHub, メール+パスワード等 | 柔軟な認証オプション |
| 🛡️ **セキュリティ** | CSRF保護、トークン管理 | 安全なログイン |
| 📦 **簡単なセットアップ** | 設定ファイルだけで動作 | 実装が簡単 |
| 🔄 **セッション管理** | JWT or データベース | 状態管理が楽 |
| 🎨 **カスタマイズ可能** | ページやコールバックを自由に変更 | 要件に合わせられる |

### このプロジェクトでの認証方式

1. **Google OAuth**: Googleアカウントでログイン
2. **Credentials**: メールアドレス + パスワードでログイン

---

## 11.3 認証システムの準備

### Step 1: 環境変数の確認

`<br/>.env.local` を開いて、認証関連の設定を確認しましょう。

```env
# NextAuth.js認証設定
AUTH_URL="http://localhost:3000"
AUTH_SECRET="your-generated-secret-key"
AUTH_TRUST_HOST=true

NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-generated-secret-key"

# Google OAuth設定（後で設定）
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""
```

**AUTH_SECRET の生成方法:**

```bash
# ターミナルで実行（ランダムな文字列を生成）
openssl rand -base64 32
```

**生成された文字列を AUTH_SECRET と NEXTAUTH_SECRET にコピー:**

```env
AUTH_SECRET="abc123xyz789...生成された文字列"
NEXTAUTH_SECRET="abc123xyz789...同じ文字列"
```

### Step 2: Prisma スキーマの確認

`prisma/schema.prisma` を開いて、認証関連のモデルを確認しましょう。

```prisma
// ========================================
// ユーザー情報
// ========================================
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  name          String?
  password      String?   // パスワード認証用
  role          UserRole  @default(member)
  image         String?
  bio           String?
  instrument    String?
  emailVerified DateTime?
  
  // NextAuth.js関連
  accounts      Account[]
  sessions      Session[]
  
  // アプリケーション機能関連
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  // ... 他のリレーション
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========================================
// OAuth アカウント情報（Google等）
// ========================================
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String  // "google", "github"等
  providerAccountId  String  // プロバイダー側のユーザーID
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// ========================================
// セッション情報
// ========================================
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ========================================
// 検証トークン（メール認証用）
// ========================================
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

**各モデルの役割:**

- **User**: ユーザー情報（メール、パスワード、役割等）
- **Account**: OAuth プロバイダー情報（Google でログインした時の情報）
- **Session**: セッション情報（ログイン状態を保持）
- **VerificationToken**: メール認証用トークン

### Step 3: NextAuth.js の設定ファイルを確認

`src/lib/auth.ts` を開いて、以下のコードを**すべて**入力してください：

以下のコードで**上書き**してください：

```typescript
import NextAuth from 'next-auth';
import Google from 'next-auth/providers/google';
import Credentials from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@auth/prisma-adapter';
import { prisma } from '@/lib/db';
import bcrypt from 'bcryptjs';

export const { handlers, signIn, signOut, auth } = NextAuth({
  adapter: PrismaAdapter(prisma),
  
  // セッション設定
  session: {
    strategy: 'jwt',  // JWTを使用
  },
  
  // 認証プロバイダー
  providers: [
    // 1. Google OAuth
    Google({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    
    // 2. メールアドレス + パスワード
    Credentials({
      name: 'Credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }
        
        // ユーザーを検索
        const user = await prisma.user.findUnique({
          where: { email: credentials.email as string },
        });
        
        if (!user || !user.password) {
          return null;
        }
        
        // パスワードを検証
        const isValid = await bcrypt.compare(
          credentials.password as string,
          user.password
        );
        
        if (!isValid) {
          return null;
        }
        
        return {
          id: user.id,
          email: user.email,
          name: user.name,
          role: user.role,
          image: user.image,
        };
      },
    }),
  ],
  
  // コールバック
  callbacks: {
    // JWTトークンにユーザー情報を追加
    async jwt({ token, user }) {
      if (user) {
        token.role = user.role;
      }
      return token;
    },
    
    // セッションにユーザー情報を追加
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.sub!;
        session.user.role = token.role as string;
      }
      return session;
    },
  },
  
  // カスタムページ
  pages: {
    signIn: '/auth/signin',  // ログインページ
  },
});
```

**このファイルの重要な部分:**

1. **providers**: 認証方法の設定（Google, Credentials）
2. **callbacks**: セッションにカスタム情報（roleなど）を追加
3. **pages**: カスタムログインページの指定

### Step 4: API Route の確認

`src/app/api/auth/[...nextauth]/route.ts` を開いて、以下のコードを**すべて**入力してください：

以下のコードで**上書き**してください：

```typescript
import { handlers } from '@/lib/auth';

// NextAuth.jsのAPIルートを自動生成
export const { GET, POST } = handlers;
```

**このファイルの役割:**
- `/api/auth/*` のエンドポイントを自動生成
- ログイン、ログアウト、セッション取得等のAPIを提供

---

## 11.4 Google OAuth の設定

Google アカウントでログインできるようにします。

### Step 1: Google Cloud Console にアクセス

1. ブラウザで https://console.cloud.google.com/ を開く
2. Google アカウントでログイン

### Step 2: プロジェクトを作成

**2-1.** 画面上部の「プロジェクトを選択」をクリック

**2-2.** 「新しいプロジェクト」をクリック

**2-3.** プロジェクト名を入力
```
プロジェクト名: keion-circle-site
```

**2-4.** 「作成」をクリック

### Step 3: OAuth 同意画面を設定

**3-1.** 左側のメニューから「APIとサービス」→「OAuth 同意画面」を選択

**3-2.** User Type を選択
```
○ 内部（組織内のユーザーのみ）
● 外部（誰でもログイン可能）  ← これを選択
```

**3-3.** 「作成」をクリック

**3-4.** アプリ情報を入力

```
アプリ名: BOLD軽音メンバーサイト
ユーザーサポートメール: あなたのメールアドレス
デベロッパーの連絡先情報: あなたのメールアドレス
```

**3-5.** 「保存して次へ」を3回クリック（スコープとテストユーザーはスキップ）

### Step 4: OAuth クライアント ID を作成

**4-1.** 左側のメニューから「認証情報」を選択

**4-2.** 上部の「+ 認証情報を作成」→「OAuth クライアント ID」を選択

**4-3.** アプリケーションの種類を選択
```
アプリケーションの種類: ウェブアプリケーション
名前: Next.js App
```

**4-4.** 承認済みのリダイレクト URI を追加

```
承認済みのリダイレクト URI:
  http://localhost:3000/api/auth/callback/google
```

**4-5.** 「作成」をクリック

### Step 5: クライアント ID とシークレットをコピー

作成が完了すると、**クライアント ID** と **クライアント シークレット** が表示されます。

**5-1.** これらをコピーして `.env.local` に貼り付け

```env
GOOGLE_CLIENT_ID="123456789-abcdefg.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="GOCSPX-abcdefghijklmnop"
```

**5-2.** 開発サーバーを再起動

```bash
# Ctrl + C で停止
npm run dev
```

---

## 11.5 サインアップページの実装

新規ユーザーがアカウントを作成できるページを作成します。

### Step 1: サインアップ API を作成

`src/app/api/auth/signup/route.ts` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/db';
import bcrypt from 'bcryptjs';

export async function POST(request: Request) {
  try {
    // リクエストボディを取得
    const { email, password, name } = await request.json();
    
    // バリデーション
    if (!email || !password || !name) {
      return NextResponse.json(
        { error: 'メールアドレス、パスワード、名前は必須です' },
        { status: 400 }
      );
    }
    
    // パスワードの長さチェック
    if (password.length < 8) {
      return NextResponse.json(
        { error: 'パスワードは8文字以上にしてください' },
        { status: 400 }
      );
    }
    
    // メールアドレスの重複チェック
    const existingUser = await prisma.user.findUnique({
      where: { email },
    });
    
    if (existingUser) {
      return NextResponse.json(
        { error: 'このメールアドレスは既に登録されています' },
        { status: 400 }
      );
    }
    
    // パスワードをハッシュ化
    const hashedPassword = await bcrypt.hash(password, 10);
    
    // ユーザーを作成
    const user = await prisma.user.create({
      data: {
        email,
        name,
        password: hashedPassword,
        role: 'member',  // デフォルトは一般メンバー
      },
    });
    
    // パスワードを除いて返す
    const { password: _, ...userWithoutPassword } = user;
    
    return NextResponse.json(
      { user: userWithoutPassword },
      { status: 201 }
    );
  } catch (error) {
    console.error('サインアップエラー:', error);
    return NextResponse.json(
      { error: 'サインアップに失敗しました' },
      { status: 500 }
    );
  }
}
```

**このAPIの処理:**

1. ✅ メールアドレス、パスワード、名前を受け取る
2. ✅ バリデーション（必須チェック、長さチェック）
3. ✅ 重複チェック（既に登録されていないか）
4. ✅ パスワードをハッシュ化（bcryptjs）
5. ✅ データベースに保存
6. ✅ ユーザー情報を返す（パスワードは除く）

### Step 2: サインアップページを作成

`src/app/auth/signup/page.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { signIn } from 'next-auth/react';
import Link from 'next/link';

export default function SignUpPage() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    name: '',
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // フォーム送信
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    // パスワード確認
    if (formData.password !== formData.confirmPassword) {
      setError('パスワードが一致しません');
      setLoading(false);
      return;
    }

    try {
      // サインアップAPI呼び出し
      const response = await fetch('/api/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: formData.email,
          password: formData.password,
          name: formData.name,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || 'サインアップに失敗しました');
        setLoading(false);
        return;
      }

      // サインアップ成功 → 自動ログイン
      const result = await signIn('credentials', {
        email: formData.email,
        password: formData.password,
        redirect: false,
      });

      if (result?.error) {
        setError('ログインに失敗しました');
        setLoading(false);
        return;
      }

      // ホームページへリダイレクト
      router.push('/');
      router.refresh();
    } catch (err) {
      setError('エラーが発生しました');
      setLoading(false);
    }
  };

  // Google でサインアップ
  const handleGoogleSignUp = () => {
    signIn('google', { callbackUrl: '/' });
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
      <div className="max-w-md w-full space-y-8">
        {/* ヘッダー */}
        <div className="text-center">
          <h2 className="text-3xl font-bold text-gray-900">
            アカウント作成
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            BOLD軽音メンバーサイトへようこそ
          </p>
        </div>

        {/* エラーメッセージ */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        )}

        {/* サインアップフォーム */}
        <form onSubmit={handleSubmit} className="mt-8 space-y-6">
          {/* 名前 */}
          <div>
            <label htmlFor="name" className="block text-sm font-medium text-gray-700">
              名前
            </label>
            <input
              id="name"
              type="text"
              required
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="山田太郎"
            />
          </div>

          {/* メールアドレス */}
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">
              メールアドレス
            </label>
            <input
              id="email"
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="email@example.com"
            />
          </div>

          {/* パスワード */}
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">
              パスワード
            </label>
            <input
              id="password"
              type="password"
              required
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="8文字以上"
              minLength={8}
            />
          </div>

          {/* パスワード確認 */}
          <div>
            <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700">
              パスワード（確認）
            </label>
            <input
              id="confirmPassword"
              type="password"
              required
              value={formData.confirmPassword}
              onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="もう一度入力"
              minLength={8}
            />
          </div>

          {/* サインアップボタン */}
          <button
            type="submit"
            disabled={loading}
            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? '作成中...' : 'アカウント作成'}
          </button>
        </form>

        {/* 区切り線 */}
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300" />
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-2 bg-gray-50 text-gray-500">または</span>
          </div>
        </div>

        {/* Google サインアップ */}
        <button
          onClick={handleGoogleSignUp}
          className="w-full flex items-center justify-center gap-3 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
          Google でサインアップ
        </button>

        {/* ログインリンク */}
        <div className="text-center">
          <p className="text-sm text-gray-600">
            すでにアカウントをお持ちですか？{' '}
            <Link href="/auth/signin" className="font-medium text-blue-600 hover:text-blue-500">
              ログイン
            </Link>
          </p>
        </div>
      </div>
    </div>
  );
}
```

### Step 3: 動作確認

**3-1.** ブラウザで http://localhost:3000/auth/signup を開く

**3-2.** フォームに入力

```
名前: テストユーザー
メールアドレス: test@example.com
パスワード: password123
パスワード（確認）: password123
```

**3-3.** 「アカウント作成」ボタンをクリック

→ ✅ アカウントが作成され、自動的にログインされます！

**3-4.** Prisma Studio で確認

```bash
npm run db:studio
```

→ User テーブルに新しいユーザーが追加されているはずです。

---

## 11.6 ログインページの実装

既存ユーザーがログインできるページを作成します。

### Step 1: ログインページを作成

`src/app/auth/signin/page.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
'use client';

import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function SignInPage() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // フォーム送信
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      // ログイン
      const result = await signIn('credentials', {
        email: formData.email,
        password: formData.password,
        redirect: false,
      });

      if (result?.error) {
        setError('メールアドレスまたはパスワードが正しくありません');
        setLoading(false);
        return;
      }

      // ログイン成功
      router.push('/');
      router.refresh();
    } catch (err) {
      setError('エラーが発生しました');
      setLoading(false);
    }
  };

  // Google でログイン
  const handleGoogleSignIn = () => {
    signIn('google', { callbackUrl: '/' });
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4">
      <div className="max-w-md w-full space-y-8">
        {/* ヘッダー */}
        <div className="text-center">
          <h2 className="text-3xl font-bold text-gray-900">
            ログイン
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            BOLD軽音メンバーサイトへ
          </p>
        </div>

        {/* エラーメッセージ */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        )}

        {/* ログインフォーム */}
        <form onSubmit={handleSubmit} className="mt-8 space-y-6">
          {/* メールアドレス */}
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700">
              メールアドレス
            </label>
            <input
              id="email"
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="email@example.com"
            />
          </div>

          {/* パスワード */}
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700">
              パスワード
            </label>
            <input
              id="password"
              type="password"
              required
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="パスワード"
            />
          </div>

          {/* ログインボタン */}
          <button
            type="submit"
            disabled={loading}
            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'ログイン中...' : 'ログイン'}
          </button>
        </form>

        {/* 区切り線 */}
        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300" />
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-2 bg-gray-50 text-gray-500">または</span>
          </div>
        </div>

        {/* Google ログイン */}
        <button
          onClick={handleGoogleSignIn}
          className="w-full flex items-center justify-center gap-3 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="currentColor"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="currentColor"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="currentColor"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
          Google でログイン
        </button>

        {/* サインアップリンク */}
        <div className="text-center">
          <p className="text-sm text-gray-600">
            アカウントをお持ちでないですか？{' '}
            <Link href="/auth/signup" className="font-medium text-blue-600 hover:text-blue-500">
              新規登録
            </Link>
          </p>
        </div>
      </div>
    </div>
  );
}
```

### Step 2: 動作確認

**2-1.** ブラウザで http://localhost:3000/auth/signin を開く

**2-2.** 先ほど作成したアカウントでログイン

```
メールアドレス: test@example.com
パスワード: password123
```

**2-3.** 「ログイン」ボタンをクリック

→ ✅ ログインに成功し、ホームページにリダイレクトされます！

---

## 11.7 認証状態の確認

ログインしているかどうかを確認し、ユーザー情報を表示しましょう。

### Step 1: ルートレイアウトを更新

`src/app/layout.tsx` を開いて、セッションプロバイダーを追加します。

```typescript
import type { Metadata } from 'next';
import { SessionProvider } from 'next-auth/react';
import './globals.css';

export const metadata: Metadata = {
  title: 'BOLD軽音メンバーサイト',
  description: '活動報告とスケジュール管理',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        <SessionProvider>
          {children}
        </SessionProvider>
      </body>
    </html>
  );
}
```

### Step 2: ナビゲーションバーを作成

`src/components/Navbar.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
'use client';

import { useSession, signOut } from 'next-auth/react';
import Link from 'next/link';
import Image from 'next/image';

export function Navbar() {
  const { data: session, status } = useSession();
  const loading = status === 'loading';

  return (
    <nav className="bg-white shadow-md">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16">
          {/* ロゴ */}
          <div className="flex items-center">
            <Link href="/" className="text-xl font-bold text-gray-900">
              🎸 BOLD軽音
            </Link>
          </div>

          {/* ナビゲーションリンク */}
          <div className="flex items-center gap-4">
            <Link href="/" className="text-gray-700 hover:text-gray-900">
              ホーム
            </Link>
            
            {session && (
              <>
                <Link href="/events" className="text-gray-700 hover:text-gray-900">
                  イベント
                </Link>
                <Link href="/schedules" className="text-gray-700 hover:text-gray-900">
                  スケジュール
                </Link>
              </>
            )}

            {/* ログイン状態 */}
            {loading ? (
              <div className="text-gray-500">読み込み中...</div>
            ) : session ? (
              <div className="flex items-center gap-3">
                {/* ユーザー情報 */}
                <div className="flex items-center gap-2">
                  {session.user?.image && (
                    <Image
                      src={session.user.image}
                      alt={session.user.name || ''}
                      width={32}
                      height={32}
                      className="rounded-full"
                    />
                  )}
                  <span className="text-sm text-gray-700">
                    {session.user?.name}
                  </span>
                  {session.user?.role === 'admin' && (
                    <span className="px-2 py-1 text-xs font-semibold text-white bg-blue-600 rounded">
                      管理者
                    </span>
                  )}
                </div>
                
                {/* ログアウトボタン */}
                <button
                  onClick={() => signOut({ callbackUrl: '/auth/signin' })}
                  className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
                >
                  ログアウト
                </button>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <Link
                  href="/auth/signin"
                  className="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900"
                >
                  ログイン
                </Link>
                <Link
                  href="/auth/signup"
                  className="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
                >
                  新規登録
                </Link>
              </div>
            )}
          </div>
        </div>
      </div>
    </nav>
  );
}
```

### Step 3: レイアウトにナビゲーションバーを追加

`src/app/layout.tsx` を更新してください。

```typescript
import type { Metadata } from 'next';
import { SessionProvider } from 'next-auth/react';
import { Navbar } from '@/components/Navbar';
import './globals.css';

export const metadata: Metadata = {
  title: 'BOLD軽音メンバーサイト',
  description: '活動報告とスケジュール管理',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        <SessionProvider>
          <Navbar />
          <main className="min-h-screen bg-gray-50">
            {children}
          </main>
        </SessionProvider>
      </body>
    </html>
  );
}
```

### Step 4: 動作確認

ブラウザで http://localhost:3000 を開いて、以下のコードを**すべて**入力してください：

以下のコードで**上書き**してください：

→ ✅ ナビゲーションバーにユーザー名とログアウトボタンが表示されます！

---

## 11.8 保護されたページの作成

ログインしていないとアクセスできないページを作成します。

### Step 1: ミドルウェアを作成

プロジェクトルートに `middleware.ts` を作成して、以下のコードを**すべて**入力してください：

```typescript
export { auth as middleware } from '@/lib/auth';

export const config = {
  matcher: [
    '/events/:path*',
    '/schedules/:path*',
    '/posts/new',
    '/posts/:id/edit',
  ],
};
```

**このミドルウェアの役割:**
- 指定したパスへのアクセス時に認証をチェック
- ログインしていなければログインページにリダイレクト

### Step 2: サーバーコンポーネントで認証チェック

`src/app/protected/page.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function ProtectedPage() {
  // セッションを取得
  const session = await auth();
  
  // ログインしていなければリダイレクト
  if (!session) {
    redirect('/auth/signin');
  }
  
  return (
    <div className="max-w-4xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">
        保護されたページ
      </h1>
      
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">
          ようこそ、{session.user?.name}さん！
        </h2>
        
        <div className="space-y-2 text-gray-700">
          <p><strong>ユーザーID:</strong> {session.user?.id}</p>
          <p><strong>メール:</strong> {session.user?.email}</p>
          <p><strong>役割:</strong> {session.user?.role}</p>
          {session.user?.image && (
            <p><strong>画像:</strong> {session.user.image}</p>
          )}
        </div>
      </div>
    </div>
  );
}
```

### Step 3: 動作確認

**3-1.** ログアウトして http://localhost:3000/protected にアクセス

→ ✅ ログインページにリダイレクトされます！

**3-2.** ログインしてから http://localhost:3000/protected にアクセス

→ ✅ ユーザー情報が表示されます！

---

## 11.9 管理者権限のチェック

特定のページを管理者のみアクセス可能にします。

### 管理者チェック関数を作成

`src/lib/auth.ts` に以下を追加してください。

```typescript
// 既存のコードの後に追加

/**
 * 管理者かどうかをチェック
 */
export async function isAdmin() {
  const session = await auth();
  return session?.user?.role === 'admin';
}

/**
 * 管理者でなければエラーをスロー
 */
export async function requireAdmin() {
  const admin = await isAdmin();
  if (!admin) {
    throw new Error('管理者権限が必要です');
  }
}
```

### 管理者専用ページを作成

`src/app/admin/page.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { auth } from '@/lib/auth';
import { redirect } from 'next/navigation';

export default async function AdminPage() {
  const session = await auth();
  
  // ログインチェック
  if (!session) {
    redirect('/auth/signin');
  }
  
  // 管理者チェック
  if (session.user?.role !== 'admin') {
    redirect('/');  // 管理者でなければホームへ
  }
  
  return (
    <div className="max-w-4xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold text-gray-900 mb-6">
        管理者ダッシュボード
      </h1>
      
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-semibold mb-4">
          管理者専用ページ
        </h2>
        
        <p className="text-gray-700">
          このページは管理者のみアクセスできます。
        </p>
        
        <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="border rounded-lg p-4">
            <h3 className="font-semibold text-gray-900 mb-2">投稿管理</h3>
            <p className="text-sm text-gray-600">投稿の作成・編集・削除</p>
          </div>
          
          <div className="border rounded-lg p-4">
            <h3 className="font-semibold text-gray-900 mb-2">ユーザー管理</h3>
            <p className="text-sm text-gray-600">ユーザーの役割変更</p>
          </div>
          
          <div className="border rounded-lg p-4">
            <h3 className="font-semibold text-gray-900 mb-2">イベント管理</h3>
            <p className="text-sm text-gray-600">イベントの作成・編集</p>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### 動作確認

**一般ユーザーでログインして http://localhost:3000/admin にアクセス**

→ ✅ ホームページにリダイレクトされます（管理者でないため）

**管理者ユーザーを作成:**

```bash
export DATABASE_URL="file:./dev.db"
node scripts/create-admin.js admin@example.com adminpass123 "管理者"
```

**管理者でログインして http://localhost:3000/admin にアクセス**

→ ✅ 管理者ダッシュボードが表示されます！

---

## 11.10 トラブルシューティング

よくある問題と解決方法です。

### エラー1: `AUTH_SECRET is not set`

**原因:** 環境変数が設定されていない

**解決方法:**

```bash
# AUTH_SECRETを生成
openssl rand -base64 32

# .env.local に追加
AUTH_SECRET="生成された文字列"
NEXTAUTH_SECRET="同じ文字列"

# 開発サーバーを再起動
npm run dev
```

### エラー2: Google OAuth が動作しない

**原因:** リダイレクト URI が正しくない

**解決方法:**

Google Cloud Console で以下を確認：

```
承認済みのリダイレクト URI:
  http://localhost:3000/api/auth/callback/google
```

**正確に一致** している必要があります（末尾の`/`も含めて）

### エラー3: ログイン後にリダイレクトされない

**原因:** `callbackUrl` が正しくない

**解決方法:**

```typescript
// ❌ 間違い
signIn('google');

// ✅ 正しい
signIn('google', { callbackUrl: '/' });
```

### エラー4: `Session user is null`

**原因:** セッションコールバックで `user.id` を追加していない

**解決方法:**

`src/lib/auth.ts` の `callbacks` を確認：

```typescript
callbacks: {
  async session({ session, token }) {
    if (session.user) {
      session.user.id = token.sub!;  // ← これが必要
      session.user.role = token.role as string;
    }
    return session;
  },
},
```

---

## 11.11 確認チェックリスト

Chapter 11の内容を理解できたか確認しましょう。

### 認証の基本概念

- [ ] 認証と認可の違いを説明できる
- [ ] セッション管理の流れを理解した
- [ ] JWTの役割を理解した

### NextAuth.jsの理解

- [ ] NextAuth.jsの特徴を説明できる
- [ ] `src/lib/auth.ts`の役割を理解した
- [ ] providersの設定方法を理解した
- [ ] callbacksの役割を理解した

### Google OAuthの設定

- [ ] Google Cloud Consoleでプロジェクトを作成できる
- [ ] OAuth クライアント ID を作成できる
- [ ] リダイレクト URI を設定できる
- [ ] 環境変数にクライアント ID を設定できる

### サインアップ・ログイン

- [ ] サインアップAPIを実装できる
- [ ] パスワードのハッシュ化を理解した
- [ ] サインアップページを作成できる
- [ ] ログインページを作成できる
- [ ] Google ログインを実装できる

### 認証状態の管理

- [ ] `useSession()`でセッションを取得できる
- [ ] サーバーコンポーネントで`auth()`を使える
- [ ] ログアウト機能を実装できる
- [ ] ナビゲーションバーにユーザー情報を表示できる

### 保護されたページ

- [ ] ミドルウェアで認証チェックができる
- [ ] サーバーコンポーネントで認証チェックができる
- [ ] 管理者権限のチェックができる

---

## まとめ

この章では、NextAuth.jsを使った認証システムを実装しました。

### 🎓 この章で学んだこと

#### 認証の基本
- ✅ 認証（Authentication）と認可（Authorization）の違い
- ✅ セッション管理の仕組み
- ✅ JWTの役割

#### NextAuth.js の設定
- ✅ NextAuth.js v5 のセットアップ
- ✅ Google OAuth プロバイダーの設定
- ✅ Credentials プロバイダーの設定
- ✅ Prisma Adapter の使用

#### 実装した機能
- ✅ サインアップページ（新規登録）
- ✅ ログインページ（メール+パスワード、Google）
- ✅ ログアウト機能
- ✅ ナビゲーションバー（ユーザー情報表示）
- ✅ 保護されたページ（認証チェック）
- ✅ 管理者専用ページ（権限チェック）

#### セキュリティ
- ✅ パスワードのハッシュ化（bcryptjs）
- ✅ CSRF保護（NextAuth.js自動）
- ✅ セッショントークン管理
- ✅ 環境変数での機密情報管理

### 🚀 次の章への準備

次の章（Chapter 12: 基本レイアウトとナビゲーション）では、以下を学びます：

1. **ルートレイアウトの完成**
   - ヘッダー、フッター
   - レスポンシブデザイン

2. **ナビゲーションの改善**
   - モバイルメニュー
   - アクティブリンク表示

3. **共通コンポーネント**
   - ボタン、カード
   - ローディング表示

**準備すること：**
- ✅ 認証システムの動作確認
- ✅ 管理者ユーザーを作成しておく
- ✅ Google OAuth が動作することを確認

### 💡 重要なポイント

1. **環境変数は必須**: AUTH_SECRET を必ず設定
2. **パスワードはハッシュ化**: 平文で保存しない
3. **セッションはサーバーで確認**: クライアントの情報は信用しない
4. **管理者権限は厳密にチェック**: サーバーサイドで必ず確認
5. **Google OAuth のリダイレクト URI**: 正確に一致させる

---

[← 前の章：第10章 データベースとPrismaの基礎](10-データベースとPrismaの基礎.md) | [目次に戻る](00-目次.md) | [次の章へ：第12章 基本レイアウトとナビゲーション →](12-基本レイアウトとナビゲーション.md)
