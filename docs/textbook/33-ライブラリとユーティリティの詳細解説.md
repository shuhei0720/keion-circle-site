# ç¬¬33ç« ï¼šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è©³ç´°è§£èª¬

> **ã“ã®ç« ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºç›¤ã¨ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å®Ÿè£…ã‚’è©³ç´°ã«è§£èª¬ã—ã¾ã™**

## ğŸ“š ã“ã®ç« ã®ç›®çš„

ã“ã®ç« ã¯**ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**ã¨ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ä½¿ã‚ã‚Œã‚‹å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä»•çµ„ã¿ã‚’æ·±ãç†è§£ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

- âœ… èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šï¼ˆNextAuth.jsï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®ç®¡ç†ï¼ˆPrismaï¼‰
- âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é€£æºï¼ˆSupabaseï¼‰
- âœ… æ¨©é™ç®¡ç†ã®å®Ÿè£…
- âœ… å‹å®šç¾©ã®è¨­è¨ˆ

## ğŸ’¡ lib ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å½¹å‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     src/lib/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹æˆ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

src/lib/
â”œâ”€ auth.ts           # NextAuth.js èªè¨¼è¨­å®š
â”œâ”€ prisma.ts         # Prisma Client ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
â”œâ”€ supabase.ts       # Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â””â”€ permissions.ts    # æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°


ã€libãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›®çš„ã€‘

  1. å†åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã‚’ã¾ã¨ã‚ã‚‹
     â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§å…±é€šã—ã¦ä½¿ã†æ©Ÿèƒ½

  2. è¨­å®šã‚’ä¸€å…ƒç®¡ç†
     â†’ å¤‰æ›´ãŒå¿…è¦ãªæ™‚ã€1ç®‡æ‰€ã ã‘ä¿®æ­£ã™ã‚Œã°OK

  3. ä¾å­˜é–¢ä¿‚ã‚’éš è”½
     â†’ å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ã„æ–¹ã‚’éš ã™
     â†’ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’çµ±ä¸€


ã€ä½¿ç”¨ä¾‹ã€‘

  // ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ãˆã‚‹
  import { auth } from '@/lib/auth'
  import { prisma } from '@/lib/prisma'
  import { isAdmin } from '@/lib/permissions'

  const session = await auth()
  const users = await prisma.user.findMany()
  const admin = await isAdmin()
```

---

## 33.1 èªè¨¼è¨­å®šï¼ˆsrc/lib/auth.tsï¼‰

NextAuth.js v5 ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

### å…¨ä½“æ§‹é€ 

```typescript
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";
import CredentialsProvider from "next-auth/providers/credentials";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";

/**
 * NextAuth v5 èªè¨¼è¨­å®š
 *
 * æä¾›ã™ã‚‹èªè¨¼æ–¹æ³•:
 * 1. Google OAuth: Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
 * 2. Credentials: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
 *
 * ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥:
 * - JWT ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä½¿ã‚ãªã„ï¼‰
 * - Cookie ã‚µã‚¤ã‚ºã‚’æœ€å°åŒ–ï¼ˆID ã¨ role ã®ã¿ä¿å­˜ï¼‰
 */
export const { handlers, signIn, signOut, auth } = NextAuth({
  // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®š
  providers: [
    // Google OAuth ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      authorization: {
        params: {
          prompt: "consent", // æ¯å›åŒæ„ç”»é¢ã‚’è¡¨ç¤º
          access_type: "offline", // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
          response_type: "code", // èªè¨¼ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼
        },
      },
    }),

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
    CredentialsProvider({
      name: "Credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" },
      },
      async authorize(credentials) {
        console.log("[NextAuth Credentials] Authorize called");
        console.log("[NextAuth Credentials] Email:", credentials?.email);

        try {
          // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
          if (!credentials?.email || !credentials?.password) {
            console.error("[NextAuth Credentials] Missing credentials");
            throw new Error("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          }

          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
          const user = await prisma.user.findUnique({
            where: { email: credentials.email as string },
            select: { id: true, email: true, password: true, role: true },
          });
          console.log("[NextAuth Credentials] User found:", !!user);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„
          if (!user || !user.password) {
            console.error(
              "[NextAuth Credentials] User not found or no password"
            );
            throw new Error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆbcryptã§ãƒãƒƒã‚·ãƒ¥ã‚’æ¯”è¼ƒï¼‰
          const isPasswordValid = await bcrypt.compare(
            credentials.password as string,
            user.password
          );
          console.log(
            "[NextAuth Credentials] Password valid:",
            isPasswordValid
          );

          if (!isPasswordValid) {
            console.error("[NextAuth Credentials] Invalid password");
            throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
          }

          // èªè¨¼æˆåŠŸ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
          const result = {
            id: user.id,
            email: user.email,
          };
          console.log(
            "[NextAuth Credentials] Success, returning:",
            JSON.stringify(result, null, 2)
          );
          return result;
        } catch (error) {
          console.error("[NextAuth Credentials] Error:", error);
          return null; // èªè¨¼å¤±æ•—
        }
      },
    }),
  ],

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š
  session: {
    strategy: "jwt", // JWT ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ä½¿ã‚ãªã„ï¼‰
    maxAge: 30 * 24 * 60 * 60, // 30æ—¥é–“æœ‰åŠ¹
  },

  // Cookie è¨­å®š
  cookies: {
    sessionToken: {
      name: `__Secure-next-auth.session-token`,
      options: {
        httpOnly: true, // JavaScript ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆXSSå¯¾ç­–ï¼‰
        sameSite: "lax", // CSRFå¯¾ç­–
        path: "/", // ã‚µã‚¤ãƒˆå…¨ä½“ã§æœ‰åŠ¹
        secure: true, // HTTPS ã®ã¿ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      },
    },
  },

  // Vercelã§ã®å‹•ä½œã«å¿…è¦
  trustHost: true,

  // ã‚«ã‚¹ã‚¿ãƒ ãƒšãƒ¼ã‚¸
  pages: {
    signIn: "/auth/signin", // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
    signOut: "/", // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®é·ç§»å…ˆ
  },

  // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
  callbacks: {
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’åˆ¶å¾¡
    async redirect({ url, baseUrl }) {
      console.log("[NextAuth Redirect] URL:", url);
      console.log("[NextAuth Redirect] Base URL:", baseUrl);

      // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯Homeç”»é¢(/)ã«é·ç§»
      if (url === baseUrl || url === `${baseUrl}/`) {
        return baseUrl;
      }
      // ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾Œã‚‚Homeã«
      if (url.startsWith(baseUrl)) {
        return url;
      }
      return baseUrl;
    },

    // ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚ã®å‡¦ç†
    async signIn({ user, account, profile }) {
      console.log("[NextAuth SignIn] Provider:", account?.provider);
      console.log("[NextAuth SignIn] User email:", user.email);
      console.log(
        "[NextAuth SignIn] User object:",
        JSON.stringify(user, null, 2)
      );

      // Google OAuth ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²
      if (account?.provider === "google" && user.email) {
        try {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          let dbUser = await prisma.user.findUnique({
            where: { email: user.email },
          });
          console.log("[NextAuth SignIn] DB User found:", !!dbUser);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ç™»éŒ²
          if (!dbUser) {
            console.log("[NextAuth SignIn] Creating new user...");
            dbUser = await prisma.user.create({
              data: {
                email: user.email,
                name: user.name || user.email.split("@")[0],
                role: "member", // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¡ãƒ³ãƒãƒ¼
              },
            });
            console.log("[NextAuth SignIn] New user created:", dbUser.id);
          }
        } catch (error) {
          console.error("[NextAuth SignIn] Error:", error);
          return false; // ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—
        }
      }
      console.log("[NextAuth SignIn] Success");
      return true; // ã‚µã‚¤ãƒ³ã‚¤ãƒ³æˆåŠŸ
    },

    // JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆãƒ»æ›´æ–°æ™‚ã®å‡¦ç†
    async jwt({ token, user, trigger, account }) {
      console.log("[NextAuth JWT] Trigger:", trigger);
      console.log("[NextAuth JWT] User present:", !!user);
      console.log("[NextAuth JWT] User email:", user?.email);
      console.log(
        "[NextAuth JWT] Token before:",
        JSON.stringify(token, null, 2)
      );

      // ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ™‚: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã«è¿½åŠ 
      if (user?.email) {
        const dbUser = await prisma.user.findUnique({
          where: { email: user.email },
          select: { id: true, role: true, name: true, avatarUrl: true },
        });
        console.log("[NextAuth JWT] DB User:", JSON.stringify(dbUser, null, 2));

        if (dbUser) {
          token.id = dbUser.id;
          token.role = dbUser.role;
          token.name = dbUser.name;
          token.avatarUrl = dbUser.avatarUrl;
        }
      }

      console.log(
        "[NextAuth JWT] Token after:",
        JSON.stringify(token, null, 2)
      );
      return token;
    },

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ç”Ÿæˆ
    async session({ session, token }) {
      console.log(
        "[NextAuth Session] Session before:",
        JSON.stringify(session, null, 2)
      );
      console.log("[NextAuth Session] Token:", JSON.stringify(token, null, 2));

      // ãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
      if (token && session.user) {
        session.user.id = token.id as string;
        session.user.role = token.role as string;
        session.user.name = token.name as string;
        session.user.image = token.avatarUrl as string | null;
      }

      console.log(
        "[NextAuth Session] Session after:",
        JSON.stringify(session, null, 2)
      );
      return session;
    },
  },
});
```

**èªè¨¼ãƒ•ãƒ­ãƒ¼ã®è©³ç´°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Google OAuth èªè¨¼ãƒ•ãƒ­ãƒ¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒGoogleã§ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
2. Google ã®èªè¨¼ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   â†“
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒGoogle ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼
   â†“
4. Google ã‹ã‚‰èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ãã‚‹
   â†“
5. NextAuth.js ãŒèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
   â†“
6. signIn ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
   - å­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ç™»éŒ²
   â†“
7. jwt ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã«æƒ…å ±ã‚’è¿½åŠ ï¼ˆid, role, name, avatarUrlï¼‰
   â†“
8. session ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
   â†“
9. ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã€Homeç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ èªè¨¼ãƒ•ãƒ­ãƒ¼        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
   â†“
2. authorize é–¢æ•°ãŒå®Ÿè¡Œ
   - å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼ï¼ˆbcrypt.compareï¼‰
   â†“
3. èªè¨¼æˆåŠŸã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
   â†“
4. jwt ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã«æƒ…å ±ã‚’è¿½åŠ 
   â†“
5. session ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œ
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
   â†“
6. ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã€Homeç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®å†…å®¹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{
  "id": "cuid123...",       // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  "role": "admin",          // å½¹å‰²ï¼ˆadmin or memberï¼‰
  "name": "å±±ç”°å¤ªéƒ",       // åå‰
  "avatarUrl": "https://...", // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒURL
  "email": "user@example.com", // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  "iat": 1640000000,        // ç™ºè¡Œæ™‚åˆ»
  "exp": 1642592000         // æœ‰åŠ¹æœŸé™
}


ã€JWT vs Database Sessionã€‘

  JWT Sessionï¼ˆã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ¡ç”¨ï¼‰:
  âœ… ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§å‹•ä½œãŒå®‰å®š
  âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸è¦
  âœ… ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŒé«˜ã„
  âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚µã‚¤ã‚ºã«åˆ¶é™ï¼ˆCookie ã¯ 4KB ã¾ã§ï¼‰
  âŒ å³åº§ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã›ã‚‹ã®ãŒé›£ã—ã„

  Database Session:
  âœ… å³åº§ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹
  âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è©³ç´°ã«ç®¡ç†ã§ãã‚‹
  âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¢—ãˆã‚‹
  âŒ ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§ä¸å®‰å®šãªå ´åˆãŒã‚ã‚‹
```

**é‡è¦ãªè¨­å®šãƒã‚¤ãƒ³ãƒˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. Cookie ã® httpOnlyã€‘
  httpOnly: true
  â†’ JavaScript ã‹ã‚‰ Cookie ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
  â†’ XSS æ”»æ’ƒã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®ˆã‚‹

ã€2. Cookie ã® sameSiteã€‘
  sameSite: 'lax'
  â†’ CSRF æ”»æ’ƒã‚’é˜²ã
  â†’ ä»–ã®ã‚µã‚¤ãƒˆã‹ã‚‰ã® POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ Cookie ãŒé€ã‚‰ã‚Œãªã„

ã€3. Cookie ã® secureã€‘
  secure: true
  â†’ HTTPS ã®ã¿ã§ Cookie ã‚’é€ä¿¡
  â†’ ä¸­é–“è€…æ”»æ’ƒï¼ˆMITMï¼‰ã‚’é˜²ã

ã€4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ã€‘
  await bcrypt.compare(inputPassword, hashedPassword)
  â†’ å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ãªã„
  â†’ ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨æ¯”è¼ƒ

ã€5. ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨ã€‘
  process.env.GOOGLE_CLIENT_ID
  â†’ ç§˜å¯†æƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãªã„
  â†’ .env.local ã‚„ Vercel ã®ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Google OAuth ã®è¨­å®š                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã€‘
  GOOGLE_CLIENT_ID=<Google Cloud Console ã§å–å¾—>
  GOOGLE_CLIENT_SECRET=<Google Cloud Console ã§å–å¾—>

ã€Google Cloud Console ã§ã®è¨­å®šã€‘
  1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
  2. OAuth 2.0 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ID ã‚’ä½œæˆ
  3. æ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã«è¿½åŠ :
     - http://localhost:3000/api/auth/callback/google (é–‹ç™º)
     - https://your-domain.vercel.app/api/auth/callback/google (æœ¬ç•ª)
  4. OAuth åŒæ„ç”»é¢ã‚’è¨­å®š
     - ã‚¢ãƒ—ãƒªå
     - ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«
     - ã‚¹ã‚³ãƒ¼ãƒ—: email, profile


ã€authorization.params ã®æ„å‘³ã€‘
  prompt: "consent"
    â†’ æ¯å›åŒæ„ç”»é¢ã‚’è¡¨ç¤º
    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨©é™ã‚’ç¢ºèªã§ãã‚‹

  access_type: "offline"
    â†’ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    â†’ é•·æœŸé–“ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹

  response_type: "code"
    â†’ èªè¨¼ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨
    â†’ ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æ–¹æ³•
```

---

## 33.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šï¼ˆsrc/lib/prisma.tsï¼‰

Prisma Client ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

### å®Ÿè£…ã®è©³ç´°

```typescript
import { PrismaClient } from "@prisma/client";

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« Prisma ã®å‹ã‚’è¿½åŠ 
const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

/**
 * Prisma Client ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 *
 * é–‹ç™ºç’°å¢ƒ: ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã‚‹ã®ã‚’é˜²ã
 * æœ¬ç•ªç’°å¢ƒ: æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
 */
export const prisma =
  globalForPrisma.prisma ?? // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
  new PrismaClient({
    log:
      process.env.NODE_ENV === "development"
        ? ["error", "warn"] // é–‹ç™ºç’°å¢ƒ: ã‚¨ãƒ©ãƒ¼ã¨è­¦å‘Šã®ã¿ãƒ­ã‚°å‡ºåŠ›
        : [], // æœ¬ç•ªç’°å¢ƒ: ãƒ­ã‚°å‡ºåŠ›ãªã—
    datasources: {
      db: {
        url: process.env.DATABASE_URL, // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ¥ç¶šURLã‚’å–å¾—
      },
    },
  });

// é–‹ç™ºç’°å¢ƒã§ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
// â†’ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨
if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}

// æœ¬ç•ªç’°å¢ƒã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
if (process.env.NODE_ENV === "production") {
  // Serverlessç’°å¢ƒã§ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®é©åˆ‡ãªç®¡ç†
  prisma.$connect(); // æ˜ç¤ºçš„ã«æ¥ç¶š
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚‚è¿½åŠ ï¼ˆimport prisma from '@/lib/prisma' ã§ã‚‚ä½¿ãˆã‚‹ï¼‰
export default prisma;
```

**Prisma Client ã®ä»•çµ„ã¿:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Prisma Client ã®å½¹å‰²                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Prisma Client ã¨ã¯ã€‘
  TypeScript ã§å‹å®‰å…¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã§ãã‚‹ORM

  ORM (Object-Relational Mapping):
  ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â†â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«
  ã®å¯¾å¿œé–¢ä¿‚ã‚’è‡ªå‹•çš„ã«ç®¡ç†


ã€ä½¿ã„æ–¹ã®ä¾‹ã€‘

  import { prisma } from '@/lib/prisma'

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
  const user = await prisma.user.findUnique({
    where: { id: '123' }
  })

  // æŠ•ç¨¿ã‚’ä½œæˆ
  const post = await prisma.post.create({
    data: {
      title: 'ã‚¿ã‚¤ãƒˆãƒ«',
      content: 'å†…å®¹',
      userId: user.id
    }
  })

  // è¤‡é›‘ãªã‚¯ã‚¨ãƒª
  const posts = await prisma.post.findMany({
    where: {
      userId: user.id,
      createdAt: {
        gte: new Date('2025-01-01')
      }
    },
    include: {
      user: true,
      comments: true
    },
    orderBy: {
      createdAt: 'desc'
    }
  })


ã€å‹å®‰å…¨æ€§ã€‘

  // âŒ å­˜åœ¨ã—ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼
  const user = await prisma.user.findUnique({
    where: { username: 'test' }  // username ã¯å­˜åœ¨ã—ãªã„
  })
  // â†’ TypeScript ã‚¨ãƒ©ãƒ¼: Property 'username' does not exist

  // âœ… å­˜åœ¨ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ä½¿ãˆã‚‹
  const user = await prisma.user.findUnique({
    where: { email: 'test@example.com' }
  })


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     é–‹ç™ºç’°å¢ƒã§ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å•é¡Œã€‘
  Next.js ã®é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã¨
  è‡ªå‹•çš„ã«å†èª­ã¿è¾¼ã¿ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã•ã‚Œã‚‹
  â†’ æ¯å› new PrismaClient() ãŒå®Ÿè¡Œã•ã‚Œã‚‹
  â†’ å¤§é‡ã® Prisma Client ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã‚‹
  â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ•°ã®ä¸Šé™ã«é”ã™ã‚‹

ã€è§£æ±ºç­–ã€‘
  ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜

  const globalForPrisma = globalThis as unknown as {
    prisma: PrismaClient | undefined
  }

  export const prisma =
    globalForPrisma.prisma ??      // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
    new PrismaClient({ ... })      // ãªã‘ã‚Œã°æ–°ã—ãä½œã‚‹

  if (process.env.NODE_ENV !== 'production') {
    globalForPrisma.prisma = prisma  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
  }

  â†’ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æœ¬ç•ªç’°å¢ƒã§ã®æ¥ç¶šç®¡ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Serverless ç’°å¢ƒã®ç‰¹æ€§ã€‘
  - é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•
  - ã‚³ãƒ³ãƒ†ãƒŠã¯ä¸€å®šæ™‚é–“ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ãŒç¶šãã¨ç ´æ£„ã•ã‚Œã‚‹
  - æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å†ã³æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•

ã€æ¥ç¶šç®¡ç†ã®é‡è¦æ€§ã€‘
  prisma.$connect()
  â†’ æ˜ç¤ºçš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
  â†’ ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–

ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã€‘
  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ä½¿ã„å›ã™ä»•çµ„ã¿

  âŒ æ¯å›æ¥ç¶šãƒ»åˆ‡æ–­:
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ æ¥ç¶š â†’ ã‚¯ã‚¨ãƒª â†’ åˆ‡æ–­
    â†’ é…ã„ã€ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„

  âœ… ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«:
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æ¥ç¶šã‚’å–å¾— â†’ ã‚¯ã‚¨ãƒª â†’ ãƒ—ãƒ¼ãƒ«ã«è¿”å´
    â†’ é€Ÿã„ã€åŠ¹ç‡çš„


ã€DATABASE_URL ã®å½¢å¼ã€‘

  PostgreSQLï¼ˆSupabaseï¼‰:
  DATABASE_URL="postgresql://user:password@host:port/database?schema=public"

  Supabaseï¼ˆPostgreSQL + PgBouncerï¼‰:
  DATABASE_URL="postgresql://postgres.[project]:[password]@...?pgbouncer=true&connection_limit=1"

  pgbouncer=true: ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°æœ‰åŠ¹åŒ–
  connection_limit=1: Serverless ç’°å¢ƒã§ã®æ¨å¥¨è¨­å®š
```

**ãƒ­ã‚°è¨­å®šã®è©³ç´°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ä½¿ç”¨å¯èƒ½ãªãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã€‘
  log: ['query', 'info', 'warn', 'error']

  'query': å®Ÿè¡Œã•ã‚Œã‚‹SQLæ–‡ã‚’å‡ºåŠ›
  'info': ä¸€èˆ¬çš„ãªæƒ…å ±
  'warn': è­¦å‘Š
  'error': ã‚¨ãƒ©ãƒ¼

ã€é–‹ç™ºç’°å¢ƒã§ã®è¨­å®šã€‘
  log: ['error', 'warn']
  â†’ ã‚¨ãƒ©ãƒ¼ã¨è­¦å‘Šã®ã¿å‡ºåŠ›
  â†’ ã‚¯ã‚¨ãƒªã¯å‡ºåŠ›ã—ãªã„ï¼ˆå¤§é‡ã®ãƒ­ã‚°ã‚’é˜²ãï¼‰

ã€æœ¬ç•ªç’°å¢ƒã§ã®è¨­å®šã€‘
  log: []
  â†’ ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãªã„
  â†’ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

ã€ãƒ‡ãƒãƒƒã‚°æ™‚ã®è¨­å®šã€‘
  log: ['query', 'error', 'warn']
  â†’ å…¨ã¦ã®ã‚¯ã‚¨ãƒªã‚’ç¢ºèªã§ãã‚‹
  â†’ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã®èª¿æŸ»ã«æœ‰ç”¨

ã€ãƒ­ã‚°ã®ä¾‹ã€‘
  prisma:query SELECT * FROM "User" WHERE "email" = $1
  prisma:info Starting a postgresql pool with 2 connections
  prisma:warn 10 connections are already active
  prisma:error Invalid `prisma.user.create()` invocation
```

---

## 33.3 Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆsrc/lib/supabase.tsï¼‰

Supabase Storage ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®šã§ã™ã€‚

### å®Ÿè£…ã®è©³ç´°

```typescript
import { createClient } from "@supabase/supabase-js";

// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

// ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®è­¦å‘Š
if (!supabaseUrl || !supabaseAnonKey) {
  console.warn(
    "Supabase URL and Anon Key are not configured. Avatar upload will not work."
  );
}

/**
 * Supabase ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
 *
 * ç”¨é€”: ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨Storageç®¡ç†
 * - avatars ãƒã‚±ãƒƒãƒˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
 * - posts ãƒã‚±ãƒƒãƒˆ: æŠ•ç¨¿ã®ç”»åƒ
 *
 * ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ null ã‚’è¿”ã™
 * â†’ ã‚¢ãƒ—ãƒªã¯å‹•ä½œã™ã‚‹ãŒã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ç„¡åŠ¹
 */
export const supabase =
  supabaseUrl && supabaseAnonKey
    ? createClient(supabaseUrl, supabaseAnonKey)
    : null;
```

**Supabase Storage ã®ä½¿ã„æ–¹:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Supabase Storage ã®åŸºæœ¬æ“ä½œ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‘

  import { supabase } from '@/lib/supabase'

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const { data, error } = await supabase?.storage
    .from('avatars')  // ãƒã‚±ãƒƒãƒˆå
    .upload(`${userId}/avatar.jpg`, file, {
      cacheControl: '3600',  // 1æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      upsert: true           // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
    })

  if (error) {
    console.error('Upload error:', error)
    return
  }

  // å…¬é–‹URLã‚’å–å¾—
  const { data: { publicUrl } } = supabase.storage
    .from('avatars')
    .getPublicUrl(`${userId}/avatar.jpg`)

  console.log('Uploaded to:', publicUrl)


ã€2. ç”»åƒã®å‰Šé™¤ã€‘

  const { error } = await supabase?.storage
    .from('avatars')
    .remove([`${userId}/avatar.jpg`])

  if (error) {
    console.error('Delete error:', error)
  }


ã€3. ç”»åƒã®ä¸€è¦§å–å¾—ã€‘

  const { data, error } = await supabase?.storage
    .from('avatars')
    .list(userId, {
      limit: 100,
      offset: 0,
      sortBy: { column: 'name', order: 'asc' }
    })

  console.log('Files:', data)


ã€4. ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‘

  const { data, error } = await supabase?.storage
    .from('avatars')
    .download(`${userId}/avatar.jpg`)

  if (data) {
    const url = URL.createObjectURL(data)
    // url ã‚’ img src ã«è¨­å®š
  }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Storage ãƒã‚±ãƒƒãƒˆã®è¨­å®š                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Supabase Dashboard ã§ã®è¨­å®šã€‘

  1. Storage â†’ Create bucket
  2. ãƒã‚±ãƒƒãƒˆå: avatars
  3. Public bucket: ON
     â†’ èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  4. File size limit: 2MB
     â†’ ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ã‚µã‚¤ã‚ºåˆ¶é™
  5. Allowed MIME types: image/*
     â†’ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¨±å¯

ã€Storage Policiesï¼ˆã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰ã€‘

  Supabase ã§ã¯ RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šå¯èƒ½

  ä¾‹: è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½

  CREATE POLICY "Users can upload to own folder"
  ON storage.objects
  FOR INSERT
  TO authenticated
  WITH CHECK (
    bucket_id = 'avatars' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç’°å¢ƒå¤‰æ•°ã®è¨­å®š                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã€‘
  NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

ã€NEXT_PUBLIC_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã€‘
  â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã§ã‚‚ä½¿ãˆã‚‹
  â†’ å…¬é–‹æƒ…å ±ãªã®ã§ç§˜å¯†æƒ…å ±ã¯å«ã¾ãªã„

ã€Supabase Dashboard ã§å–å¾—ã€‘
  1. Project Settings
  2. API
  3. URL: NEXT_PUBLIC_SUPABASE_URL
  4. anon public key: NEXT_PUBLIC_SUPABASE_ANON_KEY


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å®Ÿéš›ã®ä½¿ç”¨ä¾‹ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// components/ProfileImageUpload.tsx

const handleImageUpload = async (file: File) => {
  if (!supabase) {
    alert('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™')
    return
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  const fileExt = file.name.split('.').pop()
  const fileName = `${session.user.id}/avatar.${fileExt}`

  try {
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const { error: uploadError } = await supabase.storage
      .from('avatars')
      .upload(fileName, file, {
        cacheControl: '3600',
        upsert: true  // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
      })

    if (uploadError) {
      throw uploadError
    }

    // å…¬é–‹URLã‚’å–å¾—
    const { data: { publicUrl } } = supabase.storage
      .from('avatars')
      .getPublicUrl(fileName)

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
    await fetch('/api/profile', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ avatarUrl: publicUrl })
    })

    alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸ')
  } catch (error) {
    console.error('Upload error:', error)
    alert('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ')
  }
}
```

---

## 33.4 æ¨©é™ç®¡ç†ï¼ˆsrc/lib/permissions.tsï¼‰

æ¨©é™ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯3ã¤ã®å½¹å‰²ï¼ˆroleï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

### å®Ÿè£…ã®è©³ç´°

```typescript
import { auth } from '@/lib/auth'
import { prisma } from '@/lib/prisma'

/**
 * ç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆadminã¾ãŸã¯site_adminï¼‰
 *
 * @returns {Promise<boolean>} ç®¡ç†è€…ã®å ´åˆ true
 */
export async function isAdmin(): Promise<boolean> {
  const session = await auth()
  if (!session?.user?.id) return false

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })

  // adminã¾ãŸã¯site_adminã®å ´åˆã¯true
  return user?.role === 'admin' || user?.role === 'site_admin'
}

/**
 * ã‚µã‚¤ãƒˆç®¡ç†è€…æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆsite_adminã®ã¿ï¼‰
 *
 * @returns {Promise<boolean>} ã‚µã‚¤ãƒˆç®¡ç†è€…ã®å ´åˆ true
 */
export async function isSiteAdmin(): Promise<boolean> {
  const session = await auth()
  if (!session?.user?.id) return false

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })

  // site_adminã®ã¿true
  return user?.role === 'site_admin'
}

/**
 * ç®¡ç†è€…æ¨©é™ã‚’è¦æ±‚ï¼ˆadminã¾ãŸã¯site_adminï¼‰
 * ç®¡ç†è€…ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
 *
 * @throws {Error} ç®¡ç†è€…ã§ãªã„å ´åˆ
 */
export async function requireAdmin() {
  const admin = await isAdmin()
  if (!admin) {
    throw new Error('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™')
  }
}

/**
 * ã‚µã‚¤ãƒˆç®¡ç†è€…æ¨©é™ã‚’è¦æ±‚ï¼ˆsite_adminã®ã¿ï¼‰
 * ã‚µã‚¤ãƒˆç®¡ç†è€…ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
 *
 * @throws {Error} ã‚µã‚¤ãƒˆç®¡ç†è€…ã§ãªã„å ´åˆ
 */
export async function requireSiteAdmin() {
  const siteAdmin = await isSiteAdmin()
  if (!siteAdmin) {
    throw new Error('ã‚µã‚¤ãƒˆç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™')
  }
}
```

### å½¹å‰²ï¼ˆRoleï¼‰ã®ç¨®é¡ã¨æ¨©é™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å½¹å‰²ã®éšå±¤æ§‹é€                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  site_admin (ã‚µã‚¤ãƒˆç®¡ç†è€…)
      â†“ ã™ã¹ã¦ã®æ¨©é™ã‚’æŒã¤
  admin (ç®¡ç†è€…)
      â†“ æŠ•ç¨¿ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç®¡ç†
  member (ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼)
      â†“ é–²è¦§ãƒ»ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ


ã€å„å½¹å‰²ã®æ¨©é™ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ“ä½œ     â”‚ member  â”‚  admin  â”‚site_adminâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŠ•ç¨¿ã®é–²è¦§  â”‚    âœ…   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ ã„ã„ã­      â”‚    âœ…   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ ã‚³ãƒ¡ãƒ³ãƒˆ    â”‚    âœ…   â”‚    âœ…   â”‚    âœ…   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŠ•ç¨¿ã®ä½œæˆ  â”‚    âŒ   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ æŠ•ç¨¿ã®ç·¨é›†  â”‚    âŒ   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ æŠ•ç¨¿ã®å‰Šé™¤  â”‚    âŒ   â”‚    âœ…   â”‚    âœ…   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆâ”‚    âŒ   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«â”‚    âŒ   â”‚    âœ…   â”‚    âœ…   â”‚
â”‚ ä½œæˆ        â”‚         â”‚         â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†â”‚    âŒ   â”‚    âŒ   â”‚    âœ…   â”‚
â”‚ å½¹å‰²å¤‰æ›´    â”‚    âŒ   â”‚    âŒ   â”‚    âœ…   â”‚
â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤â”‚    âŒ   â”‚    âŒ   â”‚    âœ…   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ã€å®Ÿè£…ä¾‹ã€‘

// æŠ•ç¨¿ä½œæˆï¼ˆadminã¾ãŸã¯site_adminï¼‰
export async function POST(request: NextRequest) {
  const admin = await isAdmin()
  if (!admin) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }
  // ...
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆsite_adminã®ã¿ï¼‰
export async function PATCH(request: NextRequest) {
  const siteAdmin = await isSiteAdmin()
  if (!siteAdmin) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }
  // ...
}
```

**æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ä½¿ã„æ–¹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ‘ã‚¿ãƒ¼ãƒ³1: isAdmin() - æ¡ä»¶åˆ†å²ã€‘

  import { isAdmin } from '@/lib/permissions'

  export async function POST(request: NextRequest) {
    const session = await auth()
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ï¼ˆadminã¾ãŸã¯site_adminï¼‰
    const admin = await isAdmin()
    if (!admin) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    // ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹å‡¦ç†
    const post = await prisma.post.create({ ... })
    return NextResponse.json(post)
  }


ã€ãƒ‘ã‚¿ãƒ¼ãƒ³2: requireAdmin() - ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ­ãƒ¼ã€‘

  import { requireAdmin } from '@/lib/permissions'

  export async function POST(request: NextRequest) {
    try {
      // ç®¡ç†è€…ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
      await requireAdmin()

      // ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹å‡¦ç†
      const post = await prisma.post.create({ ... })
      return NextResponse.json(post)
    } catch (error) {
      if (error.message === 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™') {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
      }
      return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })
    }
  }


ã€ãƒ‘ã‚¿ãƒ¼ãƒ³3: isSiteAdmin() - æœ€é«˜æ¨©é™ã®ã¿ã€‘

  import { isSiteAdmin } from '@/lib/permissions'

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å¤‰æ›´ï¼ˆsite_adminã®ã¿ï¼‰
  export async function PATCH(request: NextRequest, { params }: Props) {
    const siteAdmin = await isSiteAdmin()
    if (!siteAdmin) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’å¤‰æ›´
    const { role } = await request.json()
    const user = await prisma.user.update({
      where: { id: params.id },
      data: { role },
    })
    return NextResponse.json(user)
  }


ã€ãƒ‘ã‚¿ãƒ¼ãƒ³4: UI ã§ã®ä½¿ã„åˆ†ã‘ã€‘

  import { useSession } from 'next-auth/react'

  export default function PostsPage() {
    const { data: session } = useSession()
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å½¹å‰²ã‚’å–å¾—
    const isAdmin = session?.user?.role === 'admin' || session?.user?.role === 'site_admin'
    const isSiteAdmin = session?.user?.role === 'site_admin'

    return (
      <div>
        {/* ç®¡ç†è€…ã®ã¿è¡¨ç¤º */}
        {isAdmin && (
          <Link href="/posts/new">
            æ–°è¦æŠ•ç¨¿
          </Link>
        )}

        {/* ã‚µã‚¤ãƒˆç®¡ç†è€…ã®ã¿è¡¨ç¤º */}
        {isSiteAdmin && (
          <Link href="/admin/users">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
          </Link>
        )}

        {/* å…¨å“¡ã«è¡¨ç¤º */}
        <div>æŠ•ç¨¿ä¸€è¦§</div>
      </div>
    )
  }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. ã‚µãƒ¼ãƒãƒ¼å´ã§å¿…ãšãƒã‚§ãƒƒã‚¯ã€‘
  âœ… API Route ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
  âŒ UI ã®ã¿ã§æ¨©é™ãƒã‚§ãƒƒã‚¯

  ç†ç”±: ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ UI ã‚’æ”¹å¤‰ã§ãã‚‹ãŸã‚

ã€2. é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™ã€‘
  401 Unauthorized: èªè¨¼ãŒå¿…è¦ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ï¼‰
  403 Forbidden: æ¨©é™ãŒãªã„ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãŒæ¨©é™ä¸è¶³ï¼‰
  404 Not Found: ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼ˆæ¨©é™ãŒãªã„å ´åˆã‚‚ï¼‰

ã€3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµ±ä¸€ã€‘
  'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' (isAdmin, requireAdmin)
  'ã‚µã‚¤ãƒˆç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' (isSiteAdmin, requireSiteAdmin)
  'èªè¨¼ãŒå¿…è¦ã§ã™' (æœªãƒ­ã‚°ã‚¤ãƒ³)

ã€4. ãƒ­ã‚°ã‚’è¨˜éŒ²ã€‘
  console.log('[Permission] Admin check:', isAdmin)
  console.log('[Permission] Site admin check:', isSiteAdmin)
  â†’ ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®æ¤œå‡ºã«æœ‰ç”¨

ã€5. éšå±¤çš„ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ã€‘
  // âœ… æ­£ã—ã„: site_adminã¯adminã®æ¨©é™ã‚‚æŒã¤
  const admin = await isAdmin()  // adminã¾ãŸã¯site_admin

  // âŒ é–“é•ã„: site_adminãŒadminå°‚ç”¨æ©Ÿèƒ½ã‚’ä½¿ãˆãªã„
  const user = await prisma.user.findUnique(...)
  if (user?.role !== 'admin') { ... }

ã€6. Prismaã§ã®å½¹å‰²å–å¾—ã€‘
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å½¹å‰²ã¯å¤ã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
  // é‡è¦ãªæ“ä½œã®å‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æœ€æ–°ã®å½¹å‰²ã‚’å–å¾—
  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })
```

### å½¹å‰²ã®è¿½åŠ ãƒ»æ‹¡å¼µæ–¹æ³•

å°†æ¥çš„ã«å½¹å‰²ã‚’è¿½åŠ ã™ã‚‹å ´åˆã®ä¾‹ï¼š

```typescript
// src/lib/permissions.ts

/**
 * ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆmoderator, admin, site_adminã®ã„ãšã‚Œã‹ï¼‰
 */
export async function isModerator(): Promise<boolean> {
  const session = await auth()
  if (!session?.user?.id) return false

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })

  return user?.role === 'moderator' ||
         user?.role === 'admin' ||
         user?.role === 'site_admin'
}

/**
 * ç‰¹å®šã®å½¹å‰²ã‚’ãƒã‚§ãƒƒã‚¯
 */
export async function hasRole(role: string): Promise<boolean> {
  const session = await auth()
  if (!session?.user?.id) return false

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })

  return user?.role === role
}

/**
 * è¤‡æ•°ã®å½¹å‰²ã®ã„ãšã‚Œã‹ã‚’ãƒã‚§ãƒƒã‚¯
 */
export async function hasAnyRole(roles: string[]): Promise<boolean> {
  const session = await auth()
  if (!session?.user?.id) return false

  const user = await prisma.user.findUnique({
    where: { id: session.user.id },
    select: { role: true }
  })

  return roles.includes(user?.role || '')
}
```

**ä½¿ç”¨ä¾‹**:

```typescript
// ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ä»¥ä¸Šã®æ¨©é™ãŒå¿…è¦
const isMod = await isModerator()
if (!isMod) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

// ç‰¹å®šã®å½¹å‰²ã®ã¿
const hasSpecificRole = await hasRole('editor')

// è¤‡æ•°ã®å½¹å‰²ã®ã„ãšã‚Œã‹
const canEdit = await hasAnyRole(['admin', 'site_admin', 'editor'])
```

---

## 33.5 å‹å®šç¾©ï¼ˆsrc/types/ï¼‰

TypeScript ã®å‹å®šç¾©ã§ã™ã€‚

### next-auth.d.ts

NextAuth.js ã®å‹æ‹¡å¼µã§ã™ã€‚

```typescript
import NextAuth, { DefaultSession } from "next-auth";

/**
 * NextAuth ã®å‹æ‹¡å¼µ
 *
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® User ã¨ Session å‹ã«
 * ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆid, roleï¼‰ã‚’è¿½åŠ 
 */
declare module "next-auth" {
  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å‹
   */
  interface Session {
    user: {
      id: string; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
      role: string; // å½¹å‰²ï¼ˆadmin or memberï¼‰
    } & DefaultSession["user"];
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å‹
   */
  interface User {
    id: string;
    email: string;
    role: string;
  }
}

/**
 * JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®å‹
 */
declare module "next-auth/jwt" {
  interface JWT {
    id: string;
    role: string;
    avatarUrl?: string | null;
  }
}
```

**å‹æ‹¡å¼µã®ä»•çµ„ã¿:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     TypeScript ã® declare module                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€declare module ã®å½¹å‰²ã€‘
  æ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹å®šç¾©ã‚’æ‹¡å¼µã™ã‚‹

  ä¾‹: NextAuth ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹

  interface Session {
    user: {
      name?: string | null
      email?: string | null
      image?: string | null
    }
  }

  â†’ id ã¨ role ãŒå«ã¾ã‚Œã¦ã„ãªã„


ã€æ‹¡å¼µå¾Œã®å‹ã€‘

  interface Session {
    user: {
      id: string        // âœ… è¿½åŠ 
      role: string      // âœ… è¿½åŠ 
      name?: string | null
      email?: string | null
      image?: string | null
    }
  }


ã€ä½¿ç”¨ä¾‹ã€‘

  import { useSession } from 'next-auth/react'

  export default function Component() {
    const { data: session } = useSession()

    // âœ… å‹å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
    const userId = session?.user?.id       // string | undefined
    const userRole = session?.user?.role   // string | undefined

    // âŒ å­˜åœ¨ã—ãªã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã‚¨ãƒ©ãƒ¼
    const username = session?.user?.username  // TypeScript ã‚¨ãƒ©ãƒ¼
  }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     & DefaultSession["user"] ã®æ„å‘³               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å‹ã®åˆæˆã€‘
  {
    id: string
    role: string
  } & DefaultSession["user"]

  = {
    id: string
    role: string
    name?: string | null
    email?: string | null
    image?: string | null
  }

  â†’ æ—¢å­˜ã®å‹ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŸºç›¤ã¨ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è©³ã—ãè§£èª¬ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆauth.tsï¼‰

- âœ… NextAuth.js v5 ã®è¨­å®š
- âœ… Google OAuth ã®å®Ÿè£…
- âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
- âœ… JWT ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- âœ… ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®æ´»ç”¨

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šï¼ˆprisma.tsï¼‰

- âœ… Prisma Client ã®ç®¡ç†
- âœ… ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–
- âœ… ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®è¨­å®š
- âœ… ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´

#### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é€£æºï¼ˆsupabase.tsï¼‰

- âœ… Supabase Storage ã®ä½¿ã„æ–¹
- âœ… ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤
- âœ… å…¬é–‹ URL ã®å–å¾—
- âœ… ãƒã‚±ãƒƒãƒˆã®è¨­å®š

#### æ¨©é™ç®¡ç†ï¼ˆpermissions.tsï¼‰

- âœ… isAdmin / requireAdmin ã®å®Ÿè£…
- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### å‹å®šç¾©ï¼ˆnext-auth.d.tsï¼‰

- âœ… TypeScript ã®å‹æ‹¡å¼µ
- âœ… NextAuth ã®å‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- âœ… å‹å®‰å…¨ãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¨­è¨ˆåŸå‰‡

```typescript
// âœ… è‰¯ã„ä¾‹: è¨­å®šã‚’ä¸€å…ƒç®¡ç†
export const prisma = new PrismaClient({ ... })

// âŒ æ‚ªã„ä¾‹: å„ãƒ•ã‚¡ã‚¤ãƒ«ã§å€‹åˆ¥ã«è¨­å®š
// ãƒ•ã‚¡ã‚¤ãƒ«A.ts
const prisma = new PrismaClient()

// ãƒ•ã‚¡ã‚¤ãƒ«B.ts
const prisma = new PrismaClient()
// â†’ è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œã‚‰ã‚Œã‚‹
```

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

```typescript
// âœ… ã‚µãƒ¼ãƒãƒ¼å´ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
export async function POST(request: NextRequest) {
  const admin = await isAdmin();
  if (!admin) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }
  // ...
}

// âŒ UI ã®ã¿ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
export default function Page() {
  if (session?.user?.role !== "admin") {
    return <div>æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</div>;
  }
  // â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã§æ”¹å¤‰ã§ãã‚‹
}
```

---

## 33.6 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆsrc/lib/email.tsï¼‰

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãŸã‚ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡æ©Ÿèƒ½ã§ã™ã€‚Resendã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### å®Ÿè£…ã®è©³ç´°

```typescript
import crypto from 'crypto'
import prisma from './prisma'
import { Resend } from 'resend'

// Resendã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é…å»¶åˆæœŸåŒ–ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
let resendInstance: Resend | null = null

function getResend(): Resend {
  if (!resendInstance && process.env.RESEND_API_KEY) {
    resendInstance = new Resend(process.env.RESEND_API_KEY)
  }
  if (!resendInstance) {
    throw new Error('RESEND_API_KEY is not set')
  }
  return resendInstance
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ä¿å­˜
 *
 * @param email - æ¤œè¨¼ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³
 */
export async function generateVerificationToken(email: string): Promise<string> {
  // ãƒ©ãƒ³ãƒ€ãƒ ãª32ãƒã‚¤ãƒˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
  const token = crypto.randomBytes(32).toString('hex')
  const expires = new Date(Date.now() + 24 * 60 * 60 * 1000) // 24æ™‚é–“å¾Œ

  // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ï¼ˆåŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§è¤‡æ•°å›ç™»éŒ²ã•ã‚ŒãŸå ´åˆï¼‰
  await prisma.verificationToken.deleteMany({
    where: { identifier: email }
  })

  // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ
  await prisma.verificationToken.create({
    data: {
      identifier: email,
      token,
      expires
    }
  })

  return token
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
 *
 * @param token - æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
 * @returns {Promise<string | null>} æ¤œè¨¼æˆåŠŸã—ãŸå ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å¤±æ•—ã—ãŸå ´åˆã¯null
 */
export async function verifyEmailToken(token: string): Promise<string | null> {
  const verificationToken = await prisma.verificationToken.findUnique({
    where: { token }
  })

  if (!verificationToken) {
    return null // ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„
  }

  if (verificationToken.expires < new Date()) {
    // ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã®å ´åˆã¯å‰Šé™¤
    await prisma.verificationToken.delete({
      where: { token }
    })
    return null
  }

  return verificationToken.identifier // email
}

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ä¿å­˜
 *
 * @param email - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @returns {Promise<string>} ç”Ÿæˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³
 */
export async function generatePasswordResetToken(email: string): Promise<string> {
  const token = crypto.randomBytes(32).toString('hex')
  const expires = new Date(Date.now() + 60 * 60 * 1000) // 1æ™‚é–“å¾Œ

  // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
  await prisma.verificationToken.deleteMany({
    where: { identifier: `reset:${email}` }
  })

  // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ
  // identifierã« "reset:" ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ã¤ã‘ã¦ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼ã¨åŒºåˆ¥
  await prisma.verificationToken.create({
    data: {
      identifier: `reset:${email}`,
      token,
      expires
    }
  })

  return token
}

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
 *
 * @param token - ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³
 * @returns {Promise<string | null>} æ¤œè¨¼æˆåŠŸã—ãŸå ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€å¤±æ•—ã—ãŸå ´åˆã¯null
 */
export async function verifyPasswordResetToken(token: string): Promise<string | null> {
  const verificationToken = await prisma.verificationToken.findUnique({
    where: { token }
  })

  if (!verificationToken) {
    return null
  }

  if (verificationToken.expires < new Date()) {
    await prisma.verificationToken.delete({
      where: { token }
    })
    return null
  }

  // identifier ã‹ã‚‰ email ã‚’å–å¾—ï¼ˆ"reset:" ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼‰
  const email = verificationToken.identifier.replace('reset:', '')
  return email
}

/**
 * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 *
 * @param email - é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param token - æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³
 */
export async function sendVerificationEmail(email: string, token: string) {
  const verificationUrl = `${process.env.NEXTAUTH_URL || process.env.AUTH_URL || 'http://localhost:3000'}/api/auth/verify-email?token=${token}`
  
  // é–‹ç™ºç’°å¢ƒã§ã¯ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆResendã‚’ä½¿ã‚ãªã„ï¼‰
  if (process.env.NODE_ENV !== 'production') {
    console.log('\n========================================')
    console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒªãƒ³ã‚¯')
    console.log('========================================')
    console.log(`å®›å…ˆ: ${email}`)
    console.log(`æ¤œè¨¼URL: ${verificationUrl}`)
    console.log('========================================\n')
    return
  }
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯Resendã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  try {
    const resend = getResend()
    await resend.emails.send({
      from: process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev',
      to: email,
      subject: 'BOLD è»½éŸ³ - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
      html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
          <h1 style="color: #2563eb;">BOLD è»½éŸ³</h1>
          <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
          <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
          <a href="${verificationUrl}" 
             style="display: inline-block; background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin: 16px 0;">
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª
          </a>
          <p style="color: #6b7280; font-size: 14px;">
            ã“ã®ãƒªãƒ³ã‚¯ã¯24æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚<br>
            å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      `
    })
  } catch (error) {
    console.error('Failed to send verification email:', error)
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯ç¶™ç¶šã™ã‚‹
    // é–‹ç™ºç’°å¢ƒç”¨ã®ãƒ­ã‚°ã‚’å‡ºåŠ›
    console.log('\n========================================')
    console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒªãƒ³ã‚¯ (Resendé€ä¿¡å¤±æ•—)')
    console.log('========================================')
    console.log(`å®›å…ˆ: ${email}`)
    console.log(`æ¤œè¨¼URL: ${verificationUrl}`)
    console.log('========================================\n')
  }
}

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 *
 * @param email - é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param token - ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³
 */
export async function sendPasswordResetEmail(email: string, token: string) {
  const resetUrl = `${process.env.NEXTAUTH_URL || process.env.AUTH_URL || 'http://localhost:3000'}/auth/reset-password?token=${token}`
  
  // é–‹ç™ºç’°å¢ƒã§ã¯ãƒ­ã‚°ã«å‡ºåŠ›
  if (process.env.NODE_ENV !== 'production') {
    console.log('\n========================================')
    console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯')
    console.log('========================================')
    console.log(`å®›å…ˆ: ${email}`)
    console.log(`ãƒªã‚»ãƒƒãƒˆURL: ${resetUrl}`)
    console.log('========================================\n')
    return
  }
  
  // æœ¬ç•ªç’°å¢ƒã§ã¯Resendã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  try {
    const resend = getResend()
    await resend.emails.send({
      from: process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev',
      to: email,
      subject: 'BOLD è»½éŸ³ - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ',
      html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
          <h1 style="color: #2563eb;">BOLD è»½éŸ³</h1>
          <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚</p>
          <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š</p>
          <a href="${resetUrl}" 
             style="display: inline-block; background-color: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; margin: 16px 0;">
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
          </a>
          <p style="color: #6b7280; font-size: 14px;">
            ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚<br>
            å¿ƒå½“ãŸã‚ŠãŒãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      `
    })
  } catch (error) {
    console.error('Failed to send password reset email:', error)
    console.log('\n========================================')
    console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ (Resendé€ä¿¡å¤±æ•—)')
    console.log('========================================')
    console.log(`å®›å…ˆ: ${email}`)
    console.log(`ãƒªã‚»ãƒƒãƒˆURL: ${resetUrl}`)
    console.log('========================================\n')
  }
}
```

### ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»•çµ„ã¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ•ãƒ­ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼ãƒ•ãƒ­ãƒ¼ã€‘

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   â†“
2. generateVerificationToken(email)
   - ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆ24æ™‚é–“æœ‰åŠ¹ï¼‰
   â†“
3. sendVerificationEmail(email, token)
   - æ¤œè¨¼ãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
   - é–‹ç™ºç’°å¢ƒ: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
   - æœ¬ç•ªç’°å¢ƒ: Resendã§é€ä¿¡
   â†“
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
5. /api/auth/verify-email?token=xxx
   â†“
6. verifyEmailToken(token)
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
   - æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
   â†“
7. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹
   - emailVerified ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤


ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã€‘

1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ
   â†“
2. generatePasswordResetToken(email)
   - ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆ1æ™‚é–“æœ‰åŠ¹ï¼‰
   â†“
3. sendPasswordResetEmail(email, token)
   - ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
   â†“
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
5. /auth/reset-password?token=xxx
   â†“
6. verifyPasswordResetToken(token)
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
   â†“
7. æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
   - ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤


ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã€‘

âœ… ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ¼ã‚¯ãƒ³
  crypto.randomBytes(32).toString('hex')
  â†’ æ¨æ¸¬ä¸å¯èƒ½ãª64æ–‡å­—ã®ãƒˆãƒ¼ã‚¯ãƒ³

âœ… æœ‰åŠ¹æœŸé™
  - ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼: 24æ™‚é–“
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ: 1æ™‚é–“

âœ… ä½¿ã„æ¨ã¦
  - æ¤œè¨¼å¾Œã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
  - åŒã˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†åˆ©ç”¨ã§ããªã„

âœ… identifier ã®åˆ†é›¢
  - ãƒ¡ãƒ¼ãƒ«æ¤œè¨¼: identifier = email
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ: identifier = "reset:email"
  â†’ åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ã¦ã‚‚æ··åŒã—ãªã„


ã€é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®é•ã„ã€‘

é–‹ç™ºç’°å¢ƒ (NODE_ENV !== 'production'):
  - Resendã¯ä½¿ã‚ãªã„
  - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›
  - ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ä¸è¦ã§é–‹ç™ºå¯èƒ½

æœ¬ç•ªç’°å¢ƒ (NODE_ENV === 'production'):
  - Resendã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  - RESEND_API_KEY ãŒå¿…è¦
  - RESEND_FROM_EMAIL ãŒå¿…è¦
```

### Resendã®è¨­å®š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Resend ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. Resendã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã€‘
  https://resend.com/
  â†’ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—

ã€2. APIã‚­ãƒ¼ã‚’å–å¾—ã€‘
  Dashboard â†’ API Keys â†’ Create API Key
  â†’ ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼

ã€3. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã€‘
  # .env.local ã¾ãŸã¯ Vercelç’°å¢ƒå¤‰æ•°
  RESEND_API_KEY=re_xxxxxxxxxxxxx
  RESEND_FROM_EMAIL=noreply@yourdomain.com

ã€4. ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ã€‘
  - ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é€ä¿¡ã™ã‚‹å ´åˆ
  - Dashboard â†’ Domains â†’ Add Domain
  - DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®š

ã€5. ãƒ†ã‚¹ãƒˆé€ä¿¡ã€‘
  - é–‹ç™ºç’°å¢ƒ: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã§ç¢ºèª
  - æœ¬ç•ªç’°å¢ƒ: å®Ÿéš›ã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¦ãƒ†ã‚¹ãƒˆ


ã€æ–™é‡‘ãƒ—ãƒ©ãƒ³ã€‘
  Free: æœˆ100é€šã¾ã§ç„¡æ–™
  Pro: æœˆ$20ã€œï¼ˆ10,000é€šã¾ã§ï¼‰

ã€åˆ¶é™äº‹é …ã€‘
  - Free ãƒ—ãƒ©ãƒ³ã¯ 1æ—¥100é€šã¾ã§
  - èªè¨¼ãªã—ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ onboarding@resend.dev ã‹ã‚‰é€ä¿¡
  - ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ DNS èªè¨¼ãŒå¿…è¦
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã§ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯ç¶™ç¶š
export async function sendVerificationEmail(email: string, token: string) {
  try {
    const resend = getResend()
    await resend.emails.send({ ... })
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›
    console.error('Failed to send verification email:', error)
    
    // é–‹ç™ºç’°å¢ƒç”¨ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›
    console.log('æ¤œè¨¼URL:', verificationUrl)
    
    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã›ãšã€å‡¦ç†ã‚’ç¶šè¡Œ
    // â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯æˆåŠŸæ‰±ã„ã«ã™ã‚‹
  }
}
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- ğŸ“§ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å„ªå…ˆ**: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã¯å®Œäº†
- ğŸ” **é–‹ç™ºè€…å‘ã‘ãƒ­ã‚°**: å¤±æ•—æ™‚ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒªãƒ³ã‚¯ã‚’å‡ºåŠ›
- ğŸ›¡ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã¨ä½¿ã„æ¨ã¦ã§å®‰å…¨æ€§ã‚’ç¢ºä¿

---

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¬¡ã¯ä»˜éŒ²ã§ã€ç”¨èªé›†ã€ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã€å‚è€ƒãƒªã‚½ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ï¼š

- **ä»˜éŒ² A**: ç”¨èªé›†
- **ä»˜éŒ² B**: ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰
- **ä»˜éŒ² C**: å‚è€ƒãƒªã‚½ãƒ¼ã‚¹
- **ä»˜éŒ² D**: ã‚³ãƒ¼ãƒ‰ç´¢å¼•

---

[â† å‰ã®ç« ï¼šç¬¬32ç«  ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°è§£èª¬](32-ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°è§£èª¬.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šä»˜éŒ²A ç”¨èªé›† â†’](ä»˜éŒ²A-ç”¨èªé›†.md)
