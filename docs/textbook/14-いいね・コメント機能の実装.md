# 第14章：いいね・コメント機能の実装【ハンズオン】

> **この章では、投稿に対するいいね機能とコメント機能を実装します**

## 🛠️ **ハンズオン作業**

**⚠️ 重要**: この章では実際に手を動かしていいね・コメント機能を実装します。各セクションの指示に従って、インタラクティブな機能を作っていきましょう。

## 📚 この章で学ぶこと

- ✅ いいねのトグル機能（ON/OFF切り替え）
- ✅ 楽観的UI（Optimistic UI）の実装
- ✅ コメントの投稿・表示・削除
- ✅ リアルタイムなUI更新
- ✅ ユーザー体験の向上

## 💡 この章で実装する機能

```
┌─────────────────────────────────────────┐
│         投稿詳細ページ                    │
├─────────────────────────────────────────┤
│                                         │
│  📝 タイトル                             │
│  👤 作成者  📅 2024年12月23日            │
│                                         │
│  本文...                                 │
│                                         │
│  ┌───────────────────────────┐          │
│  │  ❤️ いいね (125) │ 💬 コメント (8) │  │
│  └───────────────────────────┘          │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │ 💬 コメント                       │    │
│  ├─────────────────────────────────┤    │
│  │ 👤 太郎さん  2分前               │    │
│  │ 素晴らしい演奏でした！            │    │
│  │                        🗑️ 削除   │    │
│  ├─────────────────────────────────┤    │
│  │ 👤 花子さん  5分前               │    │
│  │ また次も参加したいです！          │    │
│  └─────────────────────────────────┘    │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │ コメントを入力...                 │    │
│  │                        [送信]     │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

---

## 14.1 いいね機能の実装

### いいね機能の仕組み

```
┌──────────────────────────────────────────────┐
│           いいね機能のフロー                  │
└──────────────────────────────────────────────┘

1️⃣ ユーザーが❤️ボタンをクリック
         ↓
2️⃣ 楽観的UI: 即座に画面を更新（いいね済みに変更）
         ↓
3️⃣ APIリクエスト: POST /api/posts/[id]/like
         ↓
4️⃣ サーバー側でトグル処理
    - いいねがなければ → 追加
    - いいねがあれば   → 削除
         ↓
5️⃣ レスポンスを受け取る
         ↓
6️⃣ エラーがあれば元に戻す
```

### Step 1: Likeモデルの確認

まず、`prisma/schema.prisma` を開いて、Likeモデルを確認しましょう。

```prisma
model Like {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())

  // 同じユーザーが同じ投稿に複数回いいねできないようにする
  @@unique([userId, postId])
}
```

**Likeモデルのポイント:**

| 項目 | 説明 |
|------|------|
| `userId` | いいねしたユーザー |
| `postId` | いいねされた投稿 |
| `@@unique([userId, postId])` | 同じユーザーが同じ投稿に重複していいねできない |
| `onDelete: Cascade` | 投稿が削除されたら、いいねも自動削除 |

### Step 2: いいねAPIを実装

`src/app/api/posts/[id]/like/route.ts` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * いいねのトグル処理（POST）
 * - いいねがなければ追加
 * - いいねがあれば削除
 */
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // 認証チェック
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      );
    }

    const postId = params.id;
    const userId = session.user.id;

    // 投稿が存在するか確認
    const post = await prisma.post.findUnique({
      where: { id: postId },
    });

    if (!post) {
      return NextResponse.json(
        { error: '投稿が見つかりません' },
        { status: 404 }
      );
    }

    // すでにいいねしているか確認
    const existingLike = await prisma.like.findUnique({
      where: {
        userId_postId: {
          userId,
          postId,
        },
      },
    });

    if (existingLike) {
      // いいね済み → 削除（いいね取り消し）
      await prisma.like.delete({
        where: {
          id: existingLike.id,
        },
      });

      // いいねの総数を取得
      const likeCount = await prisma.like.count({
        where: { postId },
      });

      return NextResponse.json({
        liked: false,
        likeCount,
      });
    } else {
      // いいねしていない → 追加
      await prisma.like.create({
        data: {
          userId,
          postId,
        },
      });

      // いいねの総数を取得
      const likeCount = await prisma.like.count({
        where: { postId },
      });

      return NextResponse.json({
        liked: true,
        likeCount,
      });
    }
  } catch (error) {
    console.error('いいねエラー:', error);
    return NextResponse.json(
      { error: 'いいねの処理に失敗しました' },
      { status: 500 }
    );
  }
}
```

**APIの処理フロー:**

1. ✅ **認証確認**: ログインしているかチェック
2. ✅ **投稿存在確認**: 投稿が存在するかチェック
3. ✅ **いいね状態確認**: すでにいいねしているか確認
4. ✅ **トグル処理**: いいねを追加または削除
5. ✅ **カウント返却**: 最新のいいね数を返す

### Step 3: いいねボタンコンポーネントを作成

`src/components/LikeButton.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
'use client';

import { useState, useTransition } from 'react';
import { Heart } from 'lucide-react';
import { useRouter } from 'next/navigation';

interface LikeButtonProps {
  postId: string;
  initialLiked: boolean; // 初期状態: いいね済みか
  initialLikeCount: number; // 初期いいね数
}

export function LikeButton({
  postId,
  initialLiked,
  initialLikeCount,
}: LikeButtonProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  
  // ローカル状態（楽観的UI用）
  const [liked, setLiked] = useState(initialLiked);
  const [likeCount, setLikeCount] = useState(initialLikeCount);

  const handleLike = async () => {
    // 楽観的UI: 即座に画面を更新
    const newLiked = !liked;
    const newLikeCount = newLiked ? likeCount + 1 : likeCount - 1;
    
    setLiked(newLiked);
    setLikeCount(newLikeCount);

    try {
      // APIリクエスト
      const response = await fetch(`/api/posts/${postId}/like`, {
        method: 'POST',
      });

      if (!response.ok) {
        throw new Error('いいねに失敗しました');
      }

      const data = await response.json();

      // サーバーからの正確な値で更新
      setLiked(data.liked);
      setLikeCount(data.likeCount);

      // ページを再検証（他の部分も最新に）
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      // エラー時は元に戻す
      setLiked(!newLiked);
      setLikeCount(newLikeCount === likeCount + 1 ? likeCount : likeCount + 1);
      alert('いいねに失敗しました');
    }
  };

  return (
    <button
      onClick={handleLike}
      disabled={isPending}
      className={`
        flex items-center gap-2 px-4 py-2 rounded-lg transition-all
        ${
          liked
            ? 'bg-red-50 text-red-600 hover:bg-red-100'
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
        }
        disabled:opacity-50 disabled:cursor-not-allowed
      `}
    >
      <Heart
        size={20}
        className={liked ? 'fill-current' : ''}
      />
      <span className="font-medium">{likeCount}</span>
    </button>
  );
}
```

**楽観的UIのポイント:**

```
┌─────────────────────────────────────────┐
│       楽観的UI（Optimistic UI）         │
├─────────────────────────────────────────┤
│                                         │
│  👍 ユーザーがボタンをクリック           │
│      ↓                                  │
│  ⚡ 即座に画面を更新（待たない）         │
│      ↓                                  │
│  🌐 バックグラウンドでAPI通信            │
│      ↓                                  │
│  ✅ 成功 → そのまま                     │
│  ❌ 失敗 → 元に戻す                     │
│                                         │
│  メリット:                               │
│  - ユーザー体験が良い（待たされない）    │
│  - アプリが速く感じる                   │
└─────────────────────────────────────────┘
```

### Step 4: 投稿詳細ページにいいねボタンを追加

`src/app/posts/[id]/page.tsx` を開いて、いいねボタンを追加しましょう。

**変更前の部分を探してください:**

```typescript
import { Calendar, User, Heart, MessageCircle, Users, Edit, Trash2 } from 'lucide-react';
```

この行の下に、LikeButtonのimportを追加:

```typescript
import { Calendar, User, Heart, MessageCircle, Users, Edit, Trash2 } from 'lucide-react';
import { LikeButton } from '@/components/LikeButton';
```

次に、投稿詳細の表示部分を探してください。メタ情報の下に、いいねボタンを追加します。

**変更箇所（ヘッダーの最後）:**

```typescript
                  {/* カウント情報 */}
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1">
                      <Heart size={16} />
                      <span>{post.likes.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <MessageCircle size={16} />
                      <span>{post.comments.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <Users size={16} />
                      <span>{post.participants.length}</span>
                    </div>
                  </div>
```

この部分の**下**に、いいねボタンを追加:

```typescript
                  {/* カウント情報 */}
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1">
                      <Heart size={16} />
                      <span>{post.likes.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <MessageCircle size={16} />
                      <span>{post.comments.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <Users size={16} />
                      <span>{post.participants.length}</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* いいねボタン（ログイン済みユーザーのみ） */}
              {session && (
                <div className="px-6 py-4 border-b border-gray-200">
                  <LikeButton
                    postId={post.id}
                    initialLiked={post.likes.some(
                      (like) => like.userId === session.user?.id
                    )}
                    initialLikeCount={post.likes.length}
                  />
                </div>
              )}
            </div>
```

### Step 5: 動作確認

**5-1.** ログインしているユーザーで投稿詳細ページを開く

**5-2.** ❤️ いいねボタンをクリック

→ ✅ 即座にハートが赤くなり、数字が増える！

**5-3.** もう一度クリック

→ ✅ ハートが元に戻り、数字が減る！

**5-4.** ページをリロード

→ ✅ いいね状態が保持されている！

---

## 14.2 コメント機能の実装

### コメント機能の仕組み

```
┌──────────────────────────────────────────────┐
│          コメント機能のフロー                 │
└──────────────────────────────────────────────┘

【コメント投稿】
1️⃣ ユーザーがコメントを入力
         ↓
2️⃣ 「送信」ボタンをクリック
         ↓
3️⃣ POST /api/posts/[id]/comments
         ↓
4️⃣ データベースに保存
         ↓
5️⃣ ページを再検証（最新のコメント一覧を表示）

【コメント削除】
1️⃣ 自分のコメントの「削除」ボタンをクリック
         ↓
2️⃣ 確認ダイアログ
         ↓
3️⃣ DELETE /api/posts/[id]/comments/[commentId]
         ↓
4️⃣ データベースから削除
         ↓
5️⃣ ページを再検証（最新のコメント一覧を表示）
```

### Step 1: Commentモデルの確認

`prisma/schema.prisma` を開いて、Commentモデルを確認しましょう。

```prisma
model Comment {
  id        String   @id @default(cuid())
  content   String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**Commentモデルのポイント:**

| 項目 | 説明 |
|------|------|
| `content` | コメントの内容 |
| `userId` | コメントしたユーザー |
| `postId` | コメントされた投稿 |
| `onDelete: Cascade` | 投稿が削除されたら、コメントも自動削除 |

### Step 2: コメントAPIを実装

`src/app/api/posts/[id]/comments/route.ts` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * コメント一覧取得（GET）
 */
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const postId = params.id;

    // コメント一覧を取得（新しい順）
    const comments = await prisma.comment.findMany({
      where: { postId },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
    });

    return NextResponse.json({ comments });
  } catch (error) {
    console.error('コメント取得エラー:', error);
    return NextResponse.json(
      { error: 'コメントの取得に失敗しました' },
      { status: 500 }
    );
  }
}

/**
 * コメント投稿（POST）
 */
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    // 認証チェック
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      );
    }

    const postId = params.id;
    const body = await request.json();
    const { content } = body;

    // バリデーション
    if (!content || !content.trim()) {
      return NextResponse.json(
        { error: 'コメント内容を入力してください' },
        { status: 400 }
      );
    }

    // 投稿が存在するか確認
    const post = await prisma.post.findUnique({
      where: { id: postId },
    });

    if (!post) {
      return NextResponse.json(
        { error: '投稿が見つかりません' },
        { status: 404 }
      );
    }

    // コメントを作成
    const comment = await prisma.comment.create({
      data: {
        content: content.trim(),
        userId: session.user.id,
        postId,
      },
      include: {
        user: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
      },
    });

    return NextResponse.json({ comment }, { status: 201 });
  } catch (error) {
    console.error('コメント投稿エラー:', error);
    return NextResponse.json(
      { error: 'コメントの投稿に失敗しました' },
      { status: 500 }
    );
  }
}
```

### Step 3: コメント削除APIを実装

`src/app/api/posts/[id]/comments/[commentId]/route.ts` を作成して、以下のコードを**すべて**入力してください：

```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';

/**
 * コメント削除（DELETE）
 */
export async function DELETE(
  request: Request,
  { params }: { params: { id: string; commentId: string } }
) {
  try {
    // 認証チェック
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: 'ログインが必要です' },
        { status: 401 }
      );
    }

    const commentId = params.commentId;

    // コメントを取得
    const comment = await prisma.comment.findUnique({
      where: { id: commentId },
    });

    if (!comment) {
      return NextResponse.json(
        { error: 'コメントが見つかりません' },
        { status: 404 }
      );
    }

    // 権限チェック（コメント作成者または管理者）
    if (
      comment.userId !== session.user.id &&
      session.user.role !== 'admin'
    ) {
      return NextResponse.json(
        { error: '削除権限がありません' },
        { status: 403 }
      );
    }

    // コメントを削除
    await prisma.comment.delete({
      where: { id: commentId },
    });

    return NextResponse.json({ message: 'コメントを削除しました' });
  } catch (error) {
    console.error('コメント削除エラー:', error);
    return NextResponse.json(
      { error: 'コメントの削除に失敗しました' },
      { status: 500 }
    );
  }
}
```

### Step 4: コメントUIコンポーネントを作成

`src/components/CommentSection.tsx` を作成して、以下のコードを**すべて**入力してください：

```typescript
'use client';

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { Trash2, Send } from 'lucide-react';
import { Button } from '@/components/ui/Button';

interface Comment {
  id: string;
  content: string;
  createdAt: Date;
  user: {
    id: string;
    name: string | null;
    email: string | null;
    image: string | null;
  };
}

interface CommentSectionProps {
  postId: string;
  initialComments: Comment[];
  currentUserId?: string;
  isAdmin?: boolean;
}

export function CommentSection({
  postId,
  initialComments,
  currentUserId,
  isAdmin,
}: CommentSectionProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [content, setContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // コメント投稿
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!content.trim()) {
      return;
    }

    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/posts/${postId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });

      if (!response.ok) {
        throw new Error('コメントの投稿に失敗しました');
      }

      // 入力欄をクリア
      setContent('');

      // ページを再検証（最新のコメントを表示）
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      alert('コメントの投稿に失敗しました');
    } finally {
      setIsSubmitting(false);
    }
  };

  // コメント削除
  const handleDelete = async (commentId: string) => {
    if (!confirm('このコメントを削除してもよろしいですか？')) {
      return;
    }

    try {
      const response = await fetch(
        `/api/posts/${postId}/comments/${commentId}`,
        {
          method: 'DELETE',
        }
      );

      if (!response.ok) {
        throw new Error('コメントの削除に失敗しました');
      }

      // ページを再検証（最新のコメントを表示）
      startTransition(() => {
        router.refresh();
      });
    } catch (error) {
      alert('コメントの削除に失敗しました');
    }
  };

  // 相対時間表示（例: 3分前）
  const getRelativeTime = (date: Date) => {
    const now = new Date();
    const diff = now.getTime() - new Date(date).getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'たった今';
    if (minutes < 60) return `${minutes}分前`;
    if (hours < 24) return `${hours}時間前`;
    if (days < 7) return `${days}日前`;
    
    return new Date(date).toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  return (
    <div className="space-y-6">
      {/* コメント一覧 */}
      <div>
        <h2 className="text-xl font-semibold text-gray-900 mb-4">
          コメント ({initialComments.length})
        </h2>

        {initialComments.length === 0 ? (
          <p className="text-gray-500 text-center py-8">
            まだコメントがありません
          </p>
        ) : (
          <div className="space-y-4">
            {initialComments.map((comment) => {
              // 自分のコメントまたは管理者なら削除可能
              const canDelete =
                currentUserId === comment.user.id || isAdmin;

              return (
                <div
                  key={comment.id}
                  className="bg-gray-50 rounded-lg p-4"
                >
                  <div className="flex items-start justify-between gap-4">
                    {/* ユーザー情報 */}
                    <div className="flex items-start gap-3 flex-1">
                      {/* アバター */}
                      {comment.user.image ? (
                        <Image
                          src={comment.user.image}
                          alt={comment.user.name || ''}
                          width={40}
                          height={40}
                          className="rounded-full"
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold">
                          {comment.user.name?.charAt(0) || 'U'}
                        </div>
                      )}

                      <div className="flex-1">
                        {/* 名前と時間 */}
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-semibold text-gray-900">
                            {comment.user.name}
                          </span>
                          <span className="text-sm text-gray-500">
                            {getRelativeTime(comment.createdAt)}
                          </span>
                        </div>

                        {/* コメント内容 */}
                        <p className="text-gray-700 whitespace-pre-wrap">
                          {comment.content}
                        </p>
                      </div>
                    </div>

                    {/* 削除ボタン */}
                    {canDelete && (
                      <button
                        onClick={() => handleDelete(comment.id)}
                        className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition-colors"
                        title="削除"
                      >
                        <Trash2 size={18} />
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* コメント投稿フォーム（ログイン済みユーザーのみ） */}
      {currentUserId && (
        <form onSubmit={handleSubmit} className="bg-white">
          <div className="mb-4">
            <label
              htmlFor="comment"
              className="block text-sm font-medium text-gray-700 mb-2"
            >
              コメントを投稿
            </label>
            <textarea
              id="comment"
              value={content}
              onChange={(e) => setContent(e.target.value)}
              rows={3}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              placeholder="コメントを入力してください..."
              disabled={isSubmitting || isPending}
            />
          </div>

          <Button
            type="submit"
            variant="primary"
            loading={isSubmitting || isPending}
            disabled={!content.trim()}
            className="w-full sm:w-auto"
          >
            <Send size={18} className="mr-2" />
            コメントを投稿
          </Button>
        </form>
      )}

      {/* ログインしていない場合のメッセージ */}
      {!currentUserId && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
          <p className="text-blue-900">
            コメントするには
            <a
              href="/auth/signin"
              className="font-semibold underline hover:text-blue-700"
            >
              ログイン
            </a>
            が必要です
          </p>
        </div>
      )}
    </div>
  );
}
```

**CommentSectionの機能:**

1. ✅ **コメント一覧表示**: 新しい順に表示
2. ✅ **相対時間**: 「3分前」「1時間前」等
3. ✅ **アバター表示**: ユーザー画像または頭文字
4. ✅ **投稿フォーム**: テキストエリア + 送信ボタン
5. ✅ **削除ボタン**: 自分のコメントまたは管理者のみ表示
6. ✅ **ログイン促進**: 未ログイン時はログインリンク表示

### Step 5: 投稿詳細ページにコメントセクションを追加

`src/app/posts/[id]/page.tsx` を開いて、コメントセクションを追加しましょう。

まず、importを追加:

```typescript
import { CommentSection } from '@/components/CommentSection';
```

次に、YouTube動画の下（または画像の下）に、コメントセクションを追加:

```typescript
          {/* YouTube動画 */}
          {post.youtubeUrls.length > 0 && (
            <div className="px-6 pb-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">
                動画
              </h2>
              <div className="space-y-4">
                {post.youtubeUrls.map((youtube) => (
                  <YouTubeEmbed key={youtube.id} url={youtube.url} />
                ))}
              </div>
            </div>
          )}

          {/* コメントセクション */}
          <div className="px-6 pb-6 border-t border-gray-200 pt-6">
            <CommentSection
              postId={post.id}
              initialComments={post.comments}
              currentUserId={session?.user?.id}
              isAdmin={session?.user?.role === 'admin'}
            />
          </div>
        </article>
      </div>
    </div>
  );
}
```

### Step 6: 動作確認

**6-1.** 投稿詳細ページを開く

→ ✅ コメントセクションが表示される！

**6-2.** コメントを入力して「コメントを投稿」ボタンをクリック

→ ✅ コメントが追加される！

**6-3.** 自分のコメントの削除ボタンをクリック

→ ✅ 確認ダイアログが表示され、OKを押すと削除される！

**6-4.** ページをリロード

→ ✅ コメントが保持されている！

---

## 14.3 投稿一覧ページの更新

投稿一覧ページにも、いいね数とコメント数を正確に表示しましょう。

`src/app/posts/page.tsx` を開いて、カウント情報の部分を確認してください。

すでに以下のようになっているはずです:

```typescript
                  {/* カウント情報 */}
                  <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-200 text-sm">
                    {/* いいね数 */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <Heart size={16} />
                      <span>{post.likes.length}</span>
                    </div>

                    {/* コメント数 */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <MessageCircle size={16} />
                      <span>{post.comments.length}</span>
                    </div>

                    {/* 参加者数 */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <Users size={16} />
                      <span>{post.participants.length}</span>
                    </div>
                  </div>
```

これで一覧ページにも正確な数が表示されます！

---

## 14.4 確認チェックリスト

Chapter 14の内容を理解できたか確認しましょう。

### いいね機能

- [ ] Likeモデルの構造を理解した
- [ ] いいねAPIのトグル処理を実装できる
- [ ] 楽観的UIの仕組みを理解した
- [ ] いいねボタンを実装できる
- [ ] いいねの追加・削除ができる

### コメント機能

- [ ] Commentモデルの構造を理解した
- [ ] コメント投稿APIを実装できる
- [ ] コメント削除APIを実装できる
- [ ] コメントUIコンポーネントを実装できる
- [ ] 相対時間表示を理解した
- [ ] 権限チェック（削除権限）を実装できる

### ユーザー体験

- [ ] 楽観的UIでスムーズな操作感を実現できる
- [ ] エラー時のロールバック処理を実装できる
- [ ] ログイン状態での条件分岐ができる
- [ ] ページ再検証（router.refresh）を活用できる

---

## まとめ

この章では、いいね・コメント機能を実装しました。

### 🎓 この章で学んだこと

#### いいね機能
- ✅ トグル処理（追加/削除の切り替え）
- ✅ 楽観的UI（即座に画面を更新）
- ✅ エラー時のロールバック
- ✅ @@unique制約（重複防止）

#### コメント機能
- ✅ コメントCRUD（作成・読み取り・削除）
- ✅ 相対時間表示（3分前、1時間前）
- ✅ 権限チェック（自分のコメントまたは管理者のみ削除可能）
- ✅ アバター表示

#### ユーザー体験の向上
- ✅ useTransitionフックの活用
- ✅ router.refreshによる再検証
- ✅ ローディング状態の管理
- ✅ 条件付きレンダリング

### 💡 重要なポイント

#### 楽観的UIのメリット

```
┌─────────────────────────────────────────┐
│      通常のUI vs 楽観的UI               │
├─────────────────────────────────────────┤
│                                         │
│  【通常のUI】                            │
│  クリック → API通信 → 待機 → 更新        │
│  ⏱️ 1-2秒待たされる                      │
│                                         │
│  【楽観的UI】                            │
│  クリック → 即座に更新 → API通信         │
│  ⚡ 待ち時間ゼロ！                       │
│                                         │
│  ユーザーは「速いアプリ」と感じる         │
└─────────────────────────────────────────┘
```

#### エラーハンドリングの重要性

```typescript
// 楽観的に更新
setLiked(!liked);
setLikeCount(liked ? likeCount - 1 : likeCount + 1);

try {
  // API通信
  await fetch(...);
} catch (error) {
  // エラー時は元に戻す（ロールバック）
  setLiked(liked);
  setLikeCount(likeCount);
}
```

#### 権限チェックの重要性

```typescript
// サーバーサイドで必ず権限チェック
if (
  comment.userId !== session.user.id &&
  session.user.role !== 'admin'
) {
  return NextResponse.json(
    { error: '削除権限がありません' },
    { status: 403 }
  );
}
```

### 🚀 次の章への準備

次の章（Chapter 15: イベント管理機能）では、以下を学びます：

1. **イベント作成**
   - 日時・場所の設定
   - イベント情報の管理

2. **参加登録**
   - 参加者の管理
   - 参加状況の確認

3. **イベントから活動報告へ**
   - テンプレート機能
   - データの引き継ぎ

**準備すること:**
- ✅ いいね機能が動作することを確認
- ✅ コメント機能が動作することを確認
- ✅ 楽観的UIの動作を理解

### 📊 実装した機能の全体像

```
┌─────────────────────────────────────────┐
│       投稿機能（完成版）                 │
├─────────────────────────────────────────┤
│                                         │
│  ✅ 投稿CRUD（Chapter 13）               │
│  ✅ いいね機能（Chapter 14）             │
│  ✅ コメント機能（Chapter 14）           │
│                                         │
│  まだ実装していない:                     │
│  ⬜ 参加者機能                           │
│  ⬜ 投稿の検索・フィルター               │
│                                         │
└─────────────────────────────────────────┘
```

---

[← 前の章：第13章 投稿機能の実装](13-投稿機能の実装.md) | [目次に戻る](00-目次.md) | [次の章へ：第15章 イベント管理機能の実装 →](15-イベント管理機能の実装.md)
