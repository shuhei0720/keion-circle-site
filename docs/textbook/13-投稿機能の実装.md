# ç¬¬ 13 ç« ï¼šæŠ•ç¨¿æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆCRUDï¼‰ã€ãƒãƒ³ã‚ºã‚ªãƒ³ã€‘

> **ã“ã®ç« ã§ã¯ã€æ´»å‹•å ±å‘Šï¼ˆæŠ•ç¨¿ï¼‰ã®ä½œæˆãƒ»èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™**

## ğŸ› ï¸ **ãƒãƒ³ã‚ºã‚ªãƒ³ä½œæ¥­**

**âš ï¸ é‡è¦**: ã“ã®ç« ã§ã¯å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦æŠ•ç¨¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã€æŠ•ç¨¿ã®ä½œæˆãƒ»è¡¨ç¤ºãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ğŸ“š ã“ã®ç« ã§å­¦ã¶ã“ã¨

- âœ… Post ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ç†è§£
- âœ… æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… æŠ•ç¨¿ä½œæˆ APIãƒ»ãƒ•ã‚©ãƒ¼ãƒ ã®å®Ÿè£…
- âœ… æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… æŠ•ç¨¿ç·¨é›†æ©Ÿèƒ½ã®å®Ÿè£…
- âœ… æŠ•ç¨¿å‰Šé™¤æ©Ÿèƒ½ã®å®Ÿè£…
- âœ… YouTube å‹•ç”»ã®åŸ‹ã‚è¾¼ã¿
- âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSupabase Storageï¼‰

---

## 13.1 æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ç¢ºèª

### Post ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ 

`prisma/schema.prisma` ã‚’é–‹ã„ã¦ã€Post ãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```prisma
model Post {
  id          String   @id @default(cuid())
  title       String
  content     String
  published   Boolean  @default(true)

  // ä½œæˆè€…
  author      User     @relation(fields: [authorId], references: [id])
  authorId    String

  // é–¢é€£ãƒ‡ãƒ¼ã‚¿
  comments    Comment[]
  likes       Like[]
  images      Image[]
  youtubeUrls YoutubeUrl[]
  participants PostParticipant[]

  // ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®é–¢é€£
  event       Event?   @relation(fields: [eventId], references: [id])
  eventId     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// æŠ•ç¨¿ã«æ·»ä»˜ã™ã‚‹ç”»åƒ
model Image {
  id        String   @id @default(cuid())
  url       String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())
}

// æŠ•ç¨¿ã«æ·»ä»˜ã™ã‚‹YouTubeå‹•ç”»
model YoutubeUrl {
  id        String   @id @default(cuid())
  url       String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())
}

// æŠ•ç¨¿ã®å‚åŠ è€…ï¼ˆã€Œå‚åŠ ã—ã¾ã—ãŸã€æ©Ÿèƒ½ï¼‰
model PostParticipant {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  createdAt DateTime @default(now())

  @@unique([userId, postId])
}
```

**Post ãƒ¢ãƒ‡ãƒ«ã®ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:**

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰     | å‹                | èª¬æ˜                         |
| -------------- | ----------------- | ---------------------------- |
| `id`           | String            | æŠ•ç¨¿ IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰          |
| `title`        | String            | ã‚¿ã‚¤ãƒˆãƒ«                     |
| `content`      | String            | æœ¬æ–‡                         |
| `published`    | Boolean           | å…¬é–‹çŠ¶æ…‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰ |
| `authorId`     | String            | ä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID          |
| `eventId`      | String?           | é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ IDï¼ˆä»»æ„ï¼‰      |
| `comments`     | Comment[]         | ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§                 |
| `likes`        | Like[]            | ã„ã„ã­ä¸€è¦§                   |
| `images`       | Image[]           | ç”»åƒä¸€è¦§                     |
| `youtubeUrls`  | YoutubeUrl[]      | YouTube URL ä¸€è¦§             |
| `participants` | PostParticipant[] | å‚åŠ è€…ä¸€è¦§                   |

---

## 13.2 æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/posts/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { prisma } from "@/lib/db";
import Link from "next/link";
import Image from "next/image";
import { Calendar, User, Heart, MessageCircle, Users } from "lucide-react";
import { auth } from "@/lib/auth";

export default async function PostsPage() {
  const session = await auth();

  // æŠ•ç¨¿ã‚’å–å¾—ï¼ˆæ–°ã—ã„é †ï¼‰
  const posts = await prisma.post.findMany({
    where: {
      published: true,
    },
    include: {
      author: true,
      images: true,
      youtubeUrls: true,
      likes: true,
      comments: true,
      participants: true,
    },
    orderBy: {
      createdAt: "desc",
    },
    take: 20, // æœ€åˆã®20ä»¶
  });

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="flex justify-between items-center mb-8">
          <div>
            <h1 className="text-3xl font-bold text-gray-900">æ´»å‹•å ±å‘Š</h1>
            <p className="text-gray-600 mt-2">
              ç·´ç¿’ã‚„ãƒ©ã‚¤ãƒ–ã®æ§˜å­ã‚’å…±æœ‰ã—ã¦ã„ã¾ã™
            </p>
          </div>

          {/* æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */}
          {session?.user?.role === "admin" && (
            <Link
              href="/posts/new"
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              æ–°è¦æŠ•ç¨¿
            </Link>
          )}
        </div>

        {/* æŠ•ç¨¿ãŒãªã„å ´åˆ */}
        {posts.length === 0 ? (
          <div className="bg-white rounded-lg shadow p-12 text-center">
            <p className="text-gray-500 text-lg">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            {session?.user?.role === "admin" && (
              <Link
                href="/posts/new"
                className="inline-block mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                æœ€åˆã®æŠ•ç¨¿ã‚’ä½œæˆ
              </Link>
            )}
          </div>
        ) : (
          /* æŠ•ç¨¿ä¸€è¦§ */
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {posts.map((post) => (
              <Link
                key={post.id}
                href={`/posts/${post.id}`}
                className="bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden"
              >
                {/* ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ */}
                {post.images[0] ? (
                  <div className="relative h-48 bg-gray-200">
                    <Image
                      src={post.images[0].url}
                      alt={post.title}
                      fill
                      className="object-cover"
                    />
                  </div>
                ) : (
                  <div className="h-48 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <span className="text-6xl">ğŸ¸</span>
                  </div>
                )}

                {/* æŠ•ç¨¿æƒ…å ± */}
                <div className="p-4">
                  {/* ã‚¿ã‚¤ãƒˆãƒ« */}
                  <h2 className="text-xl font-semibold text-gray-900 mb-2 line-clamp-2">
                    {post.title}
                  </h2>

                  {/* æœ¬æ–‡ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ */}
                  <p className="text-gray-600 text-sm mb-4 line-clamp-3">
                    {post.content}
                  </p>

                  {/* ãƒ¡ã‚¿æƒ…å ± */}
                  <div className="flex items-center gap-4 text-sm text-gray-500">
                    {/* ä½œæˆè€… */}
                    <div className="flex items-center gap-1">
                      {post.author.image ? (
                        <Image
                          src={post.author.image}
                          alt={post.author.name || ""}
                          width={20}
                          height={20}
                          className="rounded-full"
                        />
                      ) : (
                        <User size={16} />
                      )}
                      <span>{post.author.name}</span>
                    </div>

                    {/* æ—¥ä»˜ */}
                    <div className="flex items-center gap-1">
                      <Calendar size={16} />
                      <span>
                        {new Date(post.createdAt).toLocaleDateString("ja-JP")}
                      </span>
                    </div>
                  </div>

                  {/* ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± */}
                  <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-200 text-sm">
                    {/* ã„ã„ã­æ•° */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <Heart size={16} />
                      <span>{post.likes.length}</span>
                    </div>

                    {/* ã‚³ãƒ¡ãƒ³ãƒˆæ•° */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <MessageCircle size={16} />
                      <span>{post.comments.length}</span>
                    </div>

                    {/* å‚åŠ è€…æ•° */}
                    <div className="flex items-center gap-1 text-gray-600">
                      <Users size={16} />
                      <span>{post.participants.length}</span>
                    </div>
                  </div>
                </div>
              </Link>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

**ã“ã®ä¸€è¦§ãƒšãƒ¼ã‚¸ã®ç‰¹å¾´:**

1. âœ… **ã‚«ãƒ¼ãƒ‰å½¢å¼**: æŠ•ç¨¿ã‚’ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡¨ç¤º
2. âœ… **ã‚µãƒ ãƒã‚¤ãƒ«**: ç”»åƒãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
3. âœ… **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã®ä¸€éƒ¨ã‚’è¡¨ç¤º
4. âœ… **ãƒ¡ã‚¿æƒ…å ±**: ä½œæˆè€…ã€æ—¥ä»˜ã€ã„ã„ã­æ•°ç­‰
5. âœ… **ç®¡ç†è€…ã®ã¿**: æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
6. âœ… **line-clamp**: é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’çœç•¥

### Step 2: å‹•ä½œç¢ºèª

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆã¾ã ã®å ´åˆï¼‰
npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000/posts ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚

â†’ âœ… æŠ•ç¨¿ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã¾ã æŠ•ç¨¿ãŒãªã„å ´åˆã¯ã€Œã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€ã¨è¡¨ç¤ºï¼‰

---

## 13.3 æŠ•ç¨¿ä½œæˆ API ã®å®Ÿè£…

### Step 1: æŠ•ç¨¿ä½œæˆ API ã‚’ä½œæˆ

`src/app/api/posts/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/db";

// æŠ•ç¨¿ä¸€è¦§å–å¾—ï¼ˆGETï¼‰
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get("page") || "1");
    const limit = parseInt(searchParams.get("limit") || "20");
    const skip = (page - 1) * limit;

    const posts = await prisma.post.findMany({
      where: {
        published: true,
      },
      include: {
        author: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
        images: true,
        youtubeUrls: true,
        _count: {
          select: {
            likes: true,
            comments: true,
            participants: true,
          },
        },
      },
      orderBy: {
        createdAt: "desc",
      },
      skip,
      take: limit,
    });

    const total = await prisma.post.count({
      where: { published: true },
    });

    return NextResponse.json({
      posts,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    });
  } catch (error) {
    console.error("æŠ•ç¨¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}

// æŠ•ç¨¿ä½œæˆï¼ˆPOSTï¼‰
export async function POST(request: Request) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" },
        { status: 401 }
      );
    }

    // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (session.user.role !== "admin") {
      return NextResponse.json(
        { error: "ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™" },
        { status: 403 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const body = await request.json();
    const { title, content, images, youtubeUrls, eventId } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!title || !content) {
      return NextResponse.json(
        { error: "ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã¯å¿…é ˆã§ã™" },
        { status: 400 }
      );
    }

    // æŠ•ç¨¿ã‚’ä½œæˆ
    const post = await prisma.post.create({
      data: {
        title,
        content,
        authorId: session.user.id,
        eventId: eventId || null,
        // ç”»åƒã‚’è¿½åŠ 
        images: images?.length
          ? {
              create: images.map((url: string) => ({ url })),
            }
          : undefined,
        // YouTube URLã‚’è¿½åŠ 
        youtubeUrls: youtubeUrls?.length
          ? {
              create: youtubeUrls.map((url: string) => ({ url })),
            }
          : undefined,
      },
      include: {
        author: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
        images: true,
        youtubeUrls: true,
      },
    });

    return NextResponse.json({ post }, { status: 201 });
  } catch (error) {
    console.error("æŠ•ç¨¿ä½œæˆã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "æŠ•ç¨¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}
```

**ã“ã® API ã®å‡¦ç†:**

1. âœ… **GET**: æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
2. âœ… **POST**: æ–°ã—ã„æŠ•ç¨¿ã‚’ä½œæˆ
3. âœ… **èªè¨¼ãƒã‚§ãƒƒã‚¯**: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
4. âœ… **æ¨©é™ãƒã‚§ãƒƒã‚¯**: ç®¡ç†è€…ã®ã¿ä½œæˆå¯èƒ½
5. âœ… **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: å¿…é ˆé …ç›®ã®ç¢ºèª
6. âœ… **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ç”»åƒã¨ YouTube URL ã‚’ä¸€ç·’ã«ä½œæˆ

---

## 13.4 æŠ•ç¨¿ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®å®Ÿè£…

### Step 1: æŠ•ç¨¿ä½œæˆãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/posts/new/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { auth } from "@/lib/auth";
import { redirect } from "next/navigation";
import { PostForm } from "@/components/PostForm";

export default async function NewPostPage() {
  const session = await auth();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session) {
    redirect("/auth/signin");
  }

  // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
  if (session.user?.role !== "admin") {
    redirect("/posts");
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">æ–°è¦æŠ•ç¨¿</h1>

        <PostForm />
      </div>
    </div>
  );
}
```

### Step 2: æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/PostForm.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/Button";
import { X, Plus, Upload } from "lucide-react";

interface PostFormProps {
  initialData?: {
    id: string;
    title: string;
    content: string;
    images: { url: string }[];
    youtubeUrls: { url: string }[];
  };
}

export function PostForm({ initialData }: PostFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [title, setTitle] = useState(initialData?.title || "");
  const [content, setContent] = useState(initialData?.content || "");
  const [youtubeUrls, setYoutubeUrls] = useState<string[]>(
    initialData?.youtubeUrls.map((y) => y.url) || []
  );
  const [imageUrls, setImageUrls] = useState<string[]>(
    initialData?.images.map((i) => i.url) || []
  );

  // YouTube URLã‚’è¿½åŠ 
  const addYoutubeUrl = () => {
    setYoutubeUrls([...youtubeUrls, ""]);
  };

  // YouTube URLã‚’å‰Šé™¤
  const removeYoutubeUrl = (index: number) => {
    setYoutubeUrls(youtubeUrls.filter((_, i) => i !== index));
  };

  // YouTube URLã‚’æ›´æ–°
  const updateYoutubeUrl = (index: number, value: string) => {
    const newUrls = [...youtubeUrls];
    newUrls[index] = value;
    setYoutubeUrls(newUrls);
  };

  // ç”»åƒURLã‚’è¿½åŠ 
  const addImageUrl = () => {
    const url = prompt("ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆSupabase Storageç­‰ï¼‰");
    if (url) {
      setImageUrls([...imageUrls, url]);
    }
  };

  // ç”»åƒURLã‚’å‰Šé™¤
  const removeImageUrl = (index: number) => {
    setImageUrls(imageUrls.filter((_, i) => i !== index));
  };

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!title.trim()) {
        setError("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        setLoading(false);
        return;
      }

      if (!content.trim()) {
        setError("æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        setLoading(false);
        return;
      }

      // ç©ºã®YouTube URLã‚’é™¤å¤–
      const validYoutubeUrls = youtubeUrls.filter((url) => url.trim());

      const url = initialData ? `/api/posts/${initialData.id}` : "/api/posts";

      const method = initialData ? "PUT" : "POST";

      const response = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: title.trim(),
          content: content.trim(),
          youtubeUrls: validYoutubeUrls,
          images: imageUrls,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || "æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        setLoading(false);
        return;
      }

      // æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push(`/posts/${data.post.id}`);
      router.refresh();
    } catch (err) {
      setError("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6">
      {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
          {error}
        </div>
      )}

      {/* ã‚¿ã‚¤ãƒˆãƒ« */}
      <div className="mb-6">
        <label
          htmlFor="title"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          ã‚¿ã‚¤ãƒˆãƒ« <span className="text-red-500">*</span>
        </label>
        <input
          id="title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ä¾‹: 12æœˆå®šæœŸãƒ©ã‚¤ãƒ–é–‹å‚¬ã—ã¾ã—ãŸï¼"
          required
        />
      </div>

      {/* æœ¬æ–‡ */}
      <div className="mb-6">
        <label
          htmlFor="content"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          æœ¬æ–‡ <span className="text-red-500">*</span>
        </label>
        <textarea
          id="content"
          value={content}
          onChange={(e) => setContent(e.target.value)}
          rows={12}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="æ´»å‹•ã®æ§˜å­ã‚„æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ãã ã•ã„..."
          required
        />
        <p className="mt-2 text-sm text-gray-500">æ”¹è¡Œã¯è‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã¾ã™</p>
      </div>

      {/* YouTube URL */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">
            YouTube URLï¼ˆä»»æ„ï¼‰
          </label>
          <button
            type="button"
            onClick={addYoutubeUrl}
            className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
          >
            <Plus size={16} />
            è¿½åŠ 
          </button>
        </div>

        {youtubeUrls.length === 0 ? (
          <p className="text-sm text-gray-500 italic">
            YouTubeå‹•ç”»ã‚’è¿½åŠ ã§ãã¾ã™
          </p>
        ) : (
          <div className="space-y-3">
            {youtubeUrls.map((url, index) => (
              <div key={index} className="flex gap-2">
                <input
                  type="url"
                  value={url}
                  onChange={(e) => updateYoutubeUrl(index, e.target.value)}
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="https://www.youtube.com/watch?v=..."
                />
                <button
                  type="button"
                  onClick={() => removeYoutubeUrl(index)}
                  className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                >
                  <X size={20} />
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* ç”»åƒ */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">
            ç”»åƒï¼ˆä»»æ„ï¼‰
          </label>
          <button
            type="button"
            onClick={addImageUrl}
            className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
          >
            <Upload size={16} />
            ç”»åƒè¿½åŠ 
          </button>
        </div>

        {imageUrls.length === 0 ? (
          <p className="text-sm text-gray-500 italic">
            ç”»åƒã‚’è¿½åŠ ã§ãã¾ã™ï¼ˆSupabase Storageç­‰ã®URLï¼‰
          </p>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {imageUrls.map((url, index) => (
              <div key={index} className="relative group">
                <img
                  src={url}
                  alt={`ç”»åƒ${index + 1}`}
                  className="w-full h-32 object-cover rounded-lg"
                />
                <button
                  type="button"
                  onClick={() => removeImageUrl(index)}
                  className="absolute top-2 right-2 p-1 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <X size={16} />
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <Button
          type="submit"
          variant="primary"
          loading={loading}
          className="flex-1"
        >
          {initialData ? "æ›´æ–°" : "æŠ•ç¨¿"}
        </Button>

        <Button
          type="button"
          variant="outline"
          onClick={() => router.back()}
          disabled={loading}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
      </div>
    </form>
  );
}
```

**ãƒ•ã‚©ãƒ¼ãƒ ã®ç‰¹å¾´:**

1. âœ… **å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**: YouTube URL ã‚’è¤‡æ•°è¿½åŠ /å‰Šé™¤å¯èƒ½
2. âœ… **ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**: è¿½åŠ ã—ãŸç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
3. âœ… **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
4. âœ… **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹**: é€ä¿¡ä¸­ã¯ç„¡åŠ¹åŒ–
5. âœ… **ã‚¨ãƒ©ãƒ¼è¡¨ç¤º**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
6. âœ… **ç·¨é›†å¯¾å¿œ**: initialData ãŒã‚ã‚Œã°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰

### Step 3: å‹•ä½œç¢ºèª

**3-1.** ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³

**3-2.** http://localhost:3000/posts/new ã‚’é–‹ã

**3-3.** ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›

```
ã‚¿ã‚¤ãƒˆãƒ«: ãƒ†ã‚¹ãƒˆæŠ•ç¨¿
æœ¬æ–‡: ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã§ã™ã€‚
```

**3-4.** ã€ŒæŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… æŠ•ç¨¿ãŒä½œæˆã•ã‚Œã€è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ï¼

---

## 13.5 æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

### Step 1: æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/posts/[id]/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { prisma } from "@/lib/db";
import { auth } from "@/lib/auth";
import { notFound } from "next/navigation";
import Link from "next/link";
import Image from "next/image";
import {
  Calendar,
  User,
  Heart,
  MessageCircle,
  Users,
  Edit,
  Trash2,
} from "lucide-react";
import { YouTubeEmbed } from "@/components/YouTubeEmbed";
import { DeletePostButton } from "@/components/DeletePostButton";

export default async function PostDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const session = await auth();
  const { id } = await params;

  // æŠ•ç¨¿ã‚’å–å¾—
  const post = await prisma.post.findUnique({
    where: { id },
    include: {
      author: true,
      images: true,
      youtubeUrls: true,
      likes: {
        include: {
          user: true,
        },
      },
      comments: {
        include: {
          user: true,
        },
        orderBy: {
          createdAt: "desc",
        },
      },
      participants: {
        include: {
          user: true,
        },
      },
    },
  });

  // æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
  if (!post) {
    notFound();
  }

  // è‡ªåˆ†ãŒä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ã‹
  const canEdit =
    session?.user?.id === post.authorId || session?.user?.role === "admin";

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        {/* æˆ»ã‚‹ãƒªãƒ³ã‚¯ */}
        <Link
          href="/posts"
          className="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6"
        >
          â† ä¸€è¦§ã«æˆ»ã‚‹
        </Link>

        {/* æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ */}
        <article className="bg-white rounded-lg shadow-lg overflow-hidden">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="p-6 border-b border-gray-200">
            <div className="flex justify-between items-start">
              <div className="flex-1">
                {/* ã‚¿ã‚¤ãƒˆãƒ« */}
                <h1 className="text-3xl font-bold text-gray-900 mb-4">
                  {post.title}
                </h1>

                {/* ãƒ¡ã‚¿æƒ…å ± */}
                <div className="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                  {/* ä½œæˆè€… */}
                  <div className="flex items-center gap-2">
                    {post.author.image ? (
                      <Image
                        src={post.author.image}
                        alt={post.author.name || ""}
                        width={32}
                        height={32}
                        className="rounded-full"
                      />
                    ) : (
                      <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white">
                        {post.author.name?.charAt(0) || "U"}
                      </div>
                    )}
                    <span className="font-medium">{post.author.name}</span>
                  </div>

                  {/* æ—¥ä»˜ */}
                  <div className="flex items-center gap-1">
                    <Calendar size={16} />
                    <span>
                      {new Date(post.createdAt).toLocaleDateString("ja-JP", {
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                    </span>
                  </div>

                  {/* ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± */}
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1">
                      <Heart size={16} />
                      <span>{post.likes.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <MessageCircle size={16} />
                      <span>{post.comments.length}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <Users size={16} />
                      <span>{post.participants.length}</span>
                    </div>
                  </div>
                </div>
              </div>

              {/* ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */}
              {canEdit && (
                <div className="flex gap-2">
                  <Link
                    href={`/posts/${post.id}/edit`}
                    className="px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center gap-1"
                  >
                    <Edit size={18} />
                    <span>ç·¨é›†</span>
                  </Link>
                  <DeletePostButton postId={post.id} />
                </div>
              )}
            </div>
          </div>

          {/* æœ¬æ–‡ */}
          <div className="p-6">
            <div className="prose max-w-none">
              <p className="text-gray-700 whitespace-pre-wrap">
                {post.content}
              </p>
            </div>
          </div>

          {/* ç”»åƒ */}
          {post.images.length > 0 && (
            <div className="px-6 pb-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">å†™çœŸ</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {post.images.map((image) => (
                  <div
                    key={image.id}
                    className="relative h-64 rounded-lg overflow-hidden"
                  >
                    <Image
                      src={image.url}
                      alt="æŠ•ç¨¿ç”»åƒ"
                      fill
                      className="object-cover"
                    />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* YouTubeå‹•ç”» */}
          {post.youtubeUrls.length > 0 && (
            <div className="px-6 pb-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">å‹•ç”»</h2>
              <div className="space-y-4">
                {post.youtubeUrls.map((youtube) => (
                  <YouTubeEmbed key={youtube.id} url={youtube.url} />
                ))}
              </div>
            </div>
          )}
        </article>
      </div>
    </div>
  );
}
```

### Step 2: YouTube åŸ‹ã‚è¾¼ã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/YouTubeEmbed.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
"use client";

export function YouTubeEmbed({ url }: { url: string }) {
  // YouTube URLã‹ã‚‰ãƒ“ãƒ‡ã‚ªIDã‚’æŠ½å‡º
  const getVideoId = (url: string): string | null => {
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([^&\n?#]+)/,
      /youtube\.com\/live\/([^&\n?#]+)/,
    ];

    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match && match[1]) {
        return match[1];
      }
    }

    return null;
  };

  const videoId = getVideoId(url);

  if (!videoId) {
    return (
      <div className="bg-gray-100 rounded-lg p-4 text-center">
        <p className="text-gray-600">ç„¡åŠ¹ãªYouTube URLã§ã™</p>
        <p className="text-sm text-gray-500 mt-1">{url}</p>
      </div>
    );
  }

  return (
    <div className="relative w-full pb-[56.25%] rounded-lg overflow-hidden bg-gray-900">
      <iframe
        className="absolute top-0 left-0 w-full h-full"
        src={`https://www.youtube.com/embed/${videoId}`}
        title="YouTube video player"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowFullScreen
      />
    </div>
  );
}
```

**YouTubeEmbed ã®æ©Ÿèƒ½:**

1. âœ… **URL è§£æ**: æ§˜ã€…ãª YouTube URL å½¢å¼ã«å¯¾å¿œ
2. âœ… **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–**: 16:9 ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒ
3. âœ… **iframe åŸ‹ã‚è¾¼ã¿**: YouTube Player ã‚’è¡¨ç¤º

### Step 3: å‰Šé™¤ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/DeletePostButton.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Trash2 } from "lucide-react";

export function DeletePostButton({ postId }: { postId: string }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const handleDelete = async () => {
    if (!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
      return;
    }

    setLoading(true);

    try {
      const response = await fetch(`/api/posts/${postId}`, {
        method: "DELETE",
      });

      if (!response.ok) {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
        setLoading(false);
        return;
      }

      // ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push("/posts");
      router.refresh();
    } catch (error) {
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleDelete}
      disabled={loading}
      className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-1 disabled:opacity-50"
    >
      <Trash2 size={18} />
      <span>{loading ? "å‰Šé™¤ä¸­..." : "å‰Šé™¤"}</span>
    </button>
  );
}
```

### Step 4: å‹•ä½œç¢ºèª

http://localhost:3000/posts ã‚’é–‹ã„ã¦ã€ä½œæˆã—ãŸæŠ•ç¨¿ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

â†’ âœ… æŠ•ç¨¿ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼

---

## 13.6 æŠ•ç¨¿ç·¨é›†ãƒ»å‰Šé™¤ API ã®å®Ÿè£…

### Step 1: å€‹åˆ¥æŠ•ç¨¿ã® API ã‚’ä½œæˆ

`src/app/api/posts/[id]/route.ts` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { NextResponse } from "next/server";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/db";

// æŠ•ç¨¿è©³ç´°å–å¾—ï¼ˆGETï¼‰
export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;
    const post = await prisma.post.findUnique({
      where: { id },
      include: {
        author: {
          select: {
            id: true,
            name: true,
            email: true,
            image: true,
          },
        },
        images: true,
        youtubeUrls: true,
        likes: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                image: true,
              },
            },
          },
        },
        comments: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                image: true,
              },
            },
          },
          orderBy: {
            createdAt: "desc",
          },
        },
        participants: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                image: true,
              },
            },
          },
        },
      },
    });

    if (!post) {
      return NextResponse.json(
        { error: "æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" },
        { status: 404 }
      );
    }

    return NextResponse.json({ post });
  } catch (error) {
    console.error("æŠ•ç¨¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}

// æŠ•ç¨¿æ›´æ–°ï¼ˆPUTï¼‰
export async function PUT(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" },
        { status: 401 }
      );
    }

    const { id } = await params;

    // æŠ•ç¨¿ã‚’å–å¾—
    const existingPost = await prisma.post.findUnique({
      where: { id },
    });

    if (!existingPost) {
      return NextResponse.json(
        { error: "æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" },
        { status: 404 }
      );
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ï¼‰
    if (
      existingPost.authorId !== session.user.id &&
      session.user.role !== "admin"
    ) {
      return NextResponse.json(
        { error: "ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“" },
        { status: 403 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å–å¾—
    const body = await request.json();
    const { title, content, images, youtubeUrls } = body;

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!title || !content) {
      return NextResponse.json(
        { error: "ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã¯å¿…é ˆã§ã™" },
        { status: 400 }
      );
    }

    // æ—¢å­˜ã®ç”»åƒã¨YouTube URLã‚’å‰Šé™¤
    await prisma.image.deleteMany({
      where: { postId: id },
    });
    await prisma.youtubeUrl.deleteMany({
      where: { postId: id },
    });

    // æŠ•ç¨¿ã‚’æ›´æ–°
    const post = await prisma.post.update({
      where: { id },
      data: {
        title,
        content,
        // æ–°ã—ã„ç”»åƒã‚’è¿½åŠ 
        images: images?.length
          ? {
              create: images.map((url: string) => ({ url })),
            }
          : undefined,
        // æ–°ã—ã„YouTube URLã‚’è¿½åŠ 
        youtubeUrls: youtubeUrls?.length
          ? {
              create: youtubeUrls.map((url: string) => ({ url })),
            }
          : undefined,
      },
      include: {
        author: true,
        images: true,
        youtubeUrls: true,
      },
    });

    return NextResponse.json({ post });
  } catch (error) {
    console.error("æŠ•ç¨¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "æŠ•ç¨¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}

// æŠ•ç¨¿å‰Šé™¤ï¼ˆDELETEï¼‰
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { error: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™" },
        { status: 401 }
      );
    }

    const { id } = await params;

    // æŠ•ç¨¿ã‚’å–å¾—
    const post = await prisma.post.findUnique({
      where: { id },
    });

    if (!post) {
      return NextResponse.json(
        { error: "æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" },
        { status: 404 }
      );
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ï¼‰
    if (post.authorId !== session.user.id && session.user.role !== "admin") {
      return NextResponse.json(
        { error: "å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“" },
        { status: 403 }
      );
    }

    // æŠ•ç¨¿ã‚’å‰Šé™¤ï¼ˆé–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹: onDelete: Cascadeï¼‰
    await prisma.post.delete({
      where: { id },
    });

    return NextResponse.json({ message: "æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ" });
  } catch (error) {
    console.error("æŠ•ç¨¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "æŠ•ç¨¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}
```

### Step 2: ç·¨é›†ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

`src/app/posts/[id]/edit/page.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
import { prisma } from "@/lib/db";
import { auth } from "@/lib/auth";
import { notFound, redirect } from "next/navigation";
import { PostForm } from "@/components/PostForm";

export default async function EditPostPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const session = await auth();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session) {
    redirect("/auth/signin");
  }

  const { id } = await params;

  // æŠ•ç¨¿ã‚’å–å¾—
  const post = await prisma.post.findUnique({
    where: { id },
    include: {
      images: true,
      youtubeUrls: true,
    },
  });

  if (!post) {
    notFound();
  }

  // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ï¼‰
  if (post.authorId !== session.user?.id && session.user?.role !== "admin") {
    redirect(`/posts/${id}`);
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">æŠ•ç¨¿ã‚’ç·¨é›†</h1>

        <PostForm initialData={post} />
      </div>
    </div>
  );
}
```

### Step 3: å‹•ä½œç¢ºèª

**ç·¨é›†:**

1. æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ•ã‚©ãƒ¼ãƒ ã§å†…å®¹ã‚’å¤‰æ›´
3. ã€Œæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… æŠ•ç¨¿ãŒæ›´æ–°ã•ã‚Œã¾ã™ï¼

**å‰Šé™¤:**

1. æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€ŒOKã€ã‚’ã‚¯ãƒªãƒƒã‚¯

â†’ âœ… æŠ•ç¨¿ãŒå‰Šé™¤ã•ã‚Œã€ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ï¼

---

## 13.7 ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Chapter 13 ã®å†…å®¹ã‚’ç†è§£ã§ããŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®ç†è§£

- [ ] Post ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ ã‚’ç†è§£ã—ãŸ
- [ ] é–¢é€£ãƒ¢ãƒ‡ãƒ«ï¼ˆImage, YoutubeUrl ç­‰ï¼‰ã‚’ç†è§£ã—ãŸ
- [ ] ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’ç†è§£ã—ãŸ

### æŠ•ç¨¿ä¸€è¦§

- [ ] æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤ºã§ãã‚‹
- [ ] ãƒ¡ã‚¿æƒ…å ±ï¼ˆã„ã„ã­æ•°ç­‰ï¼‰ã‚’è¡¨ç¤ºã§ãã‚‹
- [ ] ç®¡ç†è€…ã®ã¿ã«æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã§ãã‚‹

### æŠ•ç¨¿ä½œæˆ

- [ ] æŠ•ç¨¿ä½œæˆ API ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] èªè¨¼ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹
- [ ] æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] YouTube URL ã‚’å‹•çš„ã«è¿½åŠ /å‰Šé™¤ã§ãã‚‹
- [ ] ç”»åƒ URL ã‚’è¿½åŠ /å‰Šé™¤ã§ãã‚‹

### æŠ•ç¨¿è©³ç´°

- [ ] æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] YouTube å‹•ç”»ã‚’åŸ‹ã‚è¾¼ã¿ã§ãã‚‹
- [ ] ç”»åƒã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã§ãã‚‹
- [ ] ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å®Ÿè£…ã§ãã‚‹

### æŠ•ç¨¿ç·¨é›†ãƒ»å‰Šé™¤

- [ ] æŠ•ç¨¿æ›´æ–° API ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] æŠ•ç¨¿å‰Šé™¤ API ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ç·¨é›†ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€æŠ•ç¨¿æ©Ÿèƒ½ï¼ˆCRUDï¼‰ã‚’å®Œå…¨ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

- âœ… Post ãƒ¢ãƒ‡ãƒ«ã®æ§‹é€ 
- âœ… é–¢é€£ãƒ¢ãƒ‡ãƒ«ï¼ˆImage, YoutubeUrl, PostParticipantï¼‰
- âœ… ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š

#### æŠ•ç¨¿ä¸€è¦§

- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ï¼ˆprisma.post.findManyï¼‰
- âœ… ã‚«ãƒ¼ãƒ‰å½¢å¼ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- âœ… ãƒ¡ã‚¿æƒ…å ±ã®è¡¨ç¤º
- âœ… æ¡ä»¶åˆ†å²ï¼ˆç®¡ç†è€…ã®ã¿ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼‰

#### æŠ•ç¨¿ä½œæˆ

- âœ… POST API ã®å®Ÿè£…
- âœ… èªè¨¼ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯
- âœ… å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆYouTube URL è¿½åŠ /å‰Šé™¤ï¼‰
- âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### æŠ•ç¨¿è©³ç´°

- âœ… è©³ç´°ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… YouTube åŸ‹ã‚è¾¼ã¿ï¼ˆiframeï¼‰
- âœ… ç”»åƒã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
- âœ… ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³

#### æŠ•ç¨¿ç·¨é›†ãƒ»å‰Šé™¤

- âœ… PUT/DELETE API ã®å®Ÿè£…
- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä½œæˆè€…ã¾ãŸã¯ç®¡ç†è€…ï¼‰
- âœ… ç·¨é›†ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- âœ… ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

### ğŸš€ æ¬¡ã®ç« ã¸ã®æº–å‚™

æ¬¡ã®ç« ï¼ˆChapter 14: ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ï¼‰ã§ã¯ã€ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š

1. **ã„ã„ã­æ©Ÿèƒ½**

   - ãƒˆã‚°ãƒ«å‡¦ç†
   - æ¥½è¦³çš„ UI
   - ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º

2. **ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½**
   - ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
   - ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

**æº–å‚™ã™ã‚‹ã“ã¨:**

- âœ… æŠ•ç¨¿ãŒä½œæˆã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… YouTube å‹•ç”»ãŒåŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… ç·¨é›†ãƒ»å‰Šé™¤ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯ã¯å¿…é ˆ**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å¿…ãšç¢ºèª
2. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ 2 æ®µéš**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®ä¸¡æ–¹
3. **é–¢é€£ãƒ‡ãƒ¼ã‚¿ã¯ Cascade**: æŠ•ç¨¿å‰Šé™¤æ™‚ã«ç”»åƒç­‰ã‚‚è‡ªå‹•å‰Šé™¤
4. **YouTube URL ã®å¯¾å¿œ**: æ§˜ã€…ãªå½¢å¼ã«å¯¾å¿œ
5. **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–**: ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚è¦‹ã‚„ã™ã

---

[â† å‰ã®ç« ï¼šç¬¬ 12 ç«  åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³](12-åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬ 14 ç«  ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ â†’](14-ã„ã„ã­ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½.md)
