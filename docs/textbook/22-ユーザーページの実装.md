# ç¬¬22ç« ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£…

ã“ã®ç« ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## 22.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸

### app/users/page.tsx

```typescript
import Link from 'next/link';
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import UserCard from '@/components/UserCard';
import SearchBox from '@/components/SearchBox';
import { Users, Crown } from 'lucide-react';

interface PageProps {
  searchParams: Promise<{
    q?: string;
    role?: string;
    instrument?: string;
  }>;
}

async function getUsers(searchQuery?: string, role?: string, instrument?: string) {
  const where: any = {};
  
  // æ¤œç´¢ã‚¯ã‚¨ãƒª
  if (searchQuery) {
    where.OR = [
      { name: { contains: searchQuery, mode: 'insensitive' } },
      { email: { contains: searchQuery, mode: 'insensitive' } },
      { instrument: { contains: searchQuery, mode: 'insensitive' } },
    ];
  }
  
  // å½¹å‰²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if (role) {
    where.role = role;
  }
  
  // æ¥½å™¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  if (instrument) {
    where.instrument = { contains: instrument, mode: 'insensitive' };
  }
  
  return prisma.user.findMany({
    where,
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      bio: true,
      instrument: true,
      role: true,
      _count: {
        select: {
          posts: true,
          comments: true,
          likes: true,
        },
      },
    },
    orderBy: {
      createdAt: 'desc',
    },
  });
}

export default async function UsersPage({ searchParams }: PageProps) {
  const params = await searchParams;
  const session = await auth();
  
  const users = await getUsers(params.q, params.role, params.instrument);
  
  // ç®¡ç†è€…ã¨ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼ã«åˆ†é¡
  const admins = users.filter(u => u.role === 'admin');
  const members = users.filter(u => u.role === 'member');
  
  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold flex items-center gap-2 mb-4">
          <Users className="w-8 h-8" />
          ãƒ¡ãƒ³ãƒãƒ¼
        </h1>
        
        <p className="text-gray-600">
          å…¨ {users.length} äººã®ãƒ¡ãƒ³ãƒãƒ¼
        </p>
      </div>
      
      {/* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */}
      <div className="mb-8">
        <SearchBox
          placeholder="ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢..."
          defaultValue={params.q}
        />
      </div>
      
      {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <div className="flex gap-4 mb-8">
        <Link
          href="/users"
          className={`px-4 py-2 rounded-lg transition-colors ${
            !params.role
              ? 'bg-blue-600 text-white'
              : 'border hover:bg-gray-100'
          }`}
        >
          ã™ã¹ã¦
        </Link>
        
        <Link
          href="/users?role=admin"
          className={`px-4 py-2 rounded-lg transition-colors ${
            params.role === 'admin'
              ? 'bg-yellow-600 text-white'
              : 'border hover:bg-gray-100'
          }`}
        >
          ç®¡ç†è€…
        </Link>
        
        <Link
          href="/users?role=member"
          className={`px-4 py-2 rounded-lg transition-colors ${
            params.role === 'member'
              ? 'bg-blue-600 text-white'
              : 'border hover:bg-gray-100'
          }`}
        >
          ãƒ¡ãƒ³ãƒãƒ¼
        </Link>
      </div>
      
      {/* ç®¡ç†è€… */}
      {admins.length > 0 && (
        <section className="mb-12">
          <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            <Crown className="w-6 h-6 text-yellow-600" />
            ç®¡ç†è€…
          </h2>
          
          <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {admins.map(user => (
              <UserCard key={user.id} user={user} />
            ))}
          </div>
        </section>
      )}
      
      {/* ãƒ¡ãƒ³ãƒãƒ¼ */}
      {members.length > 0 && (
        <section>
          <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
            <Users className="w-6 h-6" />
            ãƒ¡ãƒ³ãƒãƒ¼
          </h2>
          
          <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {members.map(user => (
              <UserCard key={user.id} user={user} />
            ))}
          </div>
        </section>
      )}
      
      {/* æ¤œç´¢çµæœãªã— */}
      {users.length === 0 && (
        <div className="text-center py-12">
          <p className="text-gray-600">
            {params.q ? 'æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ' : 'ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“'}
          </p>
        </div>
      )}
    </div>
  );
}
```

---

## 22.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/UserCard.tsx

```typescript
import Link from 'next/link';
import Image from 'next/image';
import { Crown, Music, MessageCircle, Heart } from 'lucide-react';

interface UserCardProps {
  user: {
    id: string;
    name: string | null;
    image: string | null;
    bio: string | null;
    instrument: string | null;
    role: string;
    _count: {
      posts: number;
      comments: number;
      likes: number;
    };
  };
}

export default function UserCard({ user }: UserCardProps) {
  return (
    <Link
      href={`/users/${user.id}`}
      className="block border rounded-lg p-6 hover:shadow-lg transition-shadow bg-white"
    >
      <div className="flex flex-col items-center">
        {/* ã‚¢ãƒã‚¿ãƒ¼ */}
        <div className="relative mb-4">
          <div className="relative w-24 h-24 rounded-full overflow-hidden bg-gray-200">
            {user.image ? (
              <Image
                src={user.image}
                alt={user.name || ''}
                fill
                className="object-cover"
              />
            ) : (
              <div className="w-full h-full flex items-center justify-center text-gray-400 text-3xl font-bold">
                {user.name?.[0] || '?'}
              </div>
            )}
          </div>
          
          {/* ç®¡ç†è€…ãƒãƒƒã‚¸ */}
          {user.role === 'admin' && (
            <div className="absolute -top-1 -right-1 w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center border-2 border-white">
              <Crown className="w-5 h-5 text-yellow-800" />
            </div>
          )}
        </div>
        
        {/* åå‰ */}
        <h3 className="text-xl font-bold mb-1 text-center">{user.name}</h3>
        
        {/* æ¥½å™¨ */}
        {user.instrument && (
          <p className="text-sm text-gray-600 mb-3 flex items-center gap-1">
            <Music className="w-4 h-4" />
            {user.instrument}
          </p>
        )}
        
        {/* è‡ªå·±ç´¹ä»‹ */}
        {user.bio && (
          <p className="text-sm text-gray-600 text-center mb-4 line-clamp-2">
            {user.bio}
          </p>
        )}
        
        {/* çµ±è¨ˆ */}
        <div className="flex items-center gap-4 text-sm text-gray-600">
          <span className="flex items-center gap-1">
            ğŸ“ {user._count.posts}
          </span>
          
          <span className="flex items-center gap-1">
            <Heart className="w-4 h-4" />
            {user._count.likes}
          </span>
          
          <span className="flex items-center gap-1">
            <MessageCircle className="w-4 h-4" />
            {user._count.comments}
          </span>
        </div>
      </div>
    </Link>
  );
}
```

---

## 22.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸

### app/users/[id]/page.tsx

```typescript
import { notFound } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { prisma } from '@/lib/db';
import { auth } from '@/lib/auth';
import PostCard from '@/components/PostCard';
import { Crown, Music, Mail, Edit, Calendar } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';

interface PageProps {
  params: Promise<{
    id: string;
  }>;
}

async function getUser(id: string) {
  return prisma.user.findUnique({
    where: { id },
    include: {
      posts: {
        include: {
          author: {
            select: {
              id: true,
              name: true,
              image: true,
            },
          },
          _count: {
            select: {
              likes: true,
              comments: true,
            },
          },
        },
        orderBy: {
          createdAt: 'desc',
        },
        take: 6,
      },
      _count: {
        select: {
          posts: true,
          comments: true,
          likes: true,
        },
      },
    },
  });
}

export default async function UserDetailPage({ params }: PageProps) {
  const { id } = await params;
  const session = await auth();
  
  const user = await getUser(id);
  
  if (!user) {
    notFound();
  }
  
  const isOwner = session?.user?.id === user.id;
  const isAdmin = session?.user?.role === 'admin';
  
  return (
    <div className="max-w-6xl mx-auto px-4 py-8">
      {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-8 mb-8">
        <div className="flex flex-col md:flex-row gap-6 items-start">
          {/* ã‚¢ãƒã‚¿ãƒ¼ */}
          <div className="relative">
            <div className="relative w-32 h-32 rounded-full overflow-hidden bg-gray-200 border-4 border-white shadow-lg">
              {user.image ? (
                <Image
                  src={user.image}
                  alt={user.name || ''}
                  fill
                  className="object-cover"
                />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-400 text-4xl font-bold">
                  {user.name?.[0] || '?'}
                </div>
              )}
            </div>
            
            {user.role === 'admin' && (
              <div className="absolute -bottom-2 -right-2 w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center border-2 border-white">
                <Crown className="w-6 h-6 text-yellow-800" />
              </div>
            )}
          </div>
          
          {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± */}
          <div className="flex-1">
            <div className="flex items-start justify-between mb-4">
              <div>
                <h1 className="text-3xl font-bold mb-2">{user.name}</h1>
                
                {user.role === 'admin' && (
                  <span className="inline-flex items-center gap-1 px-3 py-1 bg-yellow-400 text-yellow-900 rounded-full text-sm font-medium">
                    <Crown className="w-4 h-4" />
                    ç®¡ç†è€…
                  </span>
                )}
              </div>
              
              {(isOwner || isAdmin) && (
                <Link
                  href={`/users/${user.id}/edit`}
                  className="flex items-center gap-2 px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 transition-colors"
                >
                  <Edit className="w-4 h-4" />
                  ç·¨é›†
                </Link>
              )}
            </div>
            
            {/* æ¥½å™¨ */}
            {user.instrument && (
              <p className="flex items-center gap-2 text-gray-700 mb-2">
                <Music className="w-5 h-5" />
                {user.instrument}
              </p>
            )}
            
            {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */}
            <p className="flex items-center gap-2 text-gray-600 text-sm mb-2">
              <Mail className="w-4 h-4" />
              {user.email}
            </p>
            
            {/* ç™»éŒ²æ—¥ */}
            <p className="flex items-center gap-2 text-gray-600 text-sm">
              <Calendar className="w-4 h-4" />
              {format(new Date(user.createdAt), 'yyyyå¹´Mæœˆdæ—¥', { locale: ja })} ç™»éŒ²
            </p>
            
            {/* è‡ªå·±ç´¹ä»‹ */}
            {user.bio && (
              <p className="mt-4 text-gray-700 whitespace-pre-wrap">
                {user.bio}
              </p>
            )}
          </div>
        </div>
        
        {/* çµ±è¨ˆ */}
        <div className="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-gray-200">
          <div className="text-center">
            <p className="text-3xl font-bold text-blue-600">{user._count.posts}</p>
            <p className="text-sm text-gray-600">æŠ•ç¨¿</p>
          </div>
          
          <div className="text-center">
            <p className="text-3xl font-bold text-red-600">{user._count.likes}</p>
            <p className="text-sm text-gray-600">ã„ã„ã­</p>
          </div>
          
          <div className="text-center">
            <p className="text-3xl font-bold text-green-600">{user._count.comments}</p>
            <p className="text-sm text-gray-600">ã‚³ãƒ¡ãƒ³ãƒˆ</p>
          </div>
        </div>
      </div>
      
      {/* æŠ•ç¨¿ä¸€è¦§ */}
      <section>
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold">ğŸ“ æŠ•ç¨¿</h2>
          
          {user.posts.length > 0 && (
            <Link
              href={`/posts?author=${user.id}`}
              className="text-blue-600 hover:underline text-sm"
            >
              ã™ã¹ã¦è¦‹ã‚‹ â†’
            </Link>
          )}
        </div>
        
        {user.posts.length === 0 ? (
          <p className="text-gray-600 text-center py-12 bg-gray-50 rounded-lg">
            ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“
          </p>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {user.posts.map(post => (
              <PostCard key={post.id} post={post} />
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
```

---

## 22.4 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸

### app/users/[id]/edit/page.tsx

```typescript
import { notFound, redirect } from 'next/navigation';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';
import ProfileForm from '@/components/ProfileForm';

interface PageProps {
  params: Promise<{
    id: string;
  }>;
}

async function getUser(id: string) {
  return prisma.user.findUnique({
    where: { id },
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      bio: true,
      instrument: true,
      role: true,
    },
  });
}

export default async function EditProfilePage({ params }: PageProps) {
  const { id } = await params;
  const session = await auth();
  
  if (!session) {
    redirect('/login');
  }
  
  const user = await getUser(id);
  
  if (!user) {
    notFound();
  }
  
  // æœ¬äººã¾ãŸã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
  const canEdit = session.user.id === user.id || session.user.role === 'admin';
  
  if (!canEdit) {
    redirect(`/users/${id}`);
  }
  
  return (
    <div className="max-w-2xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h1>
      
      <ProfileForm user={user} />
    </div>
  );
}
```

---

## 22.5 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### components/ProfileForm.tsx

```typescript
'use client';

import { useState, FormEvent } from 'react';
import { useRouter } from 'next/navigation';
import AvatarUpload from './AvatarUpload';

interface ProfileFormProps {
  user: {
    id: string;
    name: string | null;
    email: string;
    image: string | null;
    bio: string | null;
    instrument: string | null;
    role: string;
  };
}

export default function ProfileForm({ user }: ProfileFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  
  const [formData, setFormData] = useState({
    name: user.name || '',
    bio: user.bio || '',
    instrument: user.instrument || '',
  });
  
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    
    if (!formData.name) {
      alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    setLoading(true);
    
    try {
      const response = await fetch(`/api/users/${user.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error);
      }
      
      router.push(`/users/${user.id}`);
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ */}
      <div>
        <label className="block text-sm font-medium mb-4">
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
        </label>
        <AvatarUpload userId={user.id} currentImage={user.image} />
      </div>
      
      {/* åå‰ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          åå‰ <span className="text-red-600">*</span>
        </label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          placeholder="å±±ç”° å¤ªéƒ"
          className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
      </div>
      
      {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        </label>
        <input
          type="email"
          value={user.email}
          className="w-full px-4 py-3 border rounded-lg bg-gray-100 cursor-not-allowed"
          disabled
        />
        <p className="text-xs text-gray-600 mt-1">
          ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“
        </p>
      </div>
      
      {/* æ¥½å™¨ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          æ‹…å½“æ¥½å™¨
        </label>
        <input
          type="text"
          value={formData.instrument}
          onChange={(e) => setFormData({ ...formData, instrument: e.target.value })}
          placeholder="ä¾‹: ã‚®ã‚¿ãƒ¼ã€ãƒœãƒ¼ã‚«ãƒ«"
          className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      
      {/* è‡ªå·±ç´¹ä»‹ */}
      <div>
        <label className="block text-sm font-medium mb-2">
          è‡ªå·±ç´¹ä»‹
        </label>
        <textarea
          value={formData.bio}
          onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
          placeholder="è‡ªå·±ç´¹ä»‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          rows={6}
          className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <p className="text-sm text-gray-600 mt-1">
          {formData.bio.length} / 500 æ–‡å­—
        </p>
      </div>
      
      {/* å½¹å‰²ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ */}
      {user.role === 'admin' && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <p className="text-sm text-yellow-800">
            ã‚ãªãŸã¯<strong>ç®¡ç†è€…</strong>ã§ã™ã€‚æŠ•ç¨¿ã‚„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒå¯èƒ½ã§ã™ã€‚
          </p>
        </div>
      )}
      
      {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <button
          type="submit"
          disabled={loading}
          className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {loading ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°ã™ã‚‹'}
        </button>
        
        <button
          type="button"
          onClick={() => router.back()}
          className="px-6 py-3 border rounded-lg hover:bg-gray-100 transition-colors"
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </form>
  );
}
```

---

## 22.6 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ 

### components/PasswordChangeForm.tsx

```typescript
'use client';

import { useState, FormEvent } from 'react';
import { Lock } from 'lucide-react';

interface PasswordChangeFormProps {
  userId: string;
}

export default function PasswordChangeForm({ userId }: PasswordChangeFormProps) {
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: '',
  });
  
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (formData.newPassword.length < 6) {
      alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
      return;
    }
    
    if (formData.newPassword !== formData.confirmPassword) {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
      return;
    }
    
    setLoading(true);
    
    try {
      const response = await fetch(`/api/users/${userId}/password`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currentPassword: formData.currentPassword,
          newPassword: formData.newPassword,
        }),
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error);
      }
      
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      setFormData({
        currentPassword: '',
        newPassword: '',
        confirmPassword: '',
      });
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="border rounded-lg p-6">
      <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
        <Lock className="w-5 h-5" />
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
      </h3>
      
      <div className="space-y-4">
        {/* ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */}
        <div>
          <label className="block text-sm font-medium mb-2">
            ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            type="password"
            value={formData.currentPassword}
            onChange={(e) => setFormData({ ...formData, currentPassword: e.target.value })}
            className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        
        {/* æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */}
        <div>
          <label className="block text-sm font-medium mb-2">
            æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <input
            type="password"
            value={formData.newPassword}
            onChange={(e) => setFormData({ ...formData, newPassword: e.target.value })}
            className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
            minLength={6}
          />
          <p className="text-xs text-gray-600 mt-1">
            6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>
        
        {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª */}
        <div>
          <label className="block text-sm font-medium mb-2">
            æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰
          </label>
          <input
            type="password"
            value={formData.confirmPassword}
            onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
            className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        
        {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
        <button
          type="submit"
          disabled={loading}
          className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {loading ? 'å¤‰æ›´ä¸­...' : 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´'}
        </button>
      </div>
    </form>
  );
}
```

---

## 22.7 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ 

### components/DeleteAccountForm.tsx

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { signOut } from 'next-auth/react';
import { Trash2, AlertTriangle } from 'lucide-react';

interface DeleteAccountFormProps {
  userId: string;
}

export default function DeleteAccountForm({ userId }: DeleteAccountFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [confirmText, setConfirmText] = useState('');
  
  const handleDelete = async () => {
    if (confirmText !== 'å‰Šé™¤ã—ã¾ã™') {
      alert('ç¢ºèªãƒ†ã‚­ã‚¹ãƒˆãŒä¸€è‡´ã—ã¾ã›ã‚“');
      return;
    }
    
    if (!confirm('æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
      return;
    }
    
    setLoading(true);
    
    try {
      const response = await fetch(`/api/users/${userId}`, {
        method: 'DELETE',
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error);
      }
      
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
      await signOut({ redirect: false });
      router.push('/');
      router.refresh();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="border-2 border-red-200 rounded-lg p-6 bg-red-50">
      <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-700">
        <Trash2 className="w-5 h-5" />
        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
      </h3>
      
      <div className="bg-white border border-red-200 rounded-lg p-4 mb-4">
        <div className="flex items-start gap-3 mb-3">
          <AlertTriangle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
          <div>
            <p className="font-medium text-red-700 mb-2">
              è­¦å‘Š: ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“
            </p>
            <ul className="text-sm text-gray-700 space-y-1 list-disc list-inside">
              <li>ã™ã¹ã¦ã®æŠ•ç¨¿ã¨ã‚³ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã™</li>
              <li>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™</li>
              <li>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">
            ç¢ºèªã®ãŸã‚ã€Œ<strong>å‰Šé™¤ã—ã¾ã™</strong>ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„
          </label>
          <input
            type="text"
            value={confirmText}
            onChange={(e) => setConfirmText(e.target.value)}
            placeholder="å‰Šé™¤ã—ã¾ã™"
            className="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"
          />
        </div>
        
        <button
          onClick={handleDelete}
          disabled={loading || confirmText !== 'å‰Šé™¤ã—ã¾ã™'}
          className="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {loading ? 'å‰Šé™¤ä¸­...' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤'}
        </button>
      </div>
    </div>
  );
}
```

---

## 22.8 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒšãƒ¼ã‚¸ï¼ˆå®Œå…¨ç‰ˆï¼‰

### app/users/[id]/edit/page.tsxï¼ˆæ‹¡å¼µç‰ˆï¼‰

```typescript
import { notFound, redirect } from 'next/navigation';
import { auth } from '@/lib/auth';
import { prisma } from '@/lib/db';
import ProfileForm from '@/components/ProfileForm';
import PasswordChangeForm from '@/components/PasswordChangeForm';
import DeleteAccountForm from '@/components/DeleteAccountForm';

interface PageProps {
  params: Promise<{
    id: string;
  }>;
}

async function getUser(id: string) {
  return prisma.user.findUnique({
    where: { id },
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      bio: true,
      instrument: true,
      role: true,
    },
  });
}

export default async function EditProfilePage({ params }: PageProps) {
  const { id } = await params;
  const session = await auth();
  
  if (!session) {
    redirect('/login');
  }
  
  const user = await getUser(id);
  
  if (!user) {
    notFound();
  }
  
  const isOwner = session.user.id === user.id;
  const isAdmin = session.user.role === 'admin';
  
  if (!isOwner && !isAdmin) {
    redirect(`/users/${id}`);
  }
  
  return (
    <div className="max-w-2xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-8">âœï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h1>
      
      {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åŸºæœ¬æƒ…å ± */}
      <section className="mb-8">
        <ProfileForm user={user} />
      </section>
      
      {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆæœ¬äººã®ã¿ï¼‰ */}
      {isOwner && (
        <section className="mb-8">
          <PasswordChangeForm userId={user.id} />
        </section>
      )}
      
      {/* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆæœ¬äººã®ã¿ï¼‰ */}
      {isOwner && (
        <section>
          <DeleteAccountForm userId={user.id} />
        </section>
      )}
    </div>
  );
}
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
- âœ… **æ¤œç´¢æ©Ÿèƒ½**: åå‰ã€ãƒ¡ãƒ¼ãƒ«ã€æ¥½å™¨ã§æ¤œç´¢
- âœ… **ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: ç®¡ç†è€…/ãƒ¡ãƒ³ãƒãƒ¼ã§çµã‚Šè¾¼ã¿
- âœ… **UserCard**: ã‚¢ãƒã‚¿ãƒ¼ã€çµ±è¨ˆæƒ…å ±ã€ç®¡ç†è€…ãƒãƒƒã‚¸

### ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°
- âœ… **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º**: ã‚¢ãƒã‚¿ãƒ¼ã€åå‰ã€æ¥½å™¨ã€è‡ªå·±ç´¹ä»‹
- âœ… **çµ±è¨ˆæƒ…å ±**: æŠ•ç¨¿æ•°ã€ã„ã„ã­æ•°ã€ã‚³ãƒ¡ãƒ³ãƒˆæ•°
- âœ… **æŠ•ç¨¿ä¸€è¦§**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€æ–°æŠ•ç¨¿6ä»¶
- âœ… **ç·¨é›†ãƒœã‚¿ãƒ³**: æœ¬äººã¾ãŸã¯ç®¡ç†è€…ã®ã¿è¡¨ç¤º

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
- âœ… **åŸºæœ¬æƒ…å ±**: åå‰ã€æ¥½å™¨ã€è‡ªå·±ç´¹ä»‹
- âœ… **ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ**: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- âœ… **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´**: ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼
- âœ… **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤**: ç¢ºèªãƒ†ã‚­ã‚¹ãƒˆã§äºŒé‡ç¢ºèª

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- âœ… **æ¨©é™ãƒã‚§ãƒƒã‚¯**: æœ¬äººã¾ãŸã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯èƒ½
- âœ… **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼**: bcryptã§ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèª
- âœ… **å‰Šé™¤ç¢ºèª**: äºŒæ®µéšç¢ºèªã§èª¤æ“ä½œã‚’é˜²æ­¢

æ¬¡ã®ç« ã§ã¯ã€**èªè¨¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£…**ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬21ç«  ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å®Ÿè£…](21-ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å®Ÿè£….md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬23ç«  èªè¨¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£… â†’](23-èªè¨¼ãƒšãƒ¼ã‚¸ã®å®Ÿè£….md)
