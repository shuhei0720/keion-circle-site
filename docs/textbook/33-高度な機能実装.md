# ç¬¬33ç« ï¼šé«˜åº¦ãªæ©Ÿèƒ½å®Ÿè£…

ã“ã®ç« ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã•ã‚‰ã«æ‹¡å¼µã™ã‚‹é«˜åº¦ãªæ©Ÿèƒ½ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

## 33.1 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½

### Server-Sent Events (SSE)

```typescript
// app/api/notifications/stream/route.ts
import { NextRequest } from 'next/server';

export const runtime = 'edge';

export async function GET(request: NextRequest) {
  const stream = new ReadableStream({
    start(controller) {
      const encoder = new TextEncoder();
      
      // å®šæœŸçš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
      const interval = setInterval(() => {
        const data = {
          type: 'notification',
          message: 'æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™',
          timestamp: new Date().toISOString(),
        };
        
        controller.enqueue(
          encoder.encode(`data: ${JSON.stringify(data)}\n\n`)
        );
      }, 5000);
      
      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      request.signal.addEventListener('abort', () => {
        clearInterval(interval);
        controller.close();
      });
    },
  });
  
  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å®Ÿè£…

```typescript
// hooks/useNotifications.ts
'use client';

import { useEffect, useState } from 'react';

interface Notification {
  type: string;
  message: string;
  timestamp: string;
}

export function useNotifications() {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    const eventSource = new EventSource('/api/notifications/stream');
    
    eventSource.onopen = () => {
      setIsConnected(true);
      console.log('SSE connected');
    };
    
    eventSource.onmessage = (event) => {
      const notification = JSON.parse(event.data);
      setNotifications((prev) => [...prev, notification]);
    };
    
    eventSource.onerror = () => {
      setIsConnected(false);
      console.error('SSE error');
      eventSource.close();
    };
    
    return () => {
      eventSource.close();
      setIsConnected(false);
    };
  }, []);
  
  return { notifications, isConnected };
}
```

---

## 33.2 ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

### ã‚«ãƒ¼ã‚½ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

```typescript
// hooks/useInfiniteScroll.ts
'use client';

import { useEffect, useState, useRef } from 'react';

interface UseInfiniteScrollOptions<T> {
  fetchData: (cursor?: string) => Promise<{
    items: T[];
    nextCursor?: string;
    hasMore: boolean;
  }>;
  initialData?: T[];
}

export function useInfiniteScroll<T>({
  fetchData,
  initialData = [],
}: UseInfiniteScrollOptions<T>) {
  const [items, setItems] = useState<T[]>(initialData);
  const [cursor, setCursor] = useState<string | undefined>();
  const [hasMore, setHasMore] = useState(true);
  const [isLoading, setIsLoading] = useState(false);
  const observerRef = useRef<IntersectionObserver | null>(null);
  const loadMoreRef = useRef<HTMLDivElement | null>(null);
  
  const loadMore = async () => {
    if (isLoading || !hasMore) return;
    
    setIsLoading(true);
    try {
      const result = await fetchData(cursor);
      setItems((prev) => [...prev, ...result.items]);
      setCursor(result.nextCursor);
      setHasMore(result.hasMore);
    } catch (error) {
      console.error('Failed to load more:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  useEffect(() => {
    observerRef.current = new IntersectionObserver(
      (entries) => {
        if (entries[0].isIntersecting && hasMore && !isLoading) {
          loadMore();
        }
      },
      { threshold: 0.1 }
    );
    
    if (loadMoreRef.current) {
      observerRef.current.observe(loadMoreRef.current);
    }
    
    return () => {
      if (observerRef.current) {
        observerRef.current.disconnect();
      }
    };
  }, [hasMore, isLoading, cursor]);
  
  return {
    items,
    isLoading,
    hasMore,
    loadMoreRef,
  };
}

// ä½¿ç”¨ä¾‹
export function InfinitePostList() {
  const { items, isLoading, hasMore, loadMoreRef } = useInfiniteScroll({
    fetchData: async (cursor) => {
      const response = await fetch(
        `/api/posts?cursor=${cursor || ''}&limit=20`
      );
      return response.json();
    },
  });
  
  return (
    <div>
      {items.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}
      
      {hasMore && (
        <div ref={loadMoreRef} className="py-8 text-center">
          {isLoading ? 'Loading...' : 'Scroll for more'}
        </div>
      )}
    </div>
  );
}
```

---

## 33.3 å…¨æ–‡æ¤œç´¢

### Prismaã§ã®æ¤œç´¢å®Ÿè£…

```typescript
// app/api/search/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const query = searchParams.get('q') || '';
  const page = parseInt(searchParams.get('page') || '1');
  const limit = 20;
  
  try {
    // æŠ•ç¨¿ã‚’æ¤œç´¢
    const posts = await prisma.post.findMany({
      where: {
        OR: [
          {
            title: {
              contains: query,
              mode: 'insensitive',
            },
          },
          {
            content: {
              contains: query,
              mode: 'insensitive',
            },
          },
        ],
        published: true,
      },
      include: {
        author: {
          select: {
            id: true,
            name: true,
            image: true,
          },
        },
      },
      orderBy: {
        createdAt: 'desc',
      },
      skip: (page - 1) * limit,
      take: limit,
    });
    
    // ç·æ•°ã‚’å–å¾—
    const total = await prisma.post.count({
      where: {
        OR: [
          { title: { contains: query, mode: 'insensitive' } },
          { content: { contains: query, mode: 'insensitive' } },
        ],
        published: true,
      },
    });
    
    return NextResponse.json({
      posts,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    });
  } catch (error) {
    console.error('Search error:', error);
    return NextResponse.json(
      { error: 'Search failed' },
      { status: 500 }
    );
  }
}
```

### æ¤œç´¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/SearchWithResults.tsx
'use client';

import { useState, useEffect } from 'react';
import { useDebounce } from '@/hooks/useDebounce';
import { Search } from 'lucide-react';

export function SearchWithResults() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const debouncedQuery = useDebounce(query, 300);
  
  useEffect(() => {
    if (!debouncedQuery) {
      setResults([]);
      return;
    }
    
    const searchPosts = async () => {
      setIsLoading(true);
      try {
        const response = await fetch(
          `/api/search?q=${encodeURIComponent(debouncedQuery)}`
        );
        const data = await response.json();
        setResults(data.posts);
      } catch (error) {
        console.error('Search failed:', error);
      } finally {
        setIsLoading(false);
      }
    };
    
    searchPosts();
  }, [debouncedQuery]);
  
  return (
    <div className="relative">
      <div className="relative">
        <input
          type="search"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="æŠ•ç¨¿ã‚’æ¤œç´¢..."
          className="input pl-10"
        />
        <Search
          className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
          size={20}
        />
      </div>
      
      {/* æ¤œç´¢çµæœ */}
      {query && (
        <div className="absolute top-full left-0 right-0 mt-2 bg-white border rounded-lg shadow-lg max-h-96 overflow-y-auto">
          {isLoading ? (
            <div className="p-4 text-center">æ¤œç´¢ä¸­...</div>
          ) : results.length > 0 ? (
            <ul>
              {results.map((post) => (
                <li key={post.id}>
                  <a
                    href={`/posts/${post.id}`}
                    className="block p-4 hover:bg-gray-50"
                  >
                    <h3 className="font-semibold">{post.title}</h3>
                    <p className="text-sm text-gray-600 line-clamp-2">
                      {post.content}
                    </p>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <div className="p-4 text-center text-gray-600">
              çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

---

## 33.4 é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### é€šçŸ¥ãƒ¢ãƒ‡ãƒ«

```prisma
// prisma/schema.prisma ã«è¿½åŠ 
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // 'like', 'comment', 'mention', 'system'
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
}
```

### é€šçŸ¥ä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼

```typescript
// lib/notifications.ts
import { prisma } from '@/lib/prisma';

export async function createNotification({
  userId,
  type,
  title,
  message,
  link,
}: {
  userId: string;
  type: string;
  title: string;
  message: string;
  link?: string;
}) {
  return prisma.notification.create({
    data: {
      userId,
      type,
      title,
      message,
      link,
    },
  });
}

// ä½¿ç”¨ä¾‹: ã„ã„ã­é€šçŸ¥
export async function notifyPostLiked(postId: string, likerId: string) {
  const post = await prisma.post.findUnique({
    where: { id: postId },
    include: { author: true },
  });
  
  if (!post || post.authorId === likerId) {
    return; // è‡ªåˆ†ã®æŠ•ç¨¿ã«ã„ã„ã­ã—ãŸå ´åˆã¯é€šçŸ¥ã—ãªã„
  }
  
  const liker = await prisma.user.findUnique({
    where: { id: likerId },
  });
  
  await createNotification({
    userId: post.authorId,
    type: 'like',
    title: 'ã„ã„ã­ã•ã‚Œã¾ã—ãŸ',
    message: `${liker?.name}ã•ã‚“ãŒã‚ãªãŸã®æŠ•ç¨¿ã«ã„ã„ã­ã—ã¾ã—ãŸ`,
    link: `/posts/${postId}`,
  });
}
```

### é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼

```typescript
// components/NotificationCenter.tsx
'use client';

import { useState, useEffect } from 'react';
import { Bell } from 'lucide-react';
import { formatRelativeTime } from '@/lib/utils/date';

interface Notification {
  id: string;
  type: string;
  title: string;
  message: string;
  link?: string;
  read: boolean;
  createdAt: Date;
}

export function NotificationCenter() {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [isOpen, setIsOpen] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);
  
  useEffect(() => {
    fetchNotifications();
  }, []);
  
  const fetchNotifications = async () => {
    const response = await fetch('/api/notifications');
    const data = await response.json();
    setNotifications(data.notifications);
    setUnreadCount(data.unreadCount);
  };
  
  const markAsRead = async (id: string) => {
    await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
    setNotifications((prev) =>
      prev.map((n) => (n.id === id ? { ...n, read: true } : n))
    );
    setUnreadCount((prev) => Math.max(0, prev - 1));
  };
  
  const markAllAsRead = async () => {
    await fetch('/api/notifications/read-all', { method: 'POST' });
    setNotifications((prev) => prev.map((n) => ({ ...n, read: true })));
    setUnreadCount(0);
  };
  
  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="relative p-2 hover:bg-gray-100 rounded-full"
        aria-label="é€šçŸ¥"
      >
        <Bell size={24} />
        {unreadCount > 0 && (
          <span className="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
            {unreadCount > 9 ? '9+' : unreadCount}
          </span>
        )}
      </button>
      
      {isOpen && (
        <div className="absolute top-full right-0 mt-2 w-80 bg-white border rounded-lg shadow-lg">
          <div className="flex items-center justify-between p-4 border-b">
            <h3 className="font-bold">é€šçŸ¥</h3>
            {unreadCount > 0 && (
              <button
                onClick={markAllAsRead}
                className="text-sm text-blue-600 hover:underline"
              >
                ã™ã¹ã¦æ—¢èª­
              </button>
            )}
          </div>
          
          <div className="max-h-96 overflow-y-auto">
            {notifications.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“
              </div>
            ) : (
              notifications.map((notification) => (
                <div
                  key={notification.id}
                  className={`p-4 border-b hover:bg-gray-50 cursor-pointer ${
                    !notification.read ? 'bg-blue-50' : ''
                  }`}
                  onClick={() => {
                    markAsRead(notification.id);
                    if (notification.link) {
                      window.location.href = notification.link;
                    }
                  }}
                >
                  <div className="flex items-start gap-2">
                    <div className="flex-1">
                      <h4 className="font-semibold text-sm">
                        {notification.title}
                      </h4>
                      <p className="text-sm text-gray-600">
                        {notification.message}
                      </p>
                      <p className="text-xs text-gray-400 mt-1">
                        {formatRelativeTime(new Date(notification.createdAt))}
                      </p>
                    </div>
                    {!notification.read && (
                      <div className="w-2 h-2 bg-blue-500 rounded-full mt-1" />
                    )}
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}
```

---

## 33.5 ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—

### ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/FileDropzone.tsx
'use client';

import { useState, useCallback } from 'react';
import { Upload } from 'lucide-react';

interface FileDropzoneProps {
  onFilesSelected: (files: File[]) => void;
  accept?: string;
  maxFiles?: number;
  maxSize?: number; // bytes
}

export function FileDropzone({
  onFilesSelected,
  accept = 'image/*',
  maxFiles = 5,
  maxSize = 5 * 1024 * 1024, // 5MB
}: FileDropzoneProps) {
  const [isDragging, setIsDragging] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const validateFiles = (files: File[]): File[] => {
    setError(null);
    
    if (files.length > maxFiles) {
      setError(`æœ€å¤§${maxFiles}ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™`);
      return [];
    }
    
    const validFiles = files.filter((file) => {
      if (file.size > maxSize) {
        setError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯${maxSize / 1024 / 1024}MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
        return false;
      }
      return true;
    });
    
    return validFiles;
  };
  
  const handleDrop = useCallback(
    (e: React.DragEvent) => {
      e.preventDefault();
      setIsDragging(false);
      
      const files = Array.from(e.dataTransfer.files);
      const validFiles = validateFiles(files);
      
      if (validFiles.length > 0) {
        onFilesSelected(validFiles);
      }
    },
    [onFilesSelected, maxFiles, maxSize]
  );
  
  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  }, []);
  
  const handleDragLeave = useCallback(() => {
    setIsDragging(false);
  }, []);
  
  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    const validFiles = validateFiles(files);
    
    if (validFiles.length > 0) {
      onFilesSelected(validFiles);
    }
  };
  
  return (
    <div>
      <div
        onDrop={handleDrop}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        className={`
          border-2 border-dashed rounded-lg p-8 text-center cursor-pointer
          transition-colors
          ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:border-gray-400'}
        `}
      >
        <Upload
          className={`mx-auto mb-4 ${isDragging ? 'text-blue-500' : 'text-gray-400'}`}
          size={48}
        />
        <p className="text-gray-600 mb-2">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        </p>
        <p className="text-sm text-gray-500 mb-4">ã¾ãŸã¯</p>
        <label className="btn btn-secondary cursor-pointer">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          <input
            type="file"
            multiple
            accept={accept}
            onChange={handleFileInput}
            className="hidden"
          />
        </label>
        <p className="text-xs text-gray-500 mt-4">
          æœ€å¤§{maxFiles}ãƒ•ã‚¡ã‚¤ãƒ«ã€å„{maxSize / 1024 / 1024}MBã¾ã§
        </p>
      </div>
      
      {error && (
        <p className="text-red-600 text-sm mt-2">{error}</p>
      )}
    </div>
  );
}

// ä½¿ç”¨ä¾‹
export function ImageUploadForm() {
  const [files, setFiles] = useState<File[]>([]);
  const [previews, setPreviews] = useState<string[]>([]);
  
  const handleFilesSelected = (newFiles: File[]) => {
    setFiles(newFiles);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
    const newPreviews = newFiles.map((file) => URL.createObjectURL(file));
    setPreviews(newPreviews);
  };
  
  return (
    <div>
      <FileDropzone
        onFilesSelected={handleFilesSelected}
        accept="image/*"
        maxFiles={5}
      />
      
      {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      {previews.length > 0 && (
        <div className="mt-4 grid grid-cols-3 gap-4">
          {previews.map((preview, index) => (
            <div key={index} className="relative aspect-square">
              <img
                src={preview}
                alt={`Preview ${index + 1}`}
                className="w-full h-full object-cover rounded-lg"
              />
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

---

## 33.6 ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿

### ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/MarkdownEditor.tsx
'use client';

import { useState } from 'react';
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';

interface MarkdownEditorProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export function MarkdownEditor({
  value,
  onChange,
  placeholder = 'ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§å…¥åŠ›...',
}: MarkdownEditorProps) {
  const [activeTab, setActiveTab] = useState<'write' | 'preview'>('write');
  
  const renderMarkdown = (markdown: string) => {
    const html = marked(markdown);
    return DOMPurify.sanitize(html);
  };
  
  const insertMarkdown = (prefix: string, suffix = '') => {
    const textarea = document.getElementById('markdown-input') as HTMLTextAreaElement;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = value.substring(start, end);
    
    const newValue =
      value.substring(0, start) +
      prefix +
      selectedText +
      suffix +
      value.substring(end);
    
    onChange(newValue);
    
    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
    setTimeout(() => {
      textarea.focus();
      textarea.setSelectionRange(
        start + prefix.length,
        start + prefix.length + selectedText.length
      );
    }, 0);
  };
  
  return (
    <div className="border rounded-lg overflow-hidden">
      {/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
      <div className="flex items-center gap-2 p-2 bg-gray-50 border-b">
        <button
          onClick={() => insertMarkdown('**', '**')}
          className="p-2 hover:bg-gray-200 rounded"
          title="å¤ªå­—"
        >
          <strong>B</strong>
        </button>
        <button
          onClick={() => insertMarkdown('*', '*')}
          className="p-2 hover:bg-gray-200 rounded"
          title="æ–œä½“"
        >
          <em>I</em>
        </button>
        <button
          onClick={() => insertMarkdown('\n## ')}
          className="p-2 hover:bg-gray-200 rounded"
          title="è¦‹å‡ºã—"
        >
          H
        </button>
        <button
          onClick={() => insertMarkdown('[', '](url)')}
          className="p-2 hover:bg-gray-200 rounded"
          title="ãƒªãƒ³ã‚¯"
        >
          ğŸ”—
        </button>
        <button
          onClick={() => insertMarkdown('```\n', '\n```')}
          className="p-2 hover:bg-gray-200 rounded"
          title="ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯"
        >
          {'</>'}
        </button>
        
        <div className="ml-auto flex gap-2">
          <button
            onClick={() => setActiveTab('write')}
            className={`px-3 py-1 rounded ${
              activeTab === 'write' ? 'bg-white' : 'hover:bg-gray-200'
            }`}
          >
            ç·¨é›†
          </button>
          <button
            onClick={() => setActiveTab('preview')}
            className={`px-3 py-1 rounded ${
              activeTab === 'preview' ? 'bg-white' : 'hover:bg-gray-200'
            }`}
          >
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </button>
        </div>
      </div>
      
      {/* ã‚¨ãƒ‡ã‚£ã‚¿ã‚¨ãƒªã‚¢ */}
      <div className="min-h-[300px]">
        {activeTab === 'write' ? (
          <textarea
            id="markdown-input"
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            className="w-full min-h-[300px] p-4 resize-none focus:outline-none"
          />
        ) : (
          <div
            className="prose max-w-none p-4"
            dangerouslySetInnerHTML={{ __html: renderMarkdown(value) }}
          />
        )}
      </div>
    </div>
  );
}
```

---

## 33.7 ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

### CSV/JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

```typescript
// lib/export.ts
export function exportToCSV(data: any[], filename: string) {
  if (data.length === 0) return;
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
  const headers = Object.keys(data[0]);
  const csvHeaders = headers.join(',');
  
  // ãƒ‡ãƒ¼ã‚¿è¡Œ
  const csvRows = data.map((row) =>
    headers.map((header) => {
      const value = row[header];
      // ã‚«ãƒ³ãƒã‚„ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’å«ã‚€å ´åˆã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value;
    }).join(',')
  );
  
  const csv = [csvHeaders, ...csvRows].join('\n');
  
  // BOMä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆExcelå¯¾å¿œï¼‰
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  downloadBlob(blob, filename);
}

export function exportToJSON(data: any[], filename: string) {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  downloadBlob(blob, filename);
}

function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// ä½¿ç”¨ä¾‹
export function ExportButton({ data }: { data: any[] }) {
  return (
    <div className="flex gap-2">
      <button
        onClick={() => exportToCSV(data, 'export.csv')}
        className="btn btn-secondary"
      >
        CSVå‡ºåŠ›
      </button>
      <button
        onClick={() => exportToJSON(data, 'export.json')}
        className="btn btn-secondary"
      >
        JSONå‡ºåŠ›
      </button>
    </div>
  );
}
```

---

## 33.8 å°åˆ·æœ€é©åŒ–

### å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«

```css
/* globals.css ã«è¿½åŠ  */
@media print {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã‚’éè¡¨ç¤º */
  header,
  footer,
  .no-print {
    display: none !important;
  }
  
  /* èƒŒæ™¯è‰²ã‚’å‰Šé™¤ */
  * {
    background: white !important;
    color: black !important;
  }
  
  /* ãƒªãƒ³ã‚¯ã®URLã‚’è¡¨ç¤º */
  a[href]:after {
    content: " (" attr(href) ")";
  }
  
  /* æ”¹ãƒšãƒ¼ã‚¸åˆ¶å¾¡ */
  h1, h2, h3 {
    page-break-after: avoid;
  }
  
  img {
    page-break-inside: avoid;
  }
  
  /* ä½™ç™½èª¿æ•´ */
  @page {
    margin: 2cm;
  }
  
  body {
    font-size: 12pt;
    line-height: 1.5;
  }
}
```

### å°åˆ·ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// components/PrintButton.tsx
'use client';

export function PrintButton() {
  const handlePrint = () => {
    window.print();
  };
  
  return (
    <button
      onClick={handlePrint}
      className="btn btn-secondary no-print"
    >
      å°åˆ·
    </button>
  );
}

// å°åˆ·å°‚ç”¨ãƒ“ãƒ¥ãƒ¼
export function PrintablePostView({ post }: { post: Post }) {
  return (
    <div className="print:p-0">
      <div className="no-print mb-4">
        <PrintButton />
      </div>
      
      <article className="prose max-w-none">
        <h1>{post.title}</h1>
        <p className="text-gray-600">
          ä½œæˆè€…: {post.author.name} | {formatDate(post.createdAt)}
        </p>
        <div dangerouslySetInnerHTML={{ __html: post.content }} />
      </article>
    </div>
  );
}
```

---

## 33.9 PWAï¼ˆProgressive Web Appï¼‰å¯¾å¿œ

### manifest.jsonè¨­å®š

```json
// public/manifest.json
{
  "name": "BOLDè»½éŸ³ ãƒ¡ãƒ³ãƒãƒ¼ã‚µã‚¤ãƒˆ",
  "short_name": "BOLDè»½éŸ³",
  "description": "BOLDè»½éŸ³ã‚µãƒ¼ã‚¯ãƒ«ã®ãƒ¡ãƒ³ãƒãƒ¼å°‚ç”¨ã‚µã‚¤ãƒˆ",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

### Service Worker

```typescript
// public/sw.js
const CACHE_NAME = 'keion-v1';
const urlsToCache = [
  '/',
  '/offline',
  '/styles/main.css',
  '/scripts/main.js',
];

// ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      return cache.addAll(urlsToCache);
    })
  );
});

// ãƒ•ã‚§ãƒƒãƒ
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™
      if (response) {
        return response;
      }
      
      // ãªã‘ã‚Œã°ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—
      return fetch(event.request).then((response) => {
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœ‰åŠ¹ã§ãªã„å ´åˆ
        if (!response || response.status !== 200 || response.type !== 'basic') {
          return response;
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        const responseToCache = response.clone();
        caches.open(CACHE_NAME).then((cache) => {
          cache.put(event.request, responseToCache);
        });
        
        return response;
      });
    }).catch(() => {
      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      return caches.match('/offline');
    })
  );
});

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
```

### PWAç™»éŒ²

```typescript
// app/layout.tsx
export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <head>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#3b82f6" />
        <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
      </head>
      <body>
        {children}
        
        {/* Service Workerç™»éŒ² */}
        <script
          dangerouslySetInnerHTML={{
            __html: `
              if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                  navigator.serviceWorker.register('/sw.js');
                });
              }
            `,
          }}
        />
      </body>
    </html>
  );
}
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‹¡å¼µã™ã‚‹é«˜åº¦ãªæ©Ÿèƒ½ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸï¼š

### ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½
- âœ… **Server-Sent Events**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
- âœ… **WebSocket**: åŒæ–¹å‘é€šä¿¡ï¼ˆåˆ¥é€”å®Ÿè£…ï¼‰

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹
- âœ… **ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿
- âœ… **å…¨æ–‡æ¤œç´¢**: é«˜é€Ÿãªæ¤œç´¢æ©Ÿèƒ½
- âœ… **é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å³æ™‚é€šçŸ¥
- âœ… **ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—**: ç›´æ„Ÿçš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†
- âœ… **ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿**: ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
- âœ… **ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: CSV/JSONå‡ºåŠ›
- âœ… **å°åˆ·æœ€é©åŒ–**: å°åˆ·ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

### PWAå¯¾å¿œ
- âœ… **manifest.json**: ã‚¢ãƒ—ãƒªãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
- âœ… **Service Worker**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- âœ… **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½**: ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ 

### å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ä»®æƒ³åŒ–ã€é…å»¶èª­ã¿è¾¼ã¿
- âœ… **UX**: ã‚¹ãƒ ãƒ¼ã‚ºãªæ“ä½œæ„Ÿ
- âœ… **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: ã™ã¹ã¦ã®æ©Ÿèƒ½ã§è€ƒæ…®
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

æ¬¡ã®ç« ã§ã¯ã€**ä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**ã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

---

[â† å‰ã®ç« ï¼šç¬¬32ç«  ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã¨SEO](32-ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã¨SEO.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬34ç«  ä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° â†’](34-ä¿å®ˆã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°.md)
