# ç¬¬18ç« ï¼šç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã€ãƒãƒ³ã‚ºã‚ªãƒ³ã€‘

> **ã“ã®ç« ã§ã¯ã€æŠ•ç¨¿ã‚„æ´»å‹•å ±å‘Šã§ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å¼·åŒ–ã—ã¾ã™**

## ğŸ› ï¸ **ãƒãƒ³ã‚ºã‚ªãƒ³ä½œæ¥­**

**âš ï¸ é‡è¦**: ã“ã®ç« ã§ã¯å®Ÿéš›ã«æ‰‹ã‚’å‹•ã‹ã—ã¦ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã€Supabaseã‚’ä½¿ã£ãŸç”»åƒç®¡ç†æ©Ÿèƒ½ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ğŸ“š ã“ã®ç« ã§å­¦ã¶ã“ã¨

- âœ… Supabase Storageã®è©³ç´°ãªè¨­å®š
- âœ… è¤‡æ•°ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- âœ… ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
- âœ… ç”»åƒã®æœ€é©åŒ–ï¼ˆnext/imageï¼‰
- âœ… ç”»åƒã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## ğŸ’¡ ã“ã®ç« ã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®å…¨ä½“åƒ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç¾åœ¨ã®çŠ¶æ…‹ã€‘
æŠ•ç¨¿ä½œæˆæ™‚ã«ç”»åƒURLã‚’æ‰‹å…¥åŠ›
   â†“
ã€æ”¹å–„å¾Œã€‘
ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•çš„ã«URLå–å¾—


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŠ•ç¨¿ä½œæˆãƒ•ã‚©ãƒ¼ãƒ                   â”‚
â”‚                                    â”‚
â”‚   [ğŸ“· ç”»åƒã‚’è¿½åŠ ]                  â”‚
â”‚                                    â”‚
â”‚   [ç”»åƒ1ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼] [å‰Šé™¤]         â”‚
â”‚   [ç”»åƒ2ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼] [å‰Šé™¤]         â”‚
â”‚                                    â”‚
â”‚   â†’ æœ€å¤§5æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æµã‚Œã€‘
1ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
2ï¸âƒ£ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚µã‚¤ã‚ºã€å½¢å¼ï¼‰
3ï¸âƒ£ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
4ï¸âƒ£ Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
5ï¸âƒ£ URLã‚’å–å¾—
6ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
```

---

## 18.1 Supabaseã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### Supabase Storageã®æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Supabase Storage ãƒã‚±ãƒƒãƒˆæ§‹æˆ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  avatars/          (Public)          â”‚
â”‚  â”œâ”€ user1-123.jpg                    â”‚
â”‚  â”œâ”€ user2-456.png                    â”‚
â”‚  â””â”€ ...                              â”‚
â”‚                                      â”‚
â”‚  posts/            (Public)          â”‚
â”‚  â”œâ”€ post1-image1.jpg                 â”‚
â”‚  â”œâ”€ post1-image2.jpg                 â”‚
â”‚  â”œâ”€ post2-image1.png                 â”‚
â”‚  â””â”€ ...                              â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 1: Storageãƒã‚±ãƒƒãƒˆã®ä½œæˆ

**1-1.** Supabase Dashboard ã‚’é–‹ã

**1-2.** å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ã€ŒStorageã€ã‚’ã‚¯ãƒªãƒƒã‚¯

**1-3.** ã€ŒCreate bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

**1-4.** æŠ•ç¨¿ç”»åƒç”¨ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ

```
Name: posts
Public bucket: âœ“ æœ‰åŠ¹ï¼ˆèª°ã§ã‚‚é–²è¦§å¯èƒ½ï¼‰
File size limit: 5MB
Allowed MIME types: image/*
```

**1-5.** ã€ŒCreate bucketã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### Step 2: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ã®è¨­å®š

Supabaseã§ã¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã§ãã¾ã™ã€‚

**2-1.** ã€ŒStorageã€â†’ã€ŒPoliciesã€ã‚¿ãƒ–ã‚’é–‹ã

**2-2.** `posts` ãƒã‚±ãƒƒãƒˆç”¨ã®ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 

**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ï¼ˆèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰:**

```sql
-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆNextAuthï¼‰ã¯æŠ•ç¨¿ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
CREATE POLICY "Authenticated users can upload post images"
ON storage.objects FOR INSERT
TO anon, authenticated
WITH CHECK (bucket_id = 'posts');
```

**é‡è¦:** NextAuth.jsã¯`anon`ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ãƒãƒªã‚·ãƒ¼ã«`anon`ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**èª­ã¿å–ã‚Šãƒãƒªã‚·ãƒ¼ï¼ˆå…¨å“¡ï¼‰:**

```sql
-- å…¨å“¡ãŒæŠ•ç¨¿ç”»åƒã‚’é–²è¦§å¯èƒ½
CREATE POLICY "Anyone can view post images"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'posts');
```

**å‰Šé™¤ãƒãƒªã‚·ãƒ¼ï¼ˆèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰:**

```sql
-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚’å‰Šé™¤å¯èƒ½
CREATE POLICY "Users can delete their own post images"
ON storage.objects FOR DELETE
TO anon, authenticated
USING (bucket_id = 'posts' AND auth.uid()::text = owner);
```

**NextAuth.jsã¨Supabase RLSã«ã¤ã„ã¦:**
NextAuth.jsã¯Supabaseã®`anon`ãƒ­ãƒ¼ãƒ«ã§å‹•ä½œã—ã¾ã™ã€‚ãã®ãŸã‚ã€RLSãƒãƒªã‚·ãƒ¼ã§ã¯`TO anon, authenticated`ã¨æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`TO authenticated`ã ã‘ã ã¨NextAuthçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã™ã€‚

### Step 3: ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª

`.env.local` ã«ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

---

## 18.2 ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å®Ÿè£…

### Step 1: Supabaseãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®æ‹¡å¼µ

`src/lib/supabase.ts` ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

```typescript
import { createClient } from '@supabase/supabase-js';

// Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

/**
 * ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 */
export async function uploadAvatar(file: File, userId: string): Promise<string> {
  const fileExt = file.name.split('.').pop();
  const fileName = `${userId}-${Date.now()}.${fileExt}`;
  const filePath = `avatars/${fileName}`;

  const { data, error } = await supabase.storage
    .from('avatars')
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
    });

  if (error) {
    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  const { data: publicUrlData } = supabase.storage
    .from('avatars')
    .getPublicUrl(filePath);

  return publicUrlData.publicUrl;
}

/**
 * æŠ•ç¨¿ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 */
export async function uploadPostImage(file: File, postId: string): Promise<string> {
  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
  if (file.size > 5 * 1024 * 1024) {
    throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
  if (!file.type.startsWith('image/')) {
    throw new Error('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
  const fileExt = file.name.split('.').pop();
  const fileName = `${postId}-${Date.now()}.${fileExt}`;
  const filePath = `posts/${fileName}`;

  // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const { data, error } = await supabase.storage
    .from('posts')
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
    });

  if (error) {
    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw new Error('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  // å…¬é–‹URLã‚’å–å¾—
  const { data: publicUrlData } = supabase.storage
    .from('posts')
    .getPublicUrl(filePath);

  return publicUrlData.publicUrl;
}

/**
 * è¤‡æ•°ã®æŠ•ç¨¿ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 */
export async function uploadPostImages(
  files: File[],
  postId: string
): Promise<string[]> {
  // æœ€å¤§5æšã¾ã§
  if (files.length > 5) {
    throw new Error('ç”»åƒã¯æœ€å¤§5æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™');
  }

  // ä¸¦åˆ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const uploadPromises = files.map((file) => uploadPostImage(file, postId));
  
  try {
    const urls = await Promise.all(uploadPromises);
    return urls;
  } catch (error) {
    console.error('è¤‡æ•°ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  }
}

/**
 * ç”»åƒã‚’å‰Šé™¤
 */
export async function deleteImage(imageUrl: string, bucket: 'avatars' | 'posts'): Promise<void> {
  try {
    // URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡º
    const url = new URL(imageUrl);
    const pathMatch = url.pathname.match(new RegExp(`/storage/v1/object/public/${bucket}/(.+)`));
    
    if (!pathMatch || !pathMatch[1]) {
      console.warn('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ:', imageUrl);
      return;
    }

    const filePath = pathMatch[1];

    // ç”»åƒã‚’å‰Šé™¤
    const { error } = await supabase.storage
      .from(bucket)
      .remove([`${bucket}/${filePath}`]);

    if (error) {
      console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    }
  } catch (error) {
    console.error('å‰Šé™¤å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
}

/**
 * è¤‡æ•°ã®ç”»åƒã‚’å‰Šé™¤
 */
export async function deleteImages(
  imageUrls: string[],
  bucket: 'avatars' | 'posts'
): Promise<void> {
  const deletePromises = imageUrls.map((url) => deleteImage(url, bucket));
  await Promise.all(deletePromises);
}
```

**Supabaseãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒã‚¤ãƒ³ãƒˆ:**

| é–¢æ•° | èª¬æ˜ |
|------|------|
| `uploadAvatar` | ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’1æšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `uploadPostImage` | æŠ•ç¨¿ç”»åƒã‚’1æšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `uploadPostImages` | æŠ•ç¨¿ç”»åƒã‚’è¤‡æ•°æšä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€å¤§5æšï¼‰ |
| `deleteImage` | ç”»åƒã‚’1æšå‰Šé™¤ |
| `deleteImages` | ç”»åƒã‚’è¤‡æ•°æšå‰Šé™¤ |

### Step 2: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

`src/components/ImageUploader.tsx` ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```typescript
'use client';

import { useState, useRef } from 'react';
import Image from 'next/image';
import { Upload, X, Loader2 } from 'lucide-react';

interface ImageUploaderProps {
  images: string[]; // æ—¢å­˜ã®ç”»åƒURL
  onImagesChange: (images: string[]) => void; // ç”»åƒå¤‰æ›´æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  maxImages?: number; // æœ€å¤§ç”»åƒæ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5ï¼‰
}

export function ImageUploader({
  images,
  onImagesChange,
  maxImages = 5,
}: ImageUploaderProps) {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [uploading, setUploading] = useState(false);
  const [previewUrls, setPreviewUrls] = useState<string[]>([]);

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    
    if (files.length === 0) return;

    // æœ€å¤§æšæ•°ãƒã‚§ãƒƒã‚¯
    const totalImages = images.length + previewUrls.length + files.length;
    if (totalImages > maxImages) {
      alert(`ç”»åƒã¯æœ€å¤§${maxImages}æšã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™`);
      return;
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    for (const file of files) {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert(`${file.name}: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„`);
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
      if (!file.type.startsWith('image/')) {
        alert(`${file.name}: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„`);
        return;
      }
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®URLã‚’ä½œæˆ
    const newPreviewUrls = files.map((file) => URL.createObjectURL(file));
    setPreviewUrls([...previewUrls, ...newPreviewUrls]);

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼ˆå®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§è¡Œã†ï¼‰
    // ã“ã“ã§ã¯ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦blobURLã‚’è¿½åŠ 
    onImagesChange([...images, ...newPreviewUrls]);
  };

  // ç”»åƒã‚’å‰Šé™¤
  const handleRemoveImage = (index: number) => {
    const newImages = images.filter((_, i) => i !== index);
    onImagesChange(newImages);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã®å ´åˆã¯ãƒ¡ãƒ¢ãƒªè§£æ”¾
    const imageUrl = images[index];
    if (imageUrl.startsWith('blob:')) {
      URL.revokeObjectURL(imageUrl);
      const newPreviewUrls = previewUrls.filter((url) => url !== imageUrl);
      setPreviewUrls(newPreviewUrls);
    }
  };

  return (
    <div>
      {/* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
      {images.length > 0 && (
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
          {images.map((imageUrl, index) => (
            <div key={index} className="relative group">
              <div className="aspect-video bg-gray-100 rounded-lg overflow-hidden">
                <Image
                  src={imageUrl}
                  alt={`Image ${index + 1}`}
                  width={300}
                  height={200}
                  className="w-full h-full object-cover"
                />
              </div>

              {/* å‰Šé™¤ãƒœã‚¿ãƒ³ */}
              <button
                type="button"
                onClick={() => handleRemoveImage(index)}
                className="absolute top-2 right-2 p-1.5 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                title="å‰Šé™¤"
              >
                <X size={16} />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */}
      {images.length < maxImages && (
        <div>
          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            multiple
            onChange={handleFileSelect}
            className="hidden"
          />
          
          <button
            type="button"
            onClick={() => fileInputRef.current?.click()}
            disabled={uploading}
            className="w-full px-4 py-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors flex flex-col items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {uploading ? (
              <>
                <Loader2 className="animate-spin text-blue-600" size={32} />
                <span className="text-blue-600 font-medium">
                  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...
                </span>
              </>
            ) : (
              <>
                <Upload className="text-gray-400" size={32} />
                <span className="text-gray-600 font-medium">
                  ç”»åƒã‚’é¸æŠï¼ˆæœ€å¤§{maxImages}æšï¼‰
                </span>
                <span className="text-sm text-gray-500">
                  JPG, PNG, GIFï¼ˆå„5MBä»¥ä¸‹ï¼‰
                </span>
              </>
            )}
          </button>
        </div>
      )}
    </div>
  );
}
```

### Step 3: PostFormã«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’çµ±åˆ

`src/components/PostForm.tsx` ã‚’æ›´æ–°ã—ã¦ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ã€‚

**æ—¢å­˜ã®PostFormã«ä»¥ä¸‹ã®å¤‰æ›´ã‚’åŠ ãˆã¦ãã ã•ã„ï¼š**

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Plus, X } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { ImageUploader } from '@/components/ImageUploader';
import { uploadPostImages } from '@/lib/supabase';

interface PostFormProps {
  post?: {
    id: string;
    title: string;
    content: string;
    youtubeUrls: string[];
    imageUrls: string[];
  };
}

export function PostForm({ post }: PostFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
  const [title, setTitle] = useState(post?.title || '');
  const [content, setContent] = useState(post?.content || '');
  const [youtubeUrls, setYoutubeUrls] = useState<string[]>(
    post?.youtubeUrls || ['']
  );
  const [imageUrls, setImageUrls] = useState<string[]>(post?.imageUrls || []);

  // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ï¼‰
  const [imageFiles, setImageFiles] = useState<File[]>([]);

  // YouTube URLã‚’è¿½åŠ 
  const addYoutubeUrl = () => {
    setYoutubeUrls([...youtubeUrls, '']);
  };

  // YouTube URLã‚’å‰Šé™¤
  const removeYoutubeUrl = (index: number) => {
    setYoutubeUrls(youtubeUrls.filter((_, i) => i !== index));
  };

  // YouTube URLã‚’æ›´æ–°
  const updateYoutubeUrl = (index: number, value: string) => {
    const newUrls = [...youtubeUrls];
    newUrls[index] = value;
    setYoutubeUrls(newUrls);
  };

  // ç”»åƒå¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleImagesChange = (urls: string[]) => {
    setImageUrls(urls);

    // æ–°ã—ã„blobURLã‹ã‚‰å®Ÿéš›ã®Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŠ½å‡º
    // ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ImageUploaderã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å—ã‘å–ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
    // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€blobURLã‚’ãã®ã¾ã¾ä¿æŒ
  };

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!title.trim()) {
        setError('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        setLoading(false);
        return;
      }

      if (!content.trim()) {
        setError('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        setLoading(false);
        return;
      }

      // YouTube URLã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆç©ºã§ãªã„ã‚‚ã®ã ã‘ï¼‰
      const validYoutubeUrls = youtubeUrls.filter((url) => url.trim());

      // ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ–°è¦ä½œæˆã®å ´åˆï¼‰
      let finalImageUrls = imageUrls;
      
      if (!post && imageFiles.length > 0) {
        // ä»®ã®postIdã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã«ã¯APIå´ã§ç”Ÿæˆã•ã‚ŒãŸIDã‚’ä½¿ç”¨ï¼‰
        const tempPostId = `temp-${Date.now()}`;
        finalImageUrls = await uploadPostImages(imageFiles, tempPostId);
      }

      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      const url = post ? `/api/posts/${post.id}` : '/api/posts';
      const method = post ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title.trim(),
          content: content.trim(),
          youtubeUrls: validYoutubeUrls,
          imageUrls: finalImageUrls,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        setError(data.error || 'æŠ•ç¨¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
        return;
      }

      // æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      router.push(`/posts/${data.post.id}`);
      router.refresh();
    } catch (err) {
      setError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow p-6">
      {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
          {error}
        </div>
      )}

      {/* ã‚¿ã‚¤ãƒˆãƒ« */}
      <div className="mb-6">
        <label
          htmlFor="title"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          ã‚¿ã‚¤ãƒˆãƒ« <span className="text-red-500">*</span>
        </label>
        <input
          id="title"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="ä¾‹: å®šæœŸãƒ©ã‚¤ãƒ–å¤§æˆåŠŸï¼"
          required
        />
      </div>

      {/* å†…å®¹ */}
      <div className="mb-6">
        <label
          htmlFor="content"
          className="block text-sm font-medium text-gray-700 mb-2"
        >
          å†…å®¹ <span className="text-red-500">*</span>
        </label>
        <textarea
          id="content"
          value={content}
          onChange={(e) => setContent(e.target.value)}
          rows={8}
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="æ´»å‹•å†…å®¹ã‚’è©³ã—ãè¨˜å…¥ã—ã¦ãã ã•ã„..."
          required
        />
      </div>

      {/* YouTube URL */}
      <div className="mb-6">
        <div className="flex items-center justify-between mb-2">
          <label className="block text-sm font-medium text-gray-700">
            YouTubeå‹•ç”»
          </label>
          <button
            type="button"
            onClick={addYoutubeUrl}
            className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
          >
            <Plus size={16} />
            å‹•ç”»ã‚’è¿½åŠ 
          </button>
        </div>

        <div className="space-y-2">
          {youtubeUrls.map((url, index) => (
            <div key={index} className="flex gap-2">
              <input
                type="url"
                value={url}
                onChange={(e) => updateYoutubeUrl(index, e.target.value)}
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="https://www.youtube.com/watch?v=..."
              />
              {youtubeUrls.length > 1 && (
                <button
                  type="button"
                  onClick={() => removeYoutubeUrl(index)}
                  className="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                >
                  <X size={20} />
                </button>
              )}
            </div>
          ))}
        </div>
      </div>

      {/* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
      <div className="mb-6">
        <label className="block text-sm font-medium text-gray-700 mb-2">
          ç”»åƒï¼ˆæœ€å¤§5æšï¼‰
        </label>
        <ImageUploader
          images={imageUrls}
          onImagesChange={handleImagesChange}
          maxImages={5}
        />
      </div>

      {/* ãƒœã‚¿ãƒ³ */}
      <div className="flex gap-4">
        <Button
          type="submit"
          variant="primary"
          loading={loading}
          className="flex-1"
        >
          {post ? 'æ›´æ–°' : 'æŠ•ç¨¿'}
        </Button>
        
        <Button
          type="button"
          variant="outline"
          onClick={() => router.back()}
          disabled={loading}
        >
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </Button>
      </div>
    </form>
  );
}
```

### Step 4: å‹•ä½œç¢ºèª

**4-1.** æŠ•ç¨¿ä½œæˆãƒšãƒ¼ã‚¸ã‚’é–‹ã

**4-2.** ã€Œç”»åƒã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ

**4-3.** ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

**4-4.** æŠ•ç¨¿ã‚’ä½œæˆ

â†’ âœ… ç”»åƒãŒSupabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€æŠ•ç¨¿ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼

---

## 18.3 ç”»åƒã®æœ€é©åŒ–

### next/imageã®æ´»ç”¨

Next.jsã®`next/image`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€è‡ªå‹•çš„ã«ç”»åƒã‚’æœ€é©åŒ–ã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     next/imageã®æœ€é©åŒ–æ©Ÿèƒ½                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ è‡ªå‹•çš„ã«WebPã«å¤‰æ›                         â”‚
â”‚ âœ“ ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒã®ç”Ÿæˆ                     â”‚
â”‚ âœ“ é…å»¶èª­ã¿è¾¼ã¿ï¼ˆlazy loadingï¼‰              â”‚
â”‚ âœ“ ã¼ã‹ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼                     â”‚
â”‚ âœ“ ç”»åƒã‚µã‚¤ã‚ºã®æœ€é©åŒ–                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 1: next.config.jsã®è¨­å®š

`next.config.js` ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
      {
        protocol: 'https',
        hostname: 'lh3.googleusercontent.com',
        port: '',
        pathname: '/**',
      },
    ],
  },
};

export default nextConfig;
```

### Step 2: ç”»åƒè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æœ€é©åŒ–

æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã®ç”»åƒè¡¨ç¤ºã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚

`src/app/posts/[id]/page.tsx` ã®ç”»åƒè¡¨ç¤ºéƒ¨åˆ†ã‚’æ›´æ–°ï¼š

```typescript
{/* ç”»åƒã‚°ãƒªãƒƒãƒ‰ */}
{post.imageUrls && post.imageUrls.length > 0 && (
  <div className="mb-6">
    <div
      className={`
        grid gap-4
        ${post.imageUrls.length === 1 ? 'grid-cols-1' : ''}
        ${post.imageUrls.length === 2 ? 'grid-cols-2' : ''}
        ${post.imageUrls.length >= 3 ? 'grid-cols-2 md:grid-cols-3' : ''}
      `}
    >
      {post.imageUrls.map((imageUrl, index) => (
        <div
          key={index}
          className="relative aspect-video bg-gray-100 rounded-lg overflow-hidden"
        >
          <Image
            src={imageUrl}
            alt={`${post.title} - Image ${index + 1}`}
            fill
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
            className="object-cover"
            priority={index === 0} // æœ€åˆã®ç”»åƒã¯å„ªå…ˆèª­ã¿è¾¼ã¿
          />
        </div>
      ))}
    </div>
  </div>
)}
```

**æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ:**

| è¨­å®š | èª¬æ˜ |
|------|------|
| `fill` | è¦ªè¦ç´ ã„ã£ã±ã„ã«ç”»åƒã‚’è¡¨ç¤º |
| `sizes` | ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªç”»åƒã‚µã‚¤ã‚ºã‚’æŒ‡å®š |
| `priority` | æœ€åˆã®ç”»åƒã¯å„ªå…ˆèª­ã¿è¾¼ã¿ï¼ˆLCPæ”¹å–„ï¼‰ |
| `object-cover` | ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰å…¨ä½“ã‚’è¡¨ç¤º |

### Step 3: ã¼ã‹ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®è¿½åŠ 

ç”»åƒèª­ã¿è¾¼ã¿ä¸­ã®ã¼ã‹ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ ã§ãã¾ã™ï¼š

```typescript
<Image
  src={imageUrl}
  alt={`${post.title} - Image ${index + 1}`}
  fill
  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
  className="object-cover"
  priority={index === 0}
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAIAAoDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwA7gAAA/9k="
/>
```

---

## 18.4 ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

Chapter 18ã®å†…å®¹ã‚’ç†è§£ã§ããŸã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

### Supabaseã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- [ ] Storageãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã§ãã‚‹
- [ ] ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã§ãã‚‹
- [ ] ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã‚‹

### ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

- [ ] Supabaseãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å®Ÿè£…ã§ãã‚‹
- [ ] ImageUploaderã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å®Ÿè£…ã§ãã‚‹
- [ ] è¤‡æ•°ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒã§ãã‚‹
- [ ] ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãŒã§ãã‚‹
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã§ãã‚‹

### ç”»åƒã®æœ€é©åŒ–

- [ ] next/imageã‚’ä½¿ã£ã¦ç”»åƒã‚’æœ€é©åŒ–ã§ãã‚‹
- [ ] next.config.jsã§remotePatternsã‚’è¨­å®šã§ãã‚‹
- [ ] sizesãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒã‚’è¨­å®šã§ãã‚‹
- [ ] priorityã§å„ªå…ˆèª­ã¿è¾¼ã¿ã‚’è¨­å®šã§ãã‚‹
- [ ] ã¼ã‹ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ ã§ãã‚‹

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### Supabase Storage
- âœ… Storageãƒã‚±ãƒƒãƒˆã®ä½œæˆ
- âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ã®è¨­å®š
- âœ… ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- âœ… å…¬é–‹URLã®å–å¾—

#### ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
- âœ… è¤‡æ•°ç”»åƒã®ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- âœ… ç”»åƒã®å‰Šé™¤

#### ç”»åƒã®æœ€é©åŒ–
- âœ… next/imageã®æ´»ç”¨
- âœ… è‡ªå‹•çš„ãªWebPå¤‰æ›
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒ
- âœ… é…å»¶èª­ã¿è¾¼ã¿
- âœ… ã¼ã‹ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼

### ğŸ’¡ é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

#### Supabase Storageã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```typescript
const { data, error } = await supabase.storage
  .from('posts')
  .upload(filePath, file, {
    cacheControl: '3600',
    upsert: false,
  });

const { data: publicUrlData } = supabase.storage
  .from('posts')
  .getPublicUrl(filePath);
```

#### next/imageã®æœ€é©åŒ–è¨­å®š

```typescript
<Image
  src={imageUrl}
  alt="Image"
  fill
  sizes="(max-width: 768px) 100vw, 50vw"
  className="object-cover"
  priority={isFirst}
/>
```

### ğŸš€ æ¬¡ã®ç« ã¸ã®æº–å‚™

æ¬¡ã®ç« ï¼ˆChapter 19: UI/UXã®å‘ä¸Šï¼‰ã§ã¯ã€ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š

1. **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹**
   - loading.tsxã®æ´»ç”¨
   - ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - error.tsxã®æ´»ç”¨
   - ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºUI

3. **æ¥½è¦³çš„UI**
   - ã„ã„ã­æ©Ÿèƒ½
   - æŠ•ç¥¨æ©Ÿèƒ½

4. **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³**
   - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
   - ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ

**æº–å‚™ã™ã‚‹ã“ã¨:**
- âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- âœ… next/imageãŒæ­£ã—ãç”»åƒã‚’æœ€é©åŒ–ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

[â† å‰ã®ç« ï¼šç¬¬17ç«  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«](17-ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬19ç«  UI/UXã®å‘ä¸Š â†’](19-UIãƒ»UXã®å‘ä¸Š.md)
