# 第25章：トラブルシューティング

> **この章では、開発中によく遭遇するエラーと対処法を学びます**

## 📚 この章で学ぶこと

- ✅ よくあるエラーの原因と対処法
- ✅ 効果的なデバッグ方法
- ✅ パフォーマンス問題の診断と解決
- ✅ ツールを使った問題の特定

## 💡 トラブルシューティングの心構え

```
┌──────────────────────────────────────────────────┐
│     エラーに遭遇したら                            │
└──────────────────────────────────────────────────┘

【ステップ1】パニックにならない
   ├─ エラーは誰にでも起こる
   └─ 落ち着いてエラーメッセージを読む

【ステップ2】エラーメッセージを読む
   ├─ どこでエラーが起きたか
   ├─ どんなエラーか
   └─ ファイル名と行番号を確認

【ステップ3】原因を特定する
   ├─ 最近何を変更したか
   ├─ エラーの直前に何をしたか
   └─ エラーメッセージをググる

【ステップ4】解決策を試す
   ├─ 一つずつ試す
   ├─ 効果がなければ元に戻す
   └─ 解決したら、なぜ解決したか理解する


┌────────────────────────────────────┐
│  デバッグの基本原則                 │
├────────────────────────────────────┤
│                                    │
│  1. 問題を再現できるようにする      │
│                                    │
│  2. 変更は一度に1つだけ            │
│                                    │
│  3. 仮説を立ててテストする          │
│                                    │
│  4. ログを活用する                  │
│                                    │
│  5. バイナリサーチ                  │
│     （半分ずつコメントアウト）       │
│                                    │
└────────────────────────────────────┘
```

---

## 25.1 よくあるエラーと対処法

### ビルドエラー

#### エラー1: Module not found

```bash
Error: Module not found: Can't resolve '@/components/Header'
```

**原因:**
- ファイルが存在しない
- パスが間違っている
- 大文字小文字が違う

**解決方法:**

```bash
# 1. ファイルが存在するか確認
ls src/components/Header.tsx

# 2. パスが正しいか確認
# ✅ 正: @/components/Header
# ❌ 誤: @/component/Header（sがない）
# ❌ 誤: @/components/header（小文字）

# 3. tsconfig.jsonのパス設定を確認
cat tsconfig.json
```

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"]  // ← これが正しく設定されているか
    }
  }
}
```

#### エラー2: Type error

```bash
Type 'string | undefined' is not assignable to type 'string'.
```

**原因:**
- 変数が `undefined` の可能性がある
- TypeScriptの型チェックに引っかかった

**解決方法:**

```typescript
// ❌ エラーが出るコード
const user = await prisma.user.findUnique({
  where: { id: userId },
});
const name: string = user.name; // user が null の可能性がある

// ✅ 解決方法1: オプショナルチェイニング
const name: string = user?.name || 'ゲスト';

// ✅ 解決方法2: null チェック
if (!user) {
  throw new Error('ユーザーが見つかりません');
}
const name: string = user.name; // ここでは user は確実に存在

// ✅ 解決方法3: Non-null assertion (! を使う)
const name: string = user!.name; // user が必ず存在すると断言
```

#### エラー3: Prisma Client not found

```bash
Error: @prisma/client did not initialize yet.
```

**原因:**
- Prisma Clientが生成されていない
- スキーマを変更した後に再生成していない

**解決方法:**

```bash
# Prisma Clientを生成
npx prisma generate

# データベースも更新する場合
npx prisma db push

# 開発サーバーを再起動
npm run dev
```

### ランタイムエラー

#### エラー4: Hydration error

```bash
Error: Hydration failed because the initial UI does not match what was rendered on the server.
```

**原因:**
- サーバーとクライアントで異なるHTMLが生成された
- `localStorage` をサーバー側で使用した
- `Date.now()` や `Math.random()` を直接レンダリングに使用

**解決方法:**

```typescript
// ❌ エラーが出るコード
export default function MyComponent() {
  return <div>{Date.now()}</div>;
  // サーバーとクライアントで異なる値になる
}

// ✅ 解決方法: useEffect で初期化
'use client';

import { useState, useEffect } from 'react';

export default function MyComponent() {
  const [currentTime, setCurrentTime] = useState<number | null>(null);

  useEffect(() => {
    setCurrentTime(Date.now()); // クライアント側でのみ実行
  }, []);

  if (currentTime === null) {
    return <div>読み込み中...</div>;
  }

  return <div>{currentTime}</div>;
}
```

**パターン2: localStorageの使用**

```typescript
// ❌ エラーが出るコード
const savedData = localStorage.getItem('data');
// サーバー側では localStorage は存在しない

// ✅ 解決方法
'use client';

import { useState, useEffect } from 'react';

export default function MyComponent() {
  const [savedData, setSavedData] = useState<string | null>(null);

  useEffect(() => {
    // クライアント側でのみ実行
    setSavedData(localStorage.getItem('data'));
  }, []);

  return <div>{savedData}</div>;
}
```

#### エラー5: fetch failed

```bash
TypeError: fetch failed
cause: Error: connect ECONNREFUSED 127.0.0.1:3000
```

**原因:**
- APIサーバーが起動していない
- ポート番号が間違っている
- ネットワーク接続エラー

**解決方法:**

```bash
# 1. 開発サーバーが起動しているか確認
ps aux | grep "next dev"

# 2. ポートが使用されているか確認
lsof -i :3000

# 3. 開発サーバーを再起動
npm run dev

# 4. fetch のURLを確認
# 相対パスを使う（✅ 推奨）
fetch('/api/posts')

# 絶対パスは避ける（❌ ポート変更時に問題）
fetch('http://localhost:3000/api/posts')
```

### データベースエラー

#### エラー6: Unique constraint failed

```bash
Error: Unique constraint failed on the fields: (`email`)
```

**原因:**
- ユニーク制約がついているフィールドに重複した値を挿入しようとした

**解決方法:**

```typescript
// ❌ エラーが出るコード
const user = await prisma.user.create({
  data: {
    email: 'user@example.com', // すでに存在するメール
    name: 'User',
  },
});

// ✅ 解決方法1: 存在チェック
const existingUser = await prisma.user.findUnique({
  where: { email: 'user@example.com' },
});

if (existingUser) {
  throw new Error('このメールアドレスは既に使用されています');
}

const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'User',
  },
});

// ✅ 解決方法2: upsert（更新または作成）
const user = await prisma.user.upsert({
  where: { email: 'user@example.com' },
  update: { name: 'Updated Name' }, // 存在すれば更新
  create: { email: 'user@example.com', name: 'User' }, // なければ作成
});
```

#### エラー7: Foreign key constraint failed

```bash
Error: Foreign key constraint failed on the field: `authorId`
```

**原因:**
- 存在しないユーザーIDを指定した
- 関連するレコードが削除された

**解決方法:**

```typescript
// ❌ エラーが出るコード
const post = await prisma.post.create({
  data: {
    title: 'タイトル',
    content: '内容',
    authorId: 'nonexistent-user-id', // 存在しないユーザー
  },
});

// ✅ 解決方法: ユーザーが存在するか確認
const user = await prisma.user.findUnique({
  where: { id: userId },
});

if (!user) {
  throw new Error('ユーザーが見つかりません');
}

const post = await prisma.post.create({
  data: {
    title: 'タイトル',
    content: '内容',
    authorId: user.id, // 確実に存在するユーザーID
  },
});
```

### 認証エラー

#### エラー8: CSRF token mismatch

```bash
Error: CSRF token mismatch
```

**原因:**
- CSRFトークンが一致しない
- クッキーが送信されていない

**解決方法:**

```typescript
// 環境変数を確認
// .env.local
AUTH_TRUST_HOST=true  // ← これが必要

// ブラウザでクッキーを確認
// 開発者ツール → Application → Cookies

// クッキーをクリア
document.cookie.split(";").forEach((c) => {
  document.cookie = c
    .replace(/^ +/, "")
    .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
});

// ログインし直す
```

#### エラー9: Unauthorized (401)

```bash
Error: 401 Unauthorized
```

**原因:**
- ログインしていない
- セッションが期限切れ
- トークンが無効

**解決方法:**

```typescript
// API Routeで適切なエラーメッセージを返す
export async function POST(request: NextRequest) {
  const session = await auth();

  if (!session?.user) {
    return NextResponse.json(
      {
        error: '認証が必要です',
        code: 'UNAUTHORIZED',
        message: 'ログインしてください',
      },
      { status: 401 }
    );
  }

  // 以降の処理...
}

// クライアント側でエラーハンドリング
try {
  const response = await fetch('/api/posts', {
    method: 'POST',
    body: JSON.stringify(data),
  });

  if (response.status === 401) {
    // ログインページにリダイレクト
    router.push('/login');
    return;
  }

  // 正常処理...
} catch (error) {
  console.error('エラー:', error);
}
```

---

## 25.2 デバッグ方法

### console.log の活用

**基本的な使い方:**

```typescript
// 変数の値を確認
console.log('userId:', userId);

// オブジェクトの確認
console.log('user:', user);

// 複数の値を確認
console.log('userId:', userId, 'user:', user);

// わかりやすいラベル
console.log('=== ユーザー情報 ===');
console.log('ID:', user.id);
console.log('名前:', user.name);
console.log('メール:', user.email);
```

**console の便利なメソッド:**

```typescript
// テーブル形式で表示
console.table([
  { name: 'Alice', age: 25 },
  { name: 'Bob', age: 30 },
]);

// 警告
console.warn('この機能は非推奨です');

// エラー
console.error('エラーが発生しました');

// グループ化
console.group('ユーザー情報');
console.log('ID:', user.id);
console.log('名前:', user.name);
console.groupEnd();

// 時間計測
console.time('データ取得');
await prisma.post.findMany();
console.timeEnd('データ取得');
// 出力: データ取得: 123.456ms
```

### VSCodeデバッガの使用

**デバッグ設定:**

`.vscode/launch.json` を作成：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug server-side",
      "type": "node-terminal",
      "request": "launch",
      "command": "npm run dev"
    },
    {
      "name": "Next.js: debug client-side",
      "type": "chrome",
      "request": "launch",
      "url": "http://localhost:3000"
    }
  ]
}
```

**ブレークポイントの設定:**

```typescript
export async function GET() {
  const posts = await prisma.post.findMany(); // ← ここにブレークポイント
  
  return NextResponse.json(posts);
}
```

**使い方:**

```
1. VSCodeの左側の行番号をクリック
   → 赤い丸（ブレークポイント）が表示される

2. F5 キーを押してデバッグ開始

3. ブレークポイントで処理が停止
   → 変数の値を確認できる

4. F10: 次の行へ（ステップオーバー）
   F11: 関数の中に入る（ステップイン）
   F5: 次のブレークポイントまで実行
```

### Prisma Studio の活用

**Prisma Studio でデータベースを確認:**

```bash
npx prisma studio
```

→ ブラウザで http://localhost:5555 が開く

```
┌──────────────────────────────────────┐
│   Prisma Studio                      │
├──────────────────────────────────────┤
│                                      │
│  📊 テーブル一覧                     │
│  ├─ User (25件)                     │
│  ├─ Post (42件)                     │
│  ├─ Event (8件)                     │
│  └─ Comment (103件)                 │
│                                      │
│  【できること】                      │
│  ✅ データの閲覧                     │
│  ✅ データの編集                     │
│  ✅ データの追加                     │
│  ✅ データの削除                     │
│  ✅ リレーションの確認               │
│                                      │
└──────────────────────────────────────┘
```

**デバッグでの活用例:**

```
問題: 投稿が表示されない

1. Prisma Studio でPostテーブルを確認
   → データは存在する？

2. Userテーブルを確認
   → authorId が正しいユーザーを指している？

3. リレーションを確認
   → author が正しく関連付けられている？
```

### ネットワークタブの活用

**ブラウザの開発者ツール → Networkタブ:**

```
┌──────────────────────────────────────┐
│   Network タブ                       │
├──────────────────────────────────────┤
│                                      │
│  Name            Status    Type      │
│  ────────────────────────────────────│
│  posts           200       xhr       │
│  users           200       xhr       │
│  events          404       xhr ❌    │
│  avatar.jpg      200       img       │
│                                      │
│  【確認項目】                        │
│  ✅ リクエストが送信されているか      │
│  ✅ ステータスコード（200, 404等）    │
│  ✅ レスポンスの内容                 │
│  ✅ リクエストヘッダー               │
│  ✅ レスポンスヘッダー               │
│  ✅ タイミング（どれくらい遅いか）    │
│                                      │
└──────────────────────────────────────┘
```

**デバッグ例:**

```typescript
// 1. Networkタブを開く
// 2. 以下のコードを実行
const response = await fetch('/api/posts');
console.log('Status:', response.status);
console.log('Headers:', response.headers);
const data = await response.json();
console.log('Data:', data);

// 3. Networkタブで確認
// - ステータスコードが 200 OK か？
// - レスポンスボディに期待したデータがあるか？
// - エラーメッセージはないか？
```

---

## 25.3 パフォーマンス問題

### 遅い読み込みの診断

**問題: ページの読み込みが遅い**

**診断方法:**

```bash
# 1. Lighthouseで測定
# ブラウザの開発者ツール → Lighthouse
# → Generate report

# 2. Networkタブで遅いリクエストを特定
# → Size（サイズ）と Time（時間）を確認

# 3. Performanceタブでプロファイリング
# → 録画ボタンを押してページを操作
# → 停止してフレームごとの処理時間を確認
```

**よくある原因と対策:**

```typescript
// 原因1: 画像が最適化されていない
// ❌ 問題のあるコード
<img src="/large-image.jpg" />  // 5MB の画像

// ✅ 解決方法
import Image from 'next/image';
<Image src="/large-image.jpg" width={800} height={600} />

// 原因2: 大量のデータを一度に取得
// ❌ 問題のあるコード
const posts = await prisma.post.findMany(); // 10,000件取得

// ✅ 解決方法: ページネーション
const posts = await prisma.post.findMany({
  take: 20,  // 20件だけ取得
  skip: page * 20,  // オフセット
});

// 原因3: N+1クエリ問題
// ❌ 問題のあるコード
const posts = await prisma.post.findMany();
for (const post of posts) {
  const author = await prisma.user.findUnique({
    where: { id: post.authorId },
  }); // 投稿ごとにクエリが発行される（遅い）
}

// ✅ 解決方法: include で一度に取得
const posts = await prisma.post.findMany({
  include: {
    author: true,  // 1回のクエリで取得
  },
});
```

### メモリリークの検出

**問題: メモリ使用量が増え続ける**

**診断方法:**

```bash
# Chrome DevTools → Memory タブ
# → Heap snapshot を撮る
# → 操作後にもう一度撮る
# → 比較して増えているオブジェクトを確認
```

**よくある原因:**

```typescript
// 原因1: イベントリスナーの削除忘れ
// ❌ 問題のあるコード
useEffect(() => {
  window.addEventListener('scroll', handleScroll);
  // クリーンアップ関数がない
}, []);

// ✅ 解決方法
useEffect(() => {
  window.addEventListener('scroll', handleScroll);
  
  return () => {
    window.removeEventListener('scroll', handleScroll); // 削除
  };
}, []);

// 原因2: setInterval の停止忘れ
// ❌ 問題のあるコード
useEffect(() => {
  setInterval(() => {
    console.log('tick');
  }, 1000);
}, []);

// ✅ 解決方法
useEffect(() => {
  const timerId = setInterval(() => {
    console.log('tick');
  }, 1000);
  
  return () => {
    clearInterval(timerId); // 停止
  };
}, []);

// 原因3: 不要なデータの保持
// ❌ 問題のあるコード
const [allData, setAllData] = useState<Post[]>([]);

useEffect(() => {
  // 10,000件のデータを保持し続ける
  fetch('/api/posts?limit=10000')
    .then(res => res.json())
    .then(setAllData);
}, []);

// ✅ 解決方法: 必要な分だけ取得
const [visibleData, setVisibleData] = useState<Post[]>([]);

useEffect(() => {
  // 必要な20件だけ取得
  fetch('/api/posts?limit=20')
    .then(res => res.json())
    .then(setVisibleData);
}, []);
```

### 無限ループの検出

**問題: ページがフリーズする**

**よくある原因:**

```typescript
// 原因1: useEffect の依存配列ミス
// ❌ 無限ループが発生
useEffect(() => {
  const newData = { ...data };
  setData(newData);
}, [data]); // data が変わると再実行 → 無限ループ

// ✅ 解決方法: 依存配列を正しく設定
useEffect(() => {
  // 初回のみ実行
  fetchData().then(setData);
}, []); // 空配列

// 原因2: 無限再帰
// ❌ 無限再帰が発生
function calculateTotal(items: number[]): number {
  if (items.length === 0) {
    return 0;
  }
  return items[0] + calculateTotal(items); // 終了条件に到達しない
}

// ✅ 解決方法: 正しい再帰
function calculateTotal(items: number[]): number {
  if (items.length === 0) {
    return 0;
  }
  return items[0] + calculateTotal(items.slice(1)); // slice(1) で要素を減らす
}
```

---

## 25.4 確認チェックリスト

Chapter 25の内容を理解できたか確認しましょう。

### エラー対処

- [ ] エラーメッセージを読んで原因を特定できる
- [ ] Module not found エラーに対処できる
- [ ] Type error に対処できる
- [ ] Hydration error に対処できる
- [ ] データベースエラーに対処できる

### デバッグ方法

- [ ] console.log を効果的に使える
- [ ] VSCodeデバッガを使える
- [ ] Prisma Studio でデータを確認できる
- [ ] Networkタブでリクエストを確認できる

### パフォーマンス

- [ ] Lighthouseでパフォーマンスを測定できる
- [ ] 遅い読み込みの原因を特定できる
- [ ] N+1クエリ問題を理解している
- [ ] メモリリークの原因を理解している

---

## まとめ

この章では、開発中によく遭遇する問題と対処法を学びました。

### 🎓 この章で学んだこと

#### よくあるエラー
- ✅ ビルドエラー（Module not found, Type error）
- ✅ ランタイムエラー（Hydration error, fetch failed）
- ✅ データベースエラー（Unique constraint, Foreign key）
- ✅ 認証エラー（CSRF, Unauthorized）

#### デバッグ方法
- ✅ console.log の活用
- ✅ VSCodeデバッガの使用
- ✅ Prisma Studio によるデータ確認
- ✅ Networkタブによるリクエスト確認

#### パフォーマンス問題
- ✅ 遅い読み込みの診断
- ✅ メモリリークの検出
- ✅ 無限ループの回避

### 💡 重要なポイント

#### エラー対処の基本

```
1. パニックにならない
2. エラーメッセージを読む
3. 原因を特定する
4. 一つずつ試す
5. 解決したら理解する
```

#### デバッグのコツ

```typescript
// 1. 問題を再現可能にする
// 2. console.log で状態を確認
console.log('Before:', data);
doSomething();
console.log('After:', data);

// 3. バイナリサーチ
// コードを半分ずつコメントアウトして
// どこで問題が起きているか特定

// 4. ドキュメントを読む
// エラーメッセージをGoogleで検索
```

### 🚀 次のステップ

これで「応用編」が完了しました！次は「コード詳細解説編」に進みます：

- **Chapter 26-28**: API Routes、ページコンポーネント、ライブラリの詳細解説

実装したコードを深く理解して、より良いコードを書けるようになりましょう！

---

[← 前の章：第24章 機能の追加とカスタマイズ](24-機能の追加とカスタマイズ.md) | [目次に戻る](00-目次.md) | [次の章へ：第26章 API Routesの詳細解説 →](26-API-Routesの詳細解説.md)
