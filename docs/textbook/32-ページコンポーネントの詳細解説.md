# ç¬¬27ç« ï¼šãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°è§£èª¬

> **ã“ã®ç« ã§ã¯ã€å®Ÿè£…ã—ãŸãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’è©³ç´°ã«è§£èª¬ã—ã¾ã™**

## ğŸ“š ã“ã®ç« ã®ç›®çš„

ã“ã®ç« ã¯**ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹**ã¨ã—ã¦ã€å„ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä»•çµ„ã¿ã‚’æ·±ãç†è§£ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

- âœ… Client Componentã¨Server Componentã®ä½¿ã„åˆ†ã‘
- âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…
- âœ… Next.jsã®App Routerãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… React Hooksã®æ´»ç”¨

## ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åŸºæœ¬æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Next.js App Router ã®ãƒšãƒ¼ã‚¸æ§‹æˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

src/app/
â”œâ”€ page.tsx                # / (ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸)
â”œâ”€ posts/
â”‚  â”œâ”€ page.tsx             # /posts
â”‚  â”œâ”€ [id]/
â”‚  â”‚  â”œâ”€ page.tsx          # /posts/:id
â”‚  â”‚  â””â”€ edit/
â”‚  â”‚     â””â”€ page.tsx       # /posts/:id/edit
â”‚  â””â”€ new/
â”‚     â””â”€ page.tsx          # /posts/new
â”œâ”€ events/
â”‚  â”œâ”€ page.tsx             # /events
â”‚  â””â”€ [id]/
â”‚     â””â”€ page.tsx          # /events/:id
â””â”€ activity-schedules/
   â”œâ”€ page.tsx             # /activity-schedules
   â””â”€ [id]/
      â””â”€ page.tsx          # /activity-schedules/:id


ã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‘

  ãƒ•ã‚¡ã‚¤ãƒ«å              URL
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  page.tsx                ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
  [id]/page.tsx           å‹•çš„ãƒ«ãƒ¼ãƒˆï¼ˆ:idéƒ¨åˆ†ãŒå¤‰ã‚ã‚‹ï¼‰
  layout.tsx              å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  loading.tsx             ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
  error.tsx               ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹


ã€Client Componentã¨Server Componentã€‘

  'use client' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®æœ‰ç„¡ã§åŒºåˆ¥

  âœ… Client Componentï¼ˆ'use client' ã‚ã‚Šï¼‰
    - ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œ
    - useState, useEffect ãªã©ã®HooksãŒä½¿ãˆã‚‹
    - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒä½¿ãˆã‚‹
    - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆ

  âœ… Server Componentï¼ˆ'use client' ãªã—ï¼‰
    - ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œ
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
    - HTMLã‚’ã‚µãƒ¼ãƒãƒ¼ã§ç”Ÿæˆã—ã¦é€ä¿¡
    - SEOã«æœ‰åˆ©
    - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒè‰¯ã„


ã€åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ§‹é€ ã€‘

'use client'  // Client Componentã®å ´åˆã®ã¿

import { useState, useEffect } from 'react'
import { useSession } from 'next-auth/react'

export default function PageName() {
  // 1. Hooks
  const { data: session } = useSession()
  const [data, setData] = useState([])
  const [loading, setLoading] = useState(true)

  // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—
  useEffect(() => {
    fetchData()
  }, [])

  const fetchData = async () => {
    const res = await fetch('/api/...')
    const data = await res.json()
    setData(data)
    setLoading(false)
  }

  // 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleAction = async () => {
    // ...
  }

  // 4. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (loading) return <div>Loading...</div>

  return (
    <div>
      {/* UI */}
    </div>
  )
}
```

---

## 27.1 ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ï¼ˆsrc/app/page.tsxï¼‰

ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã€ã‚µã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã§ã™ã€‚

### å…¨ä½“æ§‹é€ 

```typescript
'use client'  // Client Componentï¼ˆã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ãŒå¤šã„ãŸã‚ï¼‰

import Link from 'next/link'
import { Music, Calendar, MessageCircle, FileText, User } from 'lucide-react'
import { useState, useEffect } from 'react'
import YouTube from 'react-youtube'
import { useSession } from 'next-auth/react'

// æŠ•ç¨¿ã®å‹å®šç¾©
interface Post {
  id: string
  title: string
  content: string
  youtubeUrls: string[]
  images?: string[]
  userId: string
  createdAt: string
  user: {
    id: string
    name: string
    email: string
  }
  likes: {
    userId: string
    createdAt: string
  }[]
}

export default function Home() {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ï¼‰
  const { data: session } = useSession()
  
  // ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
  const [posts, setPosts] = useState<Post[]>([])        // æœ€æ–°ã®æŠ•ç¨¿
  const [popularPosts, setPopularPosts] = useState<Post[]>([])  // äººæ°—ã®æŠ•ç¨¿
  const [isLoading, setIsLoading] = useState(true)      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹

  // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
  useEffect(() => {
    fetchPosts()
  }, [])  // ä¾å­˜é…åˆ—ãŒç©º = åˆå›ã®ã¿å®Ÿè¡Œ

  // æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  const fetchPosts = async () => {
    try {
      const res = await fetch('/api/posts')
      const data = await res.json()
      
      // æœ€æ–°3ä»¶ã®ã¿è¡¨ç¤º
      setPosts(data.slice(0, 3))
      
      // ã„ã„ã­æ•°ã§ã‚½ãƒ¼ãƒˆã—ã¦äººæ°—ã®æŠ•ç¨¿ã‚’å–å¾—
      const sorted = [...data].sort((a, b) => b.likes.length - a.likes.length)
      setPopularPosts(sorted.slice(0, 3).filter(p => p.likes.length > 0))
    } catch (error) {
      console.error('Failed to fetch posts:', error)
    } finally {
      setIsLoading(false)  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
    }
  }

  // YouTube URLã‹ã‚‰IDã‚’æŠ½å‡º
  const extractYouTubeId = (url: string) => {
    const match = url.match(/(?:youtube\.com\/(?:watch\?v=|live\/|shorts\/|embed\/)|youtu\.be\/)([^&\n?#]+)/)
    return match ? match[1] : null
  }

  // Markdownã®ã‚ˆã†ãªç”»åƒè¨˜æ³•ã‚’å‡¦ç†
  const renderContent = (content: string) => {
    return content.split('\n').map((line, index) => {
      // ![alt](url) å½¢å¼ã®ç”»åƒã‚’æ¤œå‡º
      const imgMatch = line.match(/!\[.*?\]\((.*?)\)/)
      if (imgMatch) {
        return (
          <div key={index} className="my-2">
            <img
              src={imgMatch[1]}
              alt="æŠ•ç¨¿ç”»åƒ"
              className="max-w-full h-auto rounded-lg"
              style={{ maxHeight: '500px', objectFit: 'contain' }}
            />
          </div>
        )
      }
      return line ? <div key={index}>{line}</div> : <br key={index} />
    })
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      {/* Hero Section */}
      <div className="relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('/grid.svg')] opacity-10"></div>
        <div className="container mx-auto px-4 py-20 relative">
          <div className="text-center mb-12 space-y-6">
            {/* ã‚¢ã‚¤ã‚³ãƒ³ */}
            <div className="inline-flex items-center justify-center mb-6 relative">
              <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 blur-2xl opacity-50 animate-pulse"></div>
              <Music className="w-20 h-20 text-white relative z-10" />
            </div>
            
            {/* ã‚¿ã‚¤ãƒˆãƒ« */}
            <h1 className="text-6xl md:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 animate-gradient">
              BOLD è»½éŸ³
            </h1>
            <p className="text-2xl md:text-3xl text-white/90 font-light">
              ãƒ¡ãƒ³ãƒãƒ¼ã‚µã‚¤ãƒˆ
            </p>
            <p className="text-lg text-white/70 max-w-2xl mx-auto">
              éŸ³æ¥½ã‚’æ„›ã™ã‚‹ä»²é–“ãŸã¡ãŒé›†ã†ã€å‰µé€ ã¨äº¤æµã®å ´
            </p>
            
            {/* ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ */}
            {!session && (
              <div className="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                <Link 
                  href="/auth/signin"
                  className="group relative inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-purple-600 rounded-full overflow-hidden shadow-2xl transition-all duration-300 hover:scale-105 hover:shadow-purple-500/50"
                >
                  <span className="relative z-10">ãƒ­ã‚°ã‚¤ãƒ³</span>
                  <div className="absolute inset-0 bg-gradient-to-r from-purple-600 to-pink-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </Link>
                <Link 
                  href="/auth/signup"
                  className="group relative inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white border-2 border-white/30 backdrop-blur-sm rounded-full overflow-hidden transition-all duration-300 hover:scale-105 hover:border-white/60"
                >
                  <span className="relative z-10">æ–°è¦ç™»éŒ²</span>
                </Link>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Features Section - æ©Ÿèƒ½ç´¹ä»‹ */}
      <div className="container mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-white mb-12 text-center">
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
            æ©Ÿèƒ½
          </span>
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
          {/* å„æ©Ÿèƒ½ã‚«ãƒ¼ãƒ‰ */}
          <Link href="/posts" className="group relative bg-white/10 backdrop-blur-md rounded-2xl p-8 hover:bg-white/15 transition-all duration-300 hover:scale-105 border border-white/10 hover:border-white/20">
            <div className="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div className="relative">
              <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300 shadow-lg shadow-blue-500/50">
                <FileText className="w-8 h-8 text-white" />
              </div>
              <h3 className="text-2xl font-bold text-white mb-3">æ´»å‹•å ±å‘Š</h3>
              <p className="text-white/70">ç·´ç¿’ã®æˆæœã‚„æ¼”å¥å‹•ç”»ã‚’å…±æœ‰</p>
            </div>
          </Link>
          
          {/* ä»–ã®ã‚«ãƒ¼ãƒ‰ã‚‚åŒæ§˜ */}
        </div>
      </div>

      {/* Latest Posts Section - æœ€æ–°ã®æŠ•ç¨¿ */}
      {!isLoading && posts.length > 0 && (
        <div className="container mx-auto px-4 py-16">
          <h2 className="text-4xl font-bold text-white mb-12 text-center">
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
              æœ€æ–°ã®æ´»å‹•å ±å‘Š
            </span>
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
            {posts.map(post => (
              <Link 
                key={post.id} 
                href={`/posts/${post.id}`}
                className="group bg-white/10 backdrop-blur-md rounded-2xl overflow-hidden hover:bg-white/15 transition-all duration-300 hover:scale-105 border border-white/10 hover:border-white/20"
              >
                {/* æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ã®å†…å®¹ */}
              </Link>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. useEffectã®ä½¿ã„æ–¹ã€‘
  useEffect(() => {
    fetchPosts()
  }, [])  // ä¾å­˜é…åˆ—ãŒç©º â†’ åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã®ã¿å®Ÿè¡Œ

  âŒ é–“é•ã„: ä¾å­˜é…åˆ—ãªã—
  useEffect(() => {
    fetchPosts()
  })  // æ¯å›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«å®Ÿè¡Œ â†’ ç„¡é™ãƒ«ãƒ¼ãƒ—ã®å±é™º


ã€2. æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€‘
  {!session && (
    <Link href="/auth/signin">ãƒ­ã‚°ã‚¤ãƒ³</Link>
  )}
  â†’ ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã®ã¿è¡¨ç¤º

  {isLoading ? (
    <div>Loading...</div>
  ) : (
    <div>Content</div>
  )}
  â†’ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ


ã€3. é…åˆ—æ“ä½œã€‘
  // æœ€æ–°3ä»¶
  data.slice(0, 3)

  // ã„ã„ã­æ•°ã§ã‚½ãƒ¼ãƒˆ
  const sorted = [...data].sort((a, b) => 
    b.likes.length - a.likes.length
  )
  
  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ¼”ç®—å­ [...data] ã§å…ƒã®é…åˆ—ã‚’å¤‰æ›´ã—ãªã„


ã€4. Tailwind CSSã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘
  bg-gradient-to-r from-blue-600 to-purple-600
  â†’ å·¦ã‹ã‚‰å³ã¸ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

  text-transparent bg-clip-text bg-gradient-to-r ...
  â†’ ãƒ†ã‚­ã‚¹ãƒˆã«ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨


ã€5. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€‘
  hover:scale-105
  â†’ ãƒ›ãƒãƒ¼æ™‚ã«105%ã«æ‹¡å¤§

  transition-all duration-300
  â†’ å…¨ã¦ã®å¤‰åŒ–ã‚’300ms ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
```

---

## 27.2 æŠ•ç¨¿ãƒšãƒ¼ã‚¸ï¼ˆsrc/app/posts/page.tsxï¼‰

æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã§ã™ã€‚

### ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯

```typescript
'use client'

import { useState, useEffect, useRef, useCallback, useMemo } from 'react'
import YouTube from 'react-youtube'
import { useSession } from 'next-auth/react'
import { Heart, MessageCircle, Send, Trash2 } from 'lucide-react'
import Link from 'next/link'
import DashboardLayout from '@/components/DashboardLayout'

// å‹å®šç¾©
interface User {
  id: string
  name: string
  email: string
  avatarUrl?: string | null
}

interface Comment {
  id: string
  content: string
  createdAt: string
  user: User
}

interface PostParticipant {
  id: string
  status: string
  user: User
}

interface Post {
  id: string
  title: string
  content: string
  youtubeUrls: string[]
  images?: string[]
  createdAt: string
  userId: string
  user: User
  participants: PostParticipant[]
  likes: {
    userId: string
    createdAt: string
  }[]
  comments?: Comment[]
  _count?: {
    comments: number
  }
}

const POSTS_PER_PAGE = 5  // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®æŠ•ç¨¿æ•°

export default function PostsPage() {
  // Hooks
  const { data: session } = useSession()
  const [posts, setPosts] = useState<Post[]>([])
  const [currentPage, setCurrentPage] = useState(1)
  const [fetchingPosts, setFetchingPosts] = useState(true)
  const [newComment, setNewComment] = useState<{ [postId: string]: string }>({})
  const [submittingComment, setSubmittingComment] = useState<string | null>(null)
  const [expandedComments, setExpandedComments] = useState<{ [postId: string]: boolean }>({})

  const isAdmin = session?.user?.role === 'admin'

  // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
  useEffect(() => {
    fetchPosts()
  }, [])

  // æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—
  const fetchPosts = useCallback(async () => {
    setFetchingPosts(true)
    try {
      const res = await fetch('/api/posts')
      const data = await res.json()
      setPosts(data)
    } catch (error) {
      console.error('Failed to fetch posts:', error)
    } finally {
      setFetchingPosts(false)
    }
  }, [])

  // ã„ã„ã­æ©Ÿèƒ½
  const handleLike = async (postId: string) => {
    if (!session) return

    // æ¥½è¦³çš„UIæ›´æ–°ï¼ˆå³åº§ã«ç”»é¢ã«åæ˜ ï¼‰
    const isLiked = posts.find(p => p.id === postId)?.likes.some(l => l.userId === session.user.id)
    
    setPosts(posts.map(p => {
      if (p.id === postId) {
        if (isLiked) {
          // ã„ã„ã­è§£é™¤
          return {
            ...p,
            likes: p.likes.filter(l => l.userId !== session.user.id)
          }
        } else {
          // ã„ã„ã­è¿½åŠ 
          return {
            ...p,
            likes: [...p.likes, { userId: session.user.id, createdAt: new Date().toISOString() }]
          }
        }
      }
      return p
    }))

    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    try {
      const method = isLiked ? 'DELETE' : 'POST'
      const res = await fetch(`/api/posts/${postId}/like`, { method })
      
      if (!res.ok) {
        // å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
        fetchPosts()
      }
    } catch (error) {
      console.error('ã„ã„ã­ã‚¨ãƒ©ãƒ¼:', error)
      fetchPosts()
    }
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
  const handleCommentSubmit = async (postId: string) => {
    const content = newComment[postId]?.trim()
    if (!content) return

    setSubmittingComment(postId)

    try {
      const res = await fetch(`/api/posts/${postId}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
      })

      if (res.ok) {
        const comment = await res.json()
        
        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³åº§ã«ç”»é¢ã«è¿½åŠ ï¼ˆæ¥½è¦³çš„UIæ›´æ–°ï¼‰
        setPosts(posts.map(p => {
          if (p.id === postId) {
            return {
              ...p,
              comments: [comment, ...(p.comments || [])],
              _count: {
                ...p._count,
                comments: (p._count?.comments || 0) + 1
              }
            }
          }
          return p
        }))
        
        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        setNewComment({ ...newComment, [postId]: '' })
      }
    } catch (error) {
      console.error('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error)
    } finally {
      setSubmittingComment(null)
    }
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
  const handleDeleteComment = async (postId: string, commentId: string) => {
    if (!confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return

    try {
      const res = await fetch(`/api/posts/${postId}/comments/${commentId}`, {
        method: 'DELETE'
      })

      if (res.ok) {
        // ã‚³ãƒ¡ãƒ³ãƒˆã‚’å³åº§ã«ç”»é¢ã‹ã‚‰å‰Šé™¤
        setPosts(posts.map(p => {
          if (p.id === postId) {
            return {
              ...p,
              comments: p.comments?.filter(c => c.id !== commentId),
              _count: {
                ...p._count,
                comments: Math.max(0, (p._count?.comments || 0) - 1)
              }
            }
          }
          return p
        }))
      }
    } catch (error) {
      console.error('ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—ï¼ˆuseMemoã§æœ€é©åŒ–ï¼‰
  const { paginatedPosts, totalPages } = useMemo(() => {
    const startIndex = (currentPage - 1) * POSTS_PER_PAGE
    const endIndex = startIndex + POSTS_PER_PAGE
    return {
      paginatedPosts: posts.slice(startIndex, endIndex),
      totalPages: Math.ceil(posts.length / POSTS_PER_PAGE)
    }
  }, [posts, currentPage])

  // YouTube IDæŠ½å‡º
  const extractYouTubeId = (url: string) => {
    const match = url.match(/(?:youtube\.com\/(?:watch\?v=|live\/|shorts\/|embed\/)|youtu\.be\/)([^&\n?#]+)/)
    return match ? match[1] : null
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  if (fetchingPosts) {
    return (
      <DashboardLayout>
        <div className="flex justify-center items-center min-h-screen">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      </DashboardLayout>
    )
  }

  return (
    <DashboardLayout>
      <div className="max-w-4xl mx-auto p-6">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900">æ´»å‹•å ±å‘Š</h1>
          {isAdmin && (
            <Link
              href="/posts/new"
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              æ–°è¦æŠ•ç¨¿
            </Link>
          )}
        </div>

        {/* æŠ•ç¨¿ä¸€è¦§ */}
        <div className="space-y-6">
          {paginatedPosts.map(post => (
            <div key={post.id} className="bg-white rounded-lg shadow-md p-6">
              {/* æŠ•ç¨¿ãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h2 className="text-2xl font-bold mb-2">{post.title}</h2>
                  <div className="text-sm text-gray-500">
                    æŠ•ç¨¿è€…: {post.user.name} | {new Date(post.createdAt).toLocaleDateString('ja-JP')}
                  </div>
                </div>
                {isAdmin && (
                  <div className="flex gap-2">
                    <Link
                      href={`/posts/${post.id}/edit`}
                      className="text-blue-600 hover:underline"
                    >
                      ç·¨é›†
                    </Link>
                    <button
                      onClick={() => handleDelete(post.id)}
                      className="text-red-600 hover:underline"
                    >
                      å‰Šé™¤
                    </button>
                  </div>
                )}
              </div>

              {/* æŠ•ç¨¿å†…å®¹ */}
              <div className="prose max-w-none mb-4">
                {renderContent(post.content)}
              </div>

              {/* YouTubeå‹•ç”» */}
              {post.youtubeUrls && post.youtubeUrls.length > 0 && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  {post.youtubeUrls.map((url, index) => {
                    const videoId = extractYouTubeId(url)
                    return videoId ? (
                      <YouTube
                        key={index}
                        videoId={videoId}
                        opts={{
                          width: '100%',
                          playerVars: { autoplay: 0 }
                        }}
                      />
                    ) : null
                  })}
                </div>
              )}

              {/* ã„ã„ã­ã¨ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ */}
              <div className="flex gap-4 mb-4 pb-4 border-b">
                <button
                  onClick={() => handleLike(post.id)}
                  className={`flex items-center gap-2 ${
                    post.likes.some(l => l.userId === session?.user?.id)
                      ? 'text-red-600'
                      : 'text-gray-600 hover:text-red-600'
                  }`}
                >
                  <Heart className={`w-5 h-5 ${
                    post.likes.some(l => l.userId === session?.user?.id)
                      ? 'fill-current'
                      : ''
                  }`} />
                  {post.likes.length}
                </button>
                <button
                  onClick={() => toggleComments(post.id)}
                  className="flex items-center gap-2 text-gray-600 hover:text-blue-600"
                >
                  <MessageCircle className="w-5 h-5" />
                  {post._count?.comments || 0}
                </button>
              </div>

              {/* ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
              {expandedComments[post.id] && (
                <div className="mt-4">
                  {/* ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ› */}
                  <div className="flex gap-2 mb-4">
                    <input
                      type="text"
                      value={newComment[post.id] || ''}
                      onChange={(e) => setNewComment({ ...newComment, [post.id]: e.target.value })}
                      placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
                      className="flex-1 border rounded-lg px-3 py-2"
                      onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                          handleCommentSubmit(post.id)
                        }
                      }}
                    />
                    <button
                      onClick={() => handleCommentSubmit(post.id)}
                      disabled={submittingComment === post.id}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    >
                      <Send className="w-5 h-5" />
                    </button>
                  </div>

                  {/* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ */}
                  <div className="space-y-3">
                    {post.comments?.map(comment => (
                      <div key={comment.id} className="bg-gray-50 rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <div className="font-semibold text-sm">{comment.user.name}</div>
                            <div className="text-gray-700 mt-1">{comment.content}</div>
                            <div className="text-xs text-gray-500 mt-1">
                              {new Date(comment.createdAt).toLocaleDateString('ja-JP')}
                            </div>
                          </div>
                          {(session?.user?.id === comment.user.id || isAdmin) && (
                            <button
                              onClick={() => handleDeleteComment(post.id, comment.id)}
                              className="text-red-600 hover:text-red-800"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>

        {/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */}
        {totalPages > 1 && (
          <div className="flex justify-center gap-2 mt-8">
            <button
              onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
              disabled={currentPage === 1}
              className="px-4 py-2 border rounded-lg disabled:opacity-50"
            >
              å‰ã¸
            </button>
            <div className="flex items-center gap-2">
              {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                <button
                  key={page}
                  onClick={() => setCurrentPage(page)}
                  className={`px-4 py-2 rounded-lg ${
                    currentPage === page
                      ? 'bg-blue-600 text-white'
                      : 'border hover:bg-gray-100'
                  }`}
                >
                  {page}
                </button>
              ))}
            </div>
            <button
              onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
              disabled={currentPage === totalPages}
              className="px-4 py-2 border rounded-lg disabled:opacity-50"
            >
              æ¬¡ã¸
            </button>
          </div>
        )}
      </div>
    </DashboardLayout>
  )
}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã®è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. æ¥½è¦³çš„UIæ›´æ–°ï¼ˆOptimistic UIï¼‰ã€‘
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å³åº§ã«åå¿œã™ã‚‹

  const handleLike = async (postId: string) => {
    // å…ˆã«ç”»é¢ã‚’æ›´æ–°ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
    setPosts(/* æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ */)
    
    // ãã®å¾ŒAPIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const res = await fetch('/api/posts/${postId}/like', { method })
    
    // å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
    if (!res.ok) {
      fetchPosts()
    }
  }

  âœ… ãƒ¡ãƒªãƒƒãƒˆ:
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒå‘ä¸Š
    - ç´ æ—©ãåå¿œã™ã‚‹
  
  âš ï¸ æ³¨æ„ç‚¹:
    - å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¿…è¦


ã€2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ã€‘
  è¤‡æ•°ã®æŠ•ç¨¿ãã‚Œãã‚Œã«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æŒã¤

  const [newComment, setNewComment] = useState<{ [postId: string]: string }>({})
  
  // ä½¿ã„æ–¹
  newComment[post.id]  // ç‰¹å®šã®æŠ•ç¨¿ã®ã‚³ãƒ¡ãƒ³ãƒˆ
  setNewComment({ ...newComment, [postId]: 'new value' })


ã€3. useMemoã«ã‚ˆã‚‹æœ€é©åŒ–ã€‘
  è¨ˆç®—çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ä¸è¦ãªå†è¨ˆç®—ã‚’é˜²ã

  const { paginatedPosts, totalPages } = useMemo(() => {
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
    return { paginatedPosts, totalPages }
  }, [posts, currentPage])
  // posts ã¾ãŸã¯ currentPage ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘å†è¨ˆç®—


ã€4. useCallbackã«ã‚ˆã‚‹æœ€é©åŒ–ã€‘
  é–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ä¸è¦ãªå†ç”Ÿæˆã‚’é˜²ã

  const fetchPosts = useCallback(async () => {
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
  }, [])  // ä¾å­˜é…åˆ—ãŒç©º â†’ 1åº¦ã ã‘ç”Ÿæˆ


ã€5. æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã€‘
  {expandedComments[post.id] && (
    <div>ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
  )}
  â†’ ã‚³ãƒ¡ãƒ³ãƒˆãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹æ™‚ã ã‘è¡¨ç¤º


ã€6. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã€‘
  const startIndex = (currentPage - 1) * POSTS_PER_PAGE
  const endIndex = startIndex + POSTS_PER_PAGE
  const paginatedPosts = posts.slice(startIndex, endIndex)
  
  totalPages = Math.ceil(posts.length / POSTS_PER_PAGE)


ã€7. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã€‘
  onKeyPress={(e) => {
    if (e.key === 'Enter') {
      handleCommentSubmit(post.id)
    }
  }}
  â†’ Enterã‚­ãƒ¼ã§ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡
```

---

## 27.3 ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ï¼ˆsrc/app/events/page.tsxï¼‰

ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã§ã™ã€‚

### ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯

```typescript
'use client'

import { useEffect, useState, useCallback } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import DashboardLayout from '@/components/DashboardLayout'
import { Calendar, Users, Plus, MapPin, Music } from 'lucide-react'

interface Event {
  id: string
  title: string
  content: string
  date: string
  locationName: string | null
  locationUrl: string | null
  songs: string | null
  user: User
  participants: Participant[]
  comments?: Comment[]
  _count?: {
    comments: number
  }
}

export default function EventsPage() {
  const { data: session, status } = useSession()
  const router = useRouter()
  const [events, setEvents] = useState<Event[]>([])
  const [loading, setLoading] = useState(true)
  const [showCreateForm, setShowCreateForm] = useState(false)

  // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹
  const [formData, setFormData] = useState({
    title: '',
    content: '',
    date: '',
    locationName: '',
    locationUrl: '',
    songs: [] as {
      title: string
      sheetUrl: string
      youtubeUrl: string
      parts: { instrument: string; player: string }[]
    }[]
  })

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/auth/signin')
    } else if (status === 'authenticated') {
      fetchEvents()
    }
  }, [status, router])

  // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§å–å¾—
  const fetchEvents = useCallback(async () => {
    try {
      const res = await fetch('/api/events')
      if (res.ok) {
        const data = await res.json()
        setEvents(data)
      }
    } catch (error) {
      console.error('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    } finally {
      setLoading(false)
    }
  }, [])

  // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!formData.title || !formData.content || !formData.date) {
      alert('ã‚¿ã‚¤ãƒˆãƒ«ã€å†…å®¹ã€æ—¥ä»˜ã¯å¿…é ˆã§ã™')
      return
    }

    try {
      const res = await fetch('/api/events', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      })

      if (res.ok) {
        setShowCreateForm(false)
        setFormData({
          title: '',
          content: '',
          date: '',
          locationName: '',
          locationUrl: '',
          songs: []
        })
        fetchEvents()
      }
    } catch (error) {
      console.error('ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  // èª²é¡Œæ›²è¿½åŠ 
  const handleAddSong = () => {
    setFormData({
      ...formData,
      songs: [
        ...formData.songs,
        {
          title: '',
          sheetUrl: '',
          youtubeUrl: '',
          parts: []
        }
      ]
    })
  }

  // èª²é¡Œæ›²å‰Šé™¤
  const handleRemoveSong = (index: number) => {
    setFormData({
      ...formData,
      songs: formData.songs.filter((_, i) => i !== index)
    })
  }

  // ãƒ‘ãƒ¼ãƒˆè¿½åŠ 
  const handleAddPart = (songIndex: number) => {
    const newSongs = [...formData.songs]
    newSongs[songIndex].parts.push({ instrument: '', player: '' })
    setFormData({ ...formData, songs: newSongs })
  }

  // ãƒ‘ãƒ¼ãƒˆæ›´æ–°
  const handleUpdatePart = (
    songIndex: number,
    partIndex: number,
    field: 'instrument' | 'player',
    value: string
  ) => {
    const newSongs = [...formData.songs]
    newSongs[songIndex].parts[partIndex][field] = value
    setFormData({ ...formData, songs: newSongs })
  }

  // å‚åŠ ç™»éŒ²
  const handleParticipate = async (eventId: string) => {
    try {
      const res = await fetch(`/api/events/${eventId}/participate`, {
        method: 'POST'
      })

      if (res.ok) {
        fetchEvents()
      }
    } catch (error) {
      console.error('å‚åŠ ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  // å‚åŠ å–ã‚Šæ¶ˆã—
  const handleCancelParticipation = async (eventId: string) => {
    try {
      const res = await fetch(`/api/events/${eventId}/participate`, {
        method: 'DELETE'
      })

      if (res.ok) {
        fetchEvents()
      }
    } catch (error) {
      console.error('å‚åŠ å–ã‚Šæ¶ˆã—ã‚¨ãƒ©ãƒ¼:', error)
    }
  }

  if (loading) {
    return (
      <DashboardLayout>
        <div className="flex justify-center items-center min-h-screen">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      </DashboardLayout>
    )
  }

  return (
    <DashboardLayout>
      <div className="max-w-6xl mx-auto p-6">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-3xl font-bold">ã‚¤ãƒ™ãƒ³ãƒˆ</h1>
          {session?.user?.role === 'admin' && (
            <button
              onClick={() => setShowCreateForm(!showCreateForm)}
              className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              <Plus className="w-5 h-5" />
              æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆ
            </button>
          )}
        </div>

        {/* ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ  */}
        {showCreateForm && (
          <div className="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 className="text-2xl font-bold mb-4">æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              {/* ã‚¿ã‚¤ãƒˆãƒ« */}
              <div>
                <label className="block text-sm font-medium mb-1">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                <input
                  type="text"
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  className="w-full border rounded-lg px-3 py-2"
                  required
                />
              </div>

              {/* æ—¥æ™‚ */}
              <div>
                <label className="block text-sm font-medium mb-1">æ—¥æ™‚ *</label>
                <input
                  type="datetime-local"
                  value={formData.date}
                  onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                  className="w-full border rounded-lg px-3 py-2"
                  required
                />
              </div>

              {/* å ´æ‰€ */}
              <div>
                <label className="block text-sm font-medium mb-1">å ´æ‰€</label>
                <input
                  type="text"
                  value={formData.locationName}
                  onChange={(e) => setFormData({ ...formData, locationName: e.target.value })}
                  className="w-full border rounded-lg px-3 py-2"
                  placeholder="ä¾‹: æ¸‹è°·ãƒ©ã‚¤ãƒ–ãƒã‚¦ã‚¹"
                />
              </div>

              {/* åœ°å›³URL */}
              <div>
                <label className="block text-sm font-medium mb-1">åœ°å›³URL</label>
                <input
                  type="url"
                  value={formData.locationUrl}
                  onChange={(e) => setFormData({ ...formData, locationUrl: e.target.value })}
                  className="w-full border rounded-lg px-3 py-2"
                  placeholder="Google Mapsã®ãƒªãƒ³ã‚¯ç­‰"
                />
              </div>

              {/* å†…å®¹ */}
              <div>
                <label className="block text-sm font-medium mb-1">å†…å®¹ *</label>
                <textarea
                  value={formData.content}
                  onChange={(e) => setFormData({ ...formData, content: e.target.value })}
                  className="w-full border rounded-lg px-3 py-2"
                  rows={5}
                  required
                />
              </div>

              {/* èª²é¡Œæ›²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
              <div>
                <div className="flex justify-between items-center mb-2">
                  <label className="block text-sm font-medium">èª²é¡Œæ›²</label>
                  <button
                    type="button"
                    onClick={handleAddSong}
                    className="text-blue-600 hover:text-blue-800 text-sm"
                  >
                    + èª²é¡Œæ›²ã‚’è¿½åŠ 
                  </button>
                </div>
                
                {formData.songs.map((song, songIndex) => (
                  <div key={songIndex} className="border rounded-lg p-4 mb-4">
                    <div className="flex justify-between items-center mb-3">
                      <h4 className="font-semibold">èª²é¡Œæ›² {songIndex + 1}</h4>
                      <button
                        type="button"
                        onClick={() => handleRemoveSong(songIndex)}
                        className="text-red-600 hover:text-red-800 text-sm"
                      >
                        å‰Šé™¤
                      </button>
                    </div>

                    {/* æ›²ã‚¿ã‚¤ãƒˆãƒ« */}
                    <input
                      type="text"
                      value={song.title}
                      onChange={(e) => {
                        const newSongs = [...formData.songs]
                        newSongs[songIndex].title = e.target.value
                        setFormData({ ...formData, songs: newSongs })
                      }}
                      placeholder="æ›²å"
                      className="w-full border rounded-lg px-3 py-2 mb-2"
                    />

                    {/* æ¥½è­œURL */}
                    <input
                      type="url"
                      value={song.sheetUrl}
                      onChange={(e) => {
                        const newSongs = [...formData.songs]
                        newSongs[songIndex].sheetUrl = e.target.value
                        setFormData({ ...formData, songs: newSongs })
                      }}
                      placeholder="æ¥½è­œURL"
                      className="w-full border rounded-lg px-3 py-2 mb-2"
                    />

                    {/* YouTube URL */}
                    <input
                      type="url"
                      value={song.youtubeUrl}
                      onChange={(e) => {
                        const newSongs = [...formData.songs]
                        newSongs[songIndex].youtubeUrl = e.target.value
                        setFormData({ ...formData, songs: newSongs })
                      }}
                      placeholder="YouTube URL"
                      className="w-full border rounded-lg px-3 py-2 mb-2"
                    />

                    {/* ãƒ‘ãƒ¼ãƒˆå‰²ã‚Šå½“ã¦ */}
                    <div className="mt-3">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-sm font-medium">ãƒ‘ãƒ¼ãƒˆå‰²ã‚Šå½“ã¦</span>
                        <button
                          type="button"
                          onClick={() => handleAddPart(songIndex)}
                          className="text-blue-600 hover:text-blue-800 text-xs"
                        >
                          + ãƒ‘ãƒ¼ãƒˆè¿½åŠ 
                        </button>
                      </div>
                      
                      {song.parts.map((part, partIndex) => (
                        <div key={partIndex} className="flex gap-2 mb-2">
                          <input
                            type="text"
                            value={part.instrument}
                            onChange={(e) => handleUpdatePart(songIndex, partIndex, 'instrument', e.target.value)}
                            placeholder="æ¥½å™¨"
                            className="flex-1 border rounded-lg px-3 py-2 text-sm"
                          />
                          <input
                            type="text"
                            value={part.player}
                            onChange={(e) => handleUpdatePart(songIndex, partIndex, 'player', e.target.value)}
                            placeholder="æ‹…å½“è€…"
                            className="flex-1 border rounded-lg px-3 py-2 text-sm"
                          />
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              {/* ãƒœã‚¿ãƒ³ */}
              <div className="flex gap-3">
                <button
                  type="submit"
                  className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                >
                  ä½œæˆ
                </button>
                <button
                  type="button"
                  onClick={() => setShowCreateForm(false)}
                  className="border px-6 py-2 rounded-lg hover:bg-gray-100"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </form>
          </div>
        )}

        {/* ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ */}
        <div className="space-y-6">
          {events.map(event => {
            const isParticipating = event.participants.some(p => p.userId === session?.user?.id)
            const isPastEvent = new Date(event.date) < new Date()

            return (
              <div key={event.id} className="bg-white rounded-lg shadow-md p-6">
                {/* ã‚¤ãƒ™ãƒ³ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">{event.title}</h2>
                    <div className="flex flex-wrap gap-4 text-sm text-gray-600">
                      <div className="flex items-center gap-1">
                        <Calendar className="w-4 h-4" />
                        {new Date(event.date).toLocaleString('ja-JP')}
                      </div>
                      {event.locationName && (
                        <div className="flex items-center gap-1">
                          <MapPin className="w-4 h-4" />
                          {event.locationUrl ? (
                            <a
                              href={event.locationUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-blue-600 hover:underline"
                            >
                              {event.locationName}
                            </a>
                          ) : (
                            event.locationName
                          )}
                        </div>
                      )}
                      <div className="flex items-center gap-1">
                        <Users className="w-4 h-4" />
                        {event.participants.length}äººå‚åŠ 
                      </div>
                    </div>
                  </div>
                </div>

                {/* ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ */}
                <div className="prose max-w-none mb-4">
                  {event.content}
                </div>

                {/* å‚åŠ ãƒœã‚¿ãƒ³ */}
                {!isPastEvent && (
                  <div className="mt-4">
                    {isParticipating ? (
                      <button
                        onClick={() => handleCancelParticipation(event.id)}
                        className="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700"
                      >
                        å‚åŠ ã‚’å–ã‚Šæ¶ˆã™
                      </button>
                    ) : (
                      <button
                        onClick={() => handleParticipate(event.id)}
                        className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
                      >
                        å‚åŠ ã™ã‚‹
                      </button>
                    )}
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </div>
    </DashboardLayout>
  )
}
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã®è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. è¤‡é›‘ãªãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ã€‘
  ãƒã‚¹ãƒˆã—ãŸé…åˆ—ã‚’å«ã‚€ãƒ•ã‚©ãƒ¼ãƒ 

  const [formData, setFormData] = useState({
    title: '',
    songs: [] as {
      title: string
      parts: { instrument: string; player: string }[]
    }[]
  })

  // é…åˆ—ã®æ›´æ–°
  const newSongs = [...formData.songs]  // ã‚³ãƒ”ãƒ¼
  newSongs[songIndex].title = newValue  // æ›´æ–°
  setFormData({ ...formData, songs: newSongs })  // ã‚»ãƒƒãƒˆ


ã€2. æ—¥æ™‚ã®æ‰±ã„ã€‘
  input type="datetime-local"
    â†’ "2025-01-01T10:00" å½¢å¼

  new Date(event.date)
    â†’ Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›

  new Date().toLocaleString('ja-JP')
    â†’ "2025/1/1 10:00:00" å½¢å¼ã§è¡¨ç¤º


ã€3. æ¡ä»¶ä»˜ãã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã€‘
  {isPastEvent ? (
    <span className="text-gray-500">çµ‚äº†</span>
  ) : (
    <button className="bg-green-600">å‚åŠ ã™ã‚‹</button>
  )}

  className={isParticipating
    ? 'bg-red-600'
    : 'bg-green-600'
  }


ã€4. é…åˆ—ã®æ“ä½œã€‘
  // è¿½åŠ 
  setFormData({
    ...formData,
    songs: [...formData.songs, newSong]
  })

  // å‰Šé™¤
  setFormData({
    ...formData,
    songs: formData.songs.filter((_, i) => i !== index)
  })

  // æ›´æ–°
  const newSongs = [...formData.songs]
  newSongs[index] = updatedSong
  setFormData({ ...formData, songs: newSongs })


ã€5. å‚åŠ è€…ãƒã‚§ãƒƒã‚¯ã€‘
  const isParticipating = event.participants.some(
    p => p.userId === session?.user?.id
  )

  some(): é…åˆ—ã®ä¸­ã«æ¡ä»¶ã«åˆã†è¦ç´ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
```

---

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€ä¸»è¦ãªãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…ã‚’è©³ã—ãè§£èª¬ã—ã¾ã—ãŸã€‚

### ğŸ“ ã“ã®ç« ã§å­¦ã‚“ã ã“ã¨

#### Client Componentã®è¨­è¨ˆ
- âœ… 'use client' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®ä½¿ã„æ–¹
- âœ… React Hooksã®æ´»ç”¨ï¼ˆuseState, useEffect, useMemo, useCallbackï¼‰
- âœ… ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨APIé€£æº
- âœ… fetch APIã®ä½¿ã„æ–¹
- âœ… æ¥½è¦³çš„UIæ›´æ–°
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
- âœ… ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†
- âœ… ã„ã„ã­æ©Ÿèƒ½ã®å®Ÿè£…
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…
- âœ… ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- âœ… useMemoã«ã‚ˆã‚‹è¨ˆç®—çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- âœ… useCallbackã«ã‚ˆã‚‹é–¢æ•°ã®ãƒ¡ãƒ¢åŒ–
- âœ… æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

### ğŸ’¡ é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
const [data, setData] = useState([])
const [loading, setLoading] = useState(true)

useEffect(() => {
  fetchData()
}, [])

const fetchData = async () => {
  setLoading(true)
  try {
    const res = await fetch('/api/...')
    const data = await res.json()
    setData(data)
  } catch (error) {
    console.error(error)
  } finally {
    setLoading(false)
  }
}
```

#### æ¥½è¦³çš„UIæ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
const handleAction = async (id: string) => {
  // 1. å…ˆã«ç”»é¢ã‚’æ›´æ–°
  setData(/* æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ */)
  
  // 2. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  try {
    const res = await fetch('/api/...')
    if (!res.ok) {
      // 3. å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
      fetchData()
    }
  } catch (error) {
    // 3. å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
    fetchData()
  }
}
```

### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¬¡ã®ç« ã§ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è©³ç´°ã‚’è§£èª¬ã—ã¾ã™ï¼š

- **Chapter 28**: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è©³ç´°è§£èª¬

---

[â† å‰ã®ç« ï¼šç¬¬31ç«  API Routesã®è©³ç´°è§£èª¬](31-API-Routesã®è©³ç´°è§£èª¬.md) | [ç›®æ¬¡ã«æˆ»ã‚‹](00-ç›®æ¬¡.md) | [æ¬¡ã®ç« ã¸ï¼šç¬¬33ç«  ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è©³ç´°è§£èª¬ â†’](33-ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®è©³ç´°è§£èª¬.md)
