name: Database Backup

on:
  # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“12æ™‚
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          # PostgreSQL 17 ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          # PostgreSQL 17 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get install -y postgresql-client-17
      
      - name: Create backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_FILE="db_backup_$TIMESTAMP.sql"
          
          echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
          echo "ãƒ•ã‚¡ã‚¤ãƒ«å: $BACKUP_FILE"
          
          # pgbouncerãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          BACKUP_URL=$(echo $DATABASE_URL | sed 's/?pgbouncer=true&connection_limit=1//')
          BACKUP_URL=$(echo $BACKUP_URL | sed 's/?pgbouncer=true//')
          
          # pg_dump 17ã‚’æ˜ç¤ºçš„ã«ä½¿ç”¨
          /usr/lib/postgresql/17/bin/pg_dump "$BACKUP_URL" > "$BACKUP_FILE"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª
          SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼ã‚µã‚¤ã‚º: $SIZE"
          
          # æš—å·åŒ–ã—ã¦ã‹ã‚‰åœ§ç¸®ï¼ˆAES-256-CBCï¼‰
          if [ -n "$BACKUP_ENCRYPTION_KEY" ]; then
            echo "ğŸ” ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æš—å·åŒ–ä¸­..."
            openssl enc -aes-256-cbc -salt -pbkdf2 -in "$BACKUP_FILE" -out "${BACKUP_FILE}.enc" -k "$BACKUP_ENCRYPTION_KEY"
            rm "$BACKUP_FILE"  # å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            gzip "${BACKUP_FILE}.enc"
            echo "âœ… æš—å·åŒ–å®Œäº†: ${BACKUP_FILE}.enc.gz"
            echo "backup_file=${BACKUP_FILE}.enc.gz" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ BACKUP_ENCRYPTION_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æš—å·åŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            gzip "$BACKUP_FILE"
            echo "backup_file=${BACKUP_FILE}.gz" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload backup as artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: db_backup_*.enc.gz
          retention-days: 30  # 30æ—¥é–“ä¿å­˜
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "GitHub Actions ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
