name: Database Backup

on:
  # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ = æ—¥æœ¬æ™‚é–“12æ™‚
  schedule:
    - cron: '0 3 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          # PostgreSQL 17 ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’è¿½åŠ 
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          # PostgreSQL 17 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get install -y postgresql-client-17
      
      - name: Create backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_FILE="db_backup_$TIMESTAMP.sql"
          
          echo "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
          echo "ãƒ•ã‚¡ã‚¤ãƒ«å: $BACKUP_FILE"
          
          # pgbouncerãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          BACKUP_URL=$(echo $DATABASE_URL | sed 's/?pgbouncer=true&connection_limit=1//')
          BACKUP_URL=$(echo $BACKUP_URL | sed 's/?pgbouncer=true//')
          
          # pg_dump 17ã‚’æ˜ç¤ºçš„ã«ä½¿ç”¨
          /usr/lib/postgresql/17/bin/pg_dump "$BACKUP_URL" > "$BACKUP_FILE"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèª
          SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          echo "âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼ã‚µã‚¤ã‚º: $SIZE"
          
          # åœ§ç¸®
          gzip "$BACKUP_FILE"
          echo "backup_file=${BACKUP_FILE}.gz" >> $GITHUB_OUTPUT
      
      - name: Upload backup as artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: db_backup_*.sql.gz
          retention-days: 30  # 30æ—¥é–“ä¿å­˜
      
      - name: Create Release with backup
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch'  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿
        with:
          tag_name: backup-${{ github.run_number }}
          name: Database Backup ${{ github.run_number }}
          body: |
            ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            
            ä½œæˆæ—¥æ™‚: ${{ github.event.head_commit.timestamp }}
            
            ## å¾©å…ƒæ–¹æ³•
            ```bash
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            gunzip db_backup_*.sql.gz
            
            # å¾©å…ƒ
            psql "$DATABASE_URL" < db_backup_*.sql
            ```
          files: db_backup_*.sql.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "GitHub Actions ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
